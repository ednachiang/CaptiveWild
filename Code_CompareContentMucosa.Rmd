---
title: "Compare Content vs. Mucosa"
author: "Edna Chiang"
date: "3/30/2021"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(ggplot2)
library(gplots)
library(phangorn)
library(tidyr)
library(vegan)
library(phyloseq)
library(grid)
library(pgirmess)
library(picante)
library(phytools)
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('scripts/veganCovEllipse.R')
source('scripts/simper_pretty.R')
source('scripts/R_krusk.R')
source('scripts/pairwise.adonis.R')
source('scripts/misc.R')
```

### Import Data
```{r}
# Link files
shared = "mothur_output/final.shared"
taxonomy = "mothur_output/final.taxonomy"
tree = "mothur_output/final.tre"

# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy,
  mothur_tree_file = tree)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

# Add metadata
meta <- read.csv("metadata.csv")
rownames(meta) <- meta$Sample
divsum <- read.table("mothur_output/final.summary", header = T)
meta[,12:21] <- divsum[,3:12]

# Update phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))

# Order factors
sample_data(physeq)$Season <- ordered(sample_data(physeq)$Season,
                                     levels=c("Summer", "Winter", "Spring"))
sample_data(physeq)$Metabolism <- ordered(sample_data(physeq)$Metabolism,
                                     levels=c("Active", "Torpor", "IBA"))
sample_data(physeq)$Group <- ordered(sample_data(physeq)$Group,
                                     levels=c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring"))

# Separate by season
physeq.wild <- subset_samples(physeq, Group == "Summer_Wild")
physeq.sum <- subset_samples(physeq, Group == "Summer_Lab")
physeq.tor <- subset_samples(physeq, Group == "Torpor")
physeq.iba <- subset_samples(physeq, Group == "IBA")
physeq.spr <- subset_samples(physeq, Group == "Spring")

# Separate by content/mucosa
physeq.con <- subset_samples(physeq, Sample_Type == "Content")
physeq.muc <- subset_samples(physeq, Sample_Type == "Mucosa")

# Subset out paired samples
physeq.pair <- subset_samples(physeq, ID != c(3881, 3886, 4057))

# Pull out only lab squirrels
physeq.lab <- subset_samples(physeq, Diet != "Wild")

# Min, Mean, Max of sample read counts
min(sample_sums(mothurdata))
  # 10452
mean(sample_sums(mothurdata))
  # 10999.21
median(sample_sums(mothurdata))
  # 11028
max(sample_sums(mothurdata))
  # 11156
```

### Calculate Faith's phylogenetic diversity
```{r}
### Unweighted - Calculate phylogenetic diversity and MPD ###

# Calculate Faith's phylogenetic diversity
pd.res <- pd(t(data.frame(otu_table(physeq.pair))), phy_tree(physeq.pair), 
             include.root = T)
pd.df <- data.frame(pd.res)

# Calculate MPD (Mean Pairwise Distance)
pd.dist <- cophenetic(phy_tree(physeq.pair))
  # Calculate cophenetic distance
ses.mpd.res <- ses.mpd(t(data.frame(otu_table(physeq.pair))), pd.dist, 
                       null.model = "taxa.labels", abundance.weighted = F, runs = 999)
  # Calculate MPD
  # This'll take a while to run-- be patient
mpd <- data.frame(ses.mpd.res)
  # Pull out MDP results


### Prepare data for plotting ###
mpd$SampleID <- row.names(mpd)
pd.res$SampleID <- row.names(pd.res)
  # Make sure all SampleID's match!

# Pull out first Stat of each test
# PD test = PD
# MPD test = SES (Standardized Effect Size)
pd.stats <- data.frame(pd.res$SampleID, pd.res$PD)
pd.stats$Measure <- rep("PD", nrow(pd.df))
colnames(pd.stats) <- c("Sample", "Stat", "Measure")
mpd.stats <- data.frame(mpd$SampleID, mpd$mpd.obs.z)
mpd.stats$Measure <- rep("MPD SES", nrow(pd.df))
colnames(mpd.stats) <- c("Sample", "Stat", "Measure")



### Prepare PD ###
pd.ready <- merge(pd.stats, meta, by = "Sample")
pd.ready$Group <- ordered(pd.ready$Group, levels = c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring"))


### Prepare MPD ###
mpd.ready <- merge(mpd.stats, meta, by = "Sample")
mpd.ready$Group <- ordered(mpd.ready$Group, levels = c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring"))





########## TESTING PD & MPD ##########

# For the paired tests, the tests assume that your samples are in the same order (same order of ID for both content and mucosa)
# Make sure you check ID orders!!!

### Test PD ###
hist(pd.ready$Stat, breaks=10)
qqnorm(pd.ready$Stat)
qqline(pd.ready$Stat)
shapiro.test(pd.ready$Stat)
  # p-value = 0.05333
  # Normal

t.test(Stat ~ Sample_Type, data = pd.ready, paired = T)
  # p-value = 0.1376



### Test MPD ###
hist(mpd.ready$Stat, breaks=10)
qqnorm(mpd.ready$Stat)
qqline(mpd.ready$Stat)
shapiro.test(mpd.ready$Stat)
  # p-value = 0.361
  # Normal

t.test(Stat ~ Sample_Type, data = mpd.ready, paired = T)
  # p-value = 0.5895
```

### Test content vs. mucosa - Alpha Diversity
```{r}
adiv <- data.frame(sample_data(physeq.pair))

########## Compare Con vs. Muc within Group ##########

# Separate by season
adiv.wild <- adiv[which(adiv$Group == "Summer_Wild"),]
adiv.sum <- adiv[which(adiv$Group == "Summer_Lab"),]
adiv.tor <- adiv[which(adiv$Group == "Torpor"),]
adiv.iba <- adiv[which(adiv$Group == "IBA"),]
adiv.spr <- adiv[which(adiv$Group == "Spring"),]


########## Chao ##########
hist(adiv$chao, breaks=10)
qqnorm(adiv$chao)
qqline(adiv$chao)
shapiro.test(adiv$chao)
  # p-value = 0.001037
  # Not Normal

### Wilcoxon & T-Test ###
wilcox.test(chao ~ Sample_Type, data = adiv, paired = T)
  # p-value = 0.003878*
# Separate out by Group
wilcox.test(chao ~ Sample_Type, data = adiv.wild, paired = T)
  # p-value = 0.2454
wilcox.test(chao ~ Sample_Type, data = adiv.sum, paired = T)
  # p-value = 0.3271
wilcox.test(chao ~ Sample_Type, data = adiv.tor, paired = T)
  # p-value = 0.07519
wilcox.test(chao ~ Sample_Type, data = adiv.iba, paired = T)
  # p-value = 0.1953
wilcox.test(chao ~ Sample_Type, data = adiv.spr, paired = T)
  # p-value = 0.8478
p.adjust(c(0.003878, 0.2454, 0.3271, 0.07519, 0.1953, 0.8478), method = "fdr")
  # 0.023268* 0.368100 0.392520 0.225570 0.368100 0.847800
  # All content vs. all mucosa = sig diff
  # Not sig within each group




########## Shannon ##########
hist(adiv$shannon, breaks=10)
qqnorm(adiv$shannon)
qqline(adiv$shannon)
shapiro.test(adiv.wild$shannon)
  # p-value = 0.4286
  # Normal

### T-Test ###
t.test(shannon ~ Sample_Type, data = adiv, paired = T)
  # p-value = 0.3436




########## Inverse Simpson ##########
hist(adiv$invsimpson, breaks=10)
qqnorm(adiv$invsimpson)
qqline(adiv$invsimpson)
shapiro.test(adiv$invsimpson)
  # p-value = 1.215e-05
  # Not Normal

### Wilcoxon & T-Test ###
wilcox.test(invsimpson ~ Sample_Type, data = adiv, paired = T)
  # p-value = 0.2109
```



### Test content vs. mucosa - Beta Diversity
```{r}
########## Unweighted UniFrac ##########
UF.u <- phyloseq::distance(physeq = physeq.pair, method = "unifrac")
UF.u.pcoa <- ordinate(physeq = physeq.pair, method = "PCoA", distance = "unifrac")
  # Variation explained = 22.7%
plot_ordination(physeq = physeq.pair, ordination = UF.u.pcoa, axes = c(1,2),
                title = "Unweighted UniFrac") +
  geom_point(size = 2, aes(colour = Sample_Type))


### PERMANOVA ###
pair.sampdf <- data.frame(sample_data(physeq.pair))
beta.tax <- betadisper(d=UF.u, group=pair.sampdf$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.093
adonis(UF.u ~ Sample_Type, data = pair.sampdf, permutations = 9999)
  # p-value = 0.9282
  # R2 = 0.01354


########## Weighted UniFrac ##########
UF.w <- phyloseq::distance(physeq = physeq.pair, method = "wunifrac")
UF.w.pcoa <- ordinate(physeq = physeq.pair, method = "PCoA", distance = "wunifrac")
  # Variation explained = 35.8%

plot_ordination(physeq = physeq.pair, ordination = UF.w.pcoa, axes = c(1,2),
                title = "Weighted UniFrac") +
  geom_point(size = 2, aes(colour = Sample_Type))


### PERMANOVA ###
pair.sampdf <- data.frame(sample_data(physeq.pair))
beta.tax <- betadisper(d=UF.w, group=pair.sampdf$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.297
adonis(UF.w ~ Sample_Type, data = pair.sampdf, permutations = 9999)
  # p-value = 0.9947
  # R2 = 0.0067
```
