---
title: "Code"
author: "Edna Chiang"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(dunn.test)
library(effsize)
library(ggplot2)
library(grid)
library(gridExtra)
library(phyloseq)
library(picante)
library(pwr)
library(tidyr)
library(vegan)

theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('../scripts/simper_pretty.R')
source('../scripts/R_krusk.R')
source('../scripts/misc.R')
```

### Import Data
```{r}
# Link files
shared = "../mothur_output/final.shared"
taxonomy = "../mothur_output/final.taxonomy"
tree = "../mothur_output/final.tre"

# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy,
  mothur_tree_file = tree)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

# Add metadata
meta <- read.csv("../metadata.csv")
rownames(meta) <- meta$Sample
divsum <- read.table("../mothur_output/final.summary", header = T)
meta[,12:21] <- divsum[,3:12]

# Update phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))

# Subset out Captive samples
phy.cap <- subset_samples(physeq, Diet == "Captive")

# Remove OTUs that appear in < 3 samples
#otu <- data.frame(otu_table(phy.cap))
#otu.rem <- list()
#for(i in 1:nrow(otu)){
#  empty <- length(which(otu[i,] == 0))
#    # Identifies # of samples w/o OTU
#  if(empty > 54){
#    # If OTU appears in < 3 samples
#    otu.rem <- append(otu.rem, i)
#      # Create list of OTUs that appear in only 1 sample
#  }
#}
# No OTUs to remove


# Order factors
sample_data(phy.cap)$Season <- ordered(sample_data(phy.cap)$Season,
                                     levels=c("Summer", "Winter", "Spring"))
sample_data(phy.cap)$Metabolism <- ordered(sample_data(phy.cap)$Metabolism,
                                     levels=c("Active", "Torpor", "IBA"))
sample_data(phy.cap)$Group <- ordered(sample_data(phy.cap)$Group,
                                     levels=c("Summer_Captive", "Torpor", "IBA", "Spring"))

# Remove outliers
phy.cap <- subset_samples(phy.cap, ID != 3925)
phy.cap <- subset_samples(phy.cap, ID != 3916)

# Calculate relative abundance
phy.cap <- transform_sample_counts(phy.cap, function(x){(x/sum(x))*100})

# Separate by Sample Type
phy.con <- subset_samples(phy.cap, Sample_Type == "Content")
phy.muc <- subset_samples(phy.cap, Sample_Type == "Mucosa")

# Separate by Season
phy.con.sum <- subset_samples(phy.con, Group == "Summer_Captive")
phy.con.tor <- subset_samples(phy.con, Group == "Torpor")
phy.con.iba <- subset_samples(phy.con, Group == "IBA")
phy.con.spr <- subset_samples(phy.con, Group == "Spring")
phy.muc.sum <- subset_samples(phy.muc, Group == "Summer_Captive")
phy.muc.tor <- subset_samples(phy.muc, Group == "Torpor")
phy.muc.iba <- subset_samples(phy.muc, Group == "IBA")
phy.muc.spr <- subset_samples(phy.muc, Group == "Spring")

```


### Content - Test Phyla Rel Abund
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(phy.con, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

# View ordered phyla - most abundant --> least abundant
# barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)
# 10 phyla: "Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Bacteria_unclassified", "Kiritimatiellaeota", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia"
     


##### FIRMICUTES #####
fir.phy <- subset_taxa(phy99, Phylum == "Firmicutes")
fir.df <- data.frame(sample_data(fir.phy))
fir.df$RelAbund <- t(data.frame(otu_table(fir.phy)))

hist(fir.df$RelAbund, breaks=10)
qqnorm(fir.df$RelAbund)
qqline(fir.df$RelAbund)
shapiro.test(fir.df$RelAbund)
  # p-value = 0.02154
  # adj P = 2.393333e-02
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=fir.df)
  # p-value = 0.0004946
  # adj P = 0.00494600 
dunn.test(x = as.numeric(fir.df$RelAbund), g = as.factor(fir.df$Group), method = "bh", label = T)
  # Summer-Torpor = 0.0012*
  # Summer-IBA = 0.0010*
  # Summer-Spring = 0.2662
  # Torpor-IBA = 0.4686
  # Torpor-Spring = 0.0501
  # IBA-Spring = 0.0521





##### BACTEROIDETES #####
bac.phy <- subset_taxa(phy99, Phylum == "Bacteroidetes")
bac.df <- data.frame(sample_data(bac.phy))
bac.df$RelAbund <- t(data.frame(otu_table(bac.phy)))

hist(bac.df$RelAbund, breaks=10)
qqnorm(bac.df$RelAbund)
qqline(bac.df$RelAbund)
shapiro.test(bac.df$RelAbund)
  # p-value = 0.437
  # adj P = 4.370000e-01
  # Normal
summary(aov(formula = RelAbund ~ Group, data=bac.df))
  # p-value = 0.0044
  # adj P = 0.02200000
TukeyHSD(aov(formula = RelAbund ~ Group, data=bac.df))
  # Summer-Torpor = 0.0062170*
  # Summer-IBA = 0.0165052*
  # Summer-Spring = 0.1274590
  # Torpor-IBA = 0.9425026
  # Torpor-Spring = 0.9131470
  # IBA-Spring = 0.9962508





##### Verrucomicrobia #####
ver.phy <- subset_taxa(phy99, Phylum == "Verrucomicrobia")
ver.df <- data.frame(sample_data(ver.phy))
ver.df$RelAbund <- t(data.frame(otu_table(ver.phy)))

hist(ver.df$RelAbund, breaks=10)
qqnorm(ver.df$RelAbund)
qqline(ver.df$RelAbund)
shapiro.test(ver.df$RelAbund)
  # p-value = 0.0003558
  # adj P = 6.095000e-04
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=ver.df)
  # p-value = 0.04741
  # adj P = 0.11852500





##### PROTEOBACTERIA #####
pro.phy <- subset_taxa(phy99, Phylum == "Proteobacteria")
pro.df <- data.frame(sample_data(pro.phy))
pro.df$RelAbund <- t(data.frame(otu_table(pro.phy)))

hist(pro.df$RelAbund, breaks=10)
qqnorm(pro.df$RelAbund)
qqline(pro.df$RelAbund)
shapiro.test(pro.df$RelAbund)
  # p-value = 0.003036
  # adj P = 3.795000e-03
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=pro.df)
  # p-value = 0.35
  # adj P = 0.43750000





##### KIRITIMATIELLAEOTA #####
# Ki/ri/ti/ma/ti/e/llae/o/ta
kir.phy <- subset_taxa(phy99, Phylum == "Kiritimatiellaeota")
kir.df <- data.frame(sample_data(kir.phy))
kir.df$RelAbund <- t(data.frame(otu_table(kir.phy)))

hist(kir.df$RelAbund, breaks=10)
qqnorm(kir.df$RelAbund)
qqline(kir.df$RelAbund)
shapiro.test(kir.df$RelAbund)
  # p-value = 2.72e-08
  # adj P = 1.370500e-07
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=kir.df)
  # p-value = 0.01657
  # adj P = 0.05523333





##### CYANOBACTERIA #####
cya.phy <- subset_taxa(phy99, Phylum == "Cyanobacteria")
cya.df <- data.frame(sample_data(cya.phy))
cya.df$RelAbund <- t(data.frame(otu_table(cya.phy)))

hist(cya.df$RelAbund, breaks=10)
qqnorm(cya.df$RelAbund)
qqline(cya.df$RelAbund)
shapiro.test(cya.df$RelAbund)
  # p-value = 0.001164
  # adj P = 1.662857e-03
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=cya.df)
  # p-value = 0.1391
  # adj P = 0.27820000





##### TENERICUTES #####
ten.phy <- subset_taxa(phy99, Phylum == "Tenericutes")
ten.df <- data.frame(sample_data(ten.phy))
ten.df$RelAbund <- t(data.frame(otu_table(ten.phy)))

hist(ten.df$RelAbund, breaks=10)
qqnorm(ten.df$RelAbund)
qqline(ten.df$RelAbund)
shapiro.test(ten.df$RelAbund)
  # p-value = 1.929e-05
  # adj P = 4.822500e-05
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=ten.df)
  # p-value = 0.3289
  # adj P = 0.43750000





##### ACTINOBACTERIA #####
act.phy <- subset_taxa(phy99, Phylum == "Actinobacteria")
act.df <- data.frame(sample_data(act.phy))
act.df$RelAbund <- t(data.frame(otu_table(act.phy)))

hist(act.df$RelAbund, breaks=10)
qqnorm(act.df$RelAbund)
qqline(act.df$RelAbund)
shapiro.test(act.df$RelAbund)
  # p-value = 0.0003657
  # adj P = 6.095000e-04
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=act.df)
  # p-value = 0.5082
  # adj P = 0.56466667





##### ELUSIMICROBIA #####
elu.phy <- subset_taxa(phy99, Phylum == "Elusimicrobia")
elu.df <- data.frame(sample_data(elu.phy))
elu.df$RelAbund <- t(data.frame(otu_table(elu.phy)))

hist(elu.df$RelAbund, breaks=10)
qqnorm(elu.df$RelAbund)
qqline(elu.df$RelAbund)
shapiro.test(elu.df$RelAbund)
  # p-value = 2.741e-08
  # adj P = 1.370500e-07 
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=elu.df)
  # p-value = 0.2008
  # adj P = 0.33466667





##### UNCLASSIFIED #####
unc.phy <- subset_taxa(phy99, Phylum == "Bacteria_unclassified")
unc.df <- data.frame(sample_data(unc.phy))
unc.df$RelAbund <- t(data.frame(otu_table(unc.phy)))

hist(unc.df$RelAbund, breaks=10)
qqnorm(unc.df$RelAbund)
qqline(unc.df$RelAbund)
shapiro.test(unc.df$RelAbund)
  # p-value = 6.53e-08
  # adj P = 2.176667e-07
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=unc.df)
  # p-value = 0.64
  # adj P = 0.64000000





### P-adjust for Shapiro
p.adjust(c(0.02154,0.437,0.0003558,0.003036,2.72e-08,0.001164,1.929e-05,0.0003657,2.741e-08,6.53e-08), method = "BH")
  # 2.393333e-02 4.370000e-01 6.095000e-04 3.795000e-03 1.370500e-07 1.662857e-03 4.822500e-05 6.095000e-04 1.370500e-07 2.176667e-07
  # Firmicutes, Bacteroidetes, Verrucomicrobia, Proteobacteria, Kiritimatiellaeota, Cyanobacteria, Tenericutes, Actinobacteria, Elusimicrobia, Unclassified

### P-adjust for Kruskal-Wallis
p.adjust(c(0.0004946,0.0044,0.04741,0.35,0.01657,0.1391,0.3289,0.5082,0.2008,0.64), method = "BH")
  # 0.00494600 0.02200000 0.11852500 0.43750000 0.05523333 0.27820000 0.43750000 0.56466667 0.33466667 0.64000000
  # Firmicutes, Bacteroidetes, Verrucomicrobia, Proteobacteria, Kiritimatiellaeota, Cyanobacteria, Tenericutes, Actinobacteria, Elusimicrobia, Unclassified





### Format data
phy99.df <- psmelt(phy99)
phy99.df$Phylum <- ordered(phy99.df$Phylum, levels = c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Unclassified", "Kiritimatiellaeota", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia", "Epsilonbacteraeota"))
phy99.df$Phylum[which(is.na(phy99.df$Phylum))] <- rep("Unclassified",length(which(is.na(phy99.df$Phylum))))
phy.sum <- phy99.df %>%
  group_by(Group, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance),
            iqr = IQR(Abundance))

```



### Content - Alpha Diversity - Phylogenetic Diversity and SES MPD
```{r}
# Calculate Faith's phylogenetic diversity
pd.res <- pd(t(data.frame(otu_table(phy.con))), phy_tree(phy.con), include.root = T)
pd.df <- data.frame(pd.res)

# Calculate MPD (Mean Pairwise Distance)
pd.dist <- cophenetic(phy_tree(phy.con))
  # Calculate cophenetic distance
ses.mpd.res <- ses.mpd(t(data.frame(otu_table(phy.con))), pd.dist, null.model = "taxa.labels", abundance.weighted = F, runs = 999)
  # Calculate MPD
  # This'll take a while to run-- be patient
mpd <- data.frame(ses.mpd.res)
  # Pull out MDP results


### Prepare data for plotting ###
mpd$SampleID <- row.names(mpd)
pd.res$SampleID <- row.names(pd.res)
  # Make sure all SampleID's match!

# Pull out first Stat of each test
pd.stats <- data.frame(pd.res$SampleID, pd.res$PD)
pd.stats$Measure <- rep("PD", nrow(pd.df))
colnames(pd.stats) <- c("Sample", "Stat", "Measure")
mpd.stats <- data.frame(mpd$SampleID, mpd$mpd.obs.z)
mpd.stats$Measure <- rep("MPD SES", nrow(pd.df))
colnames(mpd.stats) <- c("Sample", "Stat", "Measure")



### Prepare PD ###
pd.ready <- merge(pd.stats, meta, by = "Sample")
pd.ready$Group <- ordered(pd.ready$Group, levels = c("Summer_Captive", "Torpor", "IBA", "Spring"))

### Prepare MPD ###
mpd.ready <- merge(mpd.stats, meta, by = "Sample")
mpd.ready$Group <- ordered(mpd.ready$Group, levels = c("Summer_Captive", "Torpor", "IBA", "Spring"))


        

        
########## TESTING PD & MPD ##########

### PD ###
hist(pd.ready$Stat, breaks=10)
qqnorm(pd.ready$Stat)
qqline(pd.ready$Stat)
shapiro.test(pd.ready$Stat)
  # p-value = 0.9905
  # Normal
summary(aov(Stat ~ Group, data = pd.ready))
  # p-value = 0.0519

 

### MPD ###
hist(mpd.ready$Stat, breaks=10)
qqnorm(mpd.ready$Stat)
qqline(mpd.ready$Stat)
shapiro.test(mpd.ready$Stat)
  # p-value = 0.048
  # adj p = 0.1920
  # Normal
summary(aov(Stat ~ Group, data = mpd.ready))
  # p-value = 1.76e-06
  # adj p = 0.0000068
TukeyHSD(aov(Stat ~ Group, data = mpd.ready))
  # Summer-Torpor = 0.0000057*
  # Summer-IBA = 0.0000093*
  # Summer-Spring = 0.0877749
  # Torpor-IBA = 0.9575807
  # Torpor-Spring = 0.0424799*
  # IBA-Spring = 0.0830843



```

### Content - Alpha Diversity - Shannon & # OTUs
```{r}
adiv <- data.frame(sample_data(phy.con))


########## Shannon ##########
hist(adiv$shannon, breaks=10)
qqnorm(adiv$shannon)
qqline(adiv$shannon)
shapiro.test(adiv$shannon)
  # p-value = 0.6322
  # adj p = 0.9905
  # Normal
summary(aov(shannon ~ Group, data = adiv))
  # p-value = 0.793
  # adj p = 0.793





########## Number of Unique OTUs ##########
otus <- data.frame(otu_table(phy.con))
sampNames <- colnames(otus)
uniq.otus <- data.frame(matrix(nrow = nsamples(phy.con), ncol = 2))
colnames(uniq.otus) <- c("Sample", "Unique_OTUs")
for(n in 1:nsamples(phy.con)) {
  COL <- otus[,n]
  numUniq <- length(which(COL > 0))
  uniq.otus$Sample[n] <- sampNames[n]
  uniq.otus$Unique_OTUs[n] <- numUniq
}
uniq.otus$Group <- sample_data(phy.con)$Group
rownames(uniq.otus) <- uniq.otus$Sample


hist(uniq.otus$Unique_OTUs, breaks=10)
qqnorm(uniq.otus$Unique_OTUs)
qqline(uniq.otus$Unique_OTUs)
shapiro.test(uniq.otus$Unique_OTUs)
  # p-value =  0.775
  # adj p = 0.9905
  # Normal

summary(aov(Unique_OTUs ~ Group, data = uniq.otus))
  # p-value = 0.00847
  # adj p = 0.016940
TukeyHSD(aov(Unique_OTUs ~ Group, data = uniq.otus))
  # Summer-Torpor = 0.0104213*
  # Summer-IBA = 0.0255349*
  # Summer-Spring = 0.4195955
  # Torpor-IBA = 0.9522292
  # Torpor-Spring = 0.6357198
  # IBA-Spring = 0.8518157




### P-adjust Shapiro ###
p.adjust(c(0.9905,0.048,0.6322,0.775), method = "BH")
  # 0.9905 0.1920 0.9905 0.9905
  # Unique OTUs, PD, MPD, Shannon



### P-adjust ANOVA ###
p.adjust(c(0.0519,1.7e-06,0.793,0.00847), method = "BH")
  # 0.069200 0.0000068 0.793000 0.016940
  # Unique OTUs, PD, MPD, Shannon

```

### Content - Alpha Diversity Prepare Plots
```{r}
##### Unique # of OTUs #####
uniq.otus.sum <- uniq.otus %>%
  group_by(Group) %>%
  summarize(Mean = mean(Unique_OTUs),
            SE = se(Unique_OTUs),
            SD = sd(Unique_OTUs),
            Median = median(Unique_OTUs))
uniq.otus.sum$YMAX <- uniq.otus.sum$Mean + uniq.otus.sum$SE
uniq.otus.sum$YMIN <- uniq.otus.sum$Mean - uniq.otus.sum$SE

otu.ann <- data.frame(lab = c("a", "b", "b", "ab"), Group = factor(c("Summer_Captive", "Torpor", "IBA", "Spring")))

otu.plot <- ggplot(uniq.otus, aes(x = Group, y = Unique_OTUs, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(240,830), breaks = c(240,354,468,582,696,810)) +
  scale_x_discrete(labels = c("Summer", "Torpor", "IBA", "Spring")) +
  ylab("Number of Observed OTUs") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 8, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 20, hjust = 0.5, vjust = 1.1),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = otu.ann, aes(label=lab), x=c(1,2,3,4),
            y=c(835,835,835,835), size=2.5, color="black")





##### Faith's Phylogenetic Diversity #####
### Prepare PD ###
pd.sum <- pd.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
pd.sum$YMAX <- pd.sum$Mean + pd.sum$SE
pd.sum$YMIN <- pd.sum$Mean - pd.sum$SE

pd.ann <- data.frame(lab = c("ns", " ", " ", " "), Group = factor(c("Summer_Captive", "Torpor", "IBA", "Spring")))

pd.plot <- ggplot(pd.ready, aes(x = Group, y = Stat, fill = Group)) +
  geom_violin() + 
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(14,39), breaks = c(14,19,24,29,34,39)) +
  scale_x_discrete(labels = c("Summer", "Torpor", "IBA", "Spring")) +
  ylab("Faith's Phylogenetic Diversity") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 8, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 20, hjust = 0.5, vjust = 1.1),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = pd.ann, aes(label=lab), x=c(2.5,0,0,0),
            y=c(39.5,0,0,0), size=2.5, color="black")





##### MPD #####
### Prepare MPD ###
mpd.sum <- mpd.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
mpd.sum$YMAX <- mpd.sum$Mean + mpd.sum$SE
mpd.sum$YMIN <- mpd.sum$Mean - mpd.sum$SE

mpd.ann <- data.frame(lab = c("a", "b", "bc", "ac"), Group = factor(c("Summer_Captive", "Torpor", "IBA", "Spring")))

mpd.plot <- ggplot(mpd.ready, aes(x = Group, y = Stat, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(-8.6,6.1), breaks = c(-8.6,-1.6,5.4)) +
  scale_x_discrete(labels = c("Summer", "Torpor", "IBA", "Spring")) +
  ylab("Phylogenetic Evenness (MPD)") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 8, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 20, hjust = 0.5, vjust = 1.1),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = mpd.ann, aes(label=lab), x=c(1,2,3,4),
            y=c(6.2,6.2,6.2,6.2), size=2.5, color="black")
  



##### Shannon #####
### Prepare data for plot
shannon.sum <- adiv %>%
  group_by(Group) %>%
  summarize(Mean = mean(shannon),
            SE = se(shannon),
            SD = sd(shannon),
            Median = median(shannon))
shannon.sum$YMAX <- shannon.sum$Mean + shannon.sum$SE
shannon.sum$YMIN <- shannon.sum$Mean - shannon.sum$SE

shannon.ann <- data.frame(lab = c("ns", " ", " ", " "), Group = factor(c("Summer_Captive", "Torpor", "IBA", "Spring")))

shannon.plot <- ggplot(adiv, aes(x = Group, y = shannon, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(2.3,5.5), breaks = c(2.3,3.1,3.9,4.7,5.5)) +
  scale_x_discrete(labels = c("Summer", "Torpor", "IBA", "Spring")) +
  ylab("Shannon's Diversity Index") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        legend.title = element_text(face="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 8, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 20, hjust = 0.5, vjust = 1.1),
        axis.text.y = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.height = unit(3, 'mm'),
        legend.key.width = unit(3, "mm"),
        legend.box.margin=margin(-10,-10,-10,-10)) +
  geom_text(data = shannon.ann, aes(label=lab), x=c(2.5,0,0,0),
            y=c(5.55,0,0,0), size=2.5, color="black")

```

### Content Plot - Alpha Diversity
```{r}
#png("Content/Fig4.CaptiveSeasons.con.adiv.png", width = 170, height = 60, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,4, widths = c(1, 1, 1, 1.4), heights = c(0.07, 1.5))))
grid.text("A", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=8,fontface="bold"))
print(otu.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
grid.text("B", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2),
          gp=gpar(fontsize=8,fontface="bold"))
print(pd.plot, vp=viewport(layout.pos.row=2, layout.pos.col=2))
grid.text("C", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=3),
          gp=gpar(fontsize=8,fontface="bold"))
print(mpd.plot, vp=viewport(layout.pos.row=2, layout.pos.col=3))
grid.text("D", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=4),
          gp=gpar(fontsize=8,fontface="bold"))
print(shannon.plot, vp=viewport(layout.pos.row=2, layout.pos.col=4))
#dev.off()
```

### Content - Beta Diversity
```{r}
########## Weighted UniFrac ##########
UF.w <- phyloseq::distance(physeq = phy.con, method = "wunifrac")
UF.w.pcoa <- ordinate(physeq = phy.con, method = "PCoA", distance = "wunifrac")

wUF.plot <- plot_ordination(physeq = phy.con, ordination = UF.w.pcoa, axes = c(1,2),
                title = "Weighted UniFrac", color = "Group") +
  scale_colour_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  geom_point(size=2, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "none"
        )


sampdf <- data.frame(sample_data(phy.con))
beta.tax <- betadisper(d=UF.w, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.634
adonis(UF.w ~ Group, data=sampdf, permutations = 9999)
  # p-value = 1e-04


# Separate by season
phy.sum <- subset_samples(phy.con, Group == "Summer_Captive")
phy.tor <- subset_samples(phy.con, Group == "Torpor")
phy.iba <- subset_samples(phy.con, Group == "IBA")
phy.spr <- subset_samples(phy.con, Group == "Spring")

# Separate out pairwise comparisons
phy.st <- merge_phyloseq(phy.sum, phy.tor)
phy.si <- merge_phyloseq(phy.sum, phy.iba)
phy.sp <- merge_phyloseq(phy.sum, phy.spr)
phy.ti <- merge_phyloseq(phy.tor, phy.iba)
phy.tp <- merge_phyloseq(phy.tor, phy.spr)
phy.ip <- merge_phyloseq(phy.iba, phy.spr)


# Summer vs Torpor
st.w <- phyloseq::distance(physeq = phy.st, method = "wunifrac")
sampdf.st<- data.frame(sample_data(phy.st))
beta.tax <- betadisper(d=st.w, group=sampdf.st$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.798
  # adj P = 0.798
adonis(st.w ~ Group, data=sampdf.st, permutations = 9999)
  # p-value = 6e-04
  # adj p = 0.00240


# Summer vs IBA
si.w <- phyloseq::distance(physeq = phy.si, method = "wunifrac")
sampdf.si<- data.frame(sample_data(phy.si))
beta.tax <- betadisper(d=si.w, group=sampdf.si$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.295
  # adj p = 0.798
adonis(si.w ~ Group, data=sampdf.si, permutations = 9999)
  # p-value = 8e-04
  # adj p = 0.00240


# Summer vs Spring
sp.w <- phyloseq::distance(physeq = phy.sp, method = "wunifrac")
sampdf.sp<- data.frame(sample_data(phy.sp))
beta.tax <- betadisper(d=sp.w, group=sampdf.sp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.208
  # adj p = 0.798
adonis(sp.w ~ Group, data=sampdf.sp, permutations = 9999)
  # p-value = 0.0541
  # adj p = 0.06492


# Torpor vs IBA
ti.w <- phyloseq::distance(physeq = phy.ti, method = "wunifrac")
sampdf.ti<- data.frame(sample_data(phy.ti))
beta.tax <- betadisper(d=ti.w, group=sampdf.ti$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.576
  # adj p = 0.798
adonis(ti.w ~ Group, data=sampdf.ti, permutations = 9999)
  # p-value = 0.9068
  # adj p = 0.90680


# Torpor vs Spring
tp.w <- phyloseq::distance(physeq = phy.tp, method = "wunifrac")
sampdf.tp<- data.frame(sample_data(phy.tp))
beta.tax <- betadisper(d=tp.w, group=sampdf.tp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.488
  # adj p = 0.798
adonis(tp.w ~ Group, data=sampdf.tp, permutations = 9999)
  # p-value = 0.0113
  # adj p = 0.01695


# IBA vs Spring
ip.w <- phyloseq::distance(physeq = phy.ip, method = "wunifrac")
sampdf.ip<- data.frame(sample_data(phy.ip))
beta.tax <- betadisper(d=ip.w, group=sampdf.ip$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.682
  # adj p = 0.798
adonis(ip.w ~ Group, data=sampdf.ip, permutations = 9999)
  # p-value = 0.0103
  # adj p = 0.01695


# Adjust betadisper p-values
p.adjust(c(0.798,0.295,0.208,0.576,0.488,0.682), method = "BH")
  # Summer-Torpor = 0.798
  # Summer-IBA = 0.798
  # Summer-Spring = 0.798
  # Torpor-IBA = 0.798
  # Torpor-Spring = 0.798
  # IBA-Spring = 0.798

# Adjust PERMANOVA p-values
p.adjust(c(6e-04,8e-04,0.0541,0.9068,0.0113,0.0103), method = "BH")
  # Summer-Torpor = 0.00240
  # Summer-IBA = 0.00240
  # Summer-Spring = 0.06492
  # Torpor-IBA = 0.90680
  # Torpor-Spring = 0.01695
  # IBA-Spring = 0.01695





########## Unweighted UniFrac ##########
UF.u <- phyloseq::distance(physeq = phy.con, method = "unifrac")
UF.u.pcoa <- ordinate(physeq = phy.con, method = "PCoA", distance = "unifrac")

uUF.plot <- plot_ordination(physeq = phy.con, ordination = UF.u.pcoa, axes = c(1,2),
                title = "Unweighted UniFrac", color = "Group") +
  scale_colour_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  geom_point(size=2, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position  = "none"
        )


sampdf <- data.frame(sample_data(phy.con))
beta.tax <- betadisper(d=UF.u, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.174
adonis(UF.u ~ Group, data=sampdf, permutations = 9999)
  # p-value = 3e-04


# Summer vs Torpor
st.u <- phyloseq::distance(physeq = phy.st, method = "unifrac")
sampdf.st<- data.frame(sample_data(phy.st))
beta.tax <- betadisper(d=st.u, group=sampdf.st$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.48
  # adj p = 0.594
adonis(st.u ~ Group, data=sampdf.st, permutations = 9999)
  # p-value = 7e-04
  # adj p = 0.00210


# Summer vs IBA
si.u <- phyloseq::distance(physeq = phy.si, method = "unifrac")
sampdf.si<- data.frame(sample_data(phy.si))
beta.tax <- betadisper(d=si.u, group=sampdf.si$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.495
  # adj p = 0.594
adonis(si.u ~ Group, data=sampdf.si, permutations = 9999)
  # p-value = 1e-04
  # adj p = 0.00060


# Summer vs Spring
sp.u <- phyloseq::distance(physeq = phy.sp, method = "unifrac")
sampdf.sp<- data.frame(sample_data(phy.sp))
beta.tax <- betadisper(d=sp.u, group=sampdf.sp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.019
  # adj p = 0.081
adonis(sp.u ~ Group, data=sampdf.sp, permutations = 9999)
  # p-value = 0.193
  # adj p = 0.23160


# Torpor vs IBA
ti.u <- phyloseq::distance(physeq = phy.ti, method = "unifrac")
sampdf.ti<- data.frame(sample_data(phy.ti))
beta.tax <- betadisper(d=ti.u, group=sampdf.ti$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.942
  # adj p = 0.942
adonis(ti.u ~ Group, data=sampdf.ti, permutations = 9999)
  # p-value = 0.605
  # adj p = 0.605000


# Torpor vs Spring
tp.u <- phyloseq::distance(physeq = phy.tp, method = "unifrac")
sampdf.tp<- data.frame(sample_data(phy.tp))
beta.tax <- betadisper(d=tp.u, group=sampdf.tp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.027
  # adj p = 0.081
adonis(tp.u ~ Group, data=sampdf.tp, permutations = 9999)
  # p-value = 0.0253
  # adj p = 0.03795


# IBA vs Spring
ip.u <- phyloseq::distance(physeq = phy.ip, method = "unifrac")
sampdf.ip<- data.frame(sample_data(phy.ip))
beta.tax <- betadisper(d=ip.u, group=sampdf.ip$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.18
  # adj p = 0.360
adonis(ip.u ~ Group, data=sampdf.ip, permutations = 9999)
  # p-value = 0.0239
  # adj p = 0.03795


# Adjust betadisper p-values
p.adjust(c(0.48,0.495,0.019,0.942,0.027,0.18), method = "BH")
  # Summer-Torpor = 0.594
  # Summer-IBA = 0.594
  # Summer-Spring = 0.081
  # Torpor-IBA = 0.942
  # Torpor-Spring = 0.081
  # IBA-Spring = 0.360

# Adjust PERMANOVA p-values
p.adjust(c(7e-04,1e-04,0.193,0.605,0.0253,0.0239), method = "BH")
  # Summer-Torpor = 0.00210*
  # Summer-IBA = 0.00060*
  # Summer-Spring = 0.23160
  # Torpor-IBA = 0.60500
  # Torpor-Spring = 0.03795*
  # IBA-Spring = 0.03795*





########## Bray-Curtis ##########
bray.pcoa <- ordinate(physeq=phy.con, method="PCoA", distance="bray")

bc.plot <- plot_ordination(physeq=phy.con, ordination=bray.pcoa, color="Group",
                           title = "Bray-Curtis Dissimilarity") +
  scale_colour_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  geom_point(size=2, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "none"
        #legend.title = element_text(size = 8, face = "bold"),
        #legend.text = element_text(size = 8),
        #legend.key.height = unit(4, 'mm'),
        #legend.box.margin=margin(-10,-10,-10,-10)
        )

ord.legend <- g_legend(bc.plot)


sampdf <- data.frame(sample_data(phy.con))
bray <- phyloseq::distance(physeq = phy.con, method = "bray")
beta.tax <- betadisper(d = bray, group = sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.36
adonis(bray ~ Group, data=sampdf, permutations = 9999)
  # p-value = 2e-04


### Summer vs. Torpor ###
sampdf.st <- data.frame(sample_data(phy.st))
bray.st <- phyloseq::distance(physeq = phy.st, method = "bray")
beta.tax <- betadisper(d = bray.st, group = sampdf.st$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.4
  # adj p = 0.600
adonis(bray.st ~ Group, data=sampdf.st, permutations = 9999)
  # p-value = 8e-04
  # adj p = 0.00240


### Summer vs. IBA ###
sampdf.si <- data.frame(sample_data(phy.si))
bray.si <- phyloseq::distance(physeq = phy.si, method = "bray")
beta.tax <- betadisper(d = bray.si, group = sampdf.si$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.25
  # adj p = 0.500
adonis(bray.si ~ Group, data=sampdf.si, permutations = 9999)
  # p-value = 4e-04
  # adj p = 0.00240


### Summer vs. Spring ###
sampdf.sp <- data.frame(sample_data(phy.sp))
bray.sp <- phyloseq::distance(physeq = phy.sp, method = "bray")
beta.tax <- betadisper(d = bray.sp, group = sampdf.sp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.059
  # adj p = 0.354
adonis(bray.sp ~ Group, data=sampdf.sp, permutations = 9999)
  # p-value = 0.1099
  # adj p = 0.13188


### Torpor vs. IBA ###
sampdf.ti <- data.frame(sample_data(phy.ti))
bray.ti <- phyloseq::distance(physeq = phy.ti, method = "bray")
beta.tax <- betadisper(d = bray.ti, group = sampdf.ti$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.627
  # adj p = 0.627
adonis(bray.ti ~ Group, data=sampdf.ti, permutations = 9999)
  # p-value = 0.7277
  # adj p = 0.72770


### Torpor vs. Spring ###
sampdf.tp <- data.frame(sample_data(phy.tp))
bray.tp <- phyloseq::distance(physeq = phy.tp, method = "bray")
beta.tax <- betadisper(d = bray.tp, group = sampdf.tp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.234
  # adj p = 0.500
adonis(bray.tp ~ Group, data=sampdf.tp, permutations = 9999)
  # p-value = 0.0122
  # adj p = 0.02440


### IBA vs. Spring ###
sampdf.ip <- data.frame(sample_data(phy.ip))
bray.ip <- phyloseq::distance(physeq = phy.ip, method = "bray")
beta.tax <- betadisper(d = bray.ip, group = sampdf.ip$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.6
  # adj p = 0.627
adonis(bray.ip ~ Group, data=sampdf.ip, permutations = 9999)
  # p-value = 0.0194
  # adj p = 0.02910



### Adjust betadisper p-values
p.adjust(c(0.4,0.25,0.059,0.627,0.234,0.6), method = "BH")
  # Summer-Torpor = 0.600
  # Summer-IBA = 0.500
  # Summer-Spring = 0.354
  # Torpor-IBA = 0.627
  # Torpor-Spring = 0.500
  # IBA-Spring = 0.627



### Adjust PERMANOVA p-values
p.adjust(c(8e-04,4e-04,0.1099,0.7277,0.0122,0.0194), method = "BH")
  # Summer-Torpor = 0.00240*
  # Summer-IBA = 0.00240*
  # Summer-Spring = 0.13188
  # Torpor-IBA = 0.72770
  # Torpor-Spring = 0.02440*
  # IBA-Spring = 0.02910*

```


### Content Plot - Beta diversity
```{r}
#png("Content/Fig5.CaptiveSeasons.con.bdiv.png", width = 85, height = 180, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(3,2, widths = c(1, 0.45), heights = c(1, 1, 1))))

print(wUF.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(uUF.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
print(bc.plot, vp=viewport(layout.pos.row=3, layout.pos.col=1))


ord.legend$vp <- viewport(layout.pos.row = 1:3, layout.pos.col = 2)
grid.draw(ord.legend)


grid.text("A", x=unit(0.05, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1,
                                                                  layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))
grid.text("B", x=unit(0.05, "npc"),  y=unit(0.95, "npc"), vp=viewport(layout.pos.row=2,
                                                                   layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))
grid.text("C", x=unit(0.05, "npc"),  y=unit(0.95, "npc"), vp=viewport(layout.pos.row=3,
                                                                   layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))

#dev.off()
```

### Content - SIMPER
```{r}
# Change Group names to be compatible (no "_")
con.rename <- data.frame(sample_data(phy.con))
con.rename$GroupRename <- rep(NA, nrow(con.rename))
con.rename$GroupRename[which(con.rename$Group == "Summer_Captive")] <- "Summer"
con.rename$GroupRename[which(con.rename$Group == "Torpor")] <- "Torpor"
con.rename$GroupRename[which(con.rename$Group == "IBA")] <- "IBA"
con.rename$GroupRename[which(con.rename$Group == "Spring")] <- "Spring"
con.rename$GroupRename <- ordered(con.rename$GroupRename, levels = c("Summer", "Torpor", "IBA", "Spring"))
phy.con.simp <- merge_phyloseq(otu_table(phy.con), sample_data(con.rename), tax_table(phy.con))


# Group
#simper.pretty(data.frame(otu_table(phy.con.simp)),
              data.frame(sample_data(phy.con.simp)),
              c("GroupRename"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='Content/CaptiveSeasons.con')
#group.simper <- read.csv("Content/CaptiveSeasons.con_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(phy.con.simp)),
               data.frame(sample_data(phy.con.simp)),
               csv = group.simper,
               c("GroupRename"),
               output_name = 'Content/CaptiveSeasons.con',
               taxonomy = data.frame(tax_table(phy.con.simp)))
#group.simper.kw <- read.csv("Content/CaptiveSeasons.con_krusk_simper.csv")
for(i in 1:nrow(group.simper.kw)){
  save <- which(rownames(data.frame(tax_table(phy.con.simp))) == group.simper.kw$OTU[i])
  group.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(phy.con.simp))[save,2], "-",
          data.frame(tax_table(phy.con.simp))[save,3], "-",
          data.frame(tax_table(phy.con.simp))[save,4], "-",
          data.frame(tax_table(phy.con.simp))[save,5], "-",
          data.frame(tax_table(phy.con.simp))[save,6])
}
#write.table(group.simper.kw, "Content/CaptiveSeasons.con_krusk_simper.csv", sep=",")
#group.simper.kw <- read.csv("Content/CaptiveSeasons.con_krusk_simper.csv", row.names = 1)
```

### Content - Core OTUs and Shared OTUs
```{r}
### Drop empty taxa
phy.con.sum.trim <- prune_taxa(taxa_sums(phy.con.sum) > 0, phy.con.sum)
  # 2327 OTUs
phy.con.tor.trim <- prune_taxa(taxa_sums(phy.con.tor) > 0, phy.con.tor)
  # 1237 OTUs
phy.con.iba.trim <- prune_taxa(taxa_sums(phy.con.iba) > 0, phy.con.iba)
  # 1444 OTUs
phy.con.spr.trim <- prune_taxa(taxa_sums(phy.con.spr) > 0, phy.con.spr)
  # 951 OTUs



### Identify Core OTUs
sum.con.otu <- data.frame(otu_table(phy.con.sum))
sum.con.core <- apply(sum.con.otu, 1, function(row) all(row != 0))
sum.con.core <- sum.con.otu[sum.con.core,]
phy.con.sum.core <- merge_phyloseq(otu_table(sum.con.core, taxa_are_rows = T), tax_table(phy.con.sum), sample_data(phy.con.sum))
  # 37 OTUs
tor.con.otu <- data.frame(otu_table(phy.con.tor))
tor.con.core <- apply(tor.con.otu, 1, function(row) all(row != 0))
tor.con.core <- tor.con.otu[tor.con.core,]
phy.con.tor.core <- merge_phyloseq(otu_table(tor.con.core, taxa_are_rows = T), tax_table(phy.con.tor), sample_data(phy.con.tor))
  # 57 OTUs
iba.con.otu <- data.frame(otu_table(phy.con.iba))
iba.con.core <- apply(iba.con.otu, 1, function(row) all(row != 0))
iba.con.core <- iba.con.otu[iba.con.core,]
phy.con.iba.core <- merge_phyloseq(otu_table(iba.con.core, taxa_are_rows = T), tax_table(phy.con.iba), sample_data(phy.con.iba))
  # 54 OTUs
spr.con.otu <- data.frame(otu_table(phy.con.spr))
spr.con.core <- apply(spr.con.otu, 1, function(row) all(row != 0))
spr.con.core <- spr.con.otu[spr.con.core,]
phy.con.spr.core <- merge_phyloseq(otu_table(spr.con.core, taxa_are_rows = T), tax_table(phy.con.spr), sample_data(phy.con.spr))
  # 132 OTUs



### Compare Core OTUs
intersect(rownames(sum.con.core), rownames(tor.con.core))
  # 21 shared core OTUs
  # "Otu00072" "Otu00159" "Otu00026" "Otu00154" "Otu00278" "Otu00197" "Otu00120" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00067" "Otu00040" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00041" "Otu00138" "Otu00137" "Otu00065"
intersect(rownames(sum.con.core), rownames(iba.con.core))
  # 25 shared core OTUs
  # "Otu00072" "Otu00026" "Otu00053" "Otu00154" "Otu00175" "Otu00278" "Otu00197" "Otu00120" "Otu00359" "Otu00267" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00067" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00136" "Otu00041" "Otu00138" "Otu00137" "Otu00090" "Otu00065"
intersect(rownames(sum.con.core), rownames(spr.con.core))
  # 26 shared core OTUs
  # "Otu00159" "Otu00044" "Otu00026" "Otu00053" "Otu00154" "Otu00175" "Otu00197" "Otu00199" "Otu00229" "Otu00267" "Otu00236" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00067" "Otu00040" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00041" "Otu00407" "Otu00138" "Otu00137" "Otu00090"
intersect(rownames(tor.con.core), rownames(iba.con.core))
  # 32 shared core OTUs
  # "Otu00051" "Otu00072" "Otu00433" "Otu00241" "Otu00078" "Otu00026" "Otu00154" "Otu00278" "Otu00197" "Otu00120" "Otu00150" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00067" "Otu00004" "Otu00143" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00094" "Otu00109" "Otu00041" "Otu00138" "Otu00137" "Otu00007" "Otu00086" "Otu00112" "Otu00058" "Otu00065"
intersect(rownames(tor.con.core), rownames(spr.con.core))
  # 40 shared core OTUs
  # "Otu00051" "Otu00159" "Otu00078" "Otu00026" "Otu00018" "Otu00016" "Otu00177" "Otu00154" "Otu"Otu00051" "Otu00433" "Otu00159" "Otu00241" "Otu00078" "Otu00026" "Otu00013" "Otu00018" "Otu00016" "Otu00177" "Otu00154" "Otu00197" "Otu00150" "Otu00161" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00067" "Otu00038" "Otu00009" "Otu00265" "Otu00223" "Otu00110" "Otu00045" "Otu00040" "Otu00075" "Otu00143" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00205" "Otu00094" "Otu00109" "Otu00041" "Otu00138" "Otu00137" "Otu00112" "Otu00058"
intersect(rownames(iba.con.core), rownames(spr.con.core))
  # 33 shared core OTUs
  # "Otu00170" "Otu00051" "Otu00433" "Otu00241" "Otu00078" "Otu00026" "Otu00053" "Otu00154" "Otu00175" "Otu00197" "Otu00267" "Otu00184" "Otu00150" "Otu00232" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00216" "Otu00067" "Otu00143" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00094" "Otu00109" "Otu00041" "Otu00138" "Otu00137" "Otu00090" "Otu00112" "Otu00058"



### Find core of core OTUs (in every single sample)
core1 <- intersect(rownames(sum.con.core), rownames(tor.con.core))
core2 <- intersect(core1, rownames(iba.con.core))
core3 <- intersect(core2, rownames(spr.con.core))
# 15 CORE core content OTUs
# "Otu00026" "Otu00154" "Otu00197" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00067" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00041" "Otu00138" "Otu00137"



### Physeq object with only core OTUs
phy.con.core <- merge_phyloseq(phy.con.sum.core, phy.con.tor.core, phy.con.iba.core, phy.con.spr.core)
#write.csv(data.frame(tax_table(phy.con.core)), "Content/TableS8.CaptiveSeasons_con_coreOTUs.csv")
```













### EVERYTHING BELOW IS MUCOSAAAAA



### Mucosa - Test Phyla Rel Abund
```{r}
# Merge samples with the same taxonomic rank
goodphy.muc <- tax_glom(phy.muc, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99.muc <- transform_sample_counts(goodphy.muc, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99.muc <- prune_taxa(taxa_sums(phy99.muc) > 1, phy99.muc)

# View ordered phyla - most abundant --> least abundant
# barplot(sort(taxa_sums(phy99.muc),TRUE)[1:20]/nsamples(phy99.muc),las=2,cex.axis=.7)
# 11 phyla: "Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Kiritimatiellaeota", "Bacteria_unclassified", "Cyanobacteria", "Tenericutes", "Elusimicrobia", "Actinobacteria","Epsilonbacteraeota"
     


##### FIRMICUTES #####
fir.muc.phy <- subset_taxa(phy99.muc, Phylum == "Firmicutes")
fir.muc.df <- data.frame(sample_data(fir.muc.phy))
fir.muc.df$RelAbund <- t(data.frame(otu_table(fir.muc.phy)))

hist(fir.muc.df$RelAbund, breaks=10)
qqnorm(fir.muc.df$RelAbund)
qqline(fir.muc.df$RelAbund)
shapiro.test(fir.muc.df$RelAbund)
  # p-value = 0.3238
  # adj p = 0.3238000000
  # Normal
summary(aov(formula = RelAbund ~ Group, data=fir.muc.df))
  # p-value = 8.41e-06
  # adj P = 0.00009251
TukeyHSD(aov(formula = RelAbund ~ Group, data=fir.muc.df))
  # Summer-Torpor = 0.0000488*
  # Summer-IBA = 0.0000175*
  # Summer-Spring = 0.1050824
  # Torpor-IBA = 0.9999155
  # Torpor-Spring = 0.0781171
  # IBA-Spring = 0.0644690





##### BACTEROIDETES #####
bac.muc.phy <- subset_taxa(phy99.muc, Phylum == "Bacteroidetes")
bac.muc.df <- data.frame(sample_data(bac.muc.phy))
bac.muc.df$RelAbund <- t(data.frame(otu_table(bac.muc.phy)))

hist(bac.muc.df$RelAbund, breaks=10)
qqnorm(bac.muc.df$RelAbund)
qqline(bac.muc.df$RelAbund)
shapiro.test(bac.muc.df$RelAbund)
  # p-value = 0.2837
  # adj p = 0.3120700000
  # Normal
summary(aov(formula = RelAbund ~ Group, data=bac.muc.df))
  # p-value = 0.162
  # adj p = 0.25457143





##### Verrucomicrobia #####
ver.muc.phy <- subset_taxa(phy99.muc, Phylum == "Verrucomicrobia")
ver.muc.df <- data.frame(sample_data(ver.muc.phy))
ver.muc.df$RelAbund <- t(data.frame(otu_table(ver.muc.phy)))

hist(ver.muc.df$RelAbund, breaks=10)
qqnorm(ver.muc.df$RelAbund)
qqline(ver.muc.df$RelAbund)
shapiro.test(ver.muc.df$RelAbund)
  # p-value = 0.0001722
  # adj p = 0.0003157000
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=ver.muc.df)
  # p-value = 0.05591
  # adj p = 0.20500333





##### PROTEOBACTERIA #####
pro.muc.phy <- subset_taxa(phy99.muc, Phylum == "Proteobacteria")
pro.muc.df <- data.frame(sample_data(pro.muc.phy))
pro.muc.df$RelAbund <- t(data.frame(otu_table(pro.muc.phy)))

hist(pro.muc.df$RelAbund, breaks=10)
qqnorm(pro.muc.df$RelAbund)
qqline(pro.muc.df$RelAbund)
shapiro.test(pro.muc.df$RelAbund)
  # p-value = 0.2079
  # adj p = 0.2541000000
  # Normal
summary(aov(formula = RelAbund ~ Group, data=pro.muc.df))
  # p-value = 0.0287
  # adj p = 0.15785000





##### KIRITIMATIELLAEOTA #####
# Ki/ri/ti/ma/ti/e/llae/o/ta
kir.muc.phy <- subset_taxa(phy99.muc, Phylum == "Kiritimatiellaeota")
kir.muc.df <- data.frame(sample_data(kir.muc.phy))
kir.muc.df$RelAbund <- t(data.frame(otu_table(kir.muc.phy)))

hist(kir.muc.df$RelAbund, breaks=10)
qqnorm(kir.muc.df$RelAbund)
qqline(kir.muc.df$RelAbund)
shapiro.test(kir.muc.df$RelAbund)
  # p-value = 1.863e-07
  # adj p = 0.0000006831
  # Not Normal
summary(aov(formula = RelAbund ~ Group, data=kir.muc.df))
  # p-value = 0.148
  # adj p = 0.25457143





##### CYANOBACTERIA #####
cya.muc.phy <- subset_taxa(phy99.muc, Phylum == "Cyanobacteria")
cya.muc.df <- data.frame(sample_data(cya.muc.phy))
cya.muc.df$RelAbund <- t(data.frame(otu_table(cya.muc.phy)))

hist(cya.muc.df$RelAbund, breaks=10)
qqnorm(cya.muc.df$RelAbund)
qqline(cya.muc.df$RelAbund)
shapiro.test(cya.muc.df$RelAbund)
  # p-value = 0.04871
  # adj p = 0.0765442857
  # Normal
summary(aov(formula = RelAbund ~ Group, data=kir.muc.df))
  # p-value = 0.148
  # adj p = 0.25457143 





##### TENERICUTES #####
ten.muc.phy <- subset_taxa(phy99.muc, Phylum == "Tenericutes")
ten.muc.df <- data.frame(sample_data(ten.muc.phy))
ten.muc.df$RelAbund <- t(data.frame(otu_table(ten.muc.phy)))

hist(ten.muc.df$RelAbund, breaks=10)
qqnorm(ten.muc.df$RelAbund)
qqline(ten.muc.df$RelAbund)
shapiro.test(ten.muc.df$RelAbund)
  # p-value = 4.415e-05
  # adj P = 0.0000971300 
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=ten.muc.df)
  # p-value = 0.1474
  # adj p = 0.25457143





##### ELUSIMICROBIA #####
elu.muc.phy <- subset_taxa(phy99.muc, Phylum == "Elusimicrobia")
elu.muc.df <- data.frame(sample_data(elu.muc.phy))
elu.muc.df$RelAbund <- t(data.frame(otu_table(elu.muc.phy)))

hist(elu.muc.df$RelAbund, breaks=10)
qqnorm(elu.muc.df$RelAbund)
qqline(elu.muc.df$RelAbund)
shapiro.test(elu.muc.df$RelAbund)
  # p-value = 1.382e-07
  # adj p = 0.0000006831
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=elu.muc.df)
  # p-value = 0.2135
  # adj p = 0.29356250 





##### ACTINOBACTERIA #####
act.muc.phy <- subset_taxa(phy99.muc, Phylum == "Actinobacteria")
act.muc.df <- data.frame(sample_data(act.muc.phy))
act.muc.df$RelAbund <- t(data.frame(otu_table(act.muc.phy)))

hist(act.muc.df$RelAbund, breaks=10)
qqnorm(act.muc.df$RelAbund)
qqline(act.muc.df$RelAbund)
shapiro.test(act.muc.df$RelAbund)
  # p-value = 0.1113
  # adj p = 0.1530375000
  # Normal
summary(aov(formula = RelAbund ~ Group, data=act.muc.df))
  # p-value = 0.421
  # adj P = 0.46310000





##### EPSILONBACTERAEOTA #####
eps.muc.phy <- subset_taxa(phy99.muc, Phylum == "Epsilonbacteraeota")
eps.muc.df <- data.frame(sample_data(eps.muc.phy))
eps.muc.df$RelAbund <- t(data.frame(otu_table(eps.muc.phy)))

hist(eps.muc.df$RelAbund, breaks=10)
qqnorm(eps.muc.df$RelAbund)
qqline(eps.muc.df$RelAbund)
shapiro.test(eps.muc.df$RelAbund)
  # p-value = 1.062e-07
  # adj p = 0.0000006831
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=eps.muc.df)
  # p-value = 0.5395
  # adj P = 0.53950000





##### UNCLASSIFIED #####
unc.muc.phy <- subset_taxa(phy99.muc, Phylum == "Bacteria_unclassified")
unc.muc.df <- data.frame(sample_data(unc.muc.phy))
unc.muc.df$RelAbund <- t(data.frame(otu_table(unc.muc.phy)))

hist(unc.muc.df$RelAbund, breaks=10)
qqnorm(unc.muc.df$RelAbund)
qqline(unc.muc.df$RelAbund)
shapiro.test(unc.muc.df$RelAbund)
  # p-value = 3.292e-07
  # adj p = 0.0000009053
  # Not Normal
kruskal.test(formula = RelAbund ~ Group, data=unc.muc.df)
  # p-value = 0.2998
  # adj p = 0.36642222





### P-adjust for Shapiro
p.adjust(c(0.3238,0.2837,0.0001722,0.2079,1.863e-07,0.04871,4.415e-05,1.382e-07,0.1113,1.062e-07,3.292e-07), method = "BH")
  # Firmicutes = 0.3238000000
  # Bacteroidetes = 0.3120700000
  # Verrucomicrobia = 0.0003157000
  # Proteobacteria = 0.2541000000
  # Kirimatiellaeota = 0.0000006831
  # Cyanobacteria = 0.0765442857
  # Tenericutes = 0.0000971300
  # Elusimicrobia = 0.0000006831
  # Actinobacteria = 0.1530375000
  # Epsilonbacteraeota = 0.0000006831
  # Unclassified = 0.0000009053



### P-adjust for Kruskal-Wallis/ANOVA
p.adjust(c(8.41e-06,0.162,0.05591,0.0287,0.148,0.148,0.1474,0.2135,0.421,0.5395,0.2998), method = "BH")
  # Firmicutes = 0.00009251*
  # Bacteroidetes = 0.25457143
  # Verrucomicrobia = 0.20500333
  # Proteobacteria = 0.15785000
  # Kirimatiellaeota = 0.25457143
  # Cyanobacteria = 0.25457143
  # Tenericutes = 0.25457143
  # Elusimicrobia = 0.29356250
  # Actinobacteria = 0.46310000
  # Epsilonbacteraeota = 0.53950000
  # Unclassified = 0.36642222





### Format data
phy99.muc.df <- psmelt(phy99.muc)
phy99.muc.df$Phylum <- ordered(phy99.muc.df$Phylum, levels = c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Unclassified", "Kiritimatiellaeota", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia", "Epsilonbacteraeota"))
phy99.muc.df$Phylum[which(is.na(phy99.muc.df$Phylum))] <- rep("Unclassified",length(which(is.na(phy99.muc.df$Phylum))))
phy.muc.sum <- phy99.muc.df %>%
  group_by(Group, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance),
            iqr = IQR(Abundance))

```



### Mucosa - Alpha Diversity - Phylogenetic Diversity and SES MPD
```{r}
# Calculate Faith's phylogenetic diversity
pd.muc.res <- pd(t(data.frame(otu_table(phy.muc))), phy_tree(phy.muc), include.root = T)
pd.muc.df <- data.frame(pd.muc.res)

# Calculate MPD (Mean Pairwise Distance)
pd.muc.dist <- cophenetic(phy_tree(phy.muc))
  # Calculate cophenetic distance
ses.mpd.muc.res <- ses.mpd(t(data.frame(otu_table(phy.muc))), pd.muc.dist, null.model = "taxa.labels", abundance.weighted = F, runs = 999)
  # Calculate MPD
  # This'll take a while to run-- be patient
mpd.muc <- data.frame(ses.mpd.muc.res)
  # Pull out MDP results


### Prepare data for plotting ###
mpd.muc$SampleID <- row.names(mpd.muc)
pd.muc.res$SampleID <- row.names(pd.muc.res)
  # Make sure all SampleID's match!

# Pull out first Stat of each test
pd.muc.stats <- data.frame(pd.muc.res$SampleID, pd.muc.res$PD)
pd.muc.stats$Measure <- rep("PD", nrow(pd.muc.df))
colnames(pd.muc.stats) <- c("Sample", "Stat", "Measure")
mpd.muc.stats <- data.frame(mpd.muc$SampleID, mpd.muc$mpd.obs.z)
mpd.muc.stats$Measure <- rep("MPD SES", nrow(pd.muc.df))
colnames(mpd.muc.stats) <- c("Sample", "Stat", "Measure")


### Prepare PD ###
pd.muc.ready <- merge(pd.muc.stats, meta, by = "Sample")
pd.muc.ready$Group <- ordered(pd.muc.ready$Group, levels = c("Summer_Captive", "Torpor", "IBA", "Spring"))

### Prepare MPD ###
mpd.muc.ready <- merge(mpd.muc.stats, meta, by = "Sample")
mpd.muc.ready$Group <- ordered(mpd.muc.ready$Group, levels = c("Summer_Captive", "Torpor", "IBA", "Spring"))


        

        
########## TESTING PD & MPD ##########

### PD ###
hist(pd.muc.ready$Stat, breaks=10)
qqnorm(pd.muc.ready$Stat)
qqline(pd.muc.ready$Stat)
shapiro.test(pd.muc.ready$Stat)
  # p-value = 0.01796
  # adj p = 0.0359200
  # Not Normal
kruskal.test(formula = Stat ~ Group, data=pd.muc.ready)
  # p-value = 0.01219
  # adj p = 0.02438000
dunn.test(x = as.numeric(pd.muc.ready$Stat), g = as.factor(pd.muc.ready$Group), method = "bh", label = T)
  # Summer-Torpor = 0.0316
  # Summer-IBA = 0.0175*
  # Summer-Spring = 0.4788
  # Torpor-IBA = 0.5000
  # Torpor-Spring = 0.0540
  # IBA-Spring = 0.0373
 

### MPD ###
hist(mpd.muc.ready$Stat, breaks=10)
qqnorm(mpd.muc.ready$Stat)
qqline(mpd.muc.ready$Stat)
shapiro.test(mpd.muc.ready$Stat)
  # p-value = 0.4471
  # adj p = 0.5961333
  # Normal
summary(aov(formula = Stat ~ Group, data=mpd.muc.ready))
  # p-value = 0.0313
  # adj p = 0.04173333 
TukeyHSD(aov(formula = Stat ~ Group, data=mpd.muc.ready))
  # Summer-Torpor = 0.0215479*
  # Summer-IBA = 0.2171125
  # Summer-Spring = 0.3451903
  # Torpor-IBA = 0.5188648
  # Torpor-Spring = 0.7642430
  # IBA-Spring = 0.9987692

```

### Mucosa - Alpha Diversity - Shannon & # OTUs
```{r}
adiv.muc <- data.frame(sample_data(phy.muc))


########## Shannon ##########
hist(adiv.muc$shannon, breaks=10)
qqnorm(adiv.muc$shannon)
qqline(adiv.muc$shannon)
shapiro.test(adiv.muc$shannon)
  # p-value = 0.6468
  # adj P = 0.6468000
  # Normal
summary(aov(shannon ~ Group, data = adiv.muc))
  # p-value = 0.868
  # adj P = 0.86800000





########## Number of Unique OTUs ##########
otus.muc <- data.frame(otu_table(phy.muc))
sampNames.muc <- colnames(otus.muc)
uniq.otus.muc <- data.frame(matrix(nrow = nsamples(phy.muc), ncol = 2))
colnames(uniq.otus.muc) <- c("Sample", "Unique_OTUs")
for(n in 1:nsamples(phy.muc)) {
  COL.muc <- otus.muc[,n]
  numUniq.muc <- length(which(COL.muc > 0))
  uniq.otus.muc$Sample[n] <- sampNames.muc[n]
  uniq.otus.muc$Unique_OTUs[n] <- numUniq.muc
}
uniq.otus.muc$Group <- sample_data(phy.muc)$Group
rownames(uniq.otus.muc) <- uniq.otus.muc$Sample

hist(uniq.otus.muc$Unique_OTUs, breaks=10)
qqnorm(uniq.otus.muc$Unique_OTUs)
qqline(uniq.otus.muc$Unique_OTUs)
shapiro.test(uniq.otus.muc$Unique_OTUs)
  # p-value =  0.01611
  # adj p = 0.0359200
  # Not Normal
kruskal.test(formula = Unique_OTUs ~ Group, data=uniq.otus.muc)
  # p-value = 0.004016
  # adj p = 0.01606400
dunn.test(x = as.numeric(uniq.otus.muc$Unique_OTUs), g = as.factor(uniq.otus.muc$Group), method = "bh", label = T)
  # Summer-Torpor = 0.0056*
  # Summer-IBA = 0.0104*
  # Summer-Spring = 0.4499
  # Torpor-IBA = 0.4079
  # Torpor-Spring = 0.0429
  # IBA-Spring = 0.0389





### P-adjust Shapiro
p.adjust(c(0.01796,0.4471,0.6468, 0.01611), method = "BH")
  # 0.0359200 0.5961333 0.6468000 0.0359200
  # Unique OTUs, PD, MPD, Shannon

### P-adjust AOV/Kruskal-Wallis
p.adjust(c(0.01219,0.0313,0.868, 0.004016), method = "BH")
  # 0.02438000 0.04173333 0.86800000 0.01606400
  # Unique OTUs, PD, MPD, Shannon

```

### Mucosa - Alpha Diversity Prepare Plots
```{r}
###### Unique # of OTUs ######
### Prepare data for plot
uniq.otus.muc.sum <- uniq.otus.muc %>%
  group_by(Group) %>%
  summarize(Mean = mean(Unique_OTUs),
            SE = se(Unique_OTUs),
            SD = sd(Unique_OTUs),
            Median = median(Unique_OTUs))
uniq.otus.muc.sum$YMAX <- uniq.otus.muc.sum$Mean + uniq.otus.muc.sum$SE
uniq.otus.muc.sum$YMIN <- uniq.otus.muc.sum$Mean - uniq.otus.muc.sum$SE

otu.muc.ann <- data.frame(lab = c("a", "b", "b", "ab"), Group = factor(c("Summer_Captive", "Torpor", "IBA", "Spring")))

otu.muc.plot <- ggplot(uniq.otus.muc, aes(x = Group, y = Unique_OTUs, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(220,710), breaks = c(220,335,450,565,680)) +
  scale_x_discrete(labels = c("Summer", "Torpor", "IBA", "Spring")) +
  ylab("Number of Observed OTUs") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 8, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 20, hjust = 0.5, vjust = 1.1),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = otu.muc.ann, aes(label=lab), x=c(1,2,3,4),
            y=c(710,710,710,710), size=2.5, color="black")





###### Faith's Phylogenetic Diversity ######
### Prepare PD ###
pd.muc.sum <- pd.muc.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
pd.muc.sum$YMAX <- pd.muc.sum$Mean + pd.muc.sum$SE
pd.muc.sum$YMIN <- pd.muc.sum$Mean - pd.muc.sum$SE

pd.muc.ann <- data.frame(lab = c("a", "ab", "b", "ab"), Group = factor(c("Summer_Captive", "Torpor", "IBA", "Spring")))

pd.muc.plot <- ggplot(pd.muc.ready, aes(x = Group, y = Stat, fill = Group)) +
  geom_violin() + 
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(16,36), breaks = c(16,21,26,31,36)) +
  scale_x_discrete(labels = c("Summer", "Torpor", "IBA", "Spring")) +
  ylab("Faith's Phylogenetic Diversity") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 8, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 20, hjust = 0.5, vjust = 1.1),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = pd.muc.ann, aes(label=lab), x=c(1,2,3,4),
            y=c(36,36,36,36), size=2.5, color="black")





###### Phylogenetic Diversity (MPD) ######
### Prepare MPD ###
mpd.muc.sum <- mpd.muc.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
mpd.muc.sum$YMAX <- mpd.muc.sum$Mean + mpd.muc.sum$SE
mpd.muc.sum$YMIN <- mpd.muc.sum$Mean - mpd.muc.sum$SE

mpd.muc.ann <- data.frame(lab = c("a", "b", "ab", "ab"), Group = factor(c("Summer_Captive", "Torpor", "IBA", "Spring")))

mpd.muc.plot <- ggplot(mpd.muc.ready, aes(x = Group, y = Stat, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(-6.5,3.75), breaks = c(-6.5,-4.5,-2.5,-0.5,1.5,3.5)) +
  scale_x_discrete(labels = c("Summer", "Torpor", "IBA", "Spring")) +
  ylab("Phylogenetic Evenness (MPD)") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 8, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 20, hjust = 0.5, vjust = 1.1),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = mpd.muc.ann, aes(label=lab), x=c(1,2,3,4),
            y=c(3.75,3.75,3.75,3.75), size=2.5, color="black")
  




### Prepare data for plot
shannon.muc.sum <- adiv.muc %>%
  group_by(Group) %>%
  summarize(Mean = mean(shannon),
            SE = se(shannon),
            SD = sd(shannon),
            Median = median(shannon))
shannon.muc.sum$YMAX <- shannon.muc.sum$Mean + shannon.muc.sum$SE
shannon.muc.sum$YMIN <- shannon.muc.sum$Mean - shannon.muc.sum$SE

shannon.muc.ann <- data.frame(lab = c("ns", " ", " ", " "), Group = factor(c("Summer_Captive", "Torpor", "IBA", "Spring")))

shannon.muc.plot <- ggplot(adiv.muc, aes(x = Group, y = shannon, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(1.4,5.8), breaks = c(1.4,2.5,3.6,4.7,5.8)) +
  scale_x_discrete(labels = c("Summer", "Torpor", "IBA", "Spring")) +
  ylab("Shannon's Diversity Index") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        legend.title = element_text(face="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 8, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 20, hjust = 0.5, vjust = 1.1),
        axis.text.y = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.height = unit(3, 'mm'),
        legend.key.width = unit(3, "mm"),
        legend.box.margin=margin(-10,-10,-10,-10)) +
  geom_text(data = shannon.muc.ann, aes(label=lab), x=c(2.5,0,0,0),
            y=c(5.8,0,0,0), size=2.5, color="black")

```

### Mucosa Plot - Alpha Diversity
```{r}
#png("Mucosa/FigS5.CaptiveSeasons.muc.adiv.png", width = 170, height = 60, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,4, widths = c(1, 1, 1, 1.4), heights = c(0.07, 1.5))))
grid.text("A", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=8,fontface="bold"))
print(otu.muc.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
grid.text("B", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2),
          gp=gpar(fontsize=8,fontface="bold"))
print(pd.muc.plot, vp=viewport(layout.pos.row=2, layout.pos.col=2))
grid.text("C", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=3),
          gp=gpar(fontsize=8,fontface="bold"))
print(mpd.muc.plot, vp=viewport(layout.pos.row=2, layout.pos.col=3))
grid.text("D", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=4),
          gp=gpar(fontsize=8,fontface="bold"))
print(shannon.muc.plot, vp=viewport(layout.pos.row=2, layout.pos.col=4))
#dev.off()
```



### Mucosa - Beta Diversity
```{r}
########## Weighted UniFrac ##########
UF.w.muc <- phyloseq::distance(physeq = phy.muc, method = "wunifrac")
UF.w.pcoa.muc <- ordinate(physeq = phy.muc, method = "PCoA", distance = "wunifrac")

wUF.muc.plot <- plot_ordination(physeq = phy.muc, ordination = UF.w.pcoa.muc, axes = c(1,2),
                title = "Weighted UniFrac", color = "Group") +
  scale_colour_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  geom_point(size=2, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "none"
        )


sampdf.muc <- data.frame(sample_data(phy.muc))
beta.tax <- betadisper(d=UF.w.muc, group=sampdf.muc$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.745
adonis(UF.w.muc ~ Group, data=sampdf.muc, permutations = 9999)
  # p-value = 2e-04


# Separate by season
phy.muc.sum <- subset_samples(phy.muc, Group == "Summer_Captive")
phy.muc.tor <- subset_samples(phy.muc, Group == "Torpor")
phy.muc.iba <- subset_samples(phy.muc, Group == "IBA")
phy.muc.spr <- subset_samples(phy.muc, Group == "Spring")

# Separate out pairwise comparisons
phy.muc.st <- merge_phyloseq(phy.muc.sum, phy.muc.tor)
phy.muc.si <- merge_phyloseq(phy.muc.sum, phy.muc.iba)
phy.muc.sp <- merge_phyloseq(phy.muc.sum, phy.muc.spr)
phy.muc.ti <- merge_phyloseq(phy.muc.tor, phy.muc.iba)
phy.muc.tp <- merge_phyloseq(phy.muc.tor, phy.muc.spr)
phy.muc.ip <- merge_phyloseq(phy.muc.iba, phy.muc.spr)


# Summer vs Torpor
st.w.muc <- phyloseq::distance(physeq = phy.muc.st, method = "wunifrac")
sampdf.st<- data.frame(sample_data(phy.muc.st))
beta.tax <- betadisper(d=st.w.muc, group=sampdf.st$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.501
  # adj P = 0.817
adonis(st.w.muc ~ Group, data=sampdf.st, permutations = 9999)
  # p-value = 0.0014
  # adj p = 0.00420


# Summer vs IBA
si.w.muc <- phyloseq::distance(physeq = phy.muc.si, method = "wunifrac")
sampdf.si<- data.frame(sample_data(phy.muc.si))
beta.tax <- betadisper(d=si.w.muc, group=sampdf.si$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.606
  # adj p = 0.817
adonis(si.w.muc ~ Group, data=sampdf.si, permutations = 9999)
  # p-value = 8e-04
  # adj p = 0.00420


# Summer vs Spring
sp.w.muc <- phyloseq::distance(physeq = phy.muc.sp, method = "wunifrac")
sampdf.sp<- data.frame(sample_data(phy.muc.sp))
beta.tax <- betadisper(d=sp.w.muc, group=sampdf.sp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.731
  # adj p = 0.817
adonis(sp.w.muc ~ Group, data=sampdf.sp, permutations = 9999)
  # p-value = 0.1192
  # adj p = 0.14304


# Torpor vs IBA
ti.w.muc <- phyloseq::distance(physeq = phy.muc.ti, method = "wunifrac")
sampdf.ti<- data.frame(sample_data(phy.muc.ti))
beta.tax <- betadisper(d=ti.w.muc, group=sampdf.ti$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.817
  # adj p = 0.817
adonis(ti.w.muc ~ Group, data=sampdf.ti, permutations = 9999)
  # p-value = 0.9865
  # adj p = 0.98650


# Torpor vs Spring
tp.w.muc <- phyloseq::distance(physeq = phy.muc.tp, method = "wunifrac")
sampdf.tp<- data.frame(sample_data(phy.muc.tp))
beta.tax <- betadisper(d=tp.w.muc, group=sampdf.tp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.312
  # adj p = 0.817
adonis(tp.w.muc ~ Group, data=sampdf.tp, permutations = 9999)
  # p-value = 0.0162
  # adj p = 0.02430


# IBA vs Spring
ip.w.muc <- phyloseq::distance(physeq = phy.muc.ip, method = "wunifrac")
sampdf.ip<- data.frame(sample_data(phy.muc.ip))
beta.tax <- betadisper(d=ip.w.muc, group=sampdf.ip$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.385
  # adj p = 0.817
adonis(ip.w.muc ~ Group, data=sampdf.ip, permutations = 9999)
  # p-value = 0.0095
  # adj p = 0.01900



# Adjust betadisper p-values
p.adjust(c(0.501,0.606,0.731,0.817,0.312,0.385), method = "BH")
  # Summer-Torpor = 0.817
  # Summer-IBA = 0.817
  # Summer-Spring = 0.817
  # Torpor-IBA = 0.817
  # Torpor-Spring = 0.817
  # IBA-Spring = 0.817


# Adjust PERMANOVA p-values
p.adjust(c(0.0014,8e-04,0.1192,0.9865,0.0162,0.0095), method = "BH")
  # Summer-Torpor = 0.00420
  # Summer-IBA = 0.00420
  # Summer-Spring = 0.14304
  # Torpor-IBA = 0.98650
  # Torpor-Spring = 0.02430
  # IBA-Spring = 0.01900





########## Unweighted UniFrac ##########
UF.u.muc <- phyloseq::distance(physeq = phy.muc, method = "unifrac")
UF.u.pcoa.muc <- ordinate(physeq = phy.muc, method = "PCoA", distance = "unifrac")

uUF.muc.plot <- plot_ordination(physeq = phy.muc, ordination = UF.u.pcoa.muc, axes = c(1,2),
                title = "Unweighted UniFrac", color = "Group") +
  scale_colour_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  geom_point(size=2, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position  = "none"
        )


sampdf <- data.frame(sample_data(phy.muc))
beta.tax <- betadisper(d=UF.u.muc, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.092
adonis(UF.u.muc ~ Group, data=sampdf, permutations = 9999)
  # p-value = 0.0014


# Summer vs Torpor
st.u.muc <- phyloseq::distance(physeq = phy.muc.st, method = "unifrac")
sampdf.st<- data.frame(sample_data(phy.muc.st))
beta.tax <- betadisper(d=st.u.muc, group=sampdf.st$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.11
  # adj p = 0.220
adonis(st.u.muc ~ Group, data=sampdf.st, permutations = 9999)
  # p-value = 0.0027
  # adj p = 0.00810


# Summer vs IBA
si.u.muc <- phyloseq::distance(physeq = phy.muc.si, method = "unifrac")
sampdf.si<- data.frame(sample_data(phy.muc.si))
beta.tax <- betadisper(d=si.u.muc, group=sampdf.si$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.066
  # adj p = 0.220
adonis(si.u.muc ~ Group, data=sampdf.si, permutations = 9999)
  # p-value = 5e-04
  # adj p = 0.00300


# Summer vs Spring
sp.u.muc <- phyloseq::distance(physeq = phy.muc.sp, method = "unifrac")
sampdf.sp<- data.frame(sample_data(phy.muc.sp))
beta.tax <- betadisper(d=sp.u.muc, group=sampdf.sp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.088
  # adj p = 0.220
adonis(sp.u.muc ~ Group, data=sampdf.sp, permutations = 9999)
  # p-value = 0.5296
  # adj p = 0.63552


# Torpor vs IBA
ti.u.muc <- phyloseq::distance(physeq = phy.muc.ti, method = "unifrac")
sampdf.ti<- data.frame(sample_data(phy.muc.ti))
beta.tax <- betadisper(d=ti.u.muc, group=sampdf.ti$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.721
  # adj p = 0.721
adonis(ti.u.muc ~ Group, data=sampdf.ti, permutations = 9999)
  # p-value = 0.844
  # adj p = 0.84400


# Torpor vs Spring
tp.u.muc <- phyloseq::distance(physeq = phy.muc.tp, method = "unifrac")
sampdf.tp<- data.frame(sample_data(phy.muc.tp))
beta.tax <- betadisper(d=tp.u.muc, group=sampdf.tp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.38
  # adj p = 0.570
adonis(tp.u.muc ~ Group, data=sampdf.tp, permutations = 9999)
  # p-value = 0.0697
  # adj p = 0.10455


# IBA vs Spring
ip.u.muc <- phyloseq::distance(physeq = phy.muc.ip, method = "unifrac")
sampdf.ip<- data.frame(sample_data(phy.muc.ip))
beta.tax <- betadisper(d=ip.u.muc, group=sampdf.ip$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.614
  # adj p = 0.721
adonis(ip.u.muc ~ Group, data=sampdf.ip, permutations = 9999)
  # p-value = 0.0163
  # adj p = 0.03260



# Adjust betadisper p-values
p.adjust(c(0.11,0.066,0.088,0.721,0.38,0.614), method = "BH")
  # Summer-Torpor = 0.220
  # Summer-IBA = 0.220
  # Summer-Spring = 0.220
  # Torpor-IBA = 0.721
  # Torpor-Spring = 0.570
  # IBA-Spring = 0.721

# Adjust PERMANOVA p-values
p.adjust(c(0.0027,5e-04,0.5296,0.844,0.0697,0.0163), method = "BH")
  # Summer-Torpor = 0.00810
  # Summer-IBA = 0.00300
  # Summer-Spring = 0.63552
  # Torpor-IBA = 0.84400
  # Torpor-Spring = 0.10455
  # IBA-Spring = 0.03260





########## Bray-Curtis ##########
bray.pcoa.muc <- ordinate(physeq=phy.muc, method="PCoA", distance="bray")

bc.muc.plot <- plot_ordination(physeq=phy.muc, ordination=bray.pcoa.muc, color="Group",
                           title = "Bray-Curtis Dissimilarity") +
  scale_colour_manual(values = c("#e60000", "#5876d1", "#36ccff", "chartreuse3"), labels = c("Summer", "Torpor", "IBA", "Spring")) +
  geom_point(size=2, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "none"
        #legend.title = element_text(size = 8, face = "bold"),
        #legend.text = element_text(size = 8),
        #legend.key.height = unit(4, 'mm'),
        #legend.box.margin=margin(-10,-10,-10,-10)
        )

ord.muc.legend <- g_legend(bc.muc.plot)


sampdf.muc <- data.frame(sample_data(phy.muc))
bray.muc <- phyloseq::distance(physeq = phy.muc, method = "bray")
beta.tax <- betadisper(d = bray.muc, group = sampdf.muc$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.705
adonis(bray.muc ~ Group, data=sampdf.muc, permutations = 9999)
  # p-value = 1e-04


# Summer vs. Torpor
sampdf.muc.st <- data.frame(sample_data(phy.muc.st))
bray.muc.st <- phyloseq::distance(physeq = phy.muc.st, method = "bray")
beta.tax <- betadisper(d = bray.muc.st, group = sampdf.muc.st$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.958
  # adj p = 0.958
adonis(bray.muc.st ~ Group, data=sampdf.muc.st, permutations = 9999)
  # p-value = 0.0016
  # adj p = 0.00480


# Summer vs. IBA
sampdf.muc.si <- data.frame(sample_data(phy.muc.si))
bray.muc.si <- phyloseq::distance(physeq = phy.muc.si, method = "bray")
beta.tax <- betadisper(d = bray.muc.si, group = sampdf.muc.si$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.917
  # adj p = 0.958
adonis(bray.muc.si ~ Group, data=sampdf.muc.si, permutations = 9999)
  # p-value = 7e-04
  # adj p = 0.00420


# Summer vs. Spring
sampdf.muc.sp <- data.frame(sample_data(phy.muc.sp))
bray.muc.sp <- phyloseq::distance(physeq = phy.muc.sp, method = "bray")
beta.tax <- betadisper(d = bray.muc.sp, group = sampd.mucf.sp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.933
  # adj p = 0.958
adonis(bray.muc.sp ~ Group, data=sampdf.muc.sp, permutations = 9999)
  # p-value = 0.0791
  # adj p = 0.09492


# Torpor vs. IBA
sampdf.muc.ti <- data.frame(sample_data(phy.muc.ti))
bray.muc.ti <- phyloseq::distance(physeq = phy.muc.ti, method = "bray")
beta.tax <- betadisper(d = bray.muc.ti, group = sampdf.muc.ti$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.958
  # adj p = 0.958
adonis(bray.muc.ti ~ Group, data=sampdf.muc.ti, permutations = 9999)
  # p-value = 0.9815
  # adj p = 0.98150


# Torpor vs. Spring
sampdf.muc.tp <- data.frame(sample_data(phy.muc.tp))
bray.muc.tp <- phyloseq::distance(physeq = phy.muc.tp, method = "bray")
beta.tax <- betadisper(d = bray.muc.tp, group = sampdf.muc.tp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.137
  # adj p = 0.822
adonis(bray.muc.tp ~ Group, data=sampdf.muc.tp, permutations = 9999)
  # p-value = 0.0178
  # adj p = 0.02670


# IBA vs. Spring
sampdf.muc.ip <- data.frame(sample_data(phy.muc.ip))
bray.muc.ip <- phyloseq::distance(physeq = phy.muc.ip, method = "bray")
beta.tax <- betadisper(d = bray.muc.ip, group = sampdf.muc.ip$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.354
  # adj p = 0.958
adonis(bray.muc.ip ~ Group, data=sampdf.muc.ip, permutations = 9999)
  # p-value = 0.0084
  # adj p = 0.01680



### Adjust betadisper p-values
p.adjust(c(0.958,0.917,0.933,0.958,0.137,0.354), method = "BH")
  # Summer-Torpor = 0.958
  # Summer-IBA = 0.958
  # Summer-Spring = 0.958
  # Torpor-IBA = 0.958
  # Torpor-Spring = 0.822
  # IBA-Spring = 0.958



### Adjust PERMANOVA p-values
p.adjust(c(0.0016,7e-04,0.0791,0.9815,0.0178,0.0084), method = "BH")
  # Summer-Torpor = 0.00480*
  # Summer-IBA = 0.00420*
  # Summer-Spring = 0.09492
  # Torpor-IBA = 0.98150
  # Torpor-Spring = 0.02670*
  # IBA-Spring = 0.01680*

```


### Mucosa Plot - Beta Diversity
```{r}
#png("Mucosa/FigS6.CaptiveSeasons.muc.bdiv.png", width = 85, height = 180, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(3,2, widths = c(1, 0.45), heights = c(1, 1, 1))))

print(wUF.muc.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(uUF.muc.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
print(bc.muc.plot, vp=viewport(layout.pos.row=3, layout.pos.col=1))


ord.muc.legend$vp <- viewport(layout.pos.row = 1:3, layout.pos.col = 2)
grid.draw(ord.muc.legend)


grid.text("A", x=unit(0.05, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1,
                                                                  layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))
grid.text("B", x=unit(0.05, "npc"),  y=unit(0.95, "npc"), vp=viewport(layout.pos.row=2,
                                                                   layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))
grid.text("C", x=unit(0.05, "npc"),  y=unit(0.95, "npc"), vp=viewport(layout.pos.row=3,
                                                                   layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))

#dev.off()
```



### Mucosa - SIMPER
```{r}
# Change Group names to be compatible (no "_")
muc.rename <- data.frame(sample_data(phy.muc))
muc.rename$GroupRename <- rep(NA, nrow(muc.rename))
muc.rename$GroupRename[which(muc.rename$Group == "Summer_Captive")] <- "Summer"
muc.rename$GroupRename[which(muc.rename$Group == "Torpor")] <- "Torpor"
muc.rename$GroupRename[which(muc.rename$Group == "IBA")] <- "IBA"
muc.rename$GroupRename[which(muc.rename$Group == "Spring")] <- "Spring"
muc.rename$GroupRename <- ordered(muc.rename$GroupRename, levels = c("Summer", "Torpor", "IBA", "Spring"))
phy.muc.simp <- merge_phyloseq(otu_table(phy.muc), sample_data(muc.rename), tax_table(phy.muc))


# Group
#simper.pretty(data.frame(otu_table(phy.muc.simp)),
              data.frame(sample_data(phy.muc.simp)),
              c("GroupRename"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='Mucosa/CaptiveSeasons.muc')
#group.simper <- read.csv("Mucosa/CaptiveSeasons.muc_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(phy.muc.simp)),
               data.frame(sample_data(phy.muc.simp)),
               csv = group.simper,
               c("GroupRename"),
               output_name = 'Mucosa/CaptiveSeasons.muc',
               taxonomy = data.frame(tax_table(phy.muc.simp)))
#group.simper.kw <- read.csv("Mucosa/CaptiveSeasons.muc_krusk_simper.csv")
for(i in 1:nrow(group.simper.kw)){
  save <- which(rownames(data.frame(tax_table(phy.muc.simp))) == group.simper.kw$OTU[i])
  group.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(phy.muc.simp))[save,2], "-",
          data.frame(tax_table(phy.muc.simp))[save,3], "-",
          data.frame(tax_table(phy.muc.simp))[save,4], "-",
          data.frame(tax_table(phy.muc.simp))[save,5], "-",
          data.frame(tax_table(phy.muc.simp))[save,6])
}
#write.table(group.simper.kw, "Mucosa/CaptiveSeasons.muc_krusk_simper.csv", sep=",")
#group.simper.kw <- read.csv("Mucosa/CaptiveSeasons.muc_krusk_simper.csv", row.names = 1)
```



### Mucosa - Core OTUs and Shared OTUs
```{r}
### Drop empty taxa
phy.muc.sum.trim <- prune_taxa(taxa_sums(phy.muc.sum) > 0, phy.muc.sum)
  # 1618 OTUs
phy.muc.tor.trim <- prune_taxa(taxa_sums(phy.muc.tor) > 0, phy.muc.tor)
  # 691 OTUs
phy.muc.iba.trim <- prune_taxa(taxa_sums(phy.muc.iba) > 0, phy.muc.iba)
  # 794 OTUs
phy.muc.spr.trim <- prune_taxa(taxa_sums(phy.muc.spr) > 0, phy.muc.spr)
  # 808 OTUs



### Identify Core OTUs
sum.muc.otu <- data.frame(otu_table(phy.muc.sum))
sum.muc.core <- apply(sum.muc.otu, 1, function(row) all(row != 0))
sum.muc.core <- sum.muc.otu[sum.muc.core,]
phy.muc.sum.core <- merge_phyloseq(otu_table(sum.muc.core, taxa_are_rows = T), tax_table(phy.muc.sum), sample_data(phy.muc.sum))
  # 43 OTUs
tor.muc.otu <- data.frame(otu_table(phy.muc.tor))
tor.muc.core <- apply(tor.muc.otu, 1, function(row) all(row != 0))
tor.muc.core <- tor.muc.otu[tor.muc.core,]
phy.muc.tor.core <- merge_phyloseq(otu_table(tor.muc.core, taxa_are_rows = T), tax_table(phy.muc.tor), sample_data(phy.muc.tor))
  # 65 OTUs
iba.muc.otu <- data.frame(otu_table(phy.muc.iba))
iba.muc.core <- apply(iba.muc.otu, 1, function(row) all(row != 0))
iba.muc.core <- iba.muc.otu[iba.muc.core,]
phy.muc.iba.core <- merge_phyloseq(otu_table(iba.muc.core, taxa_are_rows = T), tax_table(phy.muc.iba), sample_data(phy.muc.iba))
  # 60 OTUs
spr.muc.otu <- data.frame(otu_table(phy.muc.spr))
spr.muc.core <- apply(spr.muc.otu, 1, function(row) all(row != 0))
spr.muc.core <- spr.muc.otu[spr.muc.core,]
phy.muc.spr.core <- merge_phyloseq(otu_table(spr.muc.core, taxa_are_rows = T), tax_table(phy.muc.spr), sample_data(phy.muc.spr))
  # 141 OTUs



### Compare Core OTUs
intersect(rownames(sum.muc.core), rownames(tor.muc.core))
  # 24 shared core OTUs
  # "Otu00072" "Otu00159" "Otu00241" "Otu00026" "Otu00154" "Otu00197" "Otu00120" "Otu00184" "Otu00161" "Otu00200" "Otu00093" "Otu00067" "Otu00009" "Otu00040" "Otu00452" "Otu00143" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00041" "Otu00137" "Otu00112" "Otu00065"
intersect(rownames(sum.muc.core), rownames(iba.muc.core))
  # 26 shared core OTUs
  # "Otu00072" "Otu00241" "Otu00026" "Otu00053" "Otu00175" "Otu00278" "Otu00197" "Otu00120" "Otu00169" "Otu00184" "Otu00156" "Otu00200" "Otu00093" "Otu00067" "Otu00452" "Otu00143" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00109" "Otu00041" "Otu00137" "Otu00090" "Otu00112" "Otu00065"
intersect(rownames(sum.muc.core), rownames(spr.muc.core))
  # 34 shared core OTUs
  # "Otu00072" "Otu00159" "Otu00044" "Otu00026" "Otu00053" "Otu00455" "Otu00154" "Otu00175" "Otu00278" "Otu00197" "Otu00120" "Otu00184" "Otu00161" "Otu00236" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00067" "Otu00009" "Otu00040" "Otu00452" "Otu00143" "Otu00068" "Otu00043" "Otu00011" "Otu00109" "Otu00041" "Otu00340" "Otu00052" "Otu00137" "Otu00032" "Otu00090" "Otu00112"
intersect(rownames(tor.muc.core), rownames(iba.muc.core))
  # 35 shared core OTUs
  # "Otu00170" "Otu00097" "Otu00051" "Otu00072" "Otu00241" "Otu00026" "Otu00197" "Otu00120" "Otu00259" "Otu00184" "Otu00200" "Otu00093" "Otu00067" "Otu00004" "Otu00012" "Otu00452" "Otu00143" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00061" "Otu00094" "Otu00041" "Otu00046" "Otu00076" "Otu00138" "Otu00137" "Otu00116" "Otu00007" "Otu00086" "Otu00219" "Otu00112" "Otu00058" "Otu00065"
intersect(rownames(tor.muc.core), rownames(spr.muc.core))
  # 49 shared core OTUs
  # "Otu00170" "Otu00097" "Otu00051" "Otu00348" "Otu00072" "Otu00159" "Otu00078" "Otu00026" "Otu00018" "Otu00016" "Otu00177" "Otu00154" "Otu00197" "Otu00120" "Otu00229" "Otu00184" "Otu00161" "Otu00174" "Otu00200" "Otu00093" "Otu00067" "Otu00038" "Otu00004" "Otu00108" "Otu00102" "Otu00009" "Otu00265" "Otu00110" "Otu00045" "Otu00040" "Otu00075" "Otu00021" "Otu00452" "Otu00143" "Otu00068" "Otu00043" "Otu00011" "Otu00061" "Otu00205" "Otu00094" "Otu00041" "Otu00046" "Otu00138" "Otu00137" "Otu00007" "Otu00224" "Otu00086" "Otu00112" "Otu00058"
intersect(rownames(iba.muc.core), rownames(spr.muc.core))
  # 41 shared core OTUs
  # "Otu00170" "Otu00097" "Otu00051" "Otu00072" "Otu00240" "Otu00433" "Otu00026" "Otu00053" "Otu00175" "Otu00278" "Otu00197" "Otu00120" "Otu00267" "Otu00184" "Otu00150" "Otu00210" "Otu00232" "Otu00156" "Otu00200" "Otu00093" "Otu00067" "Otu00037" "Otu00004" "Otu00452" "Otu00143" "Otu00068" "Otu00043" "Otu00011" "Otu00061" "Otu00094" "Otu00109" "Otu00041" "Otu00046" "Otu00138" "Otu00137" "Otu00221" "Otu00007" "Otu00090" "Otu00086" "Otu00112" "Otu00058"



### Find core of core OTUs (in every single sample)
core1.muc <- intersect(rownames(sum.muc.core), rownames(tor.muc.core))
core2.muc <- intersect(core1.muc, rownames(iba.muc.core))
core3.muc <- intersect(core2.muc, rownames(spr.muc.core))
# 16 CORE core content OTUs
# "Otu00072" "Otu00026" "Otu00197" "Otu00120" "Otu00184" "Otu00200" "Otu00093" "Otu00067" "Otu00452" "Otu00143" "Otu00068" "Otu00043" "Otu00011" "Otu00041" "Otu00137" "Otu00112"



### Physeq object with only core OTUs
phy.muc.core <- merge_phyloseq(phy.muc.sum.core, phy.muc.tor.core, phy.muc.iba.core, phy.muc.spr.core)
#write.csv(data.frame(tax_table(phy.muc.core)), "Mucosa/TableS9.CaptiveSeasons_muc_coreOTUs.csv")
```