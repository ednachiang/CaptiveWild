---
title: "Code"
author: "Edna Chiang"
date: "May 7, 2018"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(ggplot2)
library(gplots)
library(phangorn)
library(tidyr)
library(vegan)
library(phyloseq)
library(grid)
library(pgirmess)
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('scripts/veganCovEllipse.R')
source('scripts/simper_pretty.R')
source('scripts/R_krusk.R')
source('scripts/pairwise.adonis.R')
source('scripts/misc.R')
```

### Import Data
```{r}
# Link files
shared = "mothur_output/final.shared"
taxonomy = "mothur_output/final.taxonomy"


# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
```

### Explore mothurdata object
```{r}
samp.sum <- data.frame(colSums(otu_table(mothurdata)))
colnames(samp.sum) <- "Sample_TotalSeqs"
samp.sum$sample <- row.names(samp.sum)
samp.sum <- arrange(samp.sum, Sample_TotalSeqs)

ggplot(samp.sum, aes(x=reorder(sample, Sample_TotalSeqs), y=Sample_TotalSeqs)) +
  ylab("Number of Sequences per Sample") +
  geom_bar(stat="identity", colour="black", fill="cornflowerblue") +
  xlab("Sample Name") +
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45,hjust = 1,
                                   vjust = 1))

ggplot(data.frame(sum = sample_sums(mothurdata)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue", bins=60) + 
  ggtitle("Sample read counts") + 
  xlab("Total sequences")


# Min, Mean, Max of sample read counts
min(sample_sums(mothurdata))
mean(sample_sums(mothurdata))
median(sample_sums(mothurdata))
max(sample_sums(mothurdata))
```


### Interim Phyloseq Object
```{r}
meta <- read.csv("metadata2.csv")
colnames(meta)[1] <- "Sample"
rownames(meta) <- meta$Sample
divsum <- read.table("mothur_output/8494.summary", header=T)
remove <- setdiff(meta$Sample, divsum$group)
for(i in 1:length(remove)){
  meta <- meta[-which(meta$Sample == remove[i]),]
}
#meta <- meta[,-12:-14]

# Add in diversity summaries
meta[,11:20] <- divsum[,3:12]

# Create interim phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))

# Order factors
sample_data(physeq)$Season <- ordered(sample_data(physeq)$Season,
                                     levels=c("Summer", "Winter", "Spring"))
sample_data(physeq)$Metabolism <- ordered(sample_data(physeq)$Metabolism,
                                     levels=c("Active", "Torpor", "IBA"))
sample_data(physeq)$Group <- ordered(sample_data(physeq)$Group,
                                     levels=c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring", "Chow"))

# Remove unwanted samples
physeq.rem <- subset_samples(physeq, Sample_Type != "Black_Tissue" & Season != "NA")
physeq.rem <- subset_samples(physeq.rem, ID != "3916" & ID != "3925" )
rem <- names(which(taxa_sums(physeq.rem) > 10))
physeq.rem <- prune_taxa(rem, physeq.rem)


#save(physeq.rem, file="Physeq.RData")

# Separate by season
physeq.wild <- subset_samples(physeq.rem, Group == "Summer_Wild")
physeq.sum <- subset_samples(physeq.rem, Group == "Summer_Lab")
physeq.tor <- subset_samples(physeq.rem, Group == "Torpor")
physeq.iba <- subset_samples(physeq.rem, Group == "IBA")
physeq.spr <- subset_samples(physeq.rem, Group == "Spring")

# Separate by content/mucosa
physeq.con <- subset_samples(physeq.rem, Sample_Type == "Content")
physeq.muc <- subset_samples(physeq.rem, Sample_Type == "Mucosa")

# Pull out only lab squirrels
physeq.lab <- subset_samples(physeq.rem, Diet != "Wild")
```
### Test content vs. mucosa - Alpha Diversity
```{r}
adiv <- data.frame(sample_data(physeq.rem))

########## Compare Con vs. Muc within Group ##########

# Separate by season
adiv.wild <- adiv[which(adiv$Group == "Summer_Wild"),]
adiv.sum <- adiv[which(adiv$Group == "Summer_Lab"),]
adiv.tor <- adiv[which(adiv$Group == "Torpor"),]
adiv.iba <- adiv[which(adiv$Group == "IBA"),]
adiv.spr <- adiv[which(adiv$Group == "Spring"),]


##### Chao #####
hist(adiv.wild$chao, breaks=10)
qqnorm(adiv.wild$chao)
qqline(adiv.wild$chao)
shapiro.test(adiv.wild$chao)
  # p-value = 0.3404
  # Normal
hist(adiv.sum$chao, breaks=10)
qqnorm(adiv.sum$chao)
qqline(adiv.sum$chao)
shapiro.test(adiv.sum$chao)
  # p-value = 0.6042
  # Normal
hist(adiv.tor$chao, breaks=10)
qqnorm(adiv.tor$chao)
qqline(adiv.tor$chao)
shapiro.test(adiv.tor$chao)
  # p-value = 0.1055
  # Normal
hist(adiv.iba$chao, breaks=10)
qqnorm(adiv.iba$chao)
qqline(adiv.iba$chao)
shapiro.test(adiv.iba$chao)
  # p-value = 0.03129
  # Not Normal
hist(adiv.spr$chao, breaks=10)
qqnorm(adiv.spr$chao)
qqline(adiv.spr$chao)
shapiro.test(adiv.spr$chao)
  # p-value = 0.3883
  # Normal

### Wilcoxon & T-Test ###
t.test(chao ~ Sample_Type, data = adiv.wild)
  # p-value = 0.3824
t.test(chao ~ Sample_Type, data = adiv.sum)
  # p-value = 0.8265
t.test(chao ~ Sample_Type, data = adiv.tor)
  # p-value = 0.03331*
wilcox.test(chao ~ Sample_Type, data = adiv.iba)
  # p-value = 0.4318
t.test(chao ~ Sample_Type, data = adiv.spr)
  # p-value = 0.9252



##### Shannon #####
hist(adiv.wild$shannon, breaks=10)
qqnorm(adiv.wild$shannon)
qqline(adiv.wild$shannon)
shapiro.test(adiv.wild$shannon)
  # p-value = 0.03979
  # Not Normal
hist(adiv.sum$shannon, breaks=10)
qqnorm(adiv.sum$shannon)
qqline(adiv.sum$shannon)
shapiro.test(adiv.sum$shannon)
  # p-value = 0.9038
  # Normal
hist(adiv.tor$shannon, breaks=10)
qqnorm(adiv.tor$shannon)
qqline(adiv.tor$shannon)
shapiro.test(adiv.tor$shannon)
  # p-value = 0.876
  # Normal
hist(adiv.iba$shannon, breaks=10)
qqnorm(adiv.iba$shannon)
qqline(adiv.iba$shannon)
shapiro.test(adiv.iba$shannon)
  # p-value = 0.7765
  # Normal
hist(adiv.spr$shannon, breaks=10)
qqnorm(adiv.spr$shannon)
qqline(adiv.spr$shannon)
shapiro.test(adiv.spr$shannon)
  # p-value = 0.3872
  # Normal

### Wilcoxon & T-Test ###
wilcox.test(shannon ~ Sample_Type, data = adiv.wild)
  # p-value = 0.2
t.test(shannon ~ Sample_Type, data = adiv.sum)
  # p-value = 0.3654
t.test(shannon ~ Sample_Type, data = adiv.tor)
  # p-value = 0.4803
t.test(shannon ~ Sample_Type, data = adiv.iba)
  # p-value = 0.4759
t.test(shannon ~ Sample_Type, data = adiv.spr)
  # p-value = 0.1112

```



### Test content vs. mucosa - Beta Diversity
```{r}
### Bray NMDS - All
nmds <- ordinate(physeq=physeq.rem, method="NMDS", distance="bray")
  # Stress = 0.1742581
plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group", shape="Sample_Type") + facet_grid(.~Group)
plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group", shape="Sex") + facet_grid(.~Group)

### Bray NMDS - By Group
nmds.wild <- ordinate(physeq=physeq.wild, method="NMDS", distance="bray")
  # stress = 0.1499987 
plot_ordination(physeq=physeq.wild, ordination=nmds.wild, color="Sample_Type", shape="Sample_Type")

nmds.sum <- ordinate(physeq=physeq.sum, method="NMDS", distance="bray")
  # stress = 0.07056971 
plot_ordination(physeq=physeq.sum, ordination=nmds.sum, color="Sample_Type", shape="Sample_Type")

nmds.tor <- ordinate(physeq=physeq.tor, method="NMDS", distance="bray")
  # stress = 0.1657292
plot_ordination(physeq=physeq.tor, ordination=nmds.tor, color="Sample_Type", shape="Sample_Type")

nmds.iba <- ordinate(physeq=physeq.iba, method="NMDS", distance="bray")
  # stress = 0.103724 
plot_ordination(physeq=physeq.iba, ordination=nmds.iba, color="Sample_Type", shape="Sample_Type")

nmds.spr <- ordinate(physeq=physeq.spr, method="NMDS", distance="bray")
  # stress = 0.1859594
plot_ordination(physeq=physeq.spr, ordination=nmds.spr, color="Sample_Type", shape="Sample_Type")



###### PERMANOVA - By Group for Sample Type ######

sampdf.wild <- data.frame(sample_data(physeq.wild))
bray.wild <- phyloseq::distance(physeq = physeq.wild, method = "bray")
beta.tax = betadisper(d=bray.wild, group=sampdf.wild$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.9013889
adonis(bray.wild ~ Sample_Type, data = sampdf.wild, permutations = 9999)
  # p-value = 0.7
  # R2 = 0.3548

sampdf.sum <- data.frame(sample_data(physeq.sum))
bray.sum <- phyloseq::distance(physeq = physeq.sum, method = "bray")
beta.tax = betadisper(d=bray.sum, group=sampdf.sum$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.628
adonis(bray.sum ~ Sample_Type, data = sampdf.sum, permutations = 9999)
  # p-value = 0.9967
  # R2 = 0.01754

sampdf.tor <- data.frame(sample_data(physeq.tor))
bray.tor <- phyloseq::distance(physeq = physeq.tor, method = "bray")
beta.tax = betadisper(d=bray.tor, group=sampdf.tor$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.755
adonis(bray.tor ~ Sample_Type, data = sampdf.tor, permutations = 9999)
  # p-value = 0.9429
  # R2 = 0.0332

sampdf.iba <- data.frame(sample_data(physeq.iba))
bray.iba <- phyloseq::distance(physeq = physeq.iba, method = "bray")
beta.tax = betadisper(d=bray.iba, group=sampdf.iba$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.79
adonis(bray.iba ~ Sample_Type, data = sampdf.iba, permutations = 9999)
  # p-value = 0.9654
  # R2 = 0.02039

sampdf.spr <- data.frame(sample_data(physeq.spr))
bray.spr <- phyloseq::distance(physeq = physeq.spr, method = "bray")
beta.tax = betadisper(d=bray.spr, group=sampdf.spr$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.008333
anosim(bray.spr, sampdf.spr$Sample_Type, permutations = 1000)
  # p-value = 1
  # R = -0.4167
```
### Alpha Diversity - Lab squirrels
```{r}
adiv.lab <- data.frame(sample_data(physeq.lab))


##### Chao #####
hist(adiv.lab$chao, breaks=10)
qqnorm(adiv.lab$chao)
qqline(adiv.lab$chao)
shapiro.test(adiv.lab$chao)
  # p-value = 0.0001635
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = chao ~ Group, data = adiv.lab)
  # p-value = 0.1209



##### Shannon #####
hist(adiv.lab$shannon, breaks=10)
qqnorm(adiv.lab$shannon)
qqline(adiv.lab$shannon)
shapiro.test(adiv.lab$shannon)
  # p-value = 0.7015
  # Normal

# ANOVA
summary(aov(shannon ~ Group, data = adiv.lab))
  # p-value = 0.0932



###### Boxplots ######

### Chao
adiv.chao <- ggplot(adiv.lab, aes(x = Group, y = chao, fill = Group)) +
  geom_boxplot(position = position_dodge(1), outlier.shape = NA) +
  geom_jitter(size=2, width = 0.2) +
  scale_y_continuous(limits = c(0,2200), breaks = c(0, 550, 1100, 1650, 2200)) +
  scale_x_discrete(breaks=c("Summer_Lab", "Torpor", "IBA", "Spring"), labels=c("Summer", "Torpor", "IBA", "Spring")) +
  ylab("Chao Richness") +
  scale_fill_manual(values = c("lightcoral", "royalblue3", "deepskyblue", "limegreen"),
                    labels = c("Summer", "Torpor", "IBA", "Spring")) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=16),
        strip.text.x = element_text(face ="bold", size=16),
        legend.title = element_text(face="bold", size=16),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(face="bold", size=16),
        axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=13),
        legend.text = element_text(size=14))



### Shannon
adiv.shannon <- ggplot(adiv.lab, aes(x = Group, y = shannon, fill = Group)) +
  geom_boxplot(position = position_dodge(1), outlier.shape = NA) +
  geom_jitter(size=2, width = 0.2) +
  scale_y_continuous(limits = c(1,6), breaks = c(1, 2, 3, 4, 5, 6)) +
  scale_x_discrete(breaks=c("Summer_Lab", "Torpor", "IBA", "Spring"), labels=c("Summer", "Torpor", "IBA", "Spring")) +
  ylab("Shannon Diversity Index\n") +
  scale_fill_manual(values = c("lightcoral", "royalblue3", "deepskyblue", "limegreen"),
                    labels = c("Summer", "Torpor", "IBA", "Spring")) +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=16),
        strip.text.x = element_text(face ="bold", size=16),
        legend.title = element_text(face="bold", size=16),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(face="bold", size=16),
        axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=13),
        legend.text = element_text(size=14))




### Combine plots
#tiff("adiv.lab.tiff", width = 11, height = 3.5, units = "in", res = 600)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,2))))
print(adiv.chao, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(adiv.shannon, vp=viewport(layout.pos.row=1, layout.pos.col=2))

grid.text("(A)", x=unit(0.025, "npc"), y=unit(0.974, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=15,fontface="bold"))
grid.text("(B)", x=unit(0.025, "npc"), y=unit(0.974, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2),gp=gpar(fontsize=15,fontface="bold"))

grid.text("ns", x=unit(0.44, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=12))
grid.text("ns", x=unit(0.45, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=12))
#dev.off()


```
### Beta Diversity - Lab squirrels
```{r}
### Bray NMDS
#nmds.lab <- ordinate(physeq=physeq.lab, method="NMDS", distance="bray")
  # Stress = 0.1413397
#save(nmds.lab, file = "nmds.lab.RData")

load("nmds.lab.RData")

##### Plot

# Ellipses
elip.nmds.lab <- data.frame(MDS1 = nmds.lab$points[,1], MDS2 = nmds.lab$points[,2],
                        Group = sample_data(physeq.lab)$Group)
plot.new()
elip.ord.lab <- ordiellipse(nmds.lab, sample_data(physeq.lab)$Group, display="sites", kind="se", conf=0.95, label=T)
elip.lab.df <- data.frame()
for(i in levels(elip.nmds.lab$Group)){
  elip.lab.df <- rbind(elip.lab.df, cbind(as.data.frame(with(elip.nmds.lab[elip.nmds.lab$Group==i,],
                                                     veganCovEllipse(elip.ord.lab[[i]]$cov,
                                                                     elip.ord.lab[[i]]$center,
                                                                     elip.ord.lab[[i]]$scale))),
                                  group=i))
}


# Ordination
nmds.lab.plot <- plot_ordination(physeq=physeq.lab, ordination=nmds.lab, color="Group") +
  scale_color_manual(values = c("lightcoral", "royalblue3", "deepskyblue", "limegreen"),
                    labels = c("Summer", "Torpor", "IBA", "Spring")) +
  geom_point(size = 2) +
  geom_path(data=elip.lab.df, aes(x=NMDS1, y=NMDS2, color=group), size=1, linetype=1) +
   theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=16, face="bold"),
        axis.title.y = element_text(size=16, face="bold"),
        legend.title = element_text(size=16, face="bold"),
        legend.text = element_text(size=16),
        plot.title = element_text(size=16, face="bold", hjust=0.5),
        plot.margin = unit(c(1,1,1,1), "mm"),      # top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,0,-10,-8)
        )

# Save plot
#tiff("nmds.lab.tiff", width=5, height=3.5, units="in", res=600)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,1))))

print(nmds.lab.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))

grid.text("stress = 0.141", x=unit(0.85, "npc"), y=unit(0.17, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=9))

#dev.off()


  
###### PERMANOVA - By Season for Sample Type ######
sampdf.lab <- data.frame(sample_data(physeq.lab))
bray.lab <- phyloseq::distance(physeq = physeq.lab, method = "bray")
beta.tax = betadisper(d=bray.lab, group=sampdf.lab$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.067
adonis(bray.lab ~ Group, data = sampdf.lab, permutations = 9999)
  # p-value = 0.0001
pairwise.adonis(as.matrix(bray.lab), sampdf.lab$Group, sim.method = "bray", p.adjust.m = "fdr")
  # Summer_Lab vs IBA = 0.000030*
  # Summer_Lab vs Torpor = 0.000030*
  # Summer_Lab vs Spring = 0.063456
  # IBA vs Torpor = 0.344260
  # IBA vs Spring = 0.000380*
  # Torpor vs Spring = 0.000495*

```
### Chow
```{r}
physeq.chow <- subset_samples(physeq, Sample_Type == "Chow")
chow.phy <- tax_glom(physeq.chow, taxrank="Phylum")
chow.phy99 <- transform_sample_counts(chow.phy, function(x){(x/sum(x))*100})
chow.phy99 <- prune_taxa(taxa_sums(chow.phy99) > 1, chow.phy99)

barplot(sort(taxa_sums(chow.phy99),TRUE)[1:20],las=2,cex.axis=.7)

chow.df <- psmelt(chow.phy99)
chow.df$Phylum <- ordered(chow.df$Phylum, levels=c("Proteobacteria", "Firmicutes", "Bacteroidetes", "Actinobacteria"))

#tiff("Chow.tiff", width=5, height=5, units="in", res=600)
ggplot(chow.df, aes(x=Phylum, y=Abundance, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  scale_fill_manual(values=c("#984ea3", "#e41a1c", "#377eb8", "#f781bf")) +
  xlab("Phyla") +
  ylab("Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,65),expand=c(0,0)) +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14),
        strip.text.x = element_text(size=12),
        strip.text.y = element_text(size=12),
        panel.spacing=unit(1, "lines"))
#dev.off()


#tiff("Chow.mdtp.tiff", width=8, height=6, units="in", res=300)
ggplot(chow.df, aes(x=Phylum, y=Abundance, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  scale_fill_manual(values=c("#984ea3", "#e41a1c", "#377eb8", "#f781bf")) +
  xlab("Phyla") +
  ylab("Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,65),expand=c(0,0)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18, face="bold"),
        legend.text = element_text(size=18),
        panel.grid.major = element_blank())
#dev.off()




##### Alpha Div
physeq.wchow <- subset_samples(physeq, Sample_Type != "Black_Tissue")
chow.adiv <- data.frame(sample_data(physeq.wchow))
chow.adiv.sum <- chow.adiv %>%
  group_by(Group) %>%
  summarize(Chao_Mean = mean(chao),
            Chao_Median = median(chao),
            Chao_SD = sd(chao),
            Chao_SE = (sd(chao)/sqrt(length(chao))),
            Chao_iqr = IQR(chao),
            InvSimp_Mean = mean(invsimpson),
            InvSimp_Median = median(invsimpson),
            InvSimp_SD = sd(invsimpson),
            InvSimp_SE = (sd(invsimpson)/sqrt(length(invsimpson))),
            InvSimp_iqr = IQR(invsimpson))

#tiff("Chow.chao.tiff", width=7, height=3, units="in", res=600)
ggplot(chow.adiv, aes(x=Group, y=chao, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  scale_fill_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen", "gray26")) +
  #scale_fill_manual(values=c("gray95", "dimgray") )+
  xlab("Group") +
  ylab("Chao Richness")
#dev.off()

#tiff("Chow.InvSimp.tiff", width=7, height=3, units="in", res=600)
ggplot(chow.adiv, aes(x=Group, y= invsimpson, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  scale_fill_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen", "gray26")) +
  xlab("Group") +
  ylab("Inverse Simpson Weighted Diversity")
#dev.off()
```


### Alpha Diversity - Wild vs. Lab
```{r}
# Subset summer samples
physeq.sum <- subset_samples(physeq.rem, Season == "Summer")

# Alpha diversity
adiv.sum <- data.frame(sample_data(sum.physeq))
adiv.sum$Habitat <- adiv.sum$Diet
adiv.sum$Habitat <- ordered(adiv.sum$Habitat, levels=c("Wild", "Captive"))
adiv.sum$Habitat[(adiv.sum$Diet == "Lab")] <- "Captive"


### Chao
hist(adiv.sum$chao, breaks=10)
qqnorm(adiv.sum$chao)
qqline(adiv.sum$chao)
shapiro.test(adiv.sum$chao)
  # p-value = 0.01554
  # Not Normal
kruskal.test(formula = chao ~ Diet, data = adiv.sum)
  # p-value = 0.0208


### Shannon
# Test normality
hist(adiv.sum$shannon, breaks=10)
qqnorm(adiv.sum$shannon)
qqline(adiv.sum$shannon)
shapiro.test(adiv.sum$shannon)
  # p-value = 0.2649
summary(aov(shannon ~ Diet, data = adiv.sum))
  # p-value = 0.0543


###### Boxplots ######

### Chao
chao.sum <- ggplot(adiv.sum, aes(x = Habitat, y = chao, fill = Habitat)) +
  geom_boxplot(position = position_dodge(1), outlier.shape = NA) +
  geom_jitter(size=2, width = 0.2) +
  scale_y_continuous(limits = c(0,2050), breaks = c(0, 500, 1000, 1500, 2000)) +
  ylab("Chao Richness") +
  scale_fill_manual(values = c("brown2", "lightcoral")) +
  labs(fill = "Group") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=16),
        strip.text.x = element_text(face ="bold", size=16),
        legend.title = element_text(face="bold", size=16),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(face="bold", size=16),
        axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=13),
        legend.text = element_text(size=14))


### Shannon
shannon.sum <- ggplot(adiv.sum, aes(x = Habitat, y = shannon, fill = Habitat)) +
  geom_boxplot(position = position_dodge(1), outlier.shape = NA) +
  geom_jitter(size=2, width = 0.25) +
  scale_y_continuous(limits = c(2.5, 6), breaks = c(2.5, 3.2, 3.9, 4.6, 5.3, 6.0)) +
  ylab("Shannon Diversity Index") +
  scale_fill_manual(values = c("brown2", "lightcoral")) +
  labs("Group") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=16),
        strip.text.x = element_text(face ="bold", size=16),
        legend.title = element_text(face="bold", size=16),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(face="bold", size=16),
        axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=13),
        legend.text = element_text(size=14))


### Combine plots
#tiff("adiv.sum.tiff", width = 8.5, height = 3.5, units = "in", res = 600)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,2))))
print(chao.sum, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(shannon.sum, vp=viewport(layout.pos.row=1, layout.pos.col=2))

grid.text("(A)", x=unit(0.031, "npc"), y=unit(0.974, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=15,fontface="bold"))
grid.text("(B)", x=unit(0.03, "npc"), y=unit(0.974, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2),gp=gpar(fontsize=15,fontface="bold"))

grid.text("a                  b", x=unit(0.435, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=12))
grid.text("ns", x=unit(0.435, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=12))
#dev.off()




###### Examine Phyla ######
# Merge samples with the same taxonomic rank
sum.goodphy <- tax_glom(sum.physeq, taxrank="Phylum")

# Transform each merged phylum count to rel abund
sum.phy99 <- transform_sample_counts(sum.goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
sum.phy99 <- prune_taxa(taxa_sums(sum.phy99) > 1, sum.phy99)


# Summarize data
sum.phy.df <- psmelt(sum.phy99)
sum.phy.df$Phylum <- ordered(sum.phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes","Verrucomicrobia", "Proteobacteria", "Unclassified", "Cyanobacteria", "Tenericutes", "Elusimicrobia"))
sum.phy.df$Phylum[which(is.na(sum.phy.df$Phylum))] <- rep("Unclassified",18)
sum.phy.sum <- sum.phy.df %>%
  group_by(Diet, Sample_Type, Phylum) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))


### Barplot ###
ggplot(sum.phy.sum, aes(x=Phylum, y=Mean, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=Mean + SE, ymin=Mean - SE), width=0.25) +
  facet_grid(Diet ~ Sample_Type) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Mean Relative Abundance for Phyla > 1%") +
  theme(axis.text.x = element_blank())





### Chao
ggplot(sum.adiv, aes(x=Diet, y=chao, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral") )+
  xlab("Diet") +
  ylab("Chao Richness")



### Shannon
ggplot(sum.adiv, aes(x=Diet, y=shannon, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral")) +
  xlab("Group") +
  ylab("Shannon Diversity")

# Test normality
hist(sum.adiv$shannon, breaks=10)
qqnorm(sum.adiv$shannon)
qqline(sum.adiv$shannon)
shapiro.test(sum.adiv$shannon)
  # p-value = 0.2649
ks.test(sum.adiv$shannon, "pnorm", mean=mean(sum.adiv$shannon), sd=sd(sum.adiv$shannon))
  # p-value = 0.6198

# Wilcoxon
t.test(shannon ~ Diet, data=sum.adiv)
  # p-value = 0.05814
t.test(shannon ~ Diet, data=sum.adiv.con)
  # p-value = 0.003129
t.test(shannon ~ Diet, data=sum.adiv.muc)
  # p-value = 0.9498
t.test(shannon ~ Sample_Type, data=sum.adiv)
  # p-value = 0.9695
t.test(shannon ~ Sample_Type, data=sum.adiv.lab)
  # p-value = 0.3654
t.test(shannon ~ Sample_Type, data=sum.adiv.wil)
  # p-value = 0.1508

# Inverse Simpson
ggplot(sum.adiv, aes(x=Diet, y= invsimpson, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral")) +
  xlab("Diet") +
  ylab("Inverse Simpson Diversity")

# Test normality
hist(sum.adiv$invsimpson, breaks=10)
qqnorm(sum.adiv$invsimpson)
qqline(sum.adiv$invsimpson)
shapiro.test(sum.adiv$invsimpson)
  # p-value = 0.01727
ks.test(sum.adiv$invsimpson, "pnorm", mean=mean(sum.adiv$invsimpson), sd=sd(sum.adiv$invsimpson))
  # p-value = 0.2989

# Wilcoxon
wilcox.test(invsimpson ~ Diet, data=sum.adiv)
  # p-value = 0.09825
wilcox.test(invsimpson ~ Diet, data=sum.adiv, subset=Sample_Type=="Content")
  # p-value = 0.01667
wilcox.test(invsimpson ~ Diet, data=sum.adiv, subset=Sample_Type=="Mucosa")
  # p-value = 0.8571
wilcox.test(invsimpson ~ Sample_Type, data=sum.adiv)
  # p-value = 0.8125
wilcox.test(invsimpson ~ Sample_Type, data=sum.adiv, subset=Diet=="Lab")
  # p-value = 0.6485
wilcox.test(invsimpson ~ Sample_Type, data=sum.adiv, subset=Diet=="Wild")
  # p-value = 0.2


###### Bray-Curtis ######
### Bray NMDS
sum.nmds <- ordinate(physeq=sum.physeq, method="NMDS", distance="bray")
  # stress = 0.07623348

plot_ordination(physeq=sum.physeq, ordination=sum.nmds, color="Diet", shape="Sample_Type")

# https://stackoverflow.com/questions/13794419/plotting-ordiellipse-function-from-vegan-package-onto-nmds-plot-created-in-ggplo

sample_data(sum.physeq)$Elip <- paste(sample_data(sum.physeq)$Diet, sample_data(sum.physeq)$Sample_Type)
elip.sum.nmds <- data.frame(MDS1 = sum.nmds$points[,1], MDS2 = sum.nmds$points[,2],
                        Group = sample_data(sum.physeq)$Elip)
plot.new()
elip.sum.ord <- ordiellipse(sum.nmds, sample_data(sum.physeq)$Elip, display="sites", kind="se", conf=0.95, label=T)

veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}

elip.sum.df <- data.frame()
for(i in levels(elip.sum.nmds$Group)){
  elip.sum.df <- rbind(elip.sum.df, cbind(as.data.frame(with(elip.sum.nmds[elip.sum.nmds$Group==i,],
                                                     veganCovEllipse(elip.sum.ord[[i]]$cov,
                                                                     elip.sum.ord[[i]]$center,
                                                                     elip.sum.ord[[i]]$scale))),
                                  group=i))
  
}




plot_ordination(physeq=sum.physeq, ordination=sum.nmds, color="Elip") +
  geom_path(data=elip.sum.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("darkgoldenrod", "darkgoldenrod1", "brown2", "lightcoral"))



### PERMANOVA
sum.sampdf <- data.frame(sample_data(sum.physeq))
sum.bray<- phyloseq::distance(physeq=sum.physeq, method="bray")
adonis(sum.bray~ Diet, data=sum.sampdf)
  # p-value = 0.001
beta.tax = betadisper(d=sum.bray, group=sum.sampdf$Diet)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.002
adonis(sum.bray~ Sample_Type, data=sum.sampdf)
  # p-value = 0.996
beta.tax = betadisper(d=sum.bray, group=sum.sampdf$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.656
```





### Beta Diversity - Wild vs. Lab
```{r}
# Subset summer samples
physeq.sum <- subset_samples(physeq.rem, Season == "Summer")

### Bray NMDS
#nmds.sum <- ordinate(physeq=physeq.sum, method="NMDS", distance="bray")
  # Stress = 0.05705866
#save(nmds.sum, file = "nmds.sum.RData")
load("nmds.lab.RData")


### PERMANOVA
sampdf.sum <- data.frame(sample_data(physeq.sum))
bray.sum <- phyloseq::distance(physeq = physeq.sum, method = "bray")
beta.tax = betadisper(d=bray.sum, group=sampdf.sum$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.002
anosim(bray.sum, sampdf.sum$Group, permutations = 1000)
  # p-value = 0.000999
  # R2 = 0.6165


##### Plot

# Ellipses
elip.nmds.sum <- data.frame(MDS1 = nmds.sum$points[,1], MDS2 = nmds.sum$points[,2],
                        Group = sample_data(physeq.sum)$Group)
plot.new()
elip.ord.sum <- ordiellipse(nmds.sum, sample_data(physeq.sum)$Group, display="sites", kind="se", conf=0.95, label=T)
elip.sum.df <- data.frame()
for(i in levels(elip.nmds.sum$Group)){
  elip.sum.df <- rbind(elip.sum.df, cbind(as.data.frame(with(elip.nmds.sum[elip.nmds.sum$Group==i,],
                                                     veganCovEllipse(elip.ord.sum[[i]]$cov,
                                                                     elip.ord.sum[[i]]$center,
                                                                     elip.ord.sum[[i]]$scale))),
                                  group=i))
}

# Ordination
nmds.sum.plot <- plot_ordination(physeq=physeq.sum, ordination=nmds.sum, color="Group") +
  scale_color_manual(values = c("brown2", "lightcoral"),
                    labels = c("Wild", "Captive")) +
  labs(color = "Group") +
  geom_point(size = 2) +
  geom_path(data=elip.sum.df, aes(x=NMDS1, y=NMDS2, color=group), size=1, linetype=1) +
   theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=16, face="bold"),
        axis.title.y = element_text(size=16, face="bold"),
        legend.title = element_text(size=16, face="bold"),
        legend.text = element_text(size=16),
        plot.title = element_text(size=16, face="bold", hjust=0.5),
        plot.margin = unit(c(1,1,1,1), "mm"),      # top, right, bottom, left
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,0,-10,-8)
        )


# Save plot
#tiff("nmds.sum.tiff", width=5, height=3.5, units="in", res=600)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,1))))
print(nmds.sum.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
grid.text("stress = 0.057", x=unit(0.865, "npc"), y=unit(0.17, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=9))
#dev.off()



```
### Examine Phyla
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.rem, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

# Create rank abundance of phyla
barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)

# Summarize data
phy.df <- psmelt(phy99)
phy.df$Phylum <- ordered(phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Unclassified", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia"))
phy.df$Phylum[which(is.na(phy.df$Phylum))] <- rep("Unclassified",18)
phy.sum <- phy.df %>%
  group_by(Group, Sample_Type, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

# Calculate IQR limits
phy.sum$iqr.min <- phy.sum$Median - 0.5*phy.sum$iqr
phy.sum[which(phy.sum$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
phy.sum$iqr.max <- phy.sum$Median + 0.5*phy.sum$iqr


### Barplot ###
tiff("Phyla.prelim.tiff", width=12, height=3.5, units="in", res=600)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,80),expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        #axis.title.x = element_text(size=10),
        #axis.title.y = element_text(size=10),
        #strip.text.x = element_text(size=8),
        #strip.text.y = element_text(size=8),
        panel.spacing=unit(1, "lines")#,
        #legend.title = element_text(size = 8),
        #legend.text = element_text(size=8)
        )
dev.off()

#tiff("Phyla3.tiff", width=13, height=8, units="in", res=600)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,80),expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12),
        axis.text.y = element_text(size=12))
#dev.off()

tiff("Phyla.mdtp.tiff", width=9.8, height=5.9, units="in", res=600)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,80),expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18),
        strip.text.x = element_text(size=13, face="bold"),
        strip.text.y = element_text(size=13, face="bold"),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 14, face="bold"),
        legend.text = element_text(size=13),
        panel.grid.major = element_blank()
        #panel.grid.minor = element_blank()
        )
dev.off()

tiff("Phyla.mdtp2.tiff", width=9.7, height=5.9, units="in", res=600)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,80),expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18),
        strip.text.x = element_text(size=16, face="bold"),
        strip.text.y = element_text(size=16, face="bold"),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 16),
        legend.text = element_text(size=14),
        panel.grid.major = element_blank()
        #panel.grid.minor = element_blank()
        )
dev.off()

# Pull out otu table to test phyla
phy.num <- as.numeric(otu_table(phy99))

# Test normality
hist(phy.num, breaks=10)
qqnorm(phy.num)
qqline(phy.num)
shapiro.test(phy.num)
  # p-value < 2.2e-16
ks.test(phy.num, "pnorm", mean=mean(phy.num), sd=sd(phy.num))
  # p-value < 2.2e-16

# Get ready for stats
sampdf <- data.frame(sample_data(phy99))
sampdf$Relative_Abundance <- otu_table(phy99)


### Examine Sex
# Summarize data
phy.df <- psmelt(phy99)
phy.df$Phylum <- ordered(phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Unclassified", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia"))
phy.df$Phylum[which(is.na(phy.df$Phylum))] <- rep("Unclassified",18)
phy.sex <- phy.df %>%
  group_by(Group, Sex, Sample_Type, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

# Calculate IQR limits
phy.sex$iqr.min <- phy.sum$Median - 0.5*phy.sum$iqr
phy.sex[which(phy.sum$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
phy.sex$iqr.max <- phy.sum$Median + 0.5*phy.sum$iqr

# Plot
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,80),expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12),
        axis.text.y = element_text(size=12))
```




### Simper - Lab squirrels
```{r}
# Change Group names to be compatible (no "_")
physeq.simp <- physeq.lab
rename.samp <- data.frame(sample_data(physeq.simp))
rename.lab <- which(data.frame(sample_data(physeq.simp))$Group == "Summer_Lab")
levels(rename.samp$Group) <- c("Summer", "Torpor", "IBA", "Spring")
rename.samp$Sex <- ordered(rename.samp$Sex, levels=c("Female","Male"))
physeq.simp <- merge_phyloseq(otu_table(physeq.rem), sample_data(rename.samp), tax_table(physeq.rem))


# Group
#simper.pretty(data.frame(otu_table(physeq.simp)),
              data.frame(sample_data(physeq.simp)),
              c("Group"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='lab_group')
lab.group.simper <- read.csv("lab_group_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(physeq.simp)),
               data.frame(sample_data(physeq.simp)),
               csv = lab.group.simper,
               c("Group"),
               output_name = 'lab_group',
               taxonomy = data.frame(tax_table(physeq.simp)))
lab.group.simper.kw <- read.csv("lab_group_krusk_simper.csv")
for(i in 1:nrow(lab.group.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.simp))) == lab.group.simper.kw$OTU[i])
  lab.group.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.simp))[save,2], "-",
          data.frame(tax_table(physeq.simp))[save,3], "-",
          data.frame(tax_table(physeq.simp))[save,4], "-",
          data.frame(tax_table(physeq.simp))[save,5], "-",
          data.frame(tax_table(physeq.simp))[save,6])
}
#write.table(lab.group.simper.kw, "lab_group_krusk_simper.csv", sep=",")




```
### Simper Heatmap - Lab squirrels
```{r}
# Subset sig OTUs
physeq.lab.simp.ra <- transform_sample_counts(physeq.simp, function(x){(x/sum(x))*100})
physeq.lab.simp.sig <- subset_taxa(physeq.lab.simp.ra, Species == "Otu00037" | 
                                     Species == "Otu00016" | Species == "Otu00032" | 
                                     Species == "Otu00001" | Species == "Otu00009" |
                                     Species == "Otu00045" | Species == "Otu00144")

# Create tax table
lab.simp.sig.tax <- data.frame(tax_table(physeq.lab.simp.sig))
lab.simp.sig.tax$Name <- c("Akkermansia", "Prevotellaceae", "Bacteroides", "Lachnospiraceae", "Lactobacillus", "Lactobacillus", "Lachnospiraceae")
lab.simp.sig.tax <- tax_table(lab.simp.sig.tax)
taxa_names(lab.simp.sig.tax) <- taxa_names(physeq.lab.simp.sig)

# Create otu table
lab.simp.sig.df <- psmelt(physeq.lab.simp.sig)
lab.simp.sig.sum <- lab.simp.sig.df %>%
  group_by(OTU, Group) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))
lab.simp.heatmap <- data.frame(matrix(NA,nrow = length(unique(lab.simp.sig.sum$OTU)), ncol = 8))
colnames(lab.simp.heatmap) <- c("OTU", "Summer", "Torpor", "IBA", "Spring", "Taxonomy", "Significance", "Name")
rownames(lab.simp.heatmap) <- unique(lab.simp.sig.sum$OTU)
lab.simp.heatmap$OTU <- unique(lab.simp.sig.sum$OTU)
for(i in 1:nrow(lab.simp.sig.sum)){
  otu <- lab.simp.sig.sum$OTU[i]
  group <- lab.simp.sig.sum$Group[i]
  ra <- lab.simp.sig.sum$Mean[i]
  
  row <- which(lab.simp.heatmap$OTU == otu)
  col <- which(colnames(lab.simp.heatmap) == group)
  
  lab.simp.heatmap[row, col] <- ra
}
lab.simp.heatmap$Taxonomy <- c("Verrucomicrobia - Verrucomicrobiae - Verrucomicrobiales - Verrucomicrobiaceae - Akkermansia", "Bacteroidetes - Bacteroidia - Bacteroidales - Prevotellaceae - Prevotellaceae_unclassified", "Bacteroidetes - Bacteroidia - Bacteroidales - Bacteroidaceae - Bacteroides", "Firmicutes - Clostridia - Clostridiales - Lachnospiraceae - Lachnospiraceae_unclassified", "Firmicutes - Bacilli - Lactobacillales - Lactobacillaceae - Lactobacillus", "Firmicutes - Bacilli - Lactobacillales - Lactobacillaceae - Lactobacillus", "Firmicutes - Clostridia - Clostridiales - Lachnospiraceae - Lachnospiraceae_unclassified")
lab.simp.heatmap$Significance <- c("IS", "PS_PT_PI", "TS", "ST_SI", "ST_SI_SP", "PT_PI", "PI")
lab.simp.heatmap$Name = c("Akkermansia", "Prevotellaceae", "Bacteroides", "Lachnospiraceae", "Lactobacillus", "Lactobacillus", "Lachnospiraceae")
lab.simp.heatmap <- lab.simp.heatmap[,-1]
lab.simp.heatmap <- lab.simp.heatmap[,-5:-7]

# Create sample data
lab.simp.heatmap.sampdat <- data.frame(c("Summer", "Torpor", "IBA", "Spring"))
colnames(lab.simp.heatmap.sampdat) <- "Group"
rownames(lab.simp.heatmap.sampdat) <- lab.simp.heatmap.sampdat$Group

# Create phyloseq object for simper heatmap
physeq.lab.simp.sig <- merge_phyloseq(otu_table(lab.simp.heatmap, taxa_are_rows=T), lab.simp.sig.tax, sample_data(lab.simp.heatmap.sampdat))
sample_data(physeq.lab.simp.sig)$Group <- ordered(sample_data(physeq.lab.simp.sig)$Group, levels=c("Summer", "Torpor", "IBA", "Spring"))


##### Plot Heatmap #####
#tiff("lab.bact.heatmap.tiff", width = 8, height = 6, units = "in", res = 600)
plot_heatmap(physeq.lab.simp.sig, sample.label = "Group", taxa.order = c("Otu00144", "Otu00045",
                                                                         "Otu00009", "Otu00001",
                                                                         "Otu00016", "Otu00037",
                                                                         "Otu00032")) +
  geom_tile(colour = "gray40") +
  geom_text(size = 5, aes(label=sprintf("%0.2f", round(Abundance, digits=2)))) +
  scale_fill_gradientn(name=expression("Mean Relative\nAbundance\n(%)"), limits = c(0,17),
                       breaks = c(0, 4.25, 8.5, 12.75, 17), colours = c("#FBFFFF", "#C2EDFF",
                                                                        "#93DFFF", "#62D1FF",
                                                                        "#1EBDFF","#00A4E8")) +
  scale_y_discrete(labels=c(expression(" "^H~"Lachnospiraceae"),
                            expression(" "^GH~italic("Lactobacillus")),
                            expression(" "^F~"Prevotallaceae"),
                            expression(" "^E~italic("Akkermansia")),
                            expression(" "^D~italic("Bacteroides")),
                            expression(" "^ABC~italic("Lactobacillus")),
                            expression(" "^AB~"Lachnospiraceae"))) +
  ylab("OTU Classification") +
  theme(panel.border=element_blank(),
        axis.text.x = element_text(angle=0, hjust=0.5, vjust=1.18, size=16, 
                                   margin = margin(t=0, r=0, b=0, l=0)),
        axis.text.y = element_text(size=16),
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_text(size=16, face="bold", margin = margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(margin = margin(t=0, r=0, b=0, l=0), size=14, face="bold"),
        axis.line=element_blank(),
        legend.title = element_text(size=16, face="bold"),
        legend.text = element_text(size=16),
        legend.margin = margin(t=0, r=-5, b=0, l=-8),
        legend.key.height = unit(0.70, "in"),
        plot.title = element_text(size=16, face="bold")
  )
#dev.off()

```


### Cyanobacteria???
```{r}
cya <- subset_taxa(physeq.rem, Phylum == "Cyanobacteria")
cya.tax <- data.frame(tax_table(cya))
cya.rel <- transform_sample_counts(cya, function(x){(x/sum(x))*100})
cya.rel <- subset_samples(cya.rel, sample_names(cya.rel)!= "CC1_923_S")
cya.rel <- subset_samples(cya.rel, sample_names(cya.rel)!= "CC1_925_I")
cya.rel <- subset_samples(cya.rel, sample_names(cya.rel)!= "CM1_916_P")
cya.rel <- prune_taxa(taxa_sums(cya.rel)>0, cya.rel)
View(data.frame(otu_table(cya.rel)))
View(data.frame(tax_table(cya.rel)))




### Simper @ Phylum-level
# Change Group names to be compatible (no "_")
physeq.simp <- physeq.rem
rename.samp <- data.frame(sample_data(physeq.simp))
rename.wild <- which(data.frame(sample_data(physeq.simp))$Group == "Summer_Wild")
rename.lab <- which(data.frame(sample_data(physeq.simp))$Group == "Summer_Lab")
levels(rename.samp$Group) <- c("SummerWild", "SummerLab", "Torpor", "IBA", "Spring")
physeq.simp <- merge_phyloseq(otu_table(physeq.rem), sample_data(rename.samp), tax_table(physeq.rem))
physeq.phylum <- tax_glom(physeq.simp, taxrank="Phylum")

# All

simper.pretty(data.frame(otu_table(physeq.phylum)),
              data.frame(sample_data(physeq.phylum)),
              c("Group", "Sample_Type"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='all.phylum')
all.phylum.simper <- read.csv("all.phylum_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.phylum)),
               data.frame(sample_data(physeq.phylum)),
               csv = all.phylum.simper,
               c("Group", "Sample_Type"),
               output_name = 'all.phylum',
               taxonomy = data.frame(tax_table(physeq.phylum)))
all.phylum.simper.kw <- read.csv("all.phylum_krusk_simper.csv")
for(i in 1:nrow(all.phylum.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.phylum))) == all.phylum.simper.kw$OTU[i])
  all.phylum.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.phylum))[save,2], "-",
          data.frame(tax_table(physeq.phylum))[save,3], "-",
          data.frame(tax_table(physeq.phylum))[save,4], "-",
          data.frame(tax_table(physeq.phylum))[save,5], "-",
          data.frame(tax_table(physeq.phylum))[save,6])
}
write.table(all.phylum.simper.kw, "all.phylum_krusk_simper.csv", sep=",")




### Test Cyano Phy Rel Abund
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.rem, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

# Pull out cyanos
cya.phy <- subset_taxa(phy99, Phylum == "Cyanobacteria")
cya.df <- data.frame(sample_data(cya.phy))
cya.df$RelAbund <- t(data.frame(otu_table(cya.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=cya.df)
  # p-value = 8.591e-05
kruskalmc(resp = RelAbund ~ Group, data=cya.df)
  # Summer_Wild vs. Summer_Lab
  # Summer_Wild vs. IBA
  # Summer_Wild vs. Spring
  # Torpor vs. Spring
pairwise.wilcox.test(cya.df$RelAbund, cya.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.00081
  # Wild-Torpor = 0.00083
  # Wild-IBA = 0.00074
  # Wild-Spring = 0.00291
  # Lab-Torpor = 0.10286
  # Lab-IBA = 1
  # Lab-Spring = 0.17796
  # Torpor-IBA = 0.01648
  # Torpor-Spring = 0.00391
  # IBA-Spring = 0.17796
kruskal.test(formula = RelAbund ~ Sample_Type, data=cya.df)
  # p-value = 0.733
```

### Verruco OTUs???
```{r}
ver <- subset_taxa(physeq.rem, Phylum == "Verrucomicrobia")
ver.tax <- data.frame(tax_table(ver))
ver.rel <- transform_sample_counts(ver, function(x){(x/sum(x))*100})
ver.rel <- subset_samples(ver.rel, sample_names(ver.rel)!= "CC1_923_S")
ver.rel <- subset_samples(ver.rel, sample_names(ver.rel)!= "CC1_925_I")
ver.rel <- subset_samples(ver.rel, sample_names(ver.rel)!= "CM1_916_P")
ver.rel <- prune_taxa(taxa_sums(ver.rel)>0, ver.rel)

```


### Test Phyla Rel Abund
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.rem, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

### CYANOBACTERIA ###
# Pull out cyanos
cya.phy <- subset_taxa(phy99, Phylum == "Cyanobacteria")
cya.df <- data.frame(sample_data(cya.phy))
cya.df$RelAbund <- t(data.frame(otu_table(cya.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=cya.df)
  # p-value = 8.591e-05
kruskalmc(resp = RelAbund ~ Group, data=cya.df)
  # Summer_Wild vs. Summer_Lab
  # Summer_Wild vs. IBA
  # Summer_Wild vs. Spring
  # Torpor vs. Spring
pairwise.wilcox.test(cya.df$RelAbund, cya.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.00081
  # Wild-Torpor = 0.00083
  # Wild-IBA = 0.00074
  # Wild-Spring = 0.00291
  # Lab-Torpor = 0.10286
  # Lab-IBA = 1
  # Lab-Spring = 0.17796
  # Torpor-IBA = 0.01648
  # Torpor-Spring = 0.00391
  # IBA-Spring = 0.17796
kruskal.test(formula = RelAbund ~ Sample_Type, data=cya.df)
  # p-value = 0.733




### FIRMICUTES ###
fir.phy <- subset_taxa(phy99, Phylum == "Firmicutes")
fir.df <- data.frame(sample_data(fir.phy))
fir.df$RelAbund <- t(data.frame(otu_table(fir.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=fir.df)
  # p-value = 7.758e-07
kruskalmc(resp = RelAbund ~ Group, data=fir.df)
  # Summer_Wild vs. Torpor
  # Summer_Wild vs. IBA
  # Summer_Lab vs. Torpor
  # Summer_Lab vs. IBA
pairwise.wilcox.test(fir.df$RelAbund, fir.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.80753
  # Wild-Torpor = 0.00062 
  # Wild-IBA = 0.00014
  # Wild-Spring = 0.17191
  # Lab-Torpor = 2.8e-05
  # Lab-IBA = 8.0e-06
  # Lab-Spring = 0.09894
  # Torpor-IBA = 0.72018
  # Torpor-Spring = 0.00326
  # IBA-Spring = 0.00062
kruskal.test(formula = RelAbund ~ Sample_Type, data=fir.df)
  # p-value = 0.6089




### BACTEROIDETES ###
bac.phy <- subset_taxa(phy99, Phylum == "Bacteroidetes")
bac.df <- data.frame(sample_data(bac.phy))
bac.df$RelAbund <- t(data.frame(otu_table(bac.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=bac.df)
  # p-value = 0.006097
kruskalmc(resp = RelAbund ~ Group, data=bac.df)
pairwise.wilcox.test(bac.df$RelAbund, bac.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.578
  # Wild-Torpor = 0.040
  # Wild-IBA = 0.040
  # Wild-Spring = 0.058
  # Lab-Torpor = 0.040
  # Lab-IBA = 0.040
  # Lab-Spring = 0.058
  # Torpor-IBA = 0.927
  # Torpor-Spring = 0.722
  # IBA-Spring = 0.607
kruskal.test(formula = RelAbund ~ Sample_Type, data=bac.df)
  # p-value = 0.03301





### Verrucomicrobia ###
ver.phy <- subset_taxa(phy99, Phylum == "Verrucomicrobia")
ver.df <- data.frame(sample_data(ver.phy))
ver.df$RelAbund <- t(data.frame(otu_table(ver.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=ver.df)
  # p-value = 1.621e-06
kruskalmc(resp = RelAbund ~ Group, data=ver.df)
  # Wild-Torpor
  # Wild-IBA
  # Lab-Torpor
  # Lab-IBA
  # Torpor-Spring
  # IBA-Spring
pairwise.wilcox.test(ver.df$RelAbund, ver.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 1
  # Wild-Torpor = 0.00042
  # Wild-IBA = 0.00021
  # Wild-Spring = 1
  # Lab-Torpor = 0.00011
  # Lab-IBA = 0.00011
  # Lab-Spring = 1
  # Torpor-IBA = 1
  # Torpor-Spring = 0.00021
  # IBA-Spring = 0.00021
kruskal.test(formula = RelAbund ~ Sample_Type, data=ver.df)
  # p-value = 0.6544




### PROTEOBACTERIA ###
pro.phy <- subset_taxa(phy99, Phylum == "Proteobacteria")
pro.df <- data.frame(sample_data(pro.phy))
pro.df$RelAbund <- t(data.frame(otu_table(pro.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=pro.df)
  # p-value = 0.02498
kruskalmc(resp = RelAbund ~ Group, data=pro.df)
pairwise.wilcox.test(pro.df$RelAbund, pro.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.430
  # Wild-Torpor = 0.023
  # Wild-IBA = 0.0144
  # Wild-Spring = 0.785
  # Lab-Torpor = 0.144
  # Lab-IBA = 0.420
  # Lab-Spring = 805
  # Torpor-IBA = 0.927
  # Torpor-Spring = 0.023
  # IBA-Spring = 0.229
kruskal.test(formula = RelAbund ~ Sample_Type, data=pro.df)
  # p-value = 0.2962




### UNCLASSIFIED ###
unc.phy <- subset_taxa(phy99, Phylum == "Bacteria_unclassified")
unc.df <- data.frame(sample_data(unc.phy))
unc.df$RelAbund <- t(data.frame(otu_table(unc.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=unc.df)
  # p-value = 0.08711
kruskalmc(resp = RelAbund ~ Group, data=unc.df)
pairwise.wilcox.test(unc.df$RelAbund, unc.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.192
  # Wild-Torpor = 0.192
  # Wild-IBA = 0.261
  # Wild-Spring = 0.034
  # Lab-Torpor = 0.409
  # Lab-IBA = 0.695
  # Lab-Spring = 0.348
  # Torpor-IBA = 0.840
  # Torpor-Spring = 0.961
  # IBA-Spring = 0.791
kruskal.test(formula = RelAbund ~ Sample_Type, data=unc.df)
  # p-value = 0.7733



### TENERICUTES ###
ten.phy <- subset_taxa(phy99, Phylum == "Tenericutes")
ten.df <- data.frame(sample_data(ten.phy))
ten.df$RelAbund <- t(data.frame(otu_table(ten.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=ten.df)
  # p-value = 0.02485
kruskalmc(resp = RelAbund ~ Group, data=ten.df)
  # Wild-Torpor
  # Wild-IBA
pairwise.wilcox.test(ten.df$RelAbund, ten.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.3235
  # Wild-Torpor = 0.0025
  # Wild-IBA = 0.0049
  # Wild-Spring = 0.5970
  # Lab-Torpor = 0.5012
  # Lab-IBA = 0.7848
  # Lab-Spring = 0.7629
  # Torpor-IBA = 0.7629
  # Torpor-Spring = 0.5874
  # IBA-Spring = 0.00021
kruskal.test(formula = RelAbund ~ Sample_Type, data=ten.df)
  # p-value = 0.6538



### ACTINOBACTERIA ###
act.phy <- subset_taxa(phy99, Phylum == "Actinobacteria")
act.df <- data.frame(sample_data(act.phy))
act.df$RelAbund <- t(data.frame(otu_table(act.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=act.df)
  # p-value = 0.03403
kruskalmc(resp = RelAbund ~ Group, data=act.df)
  # Wild-Spring
pairwise.wilcox.test(act.df$RelAbund, act.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.196
  # Wild-Torpor = 0.037
  # Wild-IBA = 0.042
  # Wild-Spring = 0.037
  # Lab-Torpor = 0.619
  # Lab-IBA = 0.618
  # Lab-Spring = 0.358
  # Torpor-IBA = 0.693
  # Torpor-Spring = 0.596
  # IBA-Spring = 0.458
kruskal.test(formula = RelAbund ~ Sample_Type, data=act.df)
  # p-value = 0.7981





### ELUSIMICROBIA ###
elu.phy <- subset_taxa(phy99, Phylum == "Elusimicrobia")
elu.df <- data.frame(sample_data(elu.phy))
elu.df$RelAbund <- t(data.frame(otu_table(elu.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=elu.df)
  # p-value = 0.03651
kruskalmc(resp = RelAbund ~ Group, data=elu.df)
pairwise.wilcox.test(elu.df$RelAbund, elu.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.11
  # Wild-Torpor = 0.11
  # Wild-IBA = 0.62
  # Wild-Spring = 0.10
  # Lab-Torpor = 0.97
  # Lab-IBA = 0.29
  # Lab-Spring = 0.29
  # Torpor-IBA = 0.29
  # Torpor-Spring = 0.49
  # IBA-Spring = 0.15
kruskal.test(formula = RelAbund ~ Sample_Type, data=elu.df)
  # p-value = 0.7981
```


