---
title: "Code"
author: "Edna Chiang"
date: "May 7, 2018"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(ggplot2)
library(gplots)
library(phangorn)
library(tidyr)
library(vegan)
library(phyloseq)
library(grid)
library(pgirmess)
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('scripts/veganCovEllipse.R')
source('scripts/simper_pretty.R')
source('scripts/R_krusk.R')
source('scripts/pairwise.adonis.R')
```

### Import Data
```{r}
# Link files
shared = "mothur_output/final.shared"
taxonomy = "mothur_output/final.taxonomy"


# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
```

### Explore mothurdata object
```{r}
samp.sum <- data.frame(colSums(otu_table(mothurdata)))
colnames(samp.sum) <- "Sample_TotalSeqs"
samp.sum$sample <- row.names(samp.sum)
samp.sum <- arrange(samp.sum, Sample_TotalSeqs)

ggplot(samp.sum, aes(x=reorder(sample, Sample_TotalSeqs), y=Sample_TotalSeqs)) +
  ylab("Number of Sequences per Sample") +
  geom_bar(stat="identity", colour="black", fill="cornflowerblue") +
  xlab("Sample Name") +
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45,hjust = 1,
                                   vjust = 1))

ggplot(data.frame(sum = sample_sums(mothurdata)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue", bins=60) + 
  ggtitle("Sample read counts") + 
  xlab("Total sequences")


# Min, Mean, Max of sample read counts
min(sample_sums(mothurdata))
mean(sample_sums(mothurdata))
median(sample_sums(mothurdata))
max(sample_sums(mothurdata))
```


### Interim Phyloseq Object
```{r}
meta <- read.csv("metadata2.csv")
colnames(meta)[1] <- "Sample"
rownames(meta) <- meta$Sample
divsum <- read.table("mothur_output/8494.summary", header=T)
remove <- setdiff(meta$Sample, divsum$group)
for(i in 1:length(remove)){
  meta <- meta[-which(meta$Sample == remove[i]),]
}
#meta <- meta[,-12:-14]

# Add in diversity summaries
meta[,11:20] <- divsum[,3:12]

# Create interim phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))

# Order factors
sample_data(physeq)$Season <- ordered(sample_data(physeq)$Season,
                                     levels=c("Summer", "Winter", "Spring"))
sample_data(physeq)$Metabolism <- ordered(sample_data(physeq)$Metabolism,
                                     levels=c("Active", "Torpor", "IBA"))
sample_data(physeq)$Group <- ordered(sample_data(physeq)$Group,
                                     levels=c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring", "Chow"))

# Remove unwanted samples
physeq.rem <- subset_samples(physeq, Sample_Type != "Black_Tissue" & Season != "NA")
physeq.rem <- subset_samples(physeq.rem, ID != "3916" & ID != "3925" )
rem <- names(which(taxa_sums(physeq.rem) > 10))
physeq.rem <- prune_taxa(rem, physeq.rem)


#save(physeq.rem, file="Physeq.RData")

# Separate by season
physeq.wild <- subset_samples(physeq.rem, Group == "Summer_Wild")
physeq.sum <- subset_samples(physeq.rem, Group == "Summer_Lab")
physeq.tor <- subset_samples(physeq.rem, Group == "Torpor")
physeq.iba <- subset_samples(physeq.rem, Group == "IBA")
physeq.spr <- subset_samples(physeq.rem, Group == "Spring")

# Separate by content/mucosa
physeq.con <- subset_samples(physeq.rem, Sample_Type == "Content")
physeq.muc <- subset_samples(physeq.rem, Sample_Type == "Mucosa")

# Pull out only lab squirrels
physeq.lab <- subset_samples(physeq.rem, Diet != "Wild")
```
### Test content vs. mucosa - Alpha Diversity
```{r}
adiv <- data.frame(sample_data(physeq.rem))

########## Compare Con vs. Muc. within Season ##########

# Separate by season
adiv.wild <- adiv[which(adiv$Group == "Summer_Wild"),]
adiv.sum <- adiv[which(adiv$Group == "Summer_Lab"),]
adiv.tor <- adiv[which(adiv$Group == "Torpor"),]
adiv.iba <- adiv[which(adiv$Group == "IBA"),]
adiv.spr <- adiv[which(adiv$Group == "Spring"),]


##### Chao #####
hist(adiv.wild$chao, breaks=10)
qqnorm(adiv.wild$chao)
qqline(adiv.wild$chao)
shapiro.test(adiv.wild$chao)
  # p-value = 0.3404
  # Normal
hist(adiv.sum$chao, breaks=10)
qqnorm(adiv.sum$chao)
qqline(adiv.sum$chao)
shapiro.test(adiv.sum$chao)
  # p-value = 0.6042
  # Normal
hist(adiv.tor$chao, breaks=10)
qqnorm(adiv.tor$chao)
qqline(adiv.tor$chao)
shapiro.test(adiv.tor$chao)
  # p-value = 0.1055
  # Normal
hist(adiv.iba$chao, breaks=10)
qqnorm(adiv.iba$chao)
qqline(adiv.iba$chao)
shapiro.test(adiv.iba$chao)
  # p-value = 0.03129
  # Not Normal
hist(adiv.spr$chao, breaks=10)
qqnorm(adiv.spr$chao)
qqline(adiv.spr$chao)
shapiro.test(adiv.spr$chao)
  # p-value = 0.3883
  # Normal

### Wilcoxon & T-Test ###
t.test(chao ~ Sample_Type, data = adiv.wild)
  # p-value = 0.3824
t.test(chao ~ Sample_Type, data = adiv.sum)
  # p-value = 0.8265
t.test(chao ~ Sample_Type, data = adiv.tor)
  # p-value = 0.03331*
wilcox.test(chao ~ Sample_Type, data = adiv.iba)
  # p-value = 0.4318
t.test(chao ~ Sample_Type, data = adiv.spr)
  # p-value = 0.9252



##### Shannon #####
hist(adiv.wild$shannon, breaks=10)
qqnorm(adiv.wild$shannon)
qqline(adiv.wild$shannon)
shapiro.test(adiv.wild$shannon)
  # p-value = 0.03979
  # Not Normal
hist(adiv.sum$shannon, breaks=10)
qqnorm(adiv.sum$shannon)
qqline(adiv.sum$shannon)
shapiro.test(adiv.sum$shannon)
  # p-value = 0.9038
  # Normal
hist(adiv.tor$shannon, breaks=10)
qqnorm(adiv.tor$shannon)
qqline(adiv.tor$shannon)
shapiro.test(adiv.tor$shannon)
  # p-value = 0.876
  # Normal
hist(adiv.iba$shannon, breaks=10)
qqnorm(adiv.iba$shannon)
qqline(adiv.iba$shannon)
shapiro.test(adiv.iba$shannon)
  # p-value = 0.7765
  # Normal
hist(adiv.spr$shannon, breaks=10)
qqnorm(adiv.spr$shannon)
qqline(adiv.spr$shannon)
shapiro.test(adiv.spr$shannon)
  # p-value = 0.3872
  # Normal

### Wilcoxon & T-Test ###
wilcox.test(shannon ~ Sample_Type, data = adiv.wild)
  # p-value = 0.2
t.test(shannon ~ Sample_Type, data = adiv.sum)
  # p-value = 0.3654
t.test(shannon ~ Sample_Type, data = adiv.tor)
  # p-value = 0.4803
t.test(shannon ~ Sample_Type, data = adiv.iba)
  # p-value = 0.4759
t.test(shannon ~ Sample_Type, data = adiv.spr)
  # p-value = 0.1112

```



### Test content vs. mucosa - Beta Diversity
```{r}
### Bray NMDS - All
nmds <- ordinate(physeq=physeq.rem, method="NMDS", distance="bray")
  # Stress = 0.1742581
plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group", shape="Sample_Type") + facet_grid(.~Group)
plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group", shape="Sex") + facet_grid(.~Group)

### Bray NMDS - By Season
nmds.wild <- ordinate(physeq=physeq.wild, method="NMDS", distance="bray")
  # stress = 0.1499987 
plot_ordination(physeq=physeq.wild, ordination=nmds.wild, color="Sample_Type", shape="Sample_Type")

nmds.sum <- ordinate(physeq=physeq.sum, method="NMDS", distance="bray")
  # stress = 0.07056971 
plot_ordination(physeq=physeq.sum, ordination=nmds.sum, color="Sample_Type", shape="Sample_Type")

nmds.tor <- ordinate(physeq=physeq.tor, method="NMDS", distance="bray")
  # stress = 0.1657292
plot_ordination(physeq=physeq.tor, ordination=nmds.tor, color="Sample_Type", shape="Sample_Type")

nmds.iba <- ordinate(physeq=physeq.iba, method="NMDS", distance="bray")
  # stress = 0.103724 
plot_ordination(physeq=physeq.iba, ordination=nmds.iba, color="Sample_Type", shape="Sample_Type")

nmds.spr <- ordinate(physeq=physeq.spr, method="NMDS", distance="bray")
  # stress = 0.1859594
plot_ordination(physeq=physeq.spr, ordination=nmds.spr, color="Sample_Type", shape="Sample_Type")



###### PERMANOVA - By Season for Sample Type ######

sampdf.wild <- data.frame(sample_data(physeq.wild))
bray.wild <- phyloseq::distance(physeq = physeq.wild, method = "bray")
beta.tax = betadisper(d=bray.wild, group=sampdf.wild$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.9013889
adonis(bray.wild ~ Sample_Type, data = sampdf.wild, permutations = 9999)
  # p-value = 0.7

sampdf.sum <- data.frame(sample_data(physeq.sum))
bray.sum <- phyloseq::distance(physeq = physeq.sum, method = "bray")
beta.tax = betadisper(d=bray.sum, group=sampdf.sum$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.321
adonis(bray.sum ~ Sample_Type, data = sampdf.sum, permutations = 9999)
  # p-value = 0.9792

sampdf.tor <- data.frame(sample_data(physeq.tor))
bray.tor <- phyloseq::distance(physeq = physeq.tor, method = "bray")
beta.tax = betadisper(d=bray.tor, group=sampdf.tor$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.737
adonis(bray.tor ~ Sample_Type, data = sampdf.tor, permutations = 9999)
  # p-value = 0.9442

sampdf.iba <- data.frame(sample_data(physeq.iba))
bray.iba <- phyloseq::distance(physeq = physeq.iba, method = "bray")
beta.tax = betadisper(d=bray.iba, group=sampdf.iba$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.795
adonis(bray.iba ~ Sample_Type, data = sampdf.iba, permutations = 9999)
  # p-value = 0.9598

sampdf.spr <- data.frame(sample_data(physeq.spr))
bray.spr <- phyloseq::distance(physeq = physeq.spr, method = "bray")
beta.tax = betadisper(d=bray.spr, group=sampdf.spr$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.008333
anosim(bray.spr, sampdf.spr$Sample_Type, permutations = 1000)
  # p-value = 1
```
### Test content & mucosa separately for season - Alpha Diversity
```{r}
### Alpha-Diversity
adiv <- data.frame(sample_data(physeq.rem))

### Separate content & mucosa
physeq.con <- subset_samples(physeq.rem, Sample_Type == "Content")
physeq.muc <- subset_samples(physeq.rem, Sample_Type == "Mucosa")

# Remove empty taxa
rem <- names(which(taxa_sums(physeq.con) > 10))
physeq.con <- prune_taxa(rem, physeq.con)
rem <- names(which(taxa_sums(physeq.muc) > 10))
physeq.muc <- prune_taxa(rem, physeq.muc)


### Alpha-Diversity
adiv.con <- data.frame(sample_data(physeq.con))
adiv.muc <- data.frame(sample_data(physeq.muc))



##### Chao #####
hist(adiv.con$chao, breaks=10)
qqnorm(adiv.con$chao)
qqline(adiv.con$chao)
shapiro.test(adiv.con$chao)
  # p-value = 0.04263
  # Not Normal
hist(adiv.muc$chao, breaks=10)
qqnorm(adiv.muc$chao)
qqline(adiv.muc$chao)
shapiro.test(adiv.muc$chao)
  # p-value = 0.0001347
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = chao ~ Group, data = adiv.con)
  # p-value = 0.02644
kruskalmc(resp = chao ~ Group, data = adiv.con)
  # Summer_Wild-Spring
kruskal.test(formula = chao ~ Group, data = adiv.muc)
  # p-value = 0.1638
# Con/muc combined
kruskal.test(formula = chao ~ Group, data = adiv)
  # p-value = 0.01262
kruskalmc(resp = chao ~ Group, data = adiv)
  # Summer_Wild-Spring 



##### Shannon #####
hist(adiv.con$shannon, breaks=10)
qqnorm(adiv.con$shannon)
qqline(adiv.con$shannon)
shapiro.test(adiv.con$shannon)
  # p-value = 0.7362
  # Normal
hist(adiv.muc$shannon, breaks=10)
qqnorm(adiv.muc$shannon)
qqline(adiv.muc$shannon)
shapiro.test(adiv.muc$shannon)
  # p-value = 0.2441
  # Normal

# ANOVA
summary(aov(shannon ~ Group, data = adiv.con))
  # p-value = 0.00195
TukeyHSD(aov(shannon ~ Group, data = adiv.con))
  # Summer_Lab-Summer_Wild = 0.03567322*
  # Torpor-Summer_Wild =  0.1132440
  # IBA-Summer_Wild = 0.1949274
  # Spring-Summer_Wild = 0.0007291*
  # Torpor-Summer_Lab = 0.9836541
  # IBA-Summer_Lab = 0.8885960
  # Spring-Summer_Lab = 0.0832229
  # IBA-Torpor = 0.9961265
  # Spring-Torpor = 0.0494151*
  # Spring-IBA = 0.0263590*
summary(aov(shannon ~ Group, data = adiv.muc))
  # p-value = 0.751
summary(aov(shannon ~ Group, data = adiv))
  # p-value = 0.00903*
TukeyHSD(aov(shannon ~ Group, data = adiv))
  # Summer_Lab-Summer_Wild = 0.2076838
  # Torpor-Summer_Wild = 0.1364256
  # IBA-Summer_Wild = 0.2187595
  # Spring-Summer_Wild = 0.0028812*
  # Torpor-Summer_Lab = 0.9980816
  # IBA-Summer_Lab = 0.9999930
  # Spring-Summer_Lab = 0.1460725
  # IBA-Torpor = 0.9953298
  # Spring-Torpor = 0.2450932
  # Spring-IBA = 0.1219430

```


### Test content & mucosa separately for season - Beta Diversity
```{r}
### Combined Bray
nmds <- ordinate(physeq=physeq.rem, method="NMDS", distance="bray")
  # stress = 0.1328032 
plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group")

### Combined PERMANOVA
sampdf <- data.frame(sample_data(physeq.rem))
bray <- phyloseq::distance(physeq = physeq.rem, method = "bray")
beta.tax = betadisper(d=bray, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.015
anosim(bray, sampdf$Group, permutations = 1000)
  # p-value = 0.000999


 

### Bray NMDS
nmds.con <- ordinate(physeq=physeq.con, method="NMDS", distance="bray")
  # stress = 0.1583457  
nmds.muc <- ordinate(physeq=physeq.muc, method="NMDS", distance="bray")
  # stress = 0.1276705 
plot_ordination(physeq=physeq.con, ordination=nmds.con, color="Group")
plot_ordination(physeq=physeq.muc, ordination=nmds.muc, color="Group")


### PERMANOVA
sampdf.con <- data.frame(sample_data(physeq.con))
bray.con <- phyloseq::distance(physeq = physeq.con, method = "bray")
beta.tax = betadisper(d=bray.con, group=sampdf.con$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.183
adonis(bray.con ~ Group, data = sampdf.con, permutations = 9999)
  # p-value = 1e-04
pairwise.adonis(as.matrix(bray.con), sampdf.con$Group, sim.method = "bray", p.adjust.m = "fdr")
  # Summer_Wild vs Summer_Lab = 0.03685714*
  # Summer_Wild vs IBA = 0.0297619*
  # Summer_Wild vs Torpor = 0.0297619*
  # Summer_Wild vs Spring = 0.125
  # Summer_Lab vs IBA = 0.0143*
  # Summer_Lab vs Torpor = 0.01945*
  # Summer_Lab vs Spring = 0.50896667
  # IBA vs Torpor = 0.77242
  # IBA vs Spring = 0.02976190*
  # Torpor vs Spring = 0.02976190*

sampdf.muc <- data.frame(sample_data(physeq.muc))
bray.muc <- phyloseq::distance(physeq = physeq.muc, method = "bray")
beta.tax = betadisper(d=bray.muc, group=sampdf.muc$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.103
adonis(bray.muc ~ Group, data = sampdf.muc)
  # p-value = 0.001
pairwise.adonis(as.matrix(bray.muc), sampdf.muc$Group, sim.method = "bray", p.adjust.m = "fdr")
  # Summer_Wild vs Summer_Lab = 0.0816326
  # Summer_Wild vs IBA = 0.02746667*
  # Summer_Wild vs Torpor = 0.04464286*
  # Summer_Wild vs Spring = 0.125
  # Summer_Lab vs IBA = 0.02746667*
  # Summer_Lab vs Torpor = 0.02746667*
  # Summer_Lab vs Spring = 0.8
  # IBA vs Torpor = 0.8
  # IBA vs Spring = 0.05576
  # Torpor vs Spring = 0.07936508
```
### Test only lab squirrels for season - Alpha Diversity
```{r}
adiv.lab <- data.frame(sample_data(physeq.lab))

# Remove empty taxa
# All taxa have > 10 reads
#rem <- names(which(taxa_sums(physeq.lab) > 10))
#physeq.lab.rem <- prune_taxa(rem, physeq.lab)



##### Chao #####
hist(adiv.lab$chao, breaks=10)
qqnorm(adiv.lab$chao)
qqline(adiv.lab$chao)
shapiro.test(adiv.lab$chao)
  # p-value = 0.0001635
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = chao ~ Group, data = adiv.lab)
  # p-value = 0.1209



##### Shannon #####
hist(adiv.lab$shannon, breaks=10)
qqnorm(adiv.lab$shannon)
qqline(adiv.lab$shannon)
shapiro.test(adiv.lab$shannon)
  # p-value = 0.7015
  # Normal

# ANOVA
summary(aov(shannon ~ Group, data = adiv.lab))
  # p-value = 0.0932


```
### Test only lab squirrels separated by content/mucosa for season - Alpha Diversity
```{r}
adiv.lab <- data.frame(sample_data(physeq.lab))


### Separate content & mucosa
physeq.lab.con <- subset_samples(physeq.lab, Sample_Type == "Content")
physeq.lab.muc <- subset_samples(physeq.lab, Sample_Type == "Mucosa")

# Remove empty taxa
rem <- names(which(taxa_sums(physeq.lab.con) > 10))
physeq.lab.con <- prune_taxa(rem, physeq.lab.con)
rem <- names(which(taxa_sums(physeq.lab.muc) > 10))
physeq.lab.muc <- prune_taxa(rem, physeq.lab.muc)


### Alpha-Diversity
adiv.lab.con <- data.frame(sample_data(physeq.lab.con))
adiv.lab.muc <- data.frame(sample_data(physeq.lab.muc))



##### Chao #####
hist(adiv.lab.con$chao, breaks=10)
qqnorm(adiv.lab.con$chao)
qqline(adiv.lab.con$chao)
shapiro.test(adiv.lab.con$chao)
  # p-value = 0.2104
  # Normal
hist(adiv.lab.muc$chao, breaks=10)
qqnorm(adiv.lab.muc$chao)
qqline(adiv.lab.muc$chao)
shapiro.test(adiv.lab.muc$chao)
  # p-value = 9.925e-05
  # Not Normal

# Kruskal-Wallis
summary(aov(formula = chao ~ Group, data = adiv.lab.con))
  # p-value = 0.208
kruskal.test(formula = chao ~ Group, data = adiv.lab.muc)
  # p-value = 0.1849




##### Shannon #####
hist(adiv.lab.con$shannon, breaks=10)
qqnorm(adiv.lab.con$shannon)
qqline(adiv.lab.con$shannon)
shapiro.test(adiv.lab.con$shannon)
  # p-value = 0.5944
  # Normal
hist(adiv.lab.muc$shannon, breaks=10)
qqnorm(adiv.lab.muc$shannon)
qqline(adiv.lab.muc$shannon)
shapiro.test(adiv.lab.muc$shannon)
  # p-value = 0.5848
  # Normal

# ANOVA
summary(aov(shannon ~ Group, data = adiv.lab.con))
  # p-value = 0.0314
TukeyHSD(aov(shannon ~ Group, data = adiv.lab.con))
  # Torpor-Summer_Lab = 0.9585678
  # IBA-Summer_Lab = 0.8229425
  # Spring-Summer_Lab = 0.0792214
  # IBA-Torpor = 0.9859815
  # Spring-Torpor = 0.0490387*
  # Spring-IBA = 0.0276141*
summary(aov(shannon ~ Group, data = adiv.lab.muc))
  # p-value = 0.744

```
### Test only lab squirrels for group - Beta Diversity
```{r}
### Bray NMDS
nmds.lab <- ordinate(physeq=physeq.lab, method="NMDS", distance="bray")
  # Stress = 0.1413397
plot_ordination(physeq=physeq.lab, ordination=nmds, color="Group", shape="Sample_Type") 
  
###### PERMANOVA - By Season for Sample Type ######
sampdf.lab <- data.frame(sample_data(physeq.lab))
bray.lab <- phyloseq::distance(physeq = physeq.lab, method = "bray")
beta.tax = betadisper(d=bray.lab, group=sampdf.lab$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.067
adonis(bray.lab ~ Group, data = sampdf.lab, permutations = 9999)
  # p-value = 0.0001
pairwise.adonis(as.matrix(bray.lab), sampdf.lab$Group, sim.method = "bray", p.adjust.m = "fdr")
  # Summer_Lab vs IBA = 0.000030*
  # Summer_Lab vs Torpor = 0.000030*
  # Summer_Lab vs Spring = 0.063456
  # IBA vs Torpor = 0.344260
  # IBA vs Spring = 0.000380*
  # Torpor vs Spring = 0.000495*

```
### Test only lab squirrels separated by content/mucosa for season - Beta Diversity
```{r}
### Bray NMDS
nmds.lab.con <- ordinate(physeq=physeq.lab.con, method="NMDS", distance="bray")
  # stress = 0.1090854   
nmds.lab.muc <- ordinate(physeq=physeq.lab.muc, method="NMDS", distance="bray")
  # stress = 0.2006364 
plot_ordination(physeq=physeq.lab.con, ordination=nmds.lab.con, color="Group")
plot_ordination(physeq=physeq.lab.muc, ordination=nmds.lab.muc, color="Group")


### PERMANOVA
sampdf.lab.con <- data.frame(sample_data(physeq.lab.con))
bray.lab.con <- phyloseq::distance(physeq = physeq.lab.con, method = "bray")
beta.tax = betadisper(d=bray.lab.con, group=sampdf.lab.con$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.446
adonis(bray.lab.con ~ Group, data = sampdf.lab.con, permutations = 9999)
  # p-value = 0.001
pairwise.adonis(as.matrix(bray.lab.con), sampdf.lab.con$Group, sim.method = "bray", p.adjust.m = "fdr")
  # Summer_Lab vs IBA = 0.00834*
  # Summer_Lab vs Torpor = 0.01848*
  # Summer_Lab vs Spring = 0.56781
  # IBA vs Torpor = 0.79393
  # IBA vs Spring = 0.02678571*
  # Torpor vs Spring = 0.02678571*

sampdf.lab.muc <- data.frame(sample_data(physeq.lab.muc))
bray.lab.muc <- phyloseq::distance(physeq = physeq.lab.muc, method = "bray")
beta.tax = betadisper(d=bray.lab.muc, group=sampdf.lab.muc$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.14
adonis(bray.lab.muc ~ Group, data = sampdf.lab.muc, permutations = 9999)
  # p-value = 0.0017
pairwise.adonis(as.matrix(bray.lab.muc), sampdf.lab.muc$Group, sim.method = "bray", p.adjust.m = "fdr")
  # Summer_Lab vs IBA = 0.01776*
  # Summer_Lab vs Torpor = 0.02451*
  # Summer_Lab vs Spring = 0.78183
  # IBA vs Torpor = 0.78183
  # IBA vs Spring = 0.05454
  # Torpor vs Spring = 0.07142857
```



### Chow
```{r}
physeq.chow <- subset_samples(physeq, Sample_Type == "Chow")
chow.phy <- tax_glom(physeq.chow, taxrank="Phylum")
chow.phy99 <- transform_sample_counts(chow.phy, function(x){(x/sum(x))*100})
chow.phy99 <- prune_taxa(taxa_sums(chow.phy99) > 1, chow.phy99)

barplot(sort(taxa_sums(chow.phy99),TRUE)[1:20],las=2,cex.axis=.7)

chow.df <- psmelt(chow.phy99)
chow.df$Phylum <- ordered(chow.df$Phylum, levels=c("Proteobacteria", "Firmicutes", "Bacteroidetes", "Actinobacteria"))

#tiff("Chow.tiff", width=5, height=5, units="in", res=600)
ggplot(chow.df, aes(x=Phylum, y=Abundance, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  scale_fill_manual(values=c("#984ea3", "#e41a1c", "#377eb8", "#f781bf")) +
  xlab("Phyla") +
  ylab("Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,65),expand=c(0,0)) +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14),
        strip.text.x = element_text(size=12),
        strip.text.y = element_text(size=12),
        panel.spacing=unit(1, "lines"))
#dev.off()


#tiff("Chow.mdtp.tiff", width=8, height=6, units="in", res=300)
ggplot(chow.df, aes(x=Phylum, y=Abundance, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  scale_fill_manual(values=c("#984ea3", "#e41a1c", "#377eb8", "#f781bf")) +
  xlab("Phyla") +
  ylab("Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,65),expand=c(0,0)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18, face="bold"),
        legend.text = element_text(size=18),
        panel.grid.major = element_blank())
#dev.off()




##### Alpha Div
physeq.wchow <- subset_samples(physeq, Sample_Type != "Black_Tissue")
chow.adiv <- data.frame(sample_data(physeq.wchow))
chow.adiv.sum <- chow.adiv %>%
  group_by(Group) %>%
  summarize(Chao_Mean = mean(chao),
            Chao_Median = median(chao),
            Chao_SD = sd(chao),
            Chao_SE = (sd(chao)/sqrt(length(chao))),
            Chao_iqr = IQR(chao),
            InvSimp_Mean = mean(invsimpson),
            InvSimp_Median = median(invsimpson),
            InvSimp_SD = sd(invsimpson),
            InvSimp_SE = (sd(invsimpson)/sqrt(length(invsimpson))),
            InvSimp_iqr = IQR(invsimpson))

#tiff("Chow.chao.tiff", width=7, height=3, units="in", res=600)
ggplot(chow.adiv, aes(x=Group, y=chao, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  scale_fill_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen", "gray26")) +
  #scale_fill_manual(values=c("gray95", "dimgray") )+
  xlab("Group") +
  ylab("Chao Richness")
#dev.off()

#tiff("Chow.InvSimp.tiff", width=7, height=3, units="in", res=600)
ggplot(chow.adiv, aes(x=Group, y= invsimpson, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  scale_fill_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen", "gray26")) +
  xlab("Group") +
  ylab("Inverse Simpson Weighted Diversity")
#dev.off()
```

### Load Phyloseq Object
```{r}
load("Physeq.RData")
```

### Examine Summer Lab vs. Wild
```{r}
sum.physeq <- subset_samples(physeq.rem, Season == "Summer")

###### Examine Phyla ######
# Merge samples with the same taxonomic rank
sum.goodphy <- tax_glom(sum.physeq, taxrank="Phylum")

# Transform each merged phylum count to rel abund
sum.phy99 <- transform_sample_counts(sum.goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
sum.phy99 <- prune_taxa(taxa_sums(sum.phy99) > 1, sum.phy99)


# Summarize data
sum.phy.df <- psmelt(sum.phy99)
sum.phy.df$Phylum <- ordered(sum.phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes","Verrucomicrobia", "Proteobacteria", "Unclassified", "Cyanobacteria", "Tenericutes", "Elusimicrobia"))
sum.phy.df$Phylum[which(is.na(sum.phy.df$Phylum))] <- rep("Unclassified",18)
sum.phy.sum <- sum.phy.df %>%
  group_by(Diet, Sample_Type, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

# Calculate IQR limits
sum.phy.sum$iqr.min <- sum.phy.sum$Median - 0.5*sum.phy.sum$iqr
sum.phy.sum[which(sum.phy.sum$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
sum.phy.sum$iqr.max <- sum.phy.sum$Median + 0.5*sum.phy.sum$iqr


### Barplot ###
ggplot(sum.phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=Mean + SE, ymin=Mean - SE), width=0.25) +
  facet_grid(Diet ~ Sample_Type) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Mean Relative Abundance for Phyla > 1%") +
  theme(axis.text.x = element_blank())


###### Alpha-Diversity ######
sum.adiv <- data.frame(sample_data(sum.physeq))

sum.adiv.con <- sum.adiv[which(sum.adiv$Sample_Type=="Content"),]
sum.adiv.muc <- sum.adiv[which(sum.adiv$Sample_Type=="Mucosa"),]
sum.adiv.lab <- sum.adiv[which(sum.adiv$Diet=="Lab"),]
sum.adiv.wil <- sum.adiv[which(sum.adiv$Diet=="Wild"),]

# Total OTUs
# Make the original, unnormalized phyloseq object

sum.otu.tot <- data.frame(sample_names(sum.physeq))
# Pull out # of OTUs from all samples
sum.otu.tot$Total_OTUs <- rep("NA", 17)
for(i in 1:17){
  sum.otu.tot[i,2] <- length(which(otu_table(sum.physeq)[,i] != 0))
}
colnames(sum.otu.tot) <- c("Sample", "Total_OTUs")
sum.otu.tot$Total_OTUs <- as.integer(sum.otu.tot$Total_OTUs)
sum.otusum <- sum.adiv
sum.otusum$Total_OTUs <- sum.otu.tot$Total_OTUs

# Color by group
ggplot(sum.otusum, aes(x=Diet, y=Total_OTUs, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral")) +
  xlab("Group") +
  ylab("Total OTUs")

# Test normality
hist(sum.otusum$Total_OTUs, breaks=10)
qqnorm(sum.otusum$Total_OTUs)
qqline(sum.otusum$Total_OTUs)
shapiro.test(sum.otusum$Total_OTUs)
  # p-value = 0.0071
  # Not normal
ks.test(sum.otusum$Total_OTUs, "pnorm", mean=mean(sum.otusum$Total_OTUs), sd=sd(sum.otusum$Total_OTUs))
  # p-value = 0.1352

# Wilcoxon
wilcox.test(Total_OTUs ~ Diet, data=sum.otusum)
  # p-value = 0.0001616
wilcox.test(Total_OTUs ~ Diet, data=sum.otusum, subset=Sample_Type=="Content")
  # p-value = 0.01667
wilcox.test(Total_OTUs ~ Diet, data=sum.otusum, subset=Sample_Type=="Mucosa")
  # p-value = 0.05714
wilcox.test(Total_OTUs ~ Sample_Type, data=sum.otusum)
  # p-value = 0.8868
wilcox.test(Total_OTUs ~ Sample_Type, data=sum.otusum, subset=Diet=="Lab")
  # p-value = 0.7879
wilcox.test(Total_OTUs ~ Sample_Type, data=sum.otusum, subset=Diet=="Wild")
  # p-value = 1




### Chao
ggplot(sum.adiv, aes(x=Diet, y=chao, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral") )+
  xlab("Diet") +
  ylab("Chao Richness")

# Test normality
hist(sum.adiv$chao, breaks=10)
qqnorm(sum.adiv$chao)
qqline(sum.adiv$chao)
shapiro.test(sum.adiv$chao)
  # p-value = 0.01554
  # Not normal
ks.test(sum.adiv$chao, "pnorm", mean=mean(sum.adiv$chao), sd=sd(sum.adiv$chao))
  # p-value = 0.6185

# Wilcoxon
wilcox.test(chao ~ Diet, data=sum.adiv)
  # p-value = 0.0202
wilcox.test(chao ~ Diet, data=sum.adiv, subset=Sample_Type=="Content")
  # p-value = 0.01667
wilcox.test(chao ~ Diet, data=sum.adiv, subset=Sample_Type=="Mucosa")
  # p-value = 0.8571
wilcox.test(chao ~ Sample_Type, data=sum.adiv)
  # p-value = 0.9623
wilcox.test(chao ~ Sample_Type, data=sum.adiv, subset=Diet=="Lab")
  # p-value = 0.7879
wilcox.test(chao ~ Sample_Type, data=sum.adiv, subset=Diet=="Wild")
  # p-value = 0.4






### Berger-Parker
ggplot(sum.adiv, aes(x=Diet, y=bergerparker, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral") )+
  xlab("Diet") +
  ylab("Berger-Parker")

# Test normality
hist(sum.adiv$bergerparker, breaks=10)
qqnorm(sum.adiv$bergerparker)
qqline(sum.adiv$bergerparker)
shapiro.test(sum.adiv$bergerparker)
  # p-value = 0.008697
ks.test(sum.adiv$bergerparker, "pnorm", mean=mean(sum.adiv$bergerparker), sd=sd(sum.adiv$bergerparker))
  # p-value = 0.4016

# Wilcoxon
wilcox.test(bergerparker ~ Diet, data=sum.adiv)
  # p-value = 0.149
wilcox.test(bergerparker ~ Diet, data=sum.adiv, subset=Sample_Type=="Content")
  # p-value = 0.03333
wilcox.test(bergerparker ~ Diet, data=sum.adiv, subset=Sample_Type=="Mucosa")
  # p-value = 0.8571
wilcox.test(bergerparker ~ Sample_Type, data=sum.adiv)
  # p-value = 0.9623
wilcox.test(bergerparker ~ Sample_Type, data=sum.adiv, subset=Diet=="Lab")
  # p-value = 0.6485
wilcox.test(bergerparker ~ Sample_Type, data=sum.adiv, subset=Diet=="Wild")
  # p-value = 0.4





### Shannon
ggplot(sum.adiv, aes(x=Diet, y=shannon, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral")) +
  xlab("Group") +
  ylab("Shannon Diversity")

# Test normality
hist(sum.adiv$shannon, breaks=10)
qqnorm(sum.adiv$shannon)
qqline(sum.adiv$shannon)
shapiro.test(sum.adiv$shannon)
  # p-value = 0.2649
ks.test(sum.adiv$shannon, "pnorm", mean=mean(sum.adiv$shannon), sd=sd(sum.adiv$shannon))
  # p-value = 0.6198

# Wilcoxon
t.test(shannon ~ Diet, data=sum.adiv)
  # p-value = 0.05814
t.test(shannon ~ Diet, data=sum.adiv.con)
  # p-value = 0.003129
t.test(shannon ~ Diet, data=sum.adiv.muc)
  # p-value = 0.9498
t.test(shannon ~ Sample_Type, data=sum.adiv)
  # p-value = 0.9695
t.test(shannon ~ Sample_Type, data=sum.adiv.lab)
  # p-value = 0.3654
t.test(shannon ~ Sample_Type, data=sum.adiv.wil)
  # p-value = 0.1508

# Inverse Simpson
ggplot(sum.adiv, aes(x=Diet, y= invsimpson, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral")) +
  xlab("Diet") +
  ylab("Inverse Simpson Diversity")

# Test normality
hist(sum.adiv$invsimpson, breaks=10)
qqnorm(sum.adiv$invsimpson)
qqline(sum.adiv$invsimpson)
shapiro.test(sum.adiv$invsimpson)
  # p-value = 0.01727
ks.test(sum.adiv$invsimpson, "pnorm", mean=mean(sum.adiv$invsimpson), sd=sd(sum.adiv$invsimpson))
  # p-value = 0.2989

# Wilcoxon
wilcox.test(invsimpson ~ Diet, data=sum.adiv)
  # p-value = 0.09825
wilcox.test(invsimpson ~ Diet, data=sum.adiv, subset=Sample_Type=="Content")
  # p-value = 0.01667
wilcox.test(invsimpson ~ Diet, data=sum.adiv, subset=Sample_Type=="Mucosa")
  # p-value = 0.8571
wilcox.test(invsimpson ~ Sample_Type, data=sum.adiv)
  # p-value = 0.8125
wilcox.test(invsimpson ~ Sample_Type, data=sum.adiv, subset=Diet=="Lab")
  # p-value = 0.6485
wilcox.test(invsimpson ~ Sample_Type, data=sum.adiv, subset=Diet=="Wild")
  # p-value = 0.2


###### Bray-Curtis ######
### Bray NMDS
sum.nmds <- ordinate(physeq=sum.physeq, method="NMDS", distance="bray")
  # stress = 0.07623348

plot_ordination(physeq=sum.physeq, ordination=sum.nmds, color="Diet", shape="Sample_Type")

# https://stackoverflow.com/questions/13794419/plotting-ordiellipse-function-from-vegan-package-onto-nmds-plot-created-in-ggplo

sample_data(sum.physeq)$Elip <- paste(sample_data(sum.physeq)$Diet, sample_data(sum.physeq)$Sample_Type)
elip.sum.nmds <- data.frame(MDS1 = sum.nmds$points[,1], MDS2 = sum.nmds$points[,2],
                        Group = sample_data(sum.physeq)$Elip)
plot.new()
elip.sum.ord <- ordiellipse(sum.nmds, sample_data(sum.physeq)$Elip, display="sites", kind="se", conf=0.95, label=T)

veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}

elip.sum.df <- data.frame()
for(i in levels(elip.sum.nmds$Group)){
  elip.sum.df <- rbind(elip.sum.df, cbind(as.data.frame(with(elip.sum.nmds[elip.sum.nmds$Group==i,],
                                                     veganCovEllipse(elip.sum.ord[[i]]$cov,
                                                                     elip.sum.ord[[i]]$center,
                                                                     elip.sum.ord[[i]]$scale))),
                                  group=i))
  
}




plot_ordination(physeq=sum.physeq, ordination=sum.nmds, color="Elip") +
  geom_path(data=elip.sum.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("darkgoldenrod", "darkgoldenrod1", "brown2", "lightcoral"))



### PERMANOVA
sum.sampdf <- data.frame(sample_data(sum.physeq))
sum.bray<- phyloseq::distance(physeq=sum.physeq, method="bray")
adonis(sum.bray~ Diet, data=sum.sampdf)
  # p-value = 0.001
beta.tax = betadisper(d=sum.bray, group=sum.sampdf$Diet)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.002
adonis(sum.bray~ Sample_Type, data=sum.sampdf)
  # p-value = 0.996
beta.tax = betadisper(d=sum.bray, group=sum.sampdf$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.656
```


### Alpha Div
```{r}
adiv <- data.frame(sample_data(physeq.rem))


# Coverage
ggplot(adiv, aes(x=Group, y= coverage, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen")) +
  xlab("Group") +
  ylab("Coverage")


### Chao
# Color by group
tiff("Chao.mdtp.tiff", width=9.1, height=5.5, units="in", res=600)
ggplot(adiv, aes(x=Group, y=chao, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  scale_fill_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen")) +
  #scale_fill_manual(values=c("gray95", "dimgray") )+
  xlab("Group") +
  ylab("Chao Richness") +
  theme(axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=13),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        #strip.text.x = element_text(size=12),
        #strip.text.y = element_text(size=12),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 16, face="bold"),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank()
        #panel.grid.minor = element_blank()
        )
dev.off()

        
        
dev.off()
# Color by group, facet by sample type
tiff("Chao.facet.tiff", width=11, height=3.5, units="in", res=600)
ggplot(adiv, aes(x=Group, y=chao, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen")) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Chao Richness")
dev.off()

# Test normality
hist(adiv$chao, breaks=10)
qqnorm(adiv$chao)
qqline(adiv$chao)
shapiro.test(adiv$chao)
  # p-value = 6.315e-05
  # Not Normal
ks.test(adiv$chao, "pnorm", mean=mean(adiv$chao), sd=sd(adiv$chao))
  # p-value = 0.4076
  # Normal

# Kruskal-Wallis
kruskal.test(formula = chao ~ Group, data = adiv)
  # p-value = 0.01262
kruskalmc(resp = chao ~ Group, data = adiv)
  # Significant:
    # Summer_Wild-Spring
kruskal.test(formula = chao ~ Group, data = adiv, subset=Diet=="Lab")
  # p-value = 0.1209
kruskal.test(formula = chao ~ Diet, data = adiv, subset=Season=="Summer")
  # p-value = 0.0208




### Shannon
# Color by group
ggplot(adiv, aes(x=Group, y=shannon, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Shannon Diversity")
# Color by group, facet by sample type
ggplot(adiv, aes(x=Group, y=shannon, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Shannon Diversity")

# Test normality
hist(adiv$shannon, breaks=10)
qqnorm(adiv$shannon)
qqline(adiv$shannon)
shapiro.test(adiv$shannon)
  # p-value = 0.3654
  # Normal
ks.test(adiv$shannon, "pnorm", mean=mean(adiv$shannon), sd=sd(adiv$shannon))
  # p-value = 0.8523
  # Normal

# ANOVA
summary(aov(shannon ~ Group, data=adiv))
  # p-value = 0.00903
TukeyHSD(aov(shannon ~ Group, data=adiv))
  # Summer_Lab-Summer_Wild = 0.2076838
  # Torpor-Summer_Wild = 0.1364256
  # IBA-Summer_Wild = 0.2187595
  # Spring-Summer_Wild = 0.0028812*
  # Torpor-Summer_Lab = 0.9980816
  # IBA-Summer_Lab = 0.9999930
  # Spring-Summer_Lab = 0.1460725
  # IBA-Torpor = 0.9953298
  # Spring-Torpor = 0.2450932
  # Spring-IBA = 0.1219430


```


### Examine Phyla
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.rem, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

# Create rank abundance of phyla
barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)

# Summarize data
phy.df <- psmelt(phy99)
phy.df$Phylum <- ordered(phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Unclassified", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia"))
phy.df$Phylum[which(is.na(phy.df$Phylum))] <- rep("Unclassified",18)
phy.sum <- phy.df %>%
  group_by(Group, Sample_Type, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

# Calculate IQR limits
phy.sum$iqr.min <- phy.sum$Median - 0.5*phy.sum$iqr
phy.sum[which(phy.sum$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
phy.sum$iqr.max <- phy.sum$Median + 0.5*phy.sum$iqr


### Barplot ###
tiff("Phyla.prelim.tiff", width=12, height=3.5, units="in", res=600)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,80),expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        #axis.title.x = element_text(size=10),
        #axis.title.y = element_text(size=10),
        #strip.text.x = element_text(size=8),
        #strip.text.y = element_text(size=8),
        panel.spacing=unit(1, "lines")#,
        #legend.title = element_text(size = 8),
        #legend.text = element_text(size=8)
        )
dev.off()

#tiff("Phyla3.tiff", width=13, height=8, units="in", res=600)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,80),expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12),
        axis.text.y = element_text(size=12))
#dev.off()

tiff("Phyla.mdtp.tiff", width=9.8, height=5.9, units="in", res=600)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,80),expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18),
        strip.text.x = element_text(size=13, face="bold"),
        strip.text.y = element_text(size=13, face="bold"),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 14, face="bold"),
        legend.text = element_text(size=13),
        panel.grid.major = element_blank()
        #panel.grid.minor = element_blank()
        )
dev.off()

tiff("Phyla.mdtp2.tiff", width=9.7, height=5.9, units="in", res=600)
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,80),expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18),
        strip.text.x = element_text(size=16, face="bold"),
        strip.text.y = element_text(size=16, face="bold"),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 16),
        legend.text = element_text(size=14),
        panel.grid.major = element_blank()
        #panel.grid.minor = element_blank()
        )
dev.off()

# Pull out otu table to test phyla
phy.num <- as.numeric(otu_table(phy99))

# Test normality
hist(phy.num, breaks=10)
qqnorm(phy.num)
qqline(phy.num)
shapiro.test(phy.num)
  # p-value < 2.2e-16
ks.test(phy.num, "pnorm", mean=mean(phy.num), sd=sd(phy.num))
  # p-value < 2.2e-16

# Get ready for stats
sampdf <- data.frame(sample_data(phy99))
sampdf$Relative_Abundance <- otu_table(phy99)


### Examine Sex
# Summarize data
phy.df <- psmelt(phy99)
phy.df$Phylum <- ordered(phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Unclassified", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia"))
phy.df$Phylum[which(is.na(phy.df$Phylum))] <- rep("Unclassified",18)
phy.sex <- phy.df %>%
  group_by(Group, Sex, Sample_Type, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

# Calculate IQR limits
phy.sex$iqr.min <- phy.sum$Median - 0.5*phy.sum$iqr
phy.sex[which(phy.sum$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
phy.sex$iqr.max <- phy.sum$Median + 0.5*phy.sum$iqr

# Plot
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  scale_y_continuous(limits=c(0,80),expand=c(0,0))+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        strip.text.x = element_text(size=14),
        strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 14),
        legend.text = element_text(size=12),
        axis.text.y = element_text(size=12))
```




### Bray-Curtis NMDS Ordination
```{r}
### Bray NMDS
nmds <- ordinate(physeq=physeq.rem, method="NMDS", distance="bray")
  # Stress = 0.1026393

plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group", shape="Sample_Type")

plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group", shape="Sex") + facet_grid(.~Group)

sample_data(physeq.rem)$Elip <- paste(sample_data(physeq.rem)$Group)
elip.nmds <- data.frame(MDS1 = nmds$points[,1], MDS2 = nmds$points[,2],
                        Group = sample_data(physeq.rem)$Elip)
plot.new()
elip.ord <- ordiellipse(nmds, sample_data(physeq.rem)$Elip, display="sites", kind="se", conf=0.95, label=T)


elip.df <- data.frame()
for(i in levels(elip.nmds$Group)){
  elip.df <- rbind(elip.df, cbind(as.data.frame(with(elip.nmds[elip.nmds$Group==i,],
                                                     veganCovEllipse(elip.ord[[i]]$cov,
                                                                     elip.ord[[i]]$center,
                                                                     elip.ord[[i]]$scale))),
                                  group=i))
  
}


tiff("NMDS.tiff", width=6, height=5, units="in", res=600)
plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group") +
  geom_path(data=elip.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen"))
dev.off()

tiff("NMDS.samptype.tiff", width=6, height=5, units="in", res=600)
plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group", shape = "Sample_Type") +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen")) +
  scale_shape_manual(values=c(19,2))
dev.off()

tiff("NMDS.mdtp.tiff", width=8, height=6, units="in", res=600)
plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group") +
  geom_point(size=3) +
  geom_path(data=elip.df, aes(x=NMDS1, y=NMDS2, colour=group), size=2, linetype=1) +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen")) +
    theme(axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        )
dev.off()




  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18),
        strip.text.x = element_text(size=13, face="bold"),
        strip.text.y = element_text(size=13, face="bold"),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 14, face="bold"),
        legend.text = element_text(size=13),
        panel.grid.major = element_blank()
        #panel.grid.minor = element_blank()
        )

### PERMANOVA
sampdf <- data.frame(sample_data(physeq.rem))
bray<- phyloseq::distance(physeq=physeq.rem, method="bray")
beta.tax = betadisper(d=bray, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.006
anosim(bray, sampdf$Group, permutations = 1000)
# p-value = 0.000999

```



### Sex NMDS
```{r}
nmds <- ordinate(physeq=physeq.rem, method="NMDS", distance="bray")
  # Stress = 0.102554

plot_ordination(physeq=physeq.rem, ordination=nmds, color="Sex", shape="Sample_Type")

sample_data(physeq.rem)$Elip <- paste(sample_data(physeq.rem)$Sex)
elip.nmds <- data.frame(MDS1 = nmds$points[,1], MDS2 = nmds$points[,2],
                        Sex = sample_data(physeq.rem)$Elip)
plot.new()
elip.ord <- ordiellipse(nmds, sample_data(physeq.rem)$Elip, display="sites", kind="se", conf=0.95, label=T)


elip.df <- data.frame()
for(i in levels(elip.nmds$Sex)){
  elip.df <- rbind(elip.df, cbind(as.data.frame(with(elip.nmds[elip.nmds$Sex==i,],
                                                     veganCovEllipse(elip.ord[[i]]$cov,
                                                                     elip.ord[[i]]$center,
                                                                     elip.ord[[i]]$scale))),
                                  Sex=i))
  
}

plot_ordination(physeq=physeq.rem, ordination=nmds, color="Sex") +
  geom_path(data=elip.df, aes(x=NMDS1, y=NMDS2, colour=Sex), size=1, linetype=1)

### Sex PERMANOVA
sampdf <- data.frame(sample_data(physeq.rem))
bray<- phyloseq::distance(physeq=physeq.rem, method="bray")
adonis(bray~ Sex, data=sampdf)  
  # p-value = 0.017
beta.tax = betadisper(d=bray, group=sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.613

# Content
physeq.con <- subset_samples(physeq.rem, Sample_Type == "Content")
sampdf <- data.frame(sample_data(physeq.con))
bray<- phyloseq::distance(physeq=physeq.con, method="bray")
adonis(bray~ Sex, data=sampdf)  
  # p-value = 0.33
beta.tax = betadisper(d=bray, group=sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.626

# Mucosa
physeq.muc <- subset_samples(physeq.rem, Sample_Type == "Mucosa")
sampdf <- data.frame(sample_data(physeq.muc))
bray<- phyloseq::distance(physeq=physeq.muc, method="bray")
adonis(bray~ Sex, data=sampdf)  
  # p-value = 0.74
beta.tax = betadisper(d=bray, group=sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.951

# Summer_Wild
physeq.wil <- subset_samples(physeq.rem, Group == "Summer_Wild")
sampdf <- data.frame(sample_data(physeq.wil))
bray<- phyloseq::distance(physeq=physeq.wil, method="bray")
adonis(bray~ Sex, data=sampdf)  
  # p-value = 0.06667
beta.tax = betadisper(d=bray, group=sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.0014

# Summer_Lab
physeq.lab <- subset_samples(physeq.rem, Group == "Summer_Lab")
sampdf <- data.frame(sample_data(physeq.lab))
bray<- phyloseq::distance(physeq=physeq.lab, method="bray")
adonis(bray~ Sex, data=sampdf)  
  # p-value = 0.012
beta.tax = betadisper(d=bray, group=sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.041

# Torpor
physeq.tor <- subset_samples(physeq.rem, Group == "Torpor")
sampdf <- data.frame(sample_data(physeq.tor))
bray<- phyloseq::distance(physeq=physeq.tor, method="bray")
adonis(bray~ Sex, data=sampdf)  
  # p-value = 0.055
beta.tax = betadisper(d=bray, group=sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.954

# IBA
physeq.iba <- subset_samples(physeq.rem, Group == "IBA")
sampdf <- data.frame(sample_data(physeq.iba))
bray<- phyloseq::distance(physeq=physeq.iba, method="bray")
adonis(bray~ Sex, data=sampdf)  
  # p-value = 0.065
beta.tax = betadisper(d=bray, group=sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.46

# Spring
physeq.spr <- subset_samples(physeq.rem, Group == "Spring")
sampdf <- data.frame(sample_data(physeq.spr))
bray<- phyloseq::distance(physeq=physeq.spr, method="bray")
adonis(bray~ Sex, data=sampdf)  
  # p-value = 0.128
beta.tax = betadisper(d=bray, group=sampdf$Sex)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.04

# PERMANOVA BH Correction
p.adjust(c(0.017, 0.33, 0.74, 0.06667, 0.012, 0.055, 0.065, 0.128), method="BH")
  # All = 0.0680000
  # Content = 0.3771429
  # Mucosa = 0.7400000
  # Summer_Wild = 0.1066720
  # Summer_Lab = 0.0680000
  # Torpor = 0.1066720
  # IBA = 0.1066720
  # Spring = 0.1706667

p.adjust(c(0.017, 0.06667, 0.012, 0.055, 0.065, 0.128), method="BH")
  # All = 0.051000
  # Summer_Wild = 0.080004
  # Summer_Lab = 0.051000
  # Torpor = 0.080004
  # IBA = 0.080004
  # Spring = 0.128000
       
```


### Bray-Curtis PCoA Ordination
```{r}
### Bray NMDS
nmds <- ordinate(physeq=physeq.rem, method="NMDS", distance="bray")
  # Stress = 0.102554

plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group", shape="Sample_Type")

bray.pcoa <- ordinate(physeq=physeq.rem, method="PCoA", distance="bray")
plot_ordination(physeq=physeq.rem, ordination=bray.pcoa, axes=c(1,2), color="Group", shape="Sample_Type")



plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group") +
  geom_path(data=elip.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen"))






sample_data(physeq.rem)$ElipPCoA <- paste(sample_data(physeq.rem)$Group)
elip.pcoa <- data.frame(Axis1 = bray.pcoa$vectors[,1], Axis2 = bray.pcoa$vectors[,2],
                        Group = sample_data(physeq.rem)$ElipPCoA)
bray.pcoa.elip <- bray.pcoa
bray.pcoa.elip <- bray.pcoa.elip$vectors[,-3:-41]
  # ordiellipse can only work w/ 1 axes. If you have more than 2 (like in a PCoA), it won't work
plot.new()
elip.bray.pcoa.ord <- ordiellipse(bray.pcoa.elip, sample_data(physeq.rem)$ElipPCoA, display="sites", kind="se", conf=0.95, label=T)

veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}

elip.bray.pcoa.df <- data.frame()
for(i in levels(elip.bray.pcoa.ord$Group)){
  elip.bray.pcoa.df <- rbind(elip.bray.pcoa.df, cbind(as.data.frame(with(elip.pcoa[elip.pcoa$Group==i,],
                                                     veganCovEllipse(elip.bray.pcoa.ord[[i]]$cov,
                                                                     elip.bray.pcoa.ord[[i]]$center,
                                                                     elip.bray.pcoaord[[i]]$scale))),
                                  group=i))
  
}




plot_ordination(physeq=physeq.rem, ordination=bray.pcoa, color="Group") +
  geom_path(data=elip.bray.pcoa.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen"))


### PERMANOVA
sampdf <- data.frame(sample_data(physeq.rem))
bray<- phyloseq::distance(physeq=physeq.rem, method="bray")
adonis(bray~ Group, data=sampdf)
  # p-value = 0.001
beta.tax = betadisper(d=bray, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.026
adonis(bray~ Sample_Type, data=sampdf)
  # p-value = 1
beta.tax = betadisper(d=bray, group=sampdf$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.192

combos <- combn(x=levels(sampdf$Group), m=2)
bray.pvals <- data.frame(rep(999,10))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.rem, Group%in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals) <- "pval"
bray.pvals$Adj.bonf <- p.adjust(bray.pvals$pval, method="bonferroni")
bray.pvals$Adj.BH <- p.adjust(bray.pvals$pval, method="BH")

sampdf2 <- data.frame(sample_data(physeq.rem))
combos2 <- combn(x=levels(sampdf2$Group), m=2)
bray.pvals2 <- data.frame(rep(999,10))
for( i in 1:ncol(combos2)){
  temp.physeq2 <- subset_samples(physeq.rem, Group%in% combos2[,i])
  temp.sampdf2 <- data.frame(sample_data(temp.physeq2))
  temp.bray2 <- phyloseq::distance(physeq=temp.physeq2, method="bray")
  test2 <- adonis(temp.bray2 ~ Group, data=temp.sampdf2)
  rownames(bray.pvals2)[i] <- paste(combos2[1,i], combos2[2,i])
  bray.pvals2[i,1]<- test2[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals2) <- "pval"
bray.pvals2$Adj.bonf <- p.adjust(bray.pvals2$pval, method="bonferroni")
bray.pvals2$Adj.BH <- p.adjust(bray.pvals2$pval, method="BH")



sampdf <- data.frame(sample_data(physeq.rem))
bray<- phyloseq::distance(physeq=physeq.rem, method="bray")
adonis(bray~ Group, data=sampdf)

#pulls out p-value:
  test[[1]]$`Pr(>F)`[1]
  #https://stackoverflow.com/questions/3366506/extract-p-value-from-aov?utm_medium=organic&utm_source=google_rich_qa&utm_campaign=google_rich_qa
```




### Bray-Curtis Content
```{r}
### Bray NMDS

physeq.con <- subset_samples(physeq.rem, Sample_Type == "Content")
nmds.con <- ordinate(physeq=physeq.con, method="NMDS", distance="bray")
  # Stress = 0.1129313

plot_ordination(physeq=physeq.con, ordination=nmds.con, color="Group")


sample_data(physeq.con)$Elip <- paste(sample_data(physeq.con)$Group)
elip.nmds.con <- data.frame(MDS1 = nmds.con$points[,1], MDS2 = nmds.con$points[,2],
                        Group = sample_data(physeq.con)$Elip)
plot.new()
elip.ord.con <- ordiellipse(nmds.con, sample_data(physeq.con)$Elip, display="sites", kind="se", conf=0.95, label=T)

veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}

elip.con.df <- data.frame()
for(i in levels(elip.nmds.con$Group)){
  elip.con.df <- rbind(elip.con.df, cbind(as.data.frame(with(elip.nmds.con[elip.nmds.con$Group==i,],
                                                     veganCovEllipse(elip.ord.con[[i]]$cov,
                                                                     elip.ord.con[[i]]$center,
                                                                     elip.ord.con[[i]]$scale))),
                                  group=i))
  
}




plot_ordination(physeq=physeq.con, ordination=nmds.con, color="Group") +
  geom_path(data=elip.con.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen"))


### PERMANOVA
sampdf.con <- data.frame(sample_data(physeq.con))
bray<- phyloseq::distance(physeq=physeq.con, method="bray")
adonis(bray~ Group, data=sampdf.con)
  # p-value = 0.001
beta.tax = betadisper(d=bray, group=sampdf.con$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.54


combos <- combn(x=levels(sampdf.con$Group), m=2)
bray.pvals <- data.frame(rep(999,10))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.con, Group%in% combos[,i])
  temp.sampdf.con <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf.con)
  rownames(bray.pvals)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals) <- "pval"
bray.pvals$Adj.bonf <- p.adjust(bray.pvals$pval, method="bonferroni")
bray.pvals$Adj.BH <- p.adjust(bray.pvals$pval, method="BH")

sampdf.con2 <- data.frame(sample_data(physeq.rem))
combos2 <- combn(x=levels(sampdf.con2$Group), m=2)
bray.pvals2 <- data.frame(rep(999,10))
for( i in 1:ncol(combos2)){
  temp.physeq2 <- subset_samples(physeq.rem, Group%in% combos2[,i])
  temp.sampdf.con2 <- data.frame(sample_data(temp.physeq2))
  temp.bray2 <- phyloseq::distance(physeq=temp.physeq2, method="bray")
  test2 <- adonis(temp.bray2 ~ Group, data=temp.sampdf.con2)
  rownames(bray.pvals2)[i] <- paste(combos2[1,i], combos2[2,i])
  bray.pvals2[i,1]<- test2[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals2) <- "pval"
bray.pvals2$Adj.bonf <- p.adjust(bray.pvals2$pval, method="bonferroni")
bray.pvals2$Adj.BH <- p.adjust(bray.pvals2$pval, method="BH")
```



### Bray-Curtis Mucosa
```{r}
### Bray NMDS

physeq.muc <- subset_samples(physeq.rem, Sample_Type == "Mucosa")
nmds.muc <- ordinate(physeq=physeq.muc, method="NMDS", distance="bray")
  # Stress = 0.08935057

plot_ordination(physeq=physeq.muc, ordination=nmds.muc, color="Group")


sample_data(physeq.muc)$Elip <- paste(sample_data(physeq.muc)$Group)
elip.nmds.muc <- data.frame(MDS1 = nmds.muc$points[,1], MDS2 = nmds.muc$points[,2],
                        Group = sample_data(physeq.muc)$Elip)
plot.new()
elip.ord.muc <- ordiellipse(nmds.muc, sample_data(physeq.muc)$Elip, display="sites", kind="se", conf=0.95, label=T)

veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}

elip.muc.df <- data.frame()
for(i in levels(elip.nmds.muc$Group)){
  elip.muc.df <- rbind(elip.muc.df, cbind(as.data.frame(with(elip.nmds.muc[elip.nmds.muc$Group==i,],
                                                     veganCovEllipse(elip.ord.muc[[i]]$cov,
                                                                     elip.ord.muc[[i]]$center,
                                                                     elip.ord.muc[[i]]$scale))),
                                  group=i))
  
}




plot_ordination(physeq=physeq.muc, ordination=nmds.muc, color="Group") +
  geom_path(data=elip.muc.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen"))


### PERMANOVA
sampdf.con <- data.frame(sample_data(physeq.muc))
bray<- phyloseq::distance(physeq=physeq.muc, method="bray")
adonis(bray~ Group, data=sampdf.con)
  # p-value = 0.001
beta.tax = betadisper(d=bray, group=sampdf.con$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.54


combos <- combn(x=levels(sampdf.con$Group), m=2)
bray.pvals <- data.frame(rep(999,10))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.muc, Group%in% combos[,i])
  temp.sampdf.con <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf.con)
  rownames(bray.pvals)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals) <- "pval"
bray.pvals$Adj.bonf <- p.adjust(bray.pvals$pval, method="bonferroni")
bray.pvals$Adj.BH <- p.adjust(bray.pvals$pval, method="BH")

sampdf.con2 <- data.frame(sample_data(physeq.rem))
combos2 <- combn(x=levels(sampdf.con2$Group), m=2)
bray.pvals2 <- data.frame(rep(999,10))
for( i in 1:ncol(combos2)){
  temp.physeq2 <- subset_samples(physeq.rem, Group%in% combos2[,i])
  temp.sampdf.con2 <- data.frame(sample_data(temp.physeq2))
  temp.bray2 <- phyloseq::distance(physeq=temp.physeq2, method="bray")
  test2 <- adonis(temp.bray2 ~ Group, data=temp.sampdf.con2)
  rownames(bray.pvals2)[i] <- paste(combos2[1,i], combos2[2,i])
  bray.pvals2[i,1]<- test2[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals2) <- "pval"
bray.pvals2$Adj.bonf <- p.adjust(bray.pvals2$pval, method="bonferroni")
bray.pvals2$Adj.BH <- p.adjust(bray.pvals2$pval, method="BH")
```





### Simper
```{r}
# Change Group names to be compatible (no "_")
physeq.simp <- physeq.rem
rename.samp <- data.frame(sample_data(physeq.simp))
rename.wild <- which(data.frame(sample_data(physeq.simp))$Group == "Summer_Wild")
rename.lab <- which(data.frame(sample_data(physeq.simp))$Group == "Summer_Lab")
levels(rename.samp$Group) <- c("SummerWild", "SummerLab", "Torpor", "IBA", "Spring")
rename.samp$Sex <- ordered(rename.samp$Sex, levels=c("Female","Male"))
physeq.simp <- merge_phyloseq(otu_table(physeq.rem), sample_data(rename.samp), tax_table(physeq.rem))


# All
simper.pretty(data.frame(otu_table(physeq.simp)),
              data.frame(sample_data(physeq.simp)),
              c("Group", "Sample_Type", "Sex"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='all')
all.simper <- read.csv("all_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.simp)),
               data.frame(sample_data(physeq.simp)),
               csv = all.simper,
               c("Group", "Sample_Type", "Sex"),
               output_name = 'all',
               taxonomy = data.frame(tax_table(physeq.simp)))
all.simper.kw <- read.csv("all_krusk_simper.csv")
for(i in 1:nrow(all.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.simp))) == all.simper.kw$OTU[i])
  all.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.simp))[save,2], "-",
          data.frame(tax_table(physeq.simp))[save,3], "-",
          data.frame(tax_table(physeq.simp))[save,4], "-",
          data.frame(tax_table(physeq.simp))[save,5], "-",
          data.frame(tax_table(physeq.simp))[save,6])
}
write.table(all.simper.kw, "all_krusk_simper.csv", sep=",")

# Group
simper.pretty(data.frame(otu_table(physeq.simp)),
              data.frame(sample_data(physeq.simp)),
              c("Group"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='group')
group.simper <- read.csv("group_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.simp)),
               data.frame(sample_data(physeq.simp)),
               csv = group.simper,
               c("Group"),
               output_name = 'group',
               taxonomy = data.frame(tax_table(physeq.simp)))
group.simper.kw <- read.csv("group_krusk_simper.csv")
for(i in 1:nrow(group.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.simp))) == group.simper.kw$OTU[i])
  group.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.simp))[save,2], "-",
          data.frame(tax_table(physeq.simp))[save,3], "-",
          data.frame(tax_table(physeq.simp))[save,4], "-",
          data.frame(tax_table(physeq.simp))[save,5], "-",
          data.frame(tax_table(physeq.simp))[save,6])
}
write.table(group.simper.kw, "group_krusk_simper.csv", sep=",")

# Sex
simper.pretty(data.frame(otu_table(physeq.simp)),
              data.frame(sample_data(physeq.simp)),
              c("Sex"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='sex')
sex.simper <- read.csv("sex_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.simp)),
               data.frame(sample_data(physeq.simp)),
               csv = sex.simper,
               c("Sex"),
               output_name = 'sex',
               taxonomy = data.frame(tax_table(physeq.simp)))
sex.simper.kw <- read.csv("sex_krusk_simper.csv")
for(i in 1:nrow(sex.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.simp))) == sex.simper.kw$OTU[i])
  sex.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.simp))[save,2], "-",
          data.frame(tax_table(physeq.simp))[save,3], "-",
          data.frame(tax_table(physeq.simp))[save,4], "-",
          data.frame(tax_table(physeq.simp))[save,5], "-",
          data.frame(tax_table(physeq.simp))[save,6])
}
write.table(sex.simper.kw, "sex_krusk_simper.csv", sep=",")

# Summer Wild
physeq.wil <- subset_samples(physeq.simp, Group == "SummerWild")
simper.pretty(data.frame(otu_table(physeq.wil)),
              data.frame(sample_data(physeq.wil)),
              c("Sex"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='wil')
wil.simper <- read.csv("wil_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.wil)),
               data.frame(sample_data(physeq.wil)),
               csv = wil.simper,
               c("Sex"),
               output_name = 'wil',
               taxonomy = data.frame(tax_table(physeq.wil)))
wil.simper.kw <- read.csv("wil_krusk_simper.csv")
for(i in 1:nrow(wil.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.wil))) == wil.simper.kw$OTU[i])
  wil.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.wil))[save,2], "-",
          data.frame(tax_table(physeq.wil))[save,3], "-",
          data.frame(tax_table(physeq.wil))[save,4], "-",
          data.frame(tax_table(physeq.wil))[save,5], "-",
          data.frame(tax_table(physeq.wil))[save,6])
}
write.table(wil.simper.kw, "wil_krusk_simper.csv", sep=",")

# Summer Lab
physeq.lab <- subset_samples(physeq.simp, Group == "SummerLab")
simper.pretty(data.frame(otu_table(physeq.lab)),
              data.frame(sample_data(physeq.lab)),
              c("Sex"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='lab')
lab.simper <- read.csv("lab_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.lab)),
               data.frame(sample_data(physeq.lab)),
               csv = lab.simper,
               c("Sex"),
               output_name = 'lab',
               taxonomy = data.frame(tax_table(physeq.lab)))
lab.simper.kw <- read.csv("lab_krusk_simper.csv")
for(i in 1:nrow(lab.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.lab))) == lab.simper.kw$OTU[i])
  lab.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.lab))[save,2], "-",
          data.frame(tax_table(physeq.lab))[save,3], "-",
          data.frame(tax_table(physeq.lab))[save,4], "-",
          data.frame(tax_table(physeq.lab))[save,5], "-",
          data.frame(tax_table(physeq.lab))[save,6])
}
write.table(lab.simper.kw, "lab_krusk_simper.csv", sep=",")

# Torpor
physeq.tor <- subset_samples(physeq.simp, Group == "Torpor")
simper.pretty(data.frame(otu_table(physeq.tor)),
              data.frame(sample_data(physeq.tor)),
              c("Sex"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='tor')
tor.simper <- read.csv("tor_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.tor)),
               data.frame(sample_data(physeq.tor)),
               csv = tor.simper,
               c("Sex"),
               output_name = 'tor',
               taxonomy = data.frame(tax_table(physeq.tor)))
tor.simper.kw <- read.csv("tor_krusk_simper.csv")
for(i in 1:nrow(tor.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.tor))) == tor.simper.kw$OTU[i])
  tor.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.tor))[save,2], "-",
          data.frame(tax_table(physeq.tor))[save,3], "-",
          data.frame(tax_table(physeq.tor))[save,4], "-",
          data.frame(tax_table(physeq.tor))[save,5], "-",
          data.frame(tax_table(physeq.tor))[save,6])
}
write.table(tor.simper.kw, "tor_krusk_simper.csv", sep=",")

# IBA
physeq.iba <- subset_samples(physeq.simp, Group == "IBA")
simper.pretty(data.frame(otu_table(physeq.iba)),
              data.frame(sample_data(physeq.iba)),
              c("Sex"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='iba')
iba.simper <- read.csv("iba_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.iba)),
               data.frame(sample_data(physeq.iba)),
               csv = iba.simper,
               c("Sex"),
               output_name = 'iba',
               taxonomy = data.frame(tax_table(physeq.iba)))
iba.simper.kw <- read.csv("iba_krusk_simper.csv")
for(i in 1:nrow(iba.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.iba))) == iba.simper.kw$OTU[i])
  iba.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.iba))[save,2], "-",
          data.frame(tax_table(physeq.iba))[save,3], "-",
          data.frame(tax_table(physeq.iba))[save,4], "-",
          data.frame(tax_table(physeq.iba))[save,5], "-",
          data.frame(tax_table(physeq.iba))[save,6])
}
write.table(iba.simper.kw, "iba_krusk_simper.csv", sep=",")

# Spring
physeq.spr <- subset_samples(physeq.simp, Group == "Spring")
simper.pretty(data.frame(otu_table(physeq.spr)),
              data.frame(sample_data(physeq.spr)),
              c("Sex"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='spr')
spr.simper <- read.csv("spr_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.spr)),
               data.frame(sample_data(physeq.spr)),
               csv = spr.simper,
               c("Sex"),
               output_name = 'spr',
               taxonomy = data.frame(tax_table(physeq.spr)))
spr.simper.kw <- read.csv("spr_krusk_simper.csv")
for(i in 1:nrow(spr.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.spr))) == spr.simper.kw$OTU[i])
  spr.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.spr))[save,2], "-",
          data.frame(tax_table(physeq.spr))[save,3], "-",
          data.frame(tax_table(physeq.spr))[save,4], "-",
          data.frame(tax_table(physeq.spr))[save,5], "-",
          data.frame(tax_table(physeq.spr))[save,6])
}
write.table(spr.simper.kw, "spr_krusk_simper.csv", sep=",")



### BH CORRECTION FOR ALL SIMPER COMPARISONS
all.simper.kw$Group <- rep("All", nrow(all.simper.kw))
all.simper.kw$OTU <- as.character(all.simper.kw$OTU)
all.simper.kw$Comparison <- as.character(all.simper.kw$Comparison)
all.simper.kw$Taxonomy <- as.character(all.simper.kw$Taxonomy)

sex.simper.kw$Group <- rep("Sex", nrow(sex.simper.kw))
sex.simper.kw$OTU <- as.character(sex.simper.kw$OTU)
sex.simper.kw$Comparison <- as.character(sex.simper.kw$Comparison)
sex.simper.kw$Taxonomy <- as.character(sex.simper.kw$Taxonomy)

wil.simper.kw$Group <- rep("Summer_Wild", nrow(wil.simper.kw))
wil.simper.kw$OTU <- as.character(wil.simper.kw$OTU)
wil.simper.kw$Comparison <- as.character(wil.simper.kw$Comparison)
wil.simper.kw$Taxonomy <- as.character(wil.simper.kw$Taxonomy)

lab.simper.kw$Group <- rep("Summer_Lab", nrow(lab.simper.kw))
lab.simper.kw$OTU <- as.character(lab.simper.kw$OTU)
lab.simper.kw$Comparison <- as.character(lab.simper.kw$Comparison)
lab.simper.kw$Taxonomy <- as.character(lab.simper.kw$Taxonomy)

tor.simper.kw$Group <- rep("Torpor", nrow(tor.simper.kw))
tor.simper.kw$OTU <- as.character(tor.simper.kw$OTU)
tor.simper.kw$Comparison <- as.character(tor.simper.kw$Comparison)
tor.simper.kw$Taxonomy <- as.character(tor.simper.kw$Taxonomy)

iba.simper.kw$Group <- rep("IBA", nrow(iba.simper.kw))
iba.simper.kw$OTU <- as.character(iba.simper.kw$OTU)
iba.simper.kw$Comparison <- as.character(iba.simper.kw$Comparison)
iba.simper.kw$Taxonomy <- as.character(iba.simper.kw$Taxonomy)

spr.simper.kw$Group <- rep("Spring", nrow(spr.simper.kw))
spr.simper.kw$OTU <- as.character(spr.simper.kw$OTU)
spr.simper.kw$Comparison <- as.character(spr.simper.kw$Comparison)
spr.simper.kw$Taxonomy <- as.character(spr.simper.kw$Taxonomy)

simper.all <- all.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(wil.simper.kw)),] <- wil.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(lab.simper.kw)),] <- lab.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(tor.simper.kw)),] <- tor.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(iba.simper.kw)),] <- iba.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(spr.simper.kw)),] <- spr.simper.kw
simper.all$fdr_krusk_p.val <- p.adjust(simper.all$krusk_p.val, "BH")
write.table(simper.all, "simper.csv", sep=",")
```

### Old Simper
```{r}
# Change Group names to be compatible (no "_")
physeq.simp <- physeq.rem
rename.samp <- data.frame(sample_data(physeq.simp))
rename.wild <- which(data.frame(sample_data(physeq.simp))$Group == "Summer_Wild")
rename.lab <- which(data.frame(sample_data(physeq.simp))$Group == "Summer_Lab")
levels(rename.samp$Group) <- c("SummerWild", "SummerLab", "Torpor", "IBA", "Spring")
physeq.simp <- merge_phyloseq(otu_table(physeq.rem), sample_data(rename.samp), tax_table(physeq.rem))


# All
simper.pretty(data.frame(otu_table(physeq.simp)),
              data.frame(sample_data(physeq.simp)),
              c("Group", "Sample_Type", "Sex"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='all')
all.simper <- read.csv("all_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.simp)),
               data.frame(sample_data(physeq.simp)),
               csv = all.simper,
               c("Group", "Sample_Type"),
               output_name = 'all',
               taxonomy = data.frame(tax_table(physeq.simp)))
all.simper.kw <- read.csv("all_krusk_simper.csv")
for(i in 1:nrow(all.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.simp))) == all.simper.kw$OTU[i])
  all.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.simp))[save,2], "-",
          data.frame(tax_table(physeq.simp))[save,3], "-",
          data.frame(tax_table(physeq.simp))[save,4], "-",
          data.frame(tax_table(physeq.simp))[save,5], "-",
          data.frame(tax_table(physeq.simp))[save,6])
}
write.table(all.simper.kw, "all_krusk_simper.csv", sep=",")

# Group
simper.pretty(data.frame(otu_table(physeq.simp)),
              data.frame(sample_data(physeq.simp)),
              c("Group"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='group')
group.simper <- read.csv("group_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.simp)),
               data.frame(sample_data(physeq.simp)),
               csv = group.simper,
               c("Group"),
               output_name = 'group',
               taxonomy = data.frame(tax_table(physeq.simp)))
group.simper.kw <- read.csv("group_krusk_simper.csv")
for(i in 1:nrow(group.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.simp))) == group.simper.kw$OTU[i])
  group.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.simp))[save,2], "-",
          data.frame(tax_table(physeq.simp))[save,3], "-",
          data.frame(tax_table(physeq.simp))[save,4], "-",
          data.frame(tax_table(physeq.simp))[save,5], "-",
          data.frame(tax_table(physeq.simp))[save,6])
}
write.table(group.simper.kw, "group_krusk_simper.csv", sep=",")

# Content
physeq.con <- subset_samples(physeq.simp, Sample_Type == "Content")
simper.pretty(data.frame(otu_table(physeq.con)),
              data.frame(sample_data(physeq.con)),
              c("Group"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='con')
con.simper <- read.csv("con_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.con)),
               data.frame(sample_data(physeq.con)),
               csv = con.simper,
               c("Group"),
               output_name = 'con',
               taxonomy = data.frame(tax_table(physeq.con)))
con.simper.kw <- read.csv("con_krusk_simper.csv")
for(i in 1:nrow(con.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.con))) == con.simper.kw$OTU[i])
  con.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.con))[save,2], "-",
          data.frame(tax_table(physeq.con))[save,3], "-",
          data.frame(tax_table(physeq.con))[save,4], "-",
          data.frame(tax_table(physeq.con))[save,5], "-",
          data.frame(tax_table(physeq.con))[save,6])
}
write.table(con.simper.kw, "con_krusk_simper.csv", sep=",")

# Mucosa
physeq.muc <- subset_samples(physeq.simp, Sample_Type == "Mucosa")
simper.pretty(data.frame(otu_table(physeq.muc)),
              data.frame(sample_data(physeq.muc)),
              c("Group"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='muc')
muc.simper <- read.csv("muc_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.muc)),
               data.frame(sample_data(physeq.muc)),
               csv = muc.simper,
               c("Group"),
               output_name = 'muc',
               taxonomy = data.frame(tax_table(physeq.muc)))
muc.simper.kw <- read.csv("muc_krusk_simper.csv")
for(i in 1:nrow(muc.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.muc))) == muc.simper.kw$OTU[i])
  muc.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.muc))[save,2], "-",
          data.frame(tax_table(physeq.muc))[save,3], "-",
          data.frame(tax_table(physeq.muc))[save,4], "-",
          data.frame(tax_table(physeq.muc))[save,5], "-",
          data.frame(tax_table(physeq.muc))[save,6])
}
write.table(muc.simper.kw, "muc_krusk_simper.csv", sep=",")

# Summer Wild
physeq.wil <- subset_samples(physeq.simp, Group == "SummerWild")
simper.pretty(data.frame(otu_table(physeq.wil)),
              data.frame(sample_data(physeq.wil)),
              c("Sample_Type"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='wil')
wil.simper <- read.csv("wil_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.wil)),
               data.frame(sample_data(physeq.wil)),
               csv = wil.simper,
               c("Sample_Type"),
               output_name = 'wil',
               taxonomy = data.frame(tax_table(physeq.wil)))
wil.simper.kw <- read.csv("wil_krusk_simper.csv")
for(i in 1:nrow(wil.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.wil))) == wil.simper.kw$OTU[i])
  wil.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.wil))[save,2], "-",
          data.frame(tax_table(physeq.wil))[save,3], "-",
          data.frame(tax_table(physeq.wil))[save,4], "-",
          data.frame(tax_table(physeq.wil))[save,5], "-",
          data.frame(tax_table(physeq.wil))[save,6])
}
write.table(wil.simper.kw, "wil_krusk_simper.csv", sep=",")

# Summer Lab
physeq.lab <- subset_samples(physeq.simp, Group == "SummerLab")
simper.pretty(data.frame(otu_table(physeq.lab)),
              data.frame(sample_data(physeq.lab)),
              c("Sample_Type"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='lab')
lab.simper <- read.csv("lab_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.lab)),
               data.frame(sample_data(physeq.lab)),
               csv = lab.simper,
               c("Sample_Type"),
               output_name = 'lab',
               taxonomy = data.frame(tax_table(physeq.lab)))
lab.simper.kw <- read.csv("lab_krusk_simper.csv")
for(i in 1:nrow(lab.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.lab))) == lab.simper.kw$OTU[i])
  lab.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.lab))[save,2], "-",
          data.frame(tax_table(physeq.lab))[save,3], "-",
          data.frame(tax_table(physeq.lab))[save,4], "-",
          data.frame(tax_table(physeq.lab))[save,5], "-",
          data.frame(tax_table(physeq.lab))[save,6])
}
write.table(lab.simper.kw, "lab_krusk_simper.csv", sep=",")

# Torpor
physeq.tor <- subset_samples(physeq.simp, Group == "Torpor")
simper.pretty(data.frame(otu_table(physeq.tor)),
              data.frame(sample_data(physeq.tor)),
              c("Sample_Type"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='tor')
tor.simper <- read.csv("tor_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.tor)),
               data.frame(sample_data(physeq.tor)),
               csv = tor.simper,
               c("Sample_Type"),
               output_name = 'tor',
               taxonomy = data.frame(tax_table(physeq.tor)))
tor.simper.kw <- read.csv("tor_krusk_simper.csv")
for(i in 1:nrow(tor.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.tor))) == tor.simper.kw$OTU[i])
  tor.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.tor))[save,2], "-",
          data.frame(tax_table(physeq.tor))[save,3], "-",
          data.frame(tax_table(physeq.tor))[save,4], "-",
          data.frame(tax_table(physeq.tor))[save,5], "-",
          data.frame(tax_table(physeq.tor))[save,6])
}
write.table(tor.simper.kw, "tor_krusk_simper.csv", sep=",")

# IBA
physeq.iba <- subset_samples(physeq.simp, Group == "IBA")
simper.pretty(data.frame(otu_table(physeq.iba)),
              data.frame(sample_data(physeq.iba)),
              c("Sample_Type"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='iba')
iba.simper <- read.csv("iba_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.iba)),
               data.frame(sample_data(physeq.iba)),
               csv = iba.simper,
               c("Sample_Type"),
               output_name = 'iba',
               taxonomy = data.frame(tax_table(physeq.iba)))
iba.simper.kw <- read.csv("iba_krusk_simper.csv")
for(i in 1:nrow(iba.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.iba))) == iba.simper.kw$OTU[i])
  iba.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.iba))[save,2], "-",
          data.frame(tax_table(physeq.iba))[save,3], "-",
          data.frame(tax_table(physeq.iba))[save,4], "-",
          data.frame(tax_table(physeq.iba))[save,5], "-",
          data.frame(tax_table(physeq.iba))[save,6])
}
write.table(iba.simper.kw, "iba_krusk_simper.csv", sep=",")

# Spring
physeq.spr <- subset_samples(physeq.simp, Group == "Spring")
simper.pretty(data.frame(otu_table(physeq.spr)),
              data.frame(sample_data(physeq.spr)),
              c("Sample_Type"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='spr')
spr.simper <- read.csv("spr_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.spr)),
               data.frame(sample_data(physeq.spr)),
               csv = spr.simper,
               c("Sample_Type"),
               output_name = 'spr',
               taxonomy = data.frame(tax_table(physeq.spr)))
spr.simper.kw <- read.csv("spr_krusk_simper.csv")
for(i in 1:nrow(spr.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.spr))) == spr.simper.kw$OTU[i])
  spr.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.spr))[save,2], "-",
          data.frame(tax_table(physeq.spr))[save,3], "-",
          data.frame(tax_table(physeq.spr))[save,4], "-",
          data.frame(tax_table(physeq.spr))[save,5], "-",
          data.frame(tax_table(physeq.spr))[save,6])
}
write.table(spr.simper.kw, "spr_krusk_simper.csv", sep=",")

# Sex
simper.pretty(data.frame(otu_table(physeq.simp)),
              data.frame(sample_data(physeq.simp)),
              c("Sex"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='sex')
sex.simper <- read.csv("sex_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.simp)),
               data.frame(sample_data(physeq.simp)),
               csv = sex.simper,
               c("Sex"),
               output_name = 'sex',
               taxonomy = data.frame(tax_table(physeq.simp)))
sex.simper.kw <- read.csv("sex_krusk_simper.csv")
for(i in 1:nrow(sex.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.simp))) == sex.simper.kw$OTU[i])
  sex.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.simp))[save,2], "-",
          data.frame(tax_table(physeq.simp))[save,3], "-",
          data.frame(tax_table(physeq.simp))[save,4], "-",
          data.frame(tax_table(physeq.simp))[save,5], "-",
          data.frame(tax_table(physeq.simp))[save,6])
}
write.table(sex.simper.kw, "sex_krusk_simper.csv", sep=",")

### BH CORRECTION FOR ALL SIMPER COMPARISONS
all.simper.kw$Group <- rep("All", nrow(all.simper.kw))
all.simper.kw$OTU <- as.character(all.simper.kw$OTU)
all.simper.kw$Comparison <- as.character(all.simper.kw$Comparison)
all.simper.kw$Taxonomy <- as.character(all.simper.kw$Taxonomy)

con.simper.kw$Group <- rep("Content", nrow(con.simper.kw))
con.simper.kw$OTU <- as.character(con.simper.kw$OTU)
con.simper.kw$Comparison <- as.character(con.simper.kw$Comparison)
con.simper.kw$Taxonomy <- as.character(con.simper.kw$Taxonomy)

muc.simper.kw$Group <- rep("Mucosa", nrow(muc.simper.kw))
muc.simper.kw$OTU <- as.character(muc.simper.kw$OTU)
muc.simper.kw$Comparison <- as.character(muc.simper.kw$Comparison)
muc.simper.kw$Taxonomy <- as.character(muc.simper.kw$Taxonomy)

wil.simper.kw$Group <- rep("Summer_Wild", nrow(wil.simper.kw))
wil.simper.kw$OTU <- as.character(wil.simper.kw$OTU)
wil.simper.kw$Comparison <- as.character(wil.simper.kw$Comparison)
wil.simper.kw$Taxonomy <- as.character(wil.simper.kw$Taxonomy)

lab.simper.kw$Group <- rep("Summer_Lab", nrow(lab.simper.kw))
lab.simper.kw$OTU <- as.character(lab.simper.kw$OTU)
lab.simper.kw$Comparison <- as.character(lab.simper.kw$Comparison)
lab.simper.kw$Taxonomy <- as.character(lab.simper.kw$Taxonomy)

tor.simper.kw$Group <- rep("Torpor", nrow(tor.simper.kw))
tor.simper.kw$OTU <- as.character(tor.simper.kw$OTU)
tor.simper.kw$Comparison <- as.character(tor.simper.kw$Comparison)
tor.simper.kw$Taxonomy <- as.character(tor.simper.kw$Taxonomy)

iba.simper.kw$Group <- rep("IBA", nrow(iba.simper.kw))
iba.simper.kw$OTU <- as.character(iba.simper.kw$OTU)
iba.simper.kw$Comparison <- as.character(iba.simper.kw$Comparison)
iba.simper.kw$Taxonomy <- as.character(iba.simper.kw$Taxonomy)

spr.simper.kw$Group <- rep("Spring", nrow(spr.simper.kw))
spr.simper.kw$OTU <- as.character(spr.simper.kw$OTU)
spr.simper.kw$Comparison <- as.character(spr.simper.kw$Comparison)
spr.simper.kw$Taxonomy <- as.character(spr.simper.kw$Taxonomy)

simper.all <- all.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(con.simper.kw)),] <- con.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(muc.simper.kw)),] <- muc.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(wil.simper.kw)),] <- wil.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(lab.simper.kw)),] <- lab.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(tor.simper.kw)),] <- tor.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(iba.simper.kw)),] <- iba.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(spr.simper.kw)),] <- spr.simper.kw
simper.all[(nrow(simper.all)+1):(nrow(simper.all)+nrow(sex.simper.kw)),] <- sex.simper.kw
simper.all$fdr_krusk_p.val <- p.adjust(simper.all$krusk_p.val, "BH")
write.table(simper.all, "simper.csv", sep=",")
```



### Cyanobacteria???
```{r}
cya <- subset_taxa(physeq.rem, Phylum == "Cyanobacteria")
cya.tax <- data.frame(tax_table(cya))
cya.rel <- transform_sample_counts(cya, function(x){(x/sum(x))*100})
cya.rel <- subset_samples(cya.rel, sample_names(cya.rel)!= "CC1_923_S")
cya.rel <- subset_samples(cya.rel, sample_names(cya.rel)!= "CC1_925_I")
cya.rel <- subset_samples(cya.rel, sample_names(cya.rel)!= "CM1_916_P")
cya.rel <- prune_taxa(taxa_sums(cya.rel)>0, cya.rel)
View(data.frame(otu_table(cya.rel)))
View(data.frame(tax_table(cya.rel)))




### Simper @ Phylum-level
# Change Group names to be compatible (no "_")
physeq.simp <- physeq.rem
rename.samp <- data.frame(sample_data(physeq.simp))
rename.wild <- which(data.frame(sample_data(physeq.simp))$Group == "Summer_Wild")
rename.lab <- which(data.frame(sample_data(physeq.simp))$Group == "Summer_Lab")
levels(rename.samp$Group) <- c("SummerWild", "SummerLab", "Torpor", "IBA", "Spring")
physeq.simp <- merge_phyloseq(otu_table(physeq.rem), sample_data(rename.samp), tax_table(physeq.rem))
physeq.phylum <- tax_glom(physeq.simp, taxrank="Phylum")

# All

simper.pretty(data.frame(otu_table(physeq.phylum)),
              data.frame(sample_data(physeq.phylum)),
              c("Group", "Sample_Type"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='all.phylum')
all.phylum.simper <- read.csv("all.phylum_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.phylum)),
               data.frame(sample_data(physeq.phylum)),
               csv = all.phylum.simper,
               c("Group", "Sample_Type"),
               output_name = 'all.phylum',
               taxonomy = data.frame(tax_table(physeq.phylum)))
all.phylum.simper.kw <- read.csv("all.phylum_krusk_simper.csv")
for(i in 1:nrow(all.phylum.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.phylum))) == all.phylum.simper.kw$OTU[i])
  all.phylum.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.phylum))[save,2], "-",
          data.frame(tax_table(physeq.phylum))[save,3], "-",
          data.frame(tax_table(physeq.phylum))[save,4], "-",
          data.frame(tax_table(physeq.phylum))[save,5], "-",
          data.frame(tax_table(physeq.phylum))[save,6])
}
write.table(all.phylum.simper.kw, "all.phylum_krusk_simper.csv", sep=",")




### Test Cyano Phy Rel Abund
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.rem, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

# Pull out cyanos
cya.phy <- subset_taxa(phy99, Phylum == "Cyanobacteria")
cya.df <- data.frame(sample_data(cya.phy))
cya.df$RelAbund <- t(data.frame(otu_table(cya.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=cya.df)
  # p-value = 8.591e-05
kruskalmc(resp = RelAbund ~ Group, data=cya.df)
  # Summer_Wild vs. Summer_Lab
  # Summer_Wild vs. IBA
  # Summer_Wild vs. Spring
  # Torpor vs. Spring
pairwise.wilcox.test(cya.df$RelAbund, cya.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.00081
  # Wild-Torpor = 0.00083
  # Wild-IBA = 0.00074
  # Wild-Spring = 0.00291
  # Lab-Torpor = 0.10286
  # Lab-IBA = 1
  # Lab-Spring = 0.17796
  # Torpor-IBA = 0.01648
  # Torpor-Spring = 0.00391
  # IBA-Spring = 0.17796
kruskal.test(formula = RelAbund ~ Sample_Type, data=cya.df)
  # p-value = 0.733
```

### Verruco OTUs???
```{r}
ver <- subset_taxa(physeq.rem, Phylum == "Verrucomicrobia")
ver.tax <- data.frame(tax_table(ver))
ver.rel <- transform_sample_counts(ver, function(x){(x/sum(x))*100})
ver.rel <- subset_samples(ver.rel, sample_names(ver.rel)!= "CC1_923_S")
ver.rel <- subset_samples(ver.rel, sample_names(ver.rel)!= "CC1_925_I")
ver.rel <- subset_samples(ver.rel, sample_names(ver.rel)!= "CM1_916_P")
ver.rel <- prune_taxa(taxa_sums(ver.rel)>0, ver.rel)

```


### Test Phyla Rel Abund
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.rem, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

### CYANOBACTERIA ###
# Pull out cyanos
cya.phy <- subset_taxa(phy99, Phylum == "Cyanobacteria")
cya.df <- data.frame(sample_data(cya.phy))
cya.df$RelAbund <- t(data.frame(otu_table(cya.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=cya.df)
  # p-value = 8.591e-05
kruskalmc(resp = RelAbund ~ Group, data=cya.df)
  # Summer_Wild vs. Summer_Lab
  # Summer_Wild vs. IBA
  # Summer_Wild vs. Spring
  # Torpor vs. Spring
pairwise.wilcox.test(cya.df$RelAbund, cya.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.00081
  # Wild-Torpor = 0.00083
  # Wild-IBA = 0.00074
  # Wild-Spring = 0.00291
  # Lab-Torpor = 0.10286
  # Lab-IBA = 1
  # Lab-Spring = 0.17796
  # Torpor-IBA = 0.01648
  # Torpor-Spring = 0.00391
  # IBA-Spring = 0.17796
kruskal.test(formula = RelAbund ~ Sample_Type, data=cya.df)
  # p-value = 0.733




### FIRMICUTES ###
fir.phy <- subset_taxa(phy99, Phylum == "Firmicutes")
fir.df <- data.frame(sample_data(fir.phy))
fir.df$RelAbund <- t(data.frame(otu_table(fir.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=fir.df)
  # p-value = 7.758e-07
kruskalmc(resp = RelAbund ~ Group, data=fir.df)
  # Summer_Wild vs. Torpor
  # Summer_Wild vs. IBA
  # Summer_Lab vs. Torpor
  # Summer_Lab vs. IBA
pairwise.wilcox.test(fir.df$RelAbund, fir.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.80753
  # Wild-Torpor = 0.00062 
  # Wild-IBA = 0.00014
  # Wild-Spring = 0.17191
  # Lab-Torpor = 2.8e-05
  # Lab-IBA = 8.0e-06
  # Lab-Spring = 0.09894
  # Torpor-IBA = 0.72018
  # Torpor-Spring = 0.00326
  # IBA-Spring = 0.00062
kruskal.test(formula = RelAbund ~ Sample_Type, data=fir.df)
  # p-value = 0.6089




### BACTEROIDETES ###
bac.phy <- subset_taxa(phy99, Phylum == "Bacteroidetes")
bac.df <- data.frame(sample_data(bac.phy))
bac.df$RelAbund <- t(data.frame(otu_table(bac.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=bac.df)
  # p-value = 0.006097
kruskalmc(resp = RelAbund ~ Group, data=bac.df)
pairwise.wilcox.test(bac.df$RelAbund, bac.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.578
  # Wild-Torpor = 0.040
  # Wild-IBA = 0.040
  # Wild-Spring = 0.058
  # Lab-Torpor = 0.040
  # Lab-IBA = 0.040
  # Lab-Spring = 0.058
  # Torpor-IBA = 0.927
  # Torpor-Spring = 0.722
  # IBA-Spring = 0.607
kruskal.test(formula = RelAbund ~ Sample_Type, data=bac.df)
  # p-value = 0.03301





### Verrucomicrobia ###
ver.phy <- subset_taxa(phy99, Phylum == "Verrucomicrobia")
ver.df <- data.frame(sample_data(ver.phy))
ver.df$RelAbund <- t(data.frame(otu_table(ver.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=ver.df)
  # p-value = 1.621e-06
kruskalmc(resp = RelAbund ~ Group, data=ver.df)
  # Wild-Torpor
  # Wild-IBA
  # Lab-Torpor
  # Lab-IBA
  # Torpor-Spring
  # IBA-Spring
pairwise.wilcox.test(ver.df$RelAbund, ver.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 1
  # Wild-Torpor = 0.00042
  # Wild-IBA = 0.00021
  # Wild-Spring = 1
  # Lab-Torpor = 0.00011
  # Lab-IBA = 0.00011
  # Lab-Spring = 1
  # Torpor-IBA = 1
  # Torpor-Spring = 0.00021
  # IBA-Spring = 0.00021
kruskal.test(formula = RelAbund ~ Sample_Type, data=ver.df)
  # p-value = 0.6544




### PROTEOBACTERIA ###
pro.phy <- subset_taxa(phy99, Phylum == "Proteobacteria")
pro.df <- data.frame(sample_data(pro.phy))
pro.df$RelAbund <- t(data.frame(otu_table(pro.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=pro.df)
  # p-value = 0.02498
kruskalmc(resp = RelAbund ~ Group, data=pro.df)
pairwise.wilcox.test(pro.df$RelAbund, pro.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.430
  # Wild-Torpor = 0.023
  # Wild-IBA = 0.0144
  # Wild-Spring = 0.785
  # Lab-Torpor = 0.144
  # Lab-IBA = 0.420
  # Lab-Spring = 805
  # Torpor-IBA = 0.927
  # Torpor-Spring = 0.023
  # IBA-Spring = 0.229
kruskal.test(formula = RelAbund ~ Sample_Type, data=pro.df)
  # p-value = 0.2962




### UNCLASSIFIED ###
unc.phy <- subset_taxa(phy99, Phylum == "Bacteria_unclassified")
unc.df <- data.frame(sample_data(unc.phy))
unc.df$RelAbund <- t(data.frame(otu_table(unc.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=unc.df)
  # p-value = 0.08711
kruskalmc(resp = RelAbund ~ Group, data=unc.df)
pairwise.wilcox.test(unc.df$RelAbund, unc.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.192
  # Wild-Torpor = 0.192
  # Wild-IBA = 0.261
  # Wild-Spring = 0.034
  # Lab-Torpor = 0.409
  # Lab-IBA = 0.695
  # Lab-Spring = 0.348
  # Torpor-IBA = 0.840
  # Torpor-Spring = 0.961
  # IBA-Spring = 0.791
kruskal.test(formula = RelAbund ~ Sample_Type, data=unc.df)
  # p-value = 0.7733



### TENERICUTES ###
ten.phy <- subset_taxa(phy99, Phylum == "Tenericutes")
ten.df <- data.frame(sample_data(ten.phy))
ten.df$RelAbund <- t(data.frame(otu_table(ten.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=ten.df)
  # p-value = 0.02485
kruskalmc(resp = RelAbund ~ Group, data=ten.df)
  # Wild-Torpor
  # Wild-IBA
pairwise.wilcox.test(ten.df$RelAbund, ten.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.3235
  # Wild-Torpor = 0.0025
  # Wild-IBA = 0.0049
  # Wild-Spring = 0.5970
  # Lab-Torpor = 0.5012
  # Lab-IBA = 0.7848
  # Lab-Spring = 0.7629
  # Torpor-IBA = 0.7629
  # Torpor-Spring = 0.5874
  # IBA-Spring = 0.00021
kruskal.test(formula = RelAbund ~ Sample_Type, data=ten.df)
  # p-value = 0.6538



### ACTINOBACTERIA ###
act.phy <- subset_taxa(phy99, Phylum == "Actinobacteria")
act.df <- data.frame(sample_data(act.phy))
act.df$RelAbund <- t(data.frame(otu_table(act.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=act.df)
  # p-value = 0.03403
kruskalmc(resp = RelAbund ~ Group, data=act.df)
  # Wild-Spring
pairwise.wilcox.test(act.df$RelAbund, act.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.196
  # Wild-Torpor = 0.037
  # Wild-IBA = 0.042
  # Wild-Spring = 0.037
  # Lab-Torpor = 0.619
  # Lab-IBA = 0.618
  # Lab-Spring = 0.358
  # Torpor-IBA = 0.693
  # Torpor-Spring = 0.596
  # IBA-Spring = 0.458
kruskal.test(formula = RelAbund ~ Sample_Type, data=act.df)
  # p-value = 0.7981





### ELUSIMICROBIA ###
elu.phy <- subset_taxa(phy99, Phylum == "Elusimicrobia")
elu.df <- data.frame(sample_data(elu.phy))
elu.df$RelAbund <- t(data.frame(otu_table(elu.phy)))

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=elu.df)
  # p-value = 0.03651
kruskalmc(resp = RelAbund ~ Group, data=elu.df)
pairwise.wilcox.test(elu.df$RelAbund, elu.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.11
  # Wild-Torpor = 0.11
  # Wild-IBA = 0.62
  # Wild-Spring = 0.10
  # Lab-Torpor = 0.97
  # Lab-IBA = 0.29
  # Lab-Spring = 0.29
  # Torpor-IBA = 0.29
  # Torpor-Spring = 0.49
  # IBA-Spring = 0.15
kruskal.test(formula = RelAbund ~ Sample_Type, data=elu.df)
  # p-value = 0.7981
```


### Jaccard Ordination
```{r}
jac <- ordinate(physeq=physeq.use, method="NMDS", distance="jaccard")
  # stress =  0.1026393

plot_ordination(physeq=physeq.use, ordination=jac, color="Group", shape="Sample_Type")

# Try removing that insanely crazy Cellobiose ABX sample with all Proteos
physeq.use.rem <- subset_samples(physeq.use=physeq.use, sample_names(physeq.use) != "CC1_S25")
jac.rem <- ordinate(physeq.use=physeq.use.rem, method="NMDS", distance="jaccard")
  # Stress = 0.1032307 

plot_ordination(physeq.use=physeq.use.rem, ordination=jac.rem, color="ABX", shape="Substrate")
```








### Play with ellipses
```{r}
### Bray NMDS
# Try removing that insanely crazy Cellobiose ABX sample with all Proteos
physeq.use.rem <- subset_samples(physeq.use=physeq.use, sample_names(physeq.use) != "CC1_S25")
nmds.rem <- ordinate(physeq.use=physeq.use.rem, method="NMDS", distance="bray")
  # Stress = 0.1233697 

plot_ordination(physeq.use=physeq.use.rem, ordination=nmds.rem, color="ABX", shape="Substrate") +
  stat_ellipse(type = "norm", linetype = 2) + stat_ellipse(type = "t")


# https://stackoverflow.com/questions/13794419/plotting-ordiellipse-function-from-vegan-package-onto-nmds-plot-created-in-ggplo

elip.nmds <- data.frame(MDS1 = nmds.rem$points[,1], MDS2 = nmds.rem$points[,2],
                        ABX = sample_data(physeq.use.rem)$ABX)
plot.new()
elip.ord <- ordiellipse(nmds.rem, sample_data(physeq.use.rem)$ABX, display="sites", kind="se", conf=0.95, label=T)


veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}


elip.df <- data.frame()
for(i in levels(elip.nmds$ABX)){
  elip.df <- rbind(elip.df, cbind(as.data.frame(with(elip.nmds[elip.nmds$ABX==i,],
                                                     veganCovEllipse(elip.ord[[i]]$cov,
                                                                     elip.ord[[i]]$center,
                                                                     elip.ord[[i]]$scale))),
                                  group=i))
  
}


plot_ordination(physeq=physeq.use, ordination=nmds.rem, color="Group") +
  geom_path(data=elip.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  scale_color_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen"))

```



### Remove 3916 outlier
```{r}
### TLDR: Removing it doesn't make a very large difference-- certainly not the diff btwn sig vs. not sig
# Squirrel 916 (Spring) is an outlier
  # Both content & mucosa is WAY LESS DIVERSE tan everything else
# 3916 metadata:
  # Weight to warm = 97
    # Normal = >110
  # Weight at sacrifice = 122
    # Normal = >145
  # Sacrifice body temp = 34
    # Normal = ~37

### New phyloseq object
physeq.use <- subset_samples(physeq=physeq.rem, sample_data(physeq.rem)$ID != 3916)

######### Alpha Diversity #########

adiv <- data.frame(sample_data(physeq.use))

### Total OTUs ###
shared = "mothur_output/final.shared"
taxonomy = "mothur_output/final.taxonomy"
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
# Read in metadata
meta <- read.csv("metadata.csv")
colnames(meta)[1] <- "Sample"
otu.tot <- data.frame(sample_names(mothurdata))
# Pull out # of OTUs from all samples
otu.tot$Total_OTUs <- rep("NA", 77)
for(i in 1:77){
  otu.tot[i,2] <- length(which(otu_table(mothurdata)[,i] != 0))
}
# Pull out the data from just the samples we kept
keep <- data.frame(rep("NA",45))
keep[,2] <- rep("NA", 45)
for(i in 1:45){
  x <- which(otu.tot$sample_names.mothurdata. == sample_names(physeq.use)[i])
  keep[i,2] <- otu.tot[x,2]
}
keep[,1] <- sample_names(physeq.use)
colnames(keep) <- c("Sample", "Total_OTUs")
keep$Total_OTUs <- as.integer(keep$Total_OTUs)
adiv$Total_OTUs <- keep$Total_OTUs


# Color by group, facet by sample type
ggplot(otusum, aes(x=Group, y=Total_OTUs, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Total OTUs")

# Color by sample type, facet by group
ggplot(otusum, aes(x=Sample_Type, y=Total_OTUs, fill = Sample_Type)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Group) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Sample Type") +
  ylab("Total OTUs")


adiv.use.combos <- combn(x=levels(sampdf$Group), m=2)
adiv.pvals <- data.frame(rep(999,10))
for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv$Group == adiv.use.combos[1,i])
  group2 <- which(adiv$Group == adiv.use.combos[2,i])
  temp.df <- adiv[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv[group2,]
  test <- wilcox.test(Total_OTUs ~ Group, data=temp.df)
  adiv.pvals[i,1] <- test$p.value
  rownames(adiv.pvals)[i] <- paste(adiv.use.combos[1,i], adiv.use.combos[2,i])
}
colnames(adiv.pvals) <- "otusum.pval"
adiv.pvals$otusum.bonf <- p.adjust(adiv.pvals$otusum.pval, method="bonferroni")
adiv.pvals$otusum.BH <- p.adjust(adiv.pvals$otusum.pval, method="BH")

for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv$Group == adiv.use.combos[1,i])
  group2 <- which(adiv$Group == adiv.use.combos[2,i])
  temp.df <- adiv[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv[group2,]
  test <- wilcox.test(chao ~ Group, data=temp.df)
  adiv.pvals[i,4] <- test$p.value
}
colnames(adiv.pvals)[4] <- "chao.pval"
adiv.pvals$chao.bonf <- p.adjust(adiv.pvals$chao.pval, method="bonferroni")
adiv.pvals$chao.BH <- p.adjust(adiv.pvals$chao.pval, method="BH")

for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv$Group == adiv.use.combos[1,i])
  group2 <- which(adiv$Group == adiv.use.combos[2,i])
  temp.df <- adiv[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv[group2,]
  test <- wilcox.test(bergerparker ~ Group, data=temp.df)
  adiv.pvals[i,7] <- test$p.value
}
colnames(adiv.pvals)[7] <- "bp.pval"
adiv.pvals$bp.bonf <- p.adjust(adiv.pvals$bp.pval, method="bonferroni")
adiv.pvals$bp.BH <- p.adjust(adiv.pvals$bp.pval, method="BH")

aov.shannon.group <- aov(shannon ~ Group, data=adiv)
tukey.shannon <- TukeyHSD(aov.shannon.group)
adiv.pvals$shannon.tukey.pval<-tukey.shannon$Group[,4]

           
for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv$Group == adiv.use.combos[1,i])
  group2 <- which(adiv$Group == adiv.use.combos[2,i])
  temp.df <- adiv[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv[group2,]
  test <- wilcox.test(invsimpson ~ Group, data=temp.df)
  adiv.pvals[i,11] <- test$p.value
}
colnames(adiv.pvals)[11] <- "invsimp.pval"
adiv.pvals$invsimp.bonf <- p.adjust(adiv.pvals$invsimp.pval, method="bonferroni")
adiv.pvals$invsimp.BH <- p.adjust(adiv.pvals$invsimp.pval, method="BH")






adiv.con <- adiv[which(adiv$Sample_Type=="Content"),]
adiv.con.pvals <- data.frame(rep(999,10))
for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv.con$Group == adiv.use.combos[1,i])
  group2 <- which(adiv.con$Group == adiv.use.combos[2,i])
  temp.df <- adiv.con[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv.con[group2,]
  test <- wilcox.test(Total_OTUs ~ Group, data=temp.df)
  adiv.con.pvals[i,1] <- test$p.value
  rownames(adiv.con.pvals)[i] <- paste(adiv.use.combos[1,i], adiv.use.combos[2,i])
}
colnames(adiv.con.pvals) <- "otusum.pval"
adiv.con.pvals$otusum.bonf <- p.adjust(adiv.con.pvals$otusum.pval, method="bonferroni")
adiv.con.pvals$otusum.BH <- p.adjust(adiv.con.pvals$otusum.pval, method="BH")

for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv.con$Group == adiv.use.combos[1,i])
  group2 <- which(adiv.con$Group == adiv.use.combos[2,i])
  temp.df <- adiv.con[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv.con[group2,]
  test <- wilcox.test(chao ~ Group, data=temp.df)
  adiv.con.pvals[i,4] <- test$p.value
}
colnames(adiv.con.pvals)[4] <- "chao.pval"
adiv.con.pvals$chao.bonf <- p.adjust(adiv.con.pvals$chao.pval, method="bonferroni")
adiv.con.pvals$chao.BH <- p.adjust(adiv.con.pvals$chao.pval, method="BH")

for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv.con$Group == adiv.use.combos[1,i])
  group2 <- which(adiv.con$Group == adiv.use.combos[2,i])
  temp.df <- adiv.con[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv.con[group2,]
  test <- wilcox.test(bergerparker ~ Group, data=temp.df)
  adiv.con.pvals[i,7] <- test$p.value
}
colnames(adiv.con.pvals)[7] <- "bp.pval"
adiv.con.pvals$bp.bonf <- p.adjust(adiv.con.pvals$bp.pval, method="bonferroni")
adiv.con.pvals$bp.BH <- p.adjust(adiv.con.pvals$bp.pval, method="BH")

aov.shannon.group <- aov(shannon ~ Group, data=adiv.con)
tukey.shannon <- TukeyHSD(aov.shannon.group)
adiv.con.pvals$shannon.tukey.pval<-tukey.shannon$Group[,4]

           
for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv.con$Group == adiv.use.combos[1,i])
  group2 <- which(adiv.con$Group == adiv.use.combos[2,i])
  temp.df <- adiv.con[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv.con[group2,]
  test <- wilcox.test(invsimpson ~ Group, data=temp.df)
  adiv.con.pvals[i,11] <- test$p.value
}
colnames(adiv.con.pvals)[11] <- "invsimp.pval"
adiv.con.pvals$invsimp.bonf <- p.adjust(adiv.con.pvals$invsimp.pval, method="bonferroni")
adiv.con.pvals$invsimp.BH <- p.adjust(adiv.con.pvals$invsimp.pval, method="BH")








adiv.muc <- adiv[which(adiv$Sample_Type=="Content"),]
adiv.muc.pvals <- data.frame(rep(999,10))
for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv.muc$Group == adiv.use.combos[1,i])
  group2 <- which(adiv.muc$Group == adiv.use.combos[2,i])
  temp.df <- adiv.muc[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv.muc[group2,]
  test <- wilcox.test(Total_OTUs ~ Group, data=temp.df)
  adiv.muc.pvals[i,1] <- test$p.value
  rownames(adiv.muc.pvals)[i] <- paste(adiv.use.combos[1,i], adiv.use.combos[2,i])
}
colnames(adiv.muc.pvals) <- "otusum.pval"
adiv.muc.pvals$otusum.bonf <- p.adjust(adiv.muc.pvals$otusum.pval, method="bonferroni")
adiv.muc.pvals$otusum.BH <- p.adjust(adiv.muc.pvals$otusum.pval, method="BH")

for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv.muc$Group == adiv.use.combos[1,i])
  group2 <- which(adiv.muc$Group == adiv.use.combos[2,i])
  temp.df <- adiv.muc[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv.muc[group2,]
  test <- wilcox.test(chao ~ Group, data=temp.df)
  adiv.muc.pvals[i,4] <- test$p.value
}
colnames(adiv.muc.pvals)[4] <- "chao.pval"
adiv.muc.pvals$chao.bonf <- p.adjust(adiv.muc.pvals$chao.pval, method="bonferroni")
adiv.muc.pvals$chao.BH <- p.adjust(adiv.muc.pvals$chao.pval, method="BH")

for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv.muc$Group == adiv.use.combos[1,i])
  group2 <- which(adiv.muc$Group == adiv.use.combos[2,i])
  temp.df <- adiv.muc[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv.muc[group2,]
  test <- wilcox.test(bergerparker ~ Group, data=temp.df)
  adiv.muc.pvals[i,7] <- test$p.value
}
colnames(adiv.muc.pvals)[7] <- "bp.pval"
adiv.muc.pvals$bp.bonf <- p.adjust(adiv.muc.pvals$bp.pval, method="bonferroni")
adiv.muc.pvals$bp.BH <- p.adjust(adiv.muc.pvals$bp.pval, method="BH")

aov.shannon.group <- aov(shannon ~ Group, data=adiv.muc)
tukey.shannon <- TukeyHSD(aov.shannon.group)
adiv.muc.pvals$shannon.tukey.pval<-tukey.shannon$Group[,4]

           
for(i in 1:ncol(adiv.use.combos)){
  group1 <- which(adiv.muc$Group == adiv.use.combos[1,i])
  group2 <- which(adiv.muc$Group == adiv.use.combos[2,i])
  temp.df <- adiv.muc[group1,]
  temp.df[(nrow(temp.df)+1):(nrow(temp.df)+length(group2)),] <- adiv.muc[group2,]
  test <- wilcox.test(invsimpson ~ Group, data=temp.df)
  adiv.muc.pvals[i,11] <- test$p.value
}
colnames(adiv.muc.pvals)[11] <- "invsimp.pval"
adiv.muc.pvals$invsimp.bonf <- p.adjust(adiv.muc.pvals$invsimp.pval, method="bonferroni")
adiv.muc.pvals$invsimp.BH <- p.adjust(adiv.muc.pvals$invsimp.pval, method="BH")




# group.combos <- data.frame(rep("blah", 10))
# for(i in 1:ncol(adiv.use.combos)){
#   rownames(group.combos)[i] <- paste(adiv.use.combos[1,i], adiv.use.combos[2,i])
#   group.combos[i,1] <- rownames(group.combos)[i]
# }
# all.combos <- data.frame(rep("NA",20))
# all.combos[,1] <- rep(rownames(group.combos),2)
# all.combos[,2] <- c(rep("Content", 10), rep("Mucosa",10))
# all.combos[,3] <- paste(all.combos[,1], all.combos[,2])



adiv.use.all.combos <- combn(x=levels(s))
bray.pvals <- data.frame(rep(999,10))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.use, Group%in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals) <- "pval"
bray.pvals$Adj.bonf <- p.adjust(bray.pvals$pval, method="bonferroni")
bray.pvals$Adj.BH <- p.adjust(bray.pvals$pval, method="BH")









# Color by group
ggplot(otusum, aes(x=Group, y=Total_OTUs, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Total OTUs")



# Test normality
hist(otusum$Total_OTUs, breaks=10)
qqnorm(otusum$Total_OTUs)
qqline(otusum$Total_OTUs)
shapiro.test(otusum$Total_OTUs)
  # p-value = 1.276e-06
  # p-value = 3.505e-07
ks.test(otusum$Total_OTUs, "pnorm", mean=mean(otusum$Total_OTUs), sd=sd(otusum$Total_OTUs))
  # p-value = 0.01574
  # p-value = 0.0112

# Kruskal-Wallis
kruskal.test(formula = Total_OTUs ~ Group, data = otusum)
  # p-value = 7.987e-05
  # p-value = 8.832e-06
kruskalmc(resp = Total_OTUs ~ Group, data = otusum)
  # Significant:
    # Summer_Wild-Torpor
    # Summer_Wild-IBA
    # Summer_Lab-IBA
kruskal.test(formula = Total_OTUs ~ Group, data = otusum, subset=Diet=="Lab")
  # p-value = 0.004659
  # p-value = 0.004648
kruskal.test(formula = Total_OTUs ~ Sample_Type, data = otusum)
  # p-value = 0.4302
  # p-value = 0.4259
kruskal.test(formula = Total_OTUs ~ Diet, data = otusum)
  # p-value = 8.811e-05
  # p-value = 9.359e-05
kruskal.test(formula = Total_OTUs ~ Diet, data = otusum, subset=Season=="Summer")
  # p-value = 0.009111
wilcox.test(Total_OTUs ~ Diet, data=otusum)
  # p-value = 0.0001003

### Chao
# Color by group
ggplot(adiv, aes(x=Group, y=chao, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  #scale_fill_manual(values=c("gray95", "dimgray") )+
  xlab("Group") +
  ylab("Chao Richness")
# Color by group, facet by sample type
ggplot(adiv, aes(x=Group, y=chao, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Chao Richness")

# Test normality
hist(adiv$chao, breaks=10)
qqnorm(adiv$chao)
qqline(adiv$chao)
shapiro.test(adiv$chao)
  # p-value = 1.736e-05
  # p-value = 3.96e-05
ks.test(adiv$chao, "pnorm", mean=mean(adiv$chao), sd=sd(adiv$chao))
  # p-value = 0.2134
  # p-value = 0.335

# Kruskal-Wallis
kruskal.test(formula = chao ~ Group, data = adiv)
  # p-value = 0.02779
  # p-value = 0.01146
kruskalmc(resp = chao ~ Group, data = adiv)
  # Significant:
    # Summer-Spring
kruskal.test(formula = chao ~ Group, data = adiv, subset=Diet=="Lab")
  # p-value = 0.119
  # p-value = 0.1177
kruskal.test(formula = chao ~ Sample_Type, data = adiv)
  # p-value = 0.1792
  # p-value = 0.2279
kruskal.test(formula = chao ~ Diet, data = adiv)
  # p-value = 0.004116
kruskal.test(formula = chao ~ Diet, data = adiv, subset=Season=="Summer")
  # p-value = 0.0208
wilcox.test(chao ~ Diet, data=adiv)
  # p-value = 0.002454


### Berger-Parker
# Color by group
ggplot(adiv, aes(x=Group, y=bergerparker, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  #scale_fill_manual(values=c("gray95", "dimgray") )+
  xlab("Group") +
  ylab("Berger-Parker")
# Color by group, facet by sample type
ggplot(adiv, aes(x=Group, y=bergerparker, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray") )+
  xlab("Group") +
  ylab("Berger-Parker")

# Test normality
hist(adiv$bergerparker, breaks=10)
qqnorm(adiv$bergerparker)
qqline(adiv$bergerparker)
shapiro.test(adiv$bergerparker)
  # p-value = 2.924e-05
ks.test(adiv$bergerparker, "pnorm", mean=mean(adiv$bergerparker), sd=sd(adiv$bergerparker))
  # p-value = 0.351

# Kruskal-Wallis
kruskal.test(formula = bergerparker ~ Group, data = adiv)
  # p-value = 0.4087
kruskal.test(formula = bergerparker ~ Group, data = adiv, subset=Diet=="Lab")
  # p-value = 0.7487
kruskal.test(formula = bergerparker ~ Sample_Type, data = adiv)
  # p-value = 0.594
kruskal.test(formula = bergerparker ~ Diet, data = adiv)
  # p-value = 0.03825
kruskal.test(formula = bergerparker ~ Diet, data = adiv, subset=Season=="Summer")
  # p-value = 0.1317
wilcox.test(bergerparker ~ Diet, data=adiv)
  # p-value = 0.03743


### Shannon
# Color by group
ggplot(adiv, aes(x=Group, y=shannon, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Shannon Diversity")
# Color by group, facet by sample type
ggplot(adiv, aes(x=Group, y=shannon, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Shannon Diversity")

# Test normality
hist(adiv$shannon, breaks=10)
qqnorm(adiv$shannon)
qqline(adiv$shannon)
shapiro.test(adiv$shannon)
  # p-value = 0.3431
ks.test(adiv$shannon, "pnorm", mean=mean(adiv$shannon), sd=sd(adiv$shannon))
  # p-value = 0.9152

# ANOVA
summary(aov(shannon ~ Group, data=adiv))
  # p-value = 0.0501
t.test(shannon ~ Sample_Type, data=adiv)
  # p-value = 0.8445
t.test(shannon ~ Diet, data=adiv)
  # p-value = 0.02371



### Inverse Simpson
# Color by group
ggplot(adiv, aes(x=Group, y= invsimpson, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Inverse Simpson Diversity")
# Color by group, facet by sample type
ggplot(adiv, aes(x=Group, y= invsimpson, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Inverse Simpson Diversity")

# Test normality
hist(adiv$invsimpson, breaks=10)
qqnorm(adiv$invsimpson)
qqline(adiv$invsimpson)
shapiro.test(adiv$invsimpson)
  # p-value = 6.667e-06
ks.test(adiv$invsimpson, "pnorm", mean=mean(adiv$invsimpson), sd=sd(adiv$invsimpson))
  # p-value = 0.02063

# Kruskal-Wallis
kruskal.test(formula = invsimpson ~ Group, data = adiv)
  # p-value = 0.3059
kruskal.test(formula = invsimpson ~ Group, data = adiv, subset=Diet=="Lab")
  # p-value = 0.6151
kruskal.test(formula = invsimpson ~ Sample_Type, data = adiv)
  # p-value = 0.7817
kruskal.test(formula = invsimpson ~ Diet, data = adiv)
  # p-value = 0.02565
kruskal.test(formula = invsimpson ~ Diet, data = adiv, subset=Season=="Summer")
  # p-value = 0.08753
wilcox.test(invsimpson ~ Diet, data=adiv)
  # p-value = 0.0239













######### Beta Diversity #########

### Bray NMDS
nmds <- ordinate(physeq=physeq.use, method="NMDS", distance="bray")
  # Stress = 0.102554

plot_ordination(physeq=physeq.use, ordination=nmds, color="Group", shape="Sample_Type")


sample_data(physeq.use)$Elip <- paste(sample_data(physeq.use)$Group)
elip.nmds <- data.frame(MDS1 = nmds$points[,1], MDS2 = nmds$points[,2],
                        Group = sample_data(physeq.use)$Elip)
plot.new()
elip.ord <- ordiellipse(nmds, sample_data(physeq.use)$Elip, display="sites", kind="se", conf=0.95, label=T)

veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}

elip.df <- data.frame()
for(i in levels(elip.nmds$Group)){
  elip.df <- rbind(elip.df, cbind(as.data.frame(with(elip.nmds[elip.nmds$Group==i,],
                                                     veganCovEllipse(elip.ord[[i]]$cov,
                                                                     elip.ord[[i]]$center,
                                                                     elip.ord[[i]]$scale))),
                                  group=i))
  
}




plot_ordination(physeq=physeq.use, ordination=nmds, color="Group") +
  geom_path(data=elip.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen"))




### PERMANOVA
sampdf <- data.frame(sample_data(physeq.use))
bray<- phyloseq::distance(physeq=physeq.use, method="bray")
adonis(bray~ Group, data=sampdf)
  # p-value = 0.001
beta.tax = betadisper(d=bray, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.026
adonis(bray~ Sample_Type, data=sampdf)
  # p-value = 1
beta.tax = betadisper(d=bray, group=sampdf$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.192

combos <- combn(x=levels(sampdf$Group), m=2)
bray.pvals <- data.frame(rep(999,10))
for( i in 1:ncol(combos)){
  temp.physeq <- subset_samples(physeq.use, Group%in% combos[,i])
  temp.sampdf <- data.frame(sample_data(temp.physeq))
  temp.bray <- phyloseq::distance(physeq=temp.physeq, method="bray")
  test <- adonis(temp.bray ~ Group, data=temp.sampdf)
  rownames(bray.pvals)[i] <- paste(combos[1,i], combos[2,i])
  bray.pvals[i,1]<- test[[1]]$`Pr(>F)`[1]
}
colnames(bray.pvals) <- "pval"
bray.pvals$Adj.bonf <- p.adjust(bray.pvals$pval, method="bonferroni")
bray.pvals$Adj.BH <- p.adjust(bray.pvals$pval, method="BH")
```


