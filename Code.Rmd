---
title: "Code"
author: "Edna Chiang"
date: "May 7, 2018"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(dunn.test)
library(ggplot2)
library(grid)
library(gridExtra)
library(phyloseq)
library(picante)
library(phytools)
library(tidyr)
library(vegan)

#library(gplots)
#library(phangorn)
#library(pgirmess)

theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('scripts/simper_pretty.R')
source('scripts/R_krusk.R')
source('scripts/misc.R')
```

### Import Data
```{r}
# Link files
shared = "mothur_output/final.shared"
taxonomy = "mothur_output/final.taxonomy"
tree = "mothur_output/final.tre"

# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy,
  mothur_tree_file = tree)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

# Remove OTUs that appear in < 3 samples
otu <- data.frame(otu_table(mothurdata))
otu.rem <- list()
for(i in 1:nrow(otu)){
  empty <- length(which(otu[i,] == 0))
    # Identifies # of samples w/o OTU
  if(empty > 54){
    # If OTU appears in < 3 samples
    otu.rem <- append(otu.rem, i)
      # Create list of OTUs that appear in only 1 sample
  }
}
otu.rem.row <- as.numeric(otu.rem)
  # Convert list to numeric
otu.rem.df <- otu[-otu.rem.row,]
  # Remove OTUs
otu.rem.tab <- otu_table(otu.rem.df, taxa_are_rows = T)
  # Convert trimmed OTU table to otu_table

# Add metadata
meta <- read.csv("metadata.csv")
rownames(meta) <- meta$Sample
divsum <- read.table("mothur_output/final.summary", header = T)
meta[,12:21] <- divsum[,3:12]

# Update phyloseq object
physeq <- merge_phyloseq(otu.rem.tab, tax_table(mothurdata), sample_data(meta),
                         phy_tree(mothurdata))

# Order factors
sample_data(physeq)$Season <- ordered(sample_data(physeq)$Season,
                                     levels=c("Summer", "Winter", "Spring"))
sample_data(physeq)$Metabolism <- ordered(sample_data(physeq)$Metabolism,
                                     levels=c("Active", "Torpor", "IBA"))
sample_data(physeq)$Group <- ordered(sample_data(physeq)$Group,
                                     levels=c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring"))

# Remove outliers
physeq <- subset_samples(physeq, ID != 3925)
physeq <- subset_samples(physeq, ID != 3916)

# Calculate relative abundance
physeq <- transform_sample_counts(physeq, function(x){(x/sum(x))*100})


# Separate by season
physeq.wild <- subset_samples(physeq, Group == "Summer_Wild")
physeq.sum <- subset_samples(physeq, Group == "Summer_Lab")
physeq.tor <- subset_samples(physeq, Group == "Torpor")
physeq.iba <- subset_samples(physeq, Group == "IBA")
physeq.spr <- subset_samples(physeq, Group == "Spring")

```


### Test Phyla Rel Abund
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

# View ordered phyla - most abundant --> least abundant
# barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)
# 11 phyla: "Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Bacteria_unclassified", "Kiritimatiellaeota", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia", "Epsilonbacteraeota"

     


##### FIRMICUTES #####
fir.phy <- subset_taxa(phy99, Phylum == "Firmicutes")
fir.df <- data.frame(sample_data(fir.phy))
fir.df$RelAbund <- t(data.frame(otu_table(fir.phy)))

# Test normality
hist(fir.df$RelAbund, breaks=10)
qqnorm(fir.df$RelAbund)
qqline(fir.df$RelAbund)
shapiro.test(fir.df$RelAbund)
  # p-value = 0.02135
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=fir.df)
  # p-value = 3.367e-08
dunn.test(x = as.numeric(fir.df$RelAbund), g = as.factor(fir.df$Group), method = "bh", label = T)
  # Wild-Lab = 0.5108
  # Wild-Torpor = 0.0002*
  # Wild-IBA = 0.0001*
  # Wild-Spring = 0.1308
  # Lab-Torpor = 0.000*
  # Lab-IBA = 0.000*
  # Lab-Spring = 0.0880
  # Torpor-IBA = 0.4975
  # Torpor-Spring = 0.0226*
  # IBA-Spring = 0.0213*






##### BACTEROIDETES #####
bac.phy <- subset_taxa(phy99, Phylum == "Bacteroidetes")
bac.df <- data.frame(sample_data(bac.phy))
bac.df$RelAbund <- t(data.frame(otu_table(bac.phy)))

# Test normality
hist(bac.df$RelAbund, breaks=10)
qqnorm(bac.df$RelAbund)
qqline(bac.df$RelAbund)
shapiro.test(bac.df$RelAbund)
  # p-value = 0.461
  # Normal
  # Sticking with Kruskal-Wallis for consistency among phyla-level comparisons

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=bac.df)
  # p-value = 0.0003114
dunn.test(x = as.numeric(bac.df$RelAbund), g = as.factor(bac.df$Group), method = "bh", label = T)
  # Wild-Lab = 0.4415
  # Wild-Torpor = 0.0054*
  # Wild-IBA = 0.0058*
  # Wild-Spring = 0.0058*
  # Lab-Torpor = 0.0062*
  # Lab-IBA = 0.0073*
  # Lab-Spring = 0.0057*
  # Torpor-IBA = 0.4696
  # Torpor-Spring = 0.4759
  # IBA-Spring = 0.4447




##### Verrucomicrobia #####
ver.phy <- subset_taxa(phy99, Phylum == "Verrucomicrobia")
ver.df <- data.frame(sample_data(ver.phy))
ver.df$RelAbund <- t(data.frame(otu_table(ver.phy)))

# Test normality
hist(ver.df$RelAbund, breaks=10)
qqnorm(ver.df$RelAbund)
qqline(ver.df$RelAbund)
shapiro.test(ver.df$RelAbund)
  # p-value = 3.582e-08
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=ver.df)
  # p-value = 0.0008299
dunn.test(x = as.numeric(ver.df$RelAbund), g = as.factor(ver.df$Group), method = "bh", label = T)
  # Wild-Lab = 0.4016
  # Wild-Torpor = 0.0704
  # Wild-IBA = 0.0021*
  # Wild-Spring = 0.2333
  # Lab-Torpor = 0.0871
  # Lab-IBA = 0.0006*
  # Lab-Spring = 0.2322
  # Torpor-IBA = 0.0778
  # Torpor-Spring = 0.3166
  # IBA-Spring = 0.0677





##### PROTEOBACTERIA #####
pro.phy <- subset_taxa(phy99, Phylum == "Proteobacteria")
pro.df <- data.frame(sample_data(pro.phy))
pro.df$RelAbund <- t(data.frame(otu_table(pro.phy)))

# Test normality
hist(pro.df$RelAbund, breaks=10)
qqnorm(pro.df$RelAbund)
qqline(pro.df$RelAbund)
shapiro.test(pro.df$RelAbund)
  # p-value = 0.0003943
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=pro.df)
  # p-value = 0.003129
dunn.test(x = as.numeric(pro.df$RelAbund), g = as.factor(pro.df$Group), method = "bh", label = T)
  # Wild-Lab = 0.0678
  # Wild-Torpor = 0.0036*
  # Wild-IBA = 0.003*
  # Wild-Spring = 0.1908
  # Lab-Torpor = 0.0579
  # Lab-IBA = 0.0746
  # Lab-Spring = 0.2889
  # Torpor-IBA = 0.3555
  # Torpor-Spring = 0.0602
  # IBA-Spring = 0.0508






##### KIRITIMATIELLAEOTA #####
# Ar/ma/ti/mon/a/de/tes
# ^        ^      ^
# Ki/ri/ti/ma/ti/e/llae/o/ta
#                       ^
# Pull out kiris
kir.phy <- subset_taxa(phy99, Phylum == "Kiritimatiellaeota")
kir.df <- data.frame(sample_data(kir.phy))
kir.df$RelAbund <- t(data.frame(otu_table(kir.phy)))

# Test normality
hist(kir.df$RelAbund, breaks=10)
qqnorm(kir.df$RelAbund)
qqline(kir.df$RelAbund)
shapiro.test(kir.df$RelAbund)
  # p-value = 8.398e-13
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=kir.df)
  # p-value = 0.01903
dunn.test(x = as.numeric(kir.df$RelAbund), g = as.factor(kir.df$Group), method = "bh", label = T)
  # Wild-Lab = 0.5439
  # Wild-Torpor = 0.0414
  # Wild-IBA = 0.3471
  # Wild-Spring = 0.0531
  # Lab-Torpor = 0.0286
  # Lab-IBA = 0.3165
  # Lab-Spring = 0.0607
  # Torpor-IBA = 0.0548
  # Torpor-Spring = 0.4929
  # IBA-Spring = 0.0832






##### CYANOBACTERIA #####
# Pull out cyanos
cya.phy <- subset_taxa(phy99, Phylum == "Cyanobacteria")
cya.df <- data.frame(sample_data(cya.phy))
cya.df$RelAbund <- t(data.frame(otu_table(cya.phy)))

# Test normality
hist(cya.df$RelAbund, breaks=10)
qqnorm(cya.df$RelAbund)
qqline(cya.df$RelAbund)
shapiro.test(cya.df$RelAbund)
  # p-value = 3.154e-08
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=cya.df)
  # p-value = 6.982e-05
dunn.test(x = as.numeric(cya.df$RelAbund), g = as.factor(cya.df$Group), method = "bh", label = T)
  # Wild-Lab = 0.0003*
  # Wild-Torpor = 0.0251*
  # Wild-IBA = 0.0001*
  # Wild-Spring = 0.0001*
  # Lab-Torpor = 0.0972
  # Lab-IBA = 0.2689
  # Lab-Spring = 0.1591
  # Torpor-IBA = 0.0347
  # Torpor-Spring = 0.0244*
  # IBA-Spring = 0.2834








##### TENERICUTES #####
ten.phy <- subset_taxa(phy99, Phylum == "Tenericutes")
ten.df <- data.frame(sample_data(ten.phy))
ten.df$RelAbund <- t(data.frame(otu_table(ten.phy)))

# Test normality
hist(ten.df$RelAbund, breaks=10)
qqnorm(ten.df$RelAbund)
qqline(ten.df$RelAbund)
shapiro.test(ten.df$RelAbund)
  # p-value = 3.674e-08
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=ten.df)
  # p-value = 0.002416
dunn.test(x = as.numeric(ten.df$RelAbund), g = as.factor(ten.df$Group), method = "bh", label = T)
  # Wild-Lab = 0.0670
  # Wild-Torpor = 0.0029*
  # Wild-IBA = 0.0031*
  # Wild-Spring = 0.1740
  # Lab-Torpor = 0.0469
  # Lab-IBA = 0.0553
  # Lab-Spring = 0.3478
  # Torpor-IBA = 0.3370
  # Torpor-Spring = 0.0609
  # IBA-Spring = 0.0564






##### ACTINOBACTERIA #####
act.phy <- subset_taxa(phy99, Phylum == "Actinobacteria")
act.df <- data.frame(sample_data(act.phy))
act.df$RelAbund <- t(data.frame(otu_table(act.phy)))

# Test normality
hist(act.df$RelAbund, breaks=10)
qqnorm(act.df$RelAbund)
qqline(act.df$RelAbund)
shapiro.test(act.df$RelAbund)
  # p-value = 9.667e-05
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=act.df)
  # p-value = 0.0614







##### ELUSIMICROBIA #####
elu.phy <- subset_taxa(phy99, Phylum == "Elusimicrobia")
elu.df <- data.frame(sample_data(elu.phy))
elu.df$RelAbund <- t(data.frame(otu_table(elu.phy)))

# Test normality
hist(elu.df$RelAbund, breaks=10)
qqnorm(elu.df$RelAbund)
qqline(elu.df$RelAbund)
shapiro.test(elu.df$RelAbund)
  # p-value = 3.056e-11
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=elu.df)
  # p-value = 0.01184
dunn.test(x = as.numeric(elu.df$RelAbund), g = as.factor(elu.df$Group), method = "bh", label = T)
  # Wild-Lab = 0.0421
  # Wild-Torpor = 0.360
  # Wild-IBA = 0.2571
  # Wild-Spring = 0.0185*
  # Lab-Torpor = 0.4673
  # Lab-IBA = 0.0655
  # Lab-Spring = 0.1584
  # Torpor-IBA = 0.0627
  # Torpor-Spring = 0.1699
  # IBA-Spring = 0.0225*







##### EPSILONBACTERAEOTA #####
eps.phy <- subset_taxa(phy99, Phylum == "Epsilonbacteraeota")
eps.df <- data.frame(sample_data(eps.phy))
eps.df$RelAbund <- t(data.frame(otu_table(eps.phy)))

# Test normality
hist(eps.df$RelAbund, breaks=10)
qqnorm(eps.df$RelAbund)
qqline(eps.df$RelAbund)
shapiro.test(eps.df$RelAbund)
  # p-value = 3.941e-14
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=eps.df)
  # p-value = 0.002286
dunn.test(x = as.numeric(eps.df$RelAbund), g = as.factor(eps.df$Group), method = "bh", label = T)
  # Wild-Lab = 0.0100*
  # Wild-Torpor = 0.0107*
  # Wild-IBA = 0.0012*
  # Wild-Spring = 0.0011*
  # Lab-Torpor = 0.4864
  # Lab-IBA = 0.1699
  # Lab-Spring = 0.1500
  # Torpor-IBA = 0.1821
  # Torpor-Spring = 0.1492
  # IBA-Spring = 0.3327


```



### Plot - Phyla Rel Abund Barplots
```{r}
### Format data
phy99.df <- psmelt(phy99)
phy99.df$Phylum <- ordered(phy99.df$Phylum, levels = c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Unclassified", "Kiritimatiellaeota", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia", "Epsilonbacteraeota"))
phy99.df$Phylum[which(is.na(phy99.df$Phylum))] <- rep("Unclassified",length(which(is.na(phy99.df$Phylum))))
phy.sum <- phy99.df %>%
  group_by(Group, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance),
            iqr = IQR(Abundance))


### Plot
#tiff("phyla.tiff", width=170, height=200, units="mm", res=600)
ggplot(phy.sum, aes(x = Phylum, y = Mean, fill = Phylum)) +
  facet_wrap(Group ~ ., strip.position = "top", nrow = 5, scale = "free_y") +
  geom_bar(stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), width = 0.2) +
  xlab("Phyla") + ylab("Relative Abundance (%)") +
  scale_fill_manual(values=c("#ed5e61", "#629fd0", "#ffff33", "#bd87c5", "gray60", "orange", "lawngreen", "rosybrown1", "#cd6b32", "gold", "lightyellow")) +
  scale_y_continuous(breaks=equal_breaks(n = 4)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10),
        axis.ticks.x = element_blank(),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        strip.text = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 10),
        legend.key.height = unit(5, 'mm'),
        legend.key.width = unit(5, 'mm'),
        legend.box.margin = margin(-10,-10,-10,-10)
  )
#dev.off()
```
### Phylogenetic Diversity and SES MPD
```{r}
### Unweighted - Calculate phylogenetic diversity and MPD ###

# Calculate Faith's phylogenetic diversity
pd.res <- pd(t(data.frame(otu_table(physeq))), phy_tree(physeq), include.root = T)
pd.df <- data.frame(pd.res)

# Calculate MPD (Mean Pairwise Distance)
pd.dist <- cophenetic(phy_tree(physeq))
  # Calculate cophenetic distance
#ses.mpd.res <- ses.mpd(t(data.frame(otu_table(physeq))), pd.dist, null.model = "taxa.labels", abundance.weighted = F, runs = 999)
  # Calculate MPD
  # This'll take a while to run-- be patient
#save(ses.mpd.res, file = "mpd.RData")
load("mpd.RData")
mpd <- data.frame(ses.mpd.res)
  # Pull out MDP results


### Prepare data for plotting ###
mpd$SampleID <- row.names(mpd)
pd.res$SampleID <- row.names(pd.res)
  # Make sure all SampleID's match!

# Pull out first Stat of each test
# PD test = PD
# MPD test = SES (Standardized Effect Size)
pd.stats <- data.frame(pd.res$SampleID, pd.res$PD)
pd.stats$Measure <- rep("PD", nrow(pd.df))
colnames(pd.stats) <- c("Sample", "Stat", "Measure")
mpd.stats <- data.frame(mpd$SampleID, mpd$mpd.obs.z)
mpd.stats$Measure <- rep("MPD SES", nrow(pd.df))
colnames(mpd.stats) <- c("Sample", "Stat", "Measure")



### Prepare PD ###
pd.ready <- merge(pd.stats, meta, by = "Sample")
pd.ready$Group <- ordered(pd.ready$Group, levels = c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring"))
pd.sum <- pd.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
pd.sum$YMAX <- pd.sum$Mean + pd.sum$SE
pd.sum$YMIN <- pd.sum$Mean - pd.sum$SE



### Prepare MPD ###
mpd.ready <- merge(mpd.stats, meta, by = "Sample")
mpd.ready$Group <- ordered(mpd.ready$Group, levels = c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring"))
mpd.sum <- mpd.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
mpd.sum$YMAX <- mpd.sum$Mean + mpd.sum$SE
mpd.sum$YMIN <- mpd.sum$Mean - mpd.sum$SE





########## PLOT PD & MPD ##########

### Plot PD ###
pd.ann <- data.frame(lab = c("a", "b", "c", "bc", "b"), Group = factor(c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring")))

pd.plot <- ggplot(pd.ready, aes(x = Group, y = Stat, fill = Group)) +
  geom_violin() +
  geom_segment(aes(x = 1, y = pd.sum$YMIN[1]-0.1, xend = 1, 
                   yend = pd.sum$YMAX[1]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = pd.sum$YMIN[2]-0.1, xend = 2, 
                   yend = pd.sum$YMAX[2]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = pd.sum$YMIN[3]-0.1, xend = 3, 
                   yend = pd.sum$YMAX[3]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = pd.sum$YMIN[4]-0.1, xend = 4, 
                   yend = pd.sum$YMAX[4]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = pd.sum$YMIN[5]-0.1, xend = 5, 
                   yend = pd.sum$YMAX[5]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 1, y = pd.sum$YMIN[1]-0.1, xend = 1, 
                   yend = pd.sum$YMAX[1]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = pd.sum$YMIN[2]-0.1, xend = 2, 
                   yend = pd.sum$YMAX[2]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = pd.sum$YMIN[3]-0.1, xend = 3, 
                   yend = pd.sum$YMAX[3]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = pd.sum$YMIN[4]-0.1, xend = 4, 
                   yend = pd.sum$YMAX[4]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = pd.sum$YMIN[5]-0.1, xend = 5, 
                   yend = pd.sum$YMAX[5]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_point(data = pd.sum, aes(y= Mean), colour="black", size = 1, show.legend = F) +
  geom_point(data = pd.sum, aes(y= Mean), colour="white", size = 0.5, 
             show.legend = F) +
  scale_fill_manual(values = c("#e60000", "#ec9393", "#1c41b0", "deepskyblue", "#74b300"), labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(13,40), breaks = c(13,19.5,26,32.5,39)) +
  scale_x_discrete(labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  ylab("Faith's Phylogenetic Diversity") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 1, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 50, hjust = 1, vjust = 1.05),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = pd.ann, aes(label=lab), x=c(1,2,3,4,5),
            y=c(40,40,40,40,40), size=2, color="black")




        
### Plot MPD ###
mpd.ann <- data.frame(lab = c("ab", "a", "b", "b", "ab"), Group = factor(c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring")))

mpd.plot <- ggplot(mpd.ready, aes(x = Group, y = Stat, fill = Group)) +
  geom_violin() +
  geom_segment(aes(x = 1, y = mpd.sum$YMIN[1]-0.1, xend = 1, 
                   yend = mpd.sum$YMAX[1]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = mpd.sum$YMIN[2]-0.1, xend = 2, 
                   yend = mpd.sum$YMAX[2]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = mpd.sum$YMIN[3]-0.1, xend = 3, 
                   yend = mpd.sum$YMAX[3]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = mpd.sum$YMIN[4]-0.1, xend = 4, 
                   yend = mpd.sum$YMAX[4]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = mpd.sum$YMIN[5]-0.1, xend = 5, 
                   yend = mpd.sum$YMAX[5]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 1, y = mpd.sum$YMIN[1]-0.1, xend = 1, 
                   yend = mpd.sum$YMAX[1]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = mpd.sum$YMIN[2]-0.1, xend = 2, 
                   yend = mpd.sum$YMAX[2]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = mpd.sum$YMIN[3]-0.1, xend = 3, 
                   yend = mpd.sum$YMAX[3]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = mpd.sum$YMIN[4]-0.1, xend = 4, 
                   yend = mpd.sum$YMAX[4]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = mpd.sum$YMIN[5]-0.1, xend = 5, 
                   yend = mpd.sum$YMAX[5]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_point(data = mpd.sum, aes(y= Mean), colour="black", size = 1, show.legend = F) +
  geom_point(data = mpd.sum, aes(y= Mean), colour="white", size = 0.5, 
             show.legend = F) +
  scale_fill_manual(values = c("#e60000", "#ec9393", "#1c41b0", "deepskyblue", "#74b300"), labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(-7,5.7), breaks = c(-7,-4.5,-2,0.5,3.0,5.5)) +
  scale_x_discrete(labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  ylab("Phylogenetic Evenness (MPD)") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 1, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 50, hjust = 1, vjust = 1.05),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = mpd.ann, aes(label=lab), x=c(1,2,3,4,5),
            y=c(5.7,5.7,5.7,5.7,5.7), size=2, color="black")

        

        
        
        
        
        
########## TESTING PD & MPD ##########

### Test PD ###
hist(pd.ready$Stat, breaks=10)
qqnorm(pd.ready$Stat)
qqline(pd.ready$Stat)
shapiro.test(pd.ready$Stat)
  # p-value = 3.843e-06
  # Not Normal

# Female vs. Male
kruskal.test(formula = Stat ~ Sex, data = pd.ready)
  # p-value = 0.4484

# Run Kruskal-Wallis
kruskal.test(formula = Stat ~ Group, data = pd.ready)
  # p-value = 5.022e-06
dunn.test(x = as.numeric(pd.ready$Stat), g = as.factor(pd.ready$Group), method = "bh", label = T)
# Wild-Lab = 0.0098*
# Wild-Torpor = 0.0000*
# Wild-IBA = 0.0001*
# Wild-Spring = 0.0327
# Lab-Torpor = 0.0045*
# Lab-IBA = 0.0367
# Lab-Spring = 0.4133
# Torpor-IBA = 0.1515
# Torpor-Spring = 0.0107*
# IBA-Spring = 0.0500




 

### Test MPD ###
hist(mpd.ready$Stat, breaks=10)
qqnorm(mpd.ready$Stat)
qqline(mpd.ready$Stat)
shapiro.test(mpd.ready$Stat)
  # p-value = 0.1652
  # Normal

# Female vs. Male
wilcox.test(formula = Stat ~ Sex, data = mpd.ready)
  # p-value = 0.02257

# Run ANOVA
summary(aov(Stat ~ Group, data = mpd.ready))
  # p-value = 0.000829
TukeyHSD(aov(Stat ~ Group, data = mpd.ready))
  # Summer_Lab-Summer_Wild = 0.1031086
  # Torpor-Summer_Wild = 0.7170097
  # IBA-Summer_Wild = 0.9988490
  # Spring-Summer_Wild = 0.9906331
  # Torpor-Summer_Lab = 0.0004883*
  # IBA-Summer_Lab = 0.0103018*
  # Spring-Summer_Lab = 0.3525159
  # IBA-Torpor = 0.7487473
  # Spring-Torpor = 0.4425591
  # Spring-IBA = 0.9364683


```

### Alpha Diversity
```{r}
adiv <- data.frame(sample_data(physeq))


########## Shannon ##########
hist(adiv$shannon, breaks=10)
qqnorm(adiv$shannon)
qqline(adiv$shannon)
shapiro.test(adiv$shannon)
  # p-value = 0.2932
  # Normal

summary(aov(shannon ~ Group, data = adiv))
  # p-value = 0.847

### Prepare data for plot
shannon.sum <- adiv %>%
  group_by(Group) %>%
  summarize(Mean = mean(shannon),
            SE = se(shannon),
            SD = sd(shannon),
            Median = median(shannon))
shannon.sum$YMAX <- shannon.sum$Mean + shannon.sum$SE
shannon.sum$YMIN <- shannon.sum$Mean - shannon.sum$SE


### Plot
shannon.plot <- ggplot(adiv, aes(x = Group, y = shannon, fill = Group)) +
  geom_violin() +
  geom_segment(aes(x = 1, y = shannon.sum$YMIN[1]-0.1, xend = 1, 
                   yend = shannon.sum$YMAX[1]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = shannon.sum$YMIN[2]-0.1, xend = 2, 
                   yend = shannon.sum$YMAX[2]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = shannon.sum$YMIN[3]-0.1, xend = 3, 
                   yend = shannon.sum$YMAX[3]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = shannon.sum$YMIN[4]-0.1, xend = 4, 
                   yend = shannon.sum$YMAX[4]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = shannon.sum$YMIN[5]-0.1, xend = 5, 
                   yend = shannon.sum$YMAX[5]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 1, y = shannon.sum$YMIN[1]-0.1, xend = 1, 
                   yend = shannon.sum$YMAX[1]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = shannon.sum$YMIN[2]-0.1, xend = 2, 
                   yend = shannon.sum$YMAX[2]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = shannon.sum$YMIN[3]-0.1, xend = 3, 
                   yend = shannon.sum$YMAX[3]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = shannon.sum$YMIN[4]-0.1, xend = 4, 
                   yend = shannon.sum$YMAX[4]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = shannon.sum$YMIN[5]-0.1, xend = 5, 
                   yend = shannon.sum$YMAX[5]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_point(data = shannon.sum, aes(y= Mean), colour="black", size = 1, show.legend = F) +
  geom_point(data = shannon.sum, aes(y= Mean), colour="white", size = 0.5, 
             show.legend = F) +
  scale_fill_manual(values = c("#e60000", "#ec9393", "#1c41b0", "deepskyblue", "#74b300"), labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(1.4, 5.75), breaks = c(1.4,2.26,3.12,3.98,4.84,5.7)) +
  scale_x_discrete(labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  ylab("Shannon's Index") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        legend.title = element_text(face="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10,
                                    margin = margin(t = 1, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 50, hjust = 1, vjust = 1.05),
        axis.text.y = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.height = unit(3, 'mm'),
        legend.key.width = unit(3, "mm"),
        legend.box.margin=margin(-10,-10,-10,-10)) +
  annotate("text", x = 3, y = 5.75, label = "ns", size = 2)




########## Number of Unique OTUs ##########
otus <- data.frame(otu_table(physeq))
sampNames <- colnames(otus)
uniq.otus <- data.frame(matrix(nrow = nsamples(physeq), ncol = 2))
colnames(uniq.otus) <- c("Sample", "Unique_OTUs")
for(n in 1:nsamples(physeq)) {
  COL <- otus[,n]
  numUniq <- length(which(COL > 0))
  uniq.otus$Sample[n] <- sampNames[n]
  uniq.otus$Unique_OTUs[n] <- numUniq
}
uniq.otus$Group <- sample_data(physeq)$Group
rownames(uniq.otus) <- uniq.otus$Sample


hist(uniq.otus$Unique_OTUs, breaks=10)
qqnorm(uniq.otus$Unique_OTUs)
qqline(uniq.otus$Unique_OTUs)
shapiro.test(uniq.otus$Unique_OTUs)
  # p-value =  2.065e-06
  # Not Normal
kruskal.test(formula = Unique_OTUs ~ Group, data = uniq.otus)
  # p-value = 4.092e-07
dunn.test(x = as.numeric(uniq.otus$Unique_OTUs), g = as.factor(uniq.otus$Group), method = "bh", label = T)
# Wild-Lab = 0.0228*
# Wild-Torpor = 0.0000*
# Wild-IBA = 0.0000*
# Wild-Spring = 0.0235*
# Lab-Torpor = 0.0005*
# Lab-IBA = 0.0034*
# Lab-Spring = 0.3570
# Torpor-IBA = 0.2326
# Torpor-Spring = 0.0129*
# IBA-Spring = 0.0345




### Prepare data for plot
uniq.otus.sum <- uniq.otus %>%
  group_by(Group) %>%
  summarize(Mean = mean(Unique_OTUs),
            SE = se(Unique_OTUs),
            SD = sd(Unique_OTUs),
            Median = median(Unique_OTUs))
uniq.otus.sum$YMAX <- uniq.otus.sum$Mean + uniq.otus.sum$SE
uniq.otus.sum$YMIN <- uniq.otus.sum$Mean - uniq.otus.sum$SE

otu.ann <- data.frame(lab = c("a", "b", "c", "cd", "bd"), Group = factor(c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring")))

otu.plot <- ggplot(uniq.otus, aes(x = Group, y = Unique_OTUs, fill = Group)) +
  geom_violin() +
  geom_segment(aes(x = 1, y = uniq.otus.sum$YMIN[1]-0.1, xend = 1, 
                   yend = uniq.otus.sum$YMAX[1]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = uniq.otus.sum$YMIN[2]-0.1, xend = 2, 
                   yend = uniq.otus.sum$YMAX[2]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = uniq.otus.sum$YMIN[3]-0.1, xend = 3, 
                   yend = uniq.otus.sum$YMAX[3]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = uniq.otus.sum$YMIN[4]-0.1, xend = 4, 
                   yend = uniq.otus.sum$YMAX[4]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = uniq.otus.sum$YMIN[5]-0.1, xend = 5, 
                   yend = uniq.otus.sum$YMAX[5]+0.1), color = "black", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 1, y = uniq.otus.sum$YMIN[1]-0.1, xend = 1, 
                   yend = uniq.otus.sum$YMAX[1]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = uniq.otus.sum$YMIN[2]-0.1, xend = 2, 
                   yend = uniq.otus.sum$YMAX[2]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = uniq.otus.sum$YMIN[3]-0.1, xend = 3, 
                   yend = uniq.otus.sum$YMAX[3]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = uniq.otus.sum$YMIN[4]-0.1, xend = 4, 
                   yend = uniq.otus.sum$YMAX[4]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = uniq.otus.sum$YMIN[5]-0.1, xend = 5, 
                   yend = uniq.otus.sum$YMAX[5]+0.1), color = "white", size = 0.5, 
               show.legend = F) +
  geom_point(data = uniq.otus.sum, aes(y= Mean), colour="black", size = 1, show.legend = F) +
  geom_point(data = uniq.otus.sum, aes(y= Mean), colour="white", size = 0.5, 
             show.legend = F) +
  scale_fill_manual(values = c("#e60000", "#ec9393", "#1c41b0", "deepskyblue", "#74b300"), labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(200,800), breaks = c(200, 400, 600, 800)) +
  scale_x_discrete(labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  ylab("Number of Unique OTUs") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6, vjust = 10, 
                                    margin = margin(t = 1, r = 10, b = -15, l = 1)),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6, angle = 50, hjust = 1, vjust = 1.05),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = otu.ann, aes(label=lab), x=c(1,2,3,4,5),
            y=c(810,810,810,810,810), size=2, color="black")

```

### Plot - PD, SES MPD, Alpha Div
```{r}
tiff("adiv.tiff", width = 170, height = 60, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,4, widths = c(1, 1, 1, 1.4), heights = c(0.07, 1.5))))
grid.text("A", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=8,fontface="bold"))
print(otu.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
grid.text("B", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2),
          gp=gpar(fontsize=8,fontface="bold"))
print(pd.plot, vp=viewport(layout.pos.row=2, layout.pos.col=2))
grid.text("C", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=3),
          gp=gpar(fontsize=8,fontface="bold"))
print(mpd.plot, vp=viewport(layout.pos.row=2, layout.pos.col=3))
grid.text("D", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=4),
          gp=gpar(fontsize=8,fontface="bold"))
print(shannon.plot, vp=viewport(layout.pos.row=2, layout.pos.col=4))
dev.off()
```

### Beta Diversity
```{r}

########## Weighted UniFrac ##########
UF.w <- phyloseq::distance(physeq = physeq, method = "wunifrac")
UF.w.pcoa <- ordinate(physeq = physeq, method = "PCoA", distance = "wunifrac")
  # Variation explained = 34.9%

wUF.plot <- plot_ordination(physeq = physeq, ordination = UF.w.pcoa, axes = c(1,2),
                title = "Weighted UniFrac", color = "Group") +
  stat_ellipse(aes(colour = Group), size = 1, level = 0.95) +
  scale_colour_manual(values = c("#e60000", "#ec9393", "#1c41b0", "deepskyblue", "#74b300"), labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "none"
        )


### PERMANOVA ###
sampdf <- data.frame(sample_data(physeq))
beta.tax <- betadisper(d=UF.w, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.009
anosim(UF.w, sampdf$Group, permutations = 9999)
  # p-value = 1e-04



# Separate out pairwise comparisons
#phy.ws <- merge_phyloseq(physeq.wild, physeq.sum)
#phy.st <- merge_phyloseq(physeq.sum, physeq.tor)
#phy.si <- merge_phyloseq(physeq.sum, physeq.iba)
#phy.sp <- merge_phyloseq(physeq.sum, physeq.spr)
#phy.ti <- merge_phyloseq(physeq.tor, physeq.iba)
#phy.tp <- merge_phyloseq(physeq.tor, physeq.spr)
#phy.ip <- merge_phyloseq(physeq.iba, physeq.spr)
#phy.wt <- merge_phyloseq(physeq.wild, physeq.tor)
#phy.wi <- merge_phyloseq(physeq.wild, physeq.iba)
#phy.wp <- merge_phyloseq(physeq.wild, physeq.spr)


# Summer Wild vs. Summer Lab
ws.w <- phyloseq::distance(physeq = phy.ws, method = "wunifrac")
sampdf.ws<- data.frame(sample_data(phy.ws))
beta.tax <- betadisper(d=ws.w, group=sampdf.ws$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
anosim(ws.w, sampdf.ws$Group, permutations = 9999)
  # p-value = 0.0039

# Summer Lab vs Torpor
st.w <- phyloseq::distance(physeq = phy.st, method = "wunifrac")
sampdf.st<- data.frame(sample_data(phy.st))
beta.tax <- betadisper(d=st.w, group=sampdf.st$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.906
anosim(st.w, sampdf.st$Group, permutations = 9999)
  # p-value = 1e-04


# Summer Lab vs IBA
si.w <- phyloseq::distance(physeq = phy.si, method = "wunifrac")
sampdf.si<- data.frame(sample_data(phy.si))
beta.tax <- betadisper(d=si.w, group=sampdf.si$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.502
anosim(si.w, sampdf.si$Group, permutations = 9999)
  # p-value = 1e-04


# Summer Lab vs Spring
sp.w <- phyloseq::distance(physeq = phy.sp, method = "wunifrac")
sampdf.sp<- data.frame(sample_data(phy.sp))
beta.tax <- betadisper(d=sp.w, group=sampdf.sp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.188
anosim(sp.w, sampdf.sp$Group, permutations = 9999)
  # p-value = 0.0374


# Torpor vs IBA
ti.w <- phyloseq::distance(physeq = phy.ti, method = "wunifrac")
sampdf.ti<- data.frame(sample_data(phy.ti))
beta.tax <- betadisper(d=ti.w, group=sampdf.ti$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.48
anosim(ti.w, sampdf.ti$Group, permutations = 9999)
  # p-value = 0.7029

# Torpor vs Spring
tp.w <- phyloseq::distance(physeq = phy.tp, method = "wunifrac")
sampdf.tp<- data.frame(sample_data(phy.tp))
beta.tax <- betadisper(d=tp.w, group=sampdf.tp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.159
anosim(tp.w, sampdf.tp$Group, permutations = 9999)
  # p-value = 2e-04

# IBA vs Spring
ip.w <- phyloseq::distance(physeq = phy.ip, method = "wunifrac")
sampdf.ip<- data.frame(sample_data(phy.ip))
beta.tax <- betadisper(d=ip.w, group=sampdf.ip$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.362
anosim(ip.w, sampdf.ip$Group, permutations = 9999)
  # p-value = 1e-04

# Summer Wild vs. Torpor
wt.w <- phyloseq::distance(physeq = phy.wt, method = "wunifrac")
sampdf.wt<- data.frame(sample_data(phy.wt))
beta.tax <- betadisper(d=wt.w, group=sampdf.wt$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.004
anosim(wt.w, sampdf.wt$Group, permutations = 9999)
  # p-value = 1e-04 

# Summer Wild vs. IBA
wi.w <- phyloseq::distance(physeq = phy.wi, method = "wunifrac")
sampdf.wi<- data.frame(sample_data(phy.wi))
beta.tax <- betadisper(d=wi.w, group=sampdf.wi$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.004
anosim(wi.w, sampdf.wi$Group, permutations = 9999)
  # p-value = 1e-04

# Summer Wild vs. Spring
wp.w <- phyloseq::distance(physeq = phy.wp, method = "wunifrac")
sampdf.wp<- data.frame(sample_data(phy.wp))
beta.tax <- betadisper(d=wp.w, group=sampdf.wp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.078
anosim(wp.w, sampdf.wp$Group, permutations = 9999)
  # p-value = 5e-04


# Adjust betadisper p-values
p.adjust(c(0.001,0.906,0.502,0.188,0.48,0.159,0.362,0.004,0.004,0.078),
         method = "fdr")
  # Summer Wild vs. Summer Lab = 0.01*
  # Summer Lab vs. Torpor = 0.906
  # Summer Lab vs. IBA = 0.55778
  # Summer Lab vs. Spring = 0.3133
  # Torpor vs. IBA = 0.55778
  # Torpor vs. Spring = 0.3133
  # IBA vs. Spring = 0.51714286
  # Summer Wild vs. Torpor = 0.0133*
  # Summer Wild vs. IBA = 0.0133*
  # Summer Wild vs. Spring = 0.195

# Adjust ANOSIM p-values
p.adjust(c(0.0039,1e-04,1e-04,0.0374,0.7029,2e-04,1e-04,1e-04,1e-04,5e-04),
         method = "fdr")
  # Summer Wild vs. Summer Lab = 0.004875*
  # Summer Lab vs. Torpor = 0.0002*
  # Summer Lab vs. IBA = 0.0002*
  # Summer Lab vs. Spring = 0.041556*
  # Torpor vs. IBA = 0.7029
  # Torpor vs. Spring = 0.00033*
  # IBA vs. Spring = 0.0002*
  # Summer Wild vs. Torpor = 0.0002*
  # Summer Wild vs. IBA = 0.0002*
  # Summer Wild vs. Spring = 0.0007142857*






########## Unweighted UniFrac ##########
UF.u <- phyloseq::distance(physeq = physeq, method = "unifrac")
UF.u.pcoa <- ordinate(physeq = physeq, method = "PCoA", distance = "unifrac")
  # Variation explained = 22.4%

uUF.plot <- plot_ordination(physeq = physeq, ordination = UF.u.pcoa, axes = c(1,2),
                title = "Unweighted UniFrac", color = "Group") +
  stat_ellipse(aes(colour = Group), size = 1, level = 0.95) +
  scale_colour_manual(values = c("#e60000", "#ec9393", "#1c41b0", "deepskyblue", "#74b300"), labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.title = element_text(size = 8, face = "bold"),
        legend.text = element_text(size = 8),
        legend.key.height = unit(4, 'mm'),
        legend.box.margin=margin(-10,-10,-10,-10)
        )


### PERMANOVA ###
sampdf <- data.frame(sample_data(physeq))
beta.tax <- betadisper(d=UF.u, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
anosim(UF.u, sampdf$Group, permutations = 9999)
  # p-value = 1e-04 



# Separate out pairwise comparisons
phy.ws <- merge_phyloseq(physeq.wild, physeq.sum)
phy.st <- merge_phyloseq(physeq.sum, physeq.tor)
phy.si <- merge_phyloseq(physeq.sum, physeq.iba)
phy.sp <- merge_phyloseq(physeq.sum, physeq.spr)
phy.ti <- merge_phyloseq(physeq.tor, physeq.iba)
phy.tp <- merge_phyloseq(physeq.tor, physeq.spr)
phy.ip <- merge_phyloseq(physeq.iba, physeq.spr)
phy.wt <- merge_phyloseq(physeq.wild, physeq.tor)
phy.wi <- merge_phyloseq(physeq.wild, physeq.iba)
phy.wp <- merge_phyloseq(physeq.wild, physeq.spr)


# Summer Wild vs. Summer Lab
ws.u <- phyloseq::distance(physeq = phy.ws, method = "unifrac")
sampdf.ws<- data.frame(sample_data(phy.ws))
beta.tax <- betadisper(d=ws.u, group=sampdf.ws$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
anosim(ws.u, sampdf.ws$Group, permutations = 9999)
  # p-value = 1e-04

# Summer Lab vs Torpor
st.u <- phyloseq::distance(physeq = phy.st, method = "unifrac")
sampdf.st<- data.frame(sample_data(phy.st))
beta.tax <- betadisper(d=st.u, group=sampdf.st$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.181
anosim(st.u, sampdf.st$Group, permutations = 9999)
  # p-value = 1e-04

# Summer Lab vs IBA
si.u <- phyloseq::distance(physeq = phy.si, method = "unifrac")
sampdf.si<- data.frame(sample_data(phy.si))
beta.tax <- betadisper(d=si.u, group=sampdf.si$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.244
anosim(si.u, sampdf.si$Group, permutations = 9999)
  # p-value = 1e-04

# Summer Lab vs Spring
sp.u <- phyloseq::distance(physeq = phy.sp, method = "unifrac")
sampdf.sp<- data.frame(sample_data(phy.sp))
beta.tax <- betadisper(d=sp.u, group=sampdf.sp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.02
anosim(sp.u, sampdf.sp$Group, permutations = 9999)
  # p-value = 0.4146

# Torpor vs IBA
ti.u <- phyloseq::distance(physeq = phy.ti, method = "unifrac")
sampdf.ti<- data.frame(sample_data(phy.ti))
beta.tax <- betadisper(d=ti.u, group=sampdf.ti$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.922
anosim(ti.u, sampdf.ti$Group, permutations = 9999)
  # p-value = 0.1647

# Torpor vs Spring
tp.u <- phyloseq::distance(physeq = phy.tp, method = "unifrac")
sampdf.tp<- data.frame(sample_data(phy.tp))
beta.tax <- betadisper(d=tp.u, group=sampdf.tp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.004
anosim(tp.u, sampdf.tp$Group, permutations = 9999)
  # p-value = 0.0012

# IBA vs Spring
ip.u <- phyloseq::distance(physeq = phy.ip, method = "unifrac")
sampdf.ip<- data.frame(sample_data(phy.ip))
beta.tax <- betadisper(d=ip.u, group=sampdf.ip$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.144
anosim(ip.u, sampdf.ip$Group, permutations = 9999)
  # p-value = 0.0122


# Summer Wild vs. Torpor
wt.u <- phyloseq::distance(physeq = phy.wt, method = "unifrac")
sampdf.wt<- data.frame(sample_data(phy.wt))
beta.tax <- betadisper(d=wt.u, group=sampdf.wt$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
anosim(wt.u, sampdf.wt$Group, permutations = 9999)
  # p-value = 1e-04 

# Summer Wild vs. IBA
wi.u <- phyloseq::distance(physeq = phy.wi, method = "unifrac")
sampdf.wi<- data.frame(sample_data(phy.wi))
beta.tax <- betadisper(d=wi.u, group=sampdf.wi$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.002
anosim(wi.u, sampdf.wi$Group, permutations = 9999)
  # p-value = 1e-04 

# Summer Wild vs. Spring
wp.u <- phyloseq::distance(physeq = phy.wp, method = "unifrac")
sampdf.wp<- data.frame(sample_data(phy.wp))
beta.tax <- betadisper(d=wp.u, group=sampdf.wp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.003
anosim(wp.u, sampdf.wp$Group, permutations = 9999)
  # p-value = 5e-04


# Adjust betadisper p-values
p.adjust(c(0.001,0.181,0.244,0.02,0.922,0.004,0.144,0.001,0.002,0.003),
         method = "fdr")
  # Summer Wild vs. Summer Lab = 0.005*
  # Summer Lab vs. Torpor = 0.22625
  # Summer Lab vs. IBA = 0.2711
  # Summer Lab vs. Spring = 0.0333*
  # Torpor vs. IBA = 0.9220
  # Torpor vs. Spring = 0.008*
  # IBA vs. Spring = 0.205714286
  # Summer Wild vs. Torpor = 0.005*
  # Summer Wild vs. IBA = 0.00667*
  # Summer Wild vs. Spring = 0.0075*


# Adjust ANOSIM p-values
p.adjust(c(1e-04,1e-04,1e-04,0.4146,0.1647,0.0012,0.0122,1e-04,1e-04,5e-04),
         method = "fdr")
  # Summer Wild vs. Summer Lab = 0.0002*
  # Summer Lab vs. Torpor = 0.0002*
  # Summer Lab vs. IBA = 0.0002*
  # Summer Lab vs. Spring = 0.4146
  # Torpor vs. IBA = 0.183
  # Torpor vs. Spring = 0.0017142857*
  # IBA vs. Spring = 0.01525*
  # Summer Wild vs. Torpor = 0.0002*
  # Summer Wild vs. IBA = 0.0002*
  # Summer Wild vs. Spring = 0.000833*



```


### Plot - UniFrac Ordinations
```{r}
tiff("bdiv.tiff", width = 170, height = 60, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,2, widths = c(0.73, 1), heights = c(0.1, 1.5))))
grid.text("A", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))
print(wUF.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
grid.text("B", x=unit(0.03, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2),
          gp=gpar(fontsize=12,fontface="bold"))
print(uUF.plot, vp=viewport(layout.pos.row=2, layout.pos.col=2))
dev.off()
```

### Simper
```{r}
# Change Group names to be compatible (no "_")
sum.rename <- data.frame(sample_data(physeq))
sum.rename$GroupRename <- rep(NA, nrow(sum.rename))
sum.rename$GroupRename[which(sum.rename$Group == "Summer_Wild")] <- "SummerWild"
sum.rename$GroupRename[which(sum.rename$Group == "Summer_Lab")] <- "SummerLab"
sum.rename$GroupRename[which(sum.rename$Group == "Torpor")] <- "Torpor"
sum.rename$GroupRename[which(sum.rename$Group == "IBA")] <- "IBA"
sum.rename$GroupRename[which(sum.rename$Group == "Spring")] <- "Spring"
sum.rename$GroupRename <- ordered(sum.rename$GroupRename, levels = c("SummerWild", "SummerLab", "Torpor", "IBA", "Spring"))
physeq.simp <- merge_phyloseq(otu_table(physeq), sample_data(sum.rename), tax_table(physeq))


# Group
#simper.pretty(data.frame(otu_table(physeq.simp)),
              data.frame(sample_data(physeq.simp)),
              c("GroupRename"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='group')
#group.simper <- read.csv("group_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(physeq.simp)),
               data.frame(sample_data(physeq.simp)),
               csv = group.simper,
               c("GroupRename"),
               output_name = 'group',
               taxonomy = data.frame(tax_table(physeq.simp)))
#group.simper.kw <- read.csv("group_krusk_simper.csv")
#for(i in 1:nrow(group.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.simp))) == group.simper.kw$OTU[i])
  group.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.simp))[save,2], "-",
          data.frame(tax_table(physeq.simp))[save,3], "-",
          data.frame(tax_table(physeq.simp))[save,4], "-",
          data.frame(tax_table(physeq.simp))[save,5], "-",
          data.frame(tax_table(physeq.simp))[save,6])
}
#write.table(group.simper.kw, "group_krusk_simper.csv", sep=",")
#group.simper.kw <- read.csv("group_clean_simper.csv", row.names = 1)
```


### Prepare SIMPER Heatmap
```{r}
simp <- read.csv("simper/group_krusk_simper.csv", sep = ",")
simp.sig <- simp[which(simp$fdr_krusk_p.val < 0.05),]
uniq.simp <- unique(simp.sig$OTU)
  # 23 OTUs

w.sig <- c("Otu00111", "Otu00119", "Otu00096", "Otu00166", "Otu00163", "Otu00055", "Otu00140")
s.sig <- c("Otu00035", "Otu00003", "Otu00017", "Otu00027", "Otu00033", "Otu00019")
t.sig <- c("Otu00013", "Otu00016", "Otu00004")
i.sig <- c("Otu00004", "Otu00001", "Otu00009")
p.sig <- c("Otu00005", "Otu00008", "Otu00002", "Otu00015", "Otu00044")


w.sig.phy <- subset_taxa(physeq, Species %in% w.sig) 
s.sig.phy <- subset_taxa(physeq, Species %in% s.sig)  
t.sig.phy <- subset_taxa(physeq, Species %in% t.sig)  
i.sig.phy <- subset_taxa(physeq, Species %in% i.sig)  
p.sig.phy <- subset_taxa(physeq, Species %in% p.sig)  



w.sig.df <- psmelt(w.sig.phy)
w.sig.sum <- w.sig.df %>%
  group_by(Group, Species) %>%
  summarize(Mean = mean(Abundance))
w.sig.sum$Species <- ordered(w.sig.sum$Species, levels = c("Otu00140", "Otu00055", "Otu00163", "Otu00166", "Otu00096", "Otu00119", "Otu00111"))

s.sig.df <- psmelt(s.sig.phy)
s.sig.sum <- s.sig.df %>%
  group_by(Group, Species) %>%
  summarize(Mean = mean(Abundance))
s.sig.sum$Species <- ordered(s.sig.sum$Species, levels = c("Otu00019", "Otu00033", "Otu00027", "Otu00017", "Otu00003", "Otu00035"))

t.sig.df <- psmelt(t.sig.phy)
t.sig.sum <- t.sig.df %>%
  group_by(Group, Species) %>%
  summarize(Mean = mean(Abundance))
t.sig.sum$Species <- ordered(t.sig.sum$Species, levels = c("Otu00004", "Otu00016", "Otu00013"))

i.sig.df <- psmelt(i.sig.phy)
i.sig.sum <- i.sig.df %>%
  group_by(Group, Species) %>%
  summarize(Mean = mean(Abundance))
i.sig.sum$Species <- ordered(i.sig.sum$Species, levels = c("Otu00009", "Otu00001", "Otu00004"))

p.sig.df <- psmelt(p.sig.phy)
p.sig.sum <- p.sig.df %>%
  group_by(Group, Species) %>%
  summarize(Mean = mean(Abundance))
p.sig.sum$Species <- ordered(p.sig.sum$Species, levels = c("Otu00044", "Otu00015", "Otu00002", "Otu00008", "Otu00005"))



########## SIMPER HEATMAP ##########


w.simp.plot <- ggplot(w.sig.sum, aes(x = Group, y = Species, fill = Mean)) +
  geom_tile(colour = "gray40") + coord_equal() +
  geom_text(size = 3, aes(label=sprintf("%0.1f", round(Mean, digits=1)))) +
  scale_y_discrete(labels = c(expression(italic("Ruminiclostridium 6")^"SummerLab,IBA,Spring"),
                              expression(italic("Prevotellaceae UCG-003")^"IBA"),
                              expression(italic("Lachnospiraceae NK4A136")^"SummerLab,Spring"),
                              expression("Lachnospiraceae"^"SummerLab"),
                              expression("Lachnospiraceae"^"SummerLab"),
                              expression("Lachnospiraceae"^"All"),
                              expression("Lachnospiraceae"^"All")),
                   position = "right") +
  scale_fill_gradientn(name = "Mean Relative\nAbundance (%)", limits = c(0, 2.5),
                       breaks = c(0, 1.25, 2.5),
                       labels = c("0", "1.2", "2.4"),
                       colours = c("#fffafa", "#ff764d"),
                       guide = guide_colorbar(frame.colour = "black", frame.linewidth = 1,
                                              ticks = T, ticks.colour = "black",
                                              ticks.linewidth = 1.5)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10, color = "black"),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        legend.key.height = unit(2.75, 'mm'),
        legend.key.width = unit(4, "mm"),
        legend.box.margin=margin(0,0,0,1.5, unit = "mm"),
        plot.margin = margin(t=0, r=0, b=0, l=25.7, unit = "mm")
  )


s.simp.plot <- ggplot(s.sig.sum, aes(x = Group, y = Species, fill = Mean)) +
  geom_tile(colour = "gray40") + coord_equal() +
  geom_text(size = 3, aes(label=sprintf("%0.1f", round(Mean, digits=1)))) +
  scale_y_discrete(labels = c(expression("Lachnospiraceae"^"SummerWild,Torpor,IBA"),
                              expression("Bacteroidales"^"SummerWild,Torpor,IBA"), 
                              expression(italic("Lachnospiraceae NK4A469")^"Torpor,IBA"),
                              expression(italic("Ruminococcus 1"^"Torpor,IBA")), 
                              expression("Lachnospiraceae"^"Torpor"), 
                              expression(italic("Lactobacillus")^"All")),
                   position = "right") +
  scale_fill_gradientn(name = "Mean Relative\nAbundance (%)", limits = c(0, 12),
                       breaks = c(0, 6, 12),
                       labels = c("0", "6", "12"),
                       colours = c("#fffafb", "#ec93a3"),
                       guide = guide_colorbar(frame.colour = "black", frame.linewidth = 1,
                                              ticks = T, ticks.colour = "black",
                                              ticks.linewidth = 1.5)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10, color = "black"),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border= element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        legend.key.height = unit(2.75, 'mm'),
        legend.key.width = unit(4, "mm"),
        legend.box.margin=margin(0,0,0,11, unit = "mm"),
        plot.margin = margin(t=0, r=0, b=0, l=26, unit = "mm")
        )


t.simp.plot <- ggplot(t.sig.sum, aes(x = Group, y = Species, fill = Mean)) +
  geom_tile(colour = "gray40") + coord_equal() +
  geom_text(size = 3, aes(label=sprintf("%0.1f", round(Mean, digits=1)))) +
  scale_y_discrete(labels = c(expression(italic("Odoribacter")^"SummerWild,SummerLab,Spring"),
                              expression(italic("Bacteroides")^"SummerWild,SummerLab"),
                              expression("WCHB1-41"^"SummerLab")),
                   position = "right") +
  scale_fill_gradientn(name = "Mean Relative\nAbundance (%)", limits = c(0, 11.4),
                       breaks = c(0, 5.7, 11.4),
                       labels = c("0", "5.7", "11.4"),
                       colours = c("#f5f5ff", "#a5a1de"),
                       guide = guide_colorbar(frame.colour = "black", frame.linewidth = 1,
                                              ticks = T, ticks.colour = "black",
                                              ticks.linewidth = 1.5)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10, color = "black"),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        legend.key.height = unit(2.75, 'mm'),
        legend.key.width = unit(4, "mm"),
        legend.box.margin=margin(0,0,0,12, unit = "mm"),
        plot.margin = margin(t=0, r=0, b=0, l=26.8, unit = "mm")
        )



i.simp.plot <- ggplot(i.sig.sum, aes(x = Group, y = Species, fill = Mean)) +
  geom_tile(colour = "gray40") + coord_equal() +
  geom_text(size = 3, aes(label=sprintf("%0.1f", round(Mean, digits=1)))) +
  scale_y_discrete(labels = c(expression("Muribaculaceae"^"SummerWild,SummerLab"),
                              expression(italic("Akkermansia")^"SummerWild,SummerLab"),
                              expression(italic("Odoribacter")^"SummerLab")),
                   position = "right") +
  scale_fill_gradientn(name = "Mean Relative\nAbundance (%)", limits = c(0, 17.6),
                       breaks = c(0, 8.8, 17.6),
                       labels = c("0", "8.8", "17.6"),
                       colours = c("#e6f9ff", "#4dd2ff"),
                       guide = guide_colorbar(frame.colour = "black", frame.linewidth = 1,
                                              ticks = T, ticks.colour = "black",
                                              ticks.linewidth = 1.5)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10, color = "black"),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        legend.key.height = unit(2.75, 'mm'),
        legend.key.width = unit(4, "mm"),
        legend.box.margin=margin(0,0,0,13.5, unit = "mm"),
        plot.margin = margin(t=0, r=0, b=0, l=26.8, unit = "mm")
        )


p.simp.plot <- ggplot(p.sig.sum, aes(x = Group, y = Species, fill = Mean)) +
  geom_tile(colour = "gray40") + coord_equal() +
  geom_text(size = 3, aes(label=sprintf("%0.1f", round(Mean, digits=1)))) +
  scale_y_discrete(labels = c(expression(italic("Lactobacillus")^"SummerWild,Torpor"),
                              expression(italic("Coprococcus 2")^"SummerWild,Torpor"),
                              expression(italic("Bacteroides")^"SummerWild"),
                              expression(italic("Prevotellaceae UCG-001")^"All"),
                              expression("Lachnospiraceae"^"All")),
                   position = "right") +
  scale_fill_gradientn(name = "Mean Relative\nAbundance (%)", limits = c(0, 6.8),
                       breaks = c(0, 3.4, 6.8),
                       labels = c("0", "3.4", "6.8"),
                       colours = c("#f4fbf4", "#adebad", "#5bd75b"),
                       guide = guide_colorbar(frame.colour = "black", frame.linewidth = 1,
                                              ticks = T, ticks.colour = "black",
                                              ticks.linewidth = 1.5)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10, color = "black"),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        legend.key.height = unit(2.75, 'mm'),
        legend.key.width = unit(4, "mm"),
        legend.box.margin=margin(0,0,0,20, unit = "mm"),
        plot.margin = margin(t=0, r=0, b=0, l=26.5, unit = "mm")
        )


```
### Plot - SIMPER Heatmap
```{r}
tiff("heatmap.tiff", width = 170, height = 225, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(6,1, heights = c(0.40,1, 0.863, 0.453, 0.454, 0.726))))

print(w.simp.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
print(s.simp.plot, vp=viewport(layout.pos.row=3, layout.pos.col=1))
print(t.simp.plot, vp=viewport(layout.pos.row=4, layout.pos.col=1))
print(i.simp.plot, vp=viewport(layout.pos.row=5, layout.pos.col=1))
print(p.simp.plot, vp=viewport(layout.pos.row=6, layout.pos.col=1))

grid.text("Summer\nWild", x=unit(0.15, "npc"), y = unit(0.5, "npc"),
          vp=viewport(layout.pos.row=2, layout.pos.col=1),
          gp=gpar(fontsize=12), just = "right")
grid.text("Summer\nLab", x=unit(0.15, "npc"), y = unit(0.5, "npc"),
          vp=viewport(layout.pos.row=3, layout.pos.col=1),
          gp=gpar(fontsize=12), just = "right")
grid.text("Torpor", x=unit(0.15, "npc"), y = unit(0.5, "npc"),
          vp=viewport(layout.pos.row=4, layout.pos.col=1),
          gp=gpar(fontsize=12), just = "right")
grid.text("IBA", x=unit(0.15, "npc"), y = unit(0.5, "npc"),
          vp=viewport(layout.pos.row=5, layout.pos.col=1),
          gp=gpar(fontsize=12), just = "right")
grid.text("Spring", x=unit(0.15, "npc"), y = unit(0.5, "npc"),
          vp=viewport(layout.pos.row=6, layout.pos.col=1),
          gp=gpar(fontsize=12), just = "right")

grid.text("Season with overrepresentation", x=unit(0.02, "npc"), y = unit(0.5, "npc"),
          vp=viewport(layout.pos.row=2:6, layout.pos.col=1),
          gp=gpar(fontsize=14,fontface="bold"), rot = 90)
grid.text("OTU Taxonomic Classification", x=unit(0.78, "npc"), y = unit(0.5, "npc"),
          vp=viewport(layout.pos.row=2:6, layout.pos.col=1),
          gp=gpar(fontsize=14,fontface="bold"), rot = 270)

grid.text("Group", x=unit(0.29, "npc"), y = unit(0.9, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=14,fontface="bold"))
grid.text("Summer Wild", x=unit(0.235, "npc"), y = unit(0.34, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=12), rot = 35)
grid.text("Summer Lab", x=unit(0.285, "npc"), y = unit(0.34, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=12), rot = 35)
grid.text("Torpor", x=unit(0.31, "npc"), y = unit(0.2, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=12), rot = 35)
grid.text("IBA", x=unit(0.35, "npc"), y = unit(0.15, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=12), rot = 35)
grid.text("Spring", x=unit(0.405, "npc"), y = unit(0.2, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=12), rot = 35)

dev.off()
```
