---
title: "Code"
author: "Edna Chiang"
date: "May 7, 2018"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(ggplot2)
library(gplots)
library(phangorn)
library(tidyr)
library(vegan)
library(phyloseq)
library(grid)
library(pgirmess)
library(picante)
library(phytools)
theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('scripts/veganCovEllipse.R')
source('scripts/simper_pretty.R')
source('scripts/R_krusk.R')
source('scripts/pairwise.adonis.R')
source('scripts/misc.R')
```

### Import Data
```{r}
# Link files
shared = "mothur_output/final.shared"
taxonomy = "mothur_output/final.taxonomy"
tree = "mothur_output/final.tre"

# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy,
  mothur_tree_file = tree)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

# Add metadata
meta <- read.csv("metadata.csv")
rownames(meta) <- meta$Sample
divsum <- read.table("mothur_output/final.summary", header = T)
meta[,12:21] <- divsum[,3:12]

# Update phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))

# Order factors
sample_data(physeq)$Season <- ordered(sample_data(physeq)$Season,
                                     levels=c("Summer", "Winter", "Spring"))
sample_data(physeq)$Metabolism <- ordered(sample_data(physeq)$Metabolism,
                                     levels=c("Active", "Torpor", "IBA"))
sample_data(physeq)$Group <- ordered(sample_data(physeq)$Group,
                                     levels=c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring"))

# Remove outliers
physeq <- subset_samples(physeq, ID != 3925)
physeq <- subset_samples(physeq, ID != 3916)

# Separate by season
physeq.wild <- subset_samples(physeq, Group == "Summer_Wild")
physeq.sum <- subset_samples(physeq, Group == "Summer_Lab")
physeq.tor <- subset_samples(physeq, Group == "Torpor")
physeq.iba <- subset_samples(physeq, Group == "IBA")
physeq.spr <- subset_samples(physeq, Group == "Spring")

# Pull out only lab squirrels
physeq.lab <- subset_samples(physeq, Diet != "Wild")

# Min, Mean, Max of sample read counts
min(sample_sums(mothurdata))
  # 10452
mean(sample_sums(mothurdata))
  # 10999.21
median(sample_sums(mothurdata))
  # 11028
max(sample_sums(mothurdata))
  # 11156
```

### Phylogenetic Diversity and SES MPD
```{r}
### Unweighted - Calculate phylogenetic diversity and MPD ###

# Calculate Faith's phylogenetic diversity
pd.res <- pd(t(data.frame(otu_table(physeq))), phy_tree(physeq), include.root = T)
pd.df <- data.frame(pd.res)

# Calculate MPD (Mean Pairwise Distance)
pd.dist <- cophenetic(phy_tree(physeq))
  # Calculate cophenetic distance
ses.mpd.res <- ses.mpd(t(data.frame(otu_table(physeq))), pd.dist, null.model = "taxa.labels", abundance.weighted = F, runs = 999)
  # Calculate MPD
  # This'll take a while to run-- be patient
#save(ses.mpd.res, file = "mpd.RData")
load("mpd.RData")
mpd <- data.frame(ses.mpd.res)
  # Pull out MDP results


### Prepare data for plotting ###
mpd$SampleID <- row.names(mpd)
pd.res$SampleID <- row.names(pd.res)
  # Make sure all SampleID's match!

# Pull out first Stat of each test
# PD test = PD
# MPD test = SES (Standardized Effect Size)
pd.stats <- data.frame(pd.res$SampleID, pd.res$PD)
pd.stats$Measure <- rep("PD", nrow(pd.df))
colnames(pd.stats) <- c("Sample", "Stat", "Measure")
mpd.stats <- data.frame(mpd$SampleID, mpd$mpd.obs.z)
mpd.stats$Measure <- rep("MPD SES", nrow(pd.df))
colnames(mpd.stats) <- c("Sample", "Stat", "Measure")



### Prepare PD ###
pd.ready <- merge(pd.stats, meta, by = "Sample")
pd.ready$Group <- ordered(pd.ready$Group, levels = c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring"))
pd.sum <- pd.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
pd.sum$YMAX <- pd.sum$Mean + pd.sum$SE
pd.sum$YMIN <- pd.sum$Mean - pd.sum$SE



### Prepare MPD ###
mpd.ready <- merge(mpd.stats, meta, by = "Sample")
mpd.ready$Group <- ordered(mpd.ready$Group, levels = c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring"))
mpd.sum <- mpd.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
mpd.sum$YMAX <- mpd.sum$Mean + mpd.sum$SE
mpd.sum$YMIN <- mpd.sum$Mean - mpd.sum$SE





########## PLOT PD & MPD ##########

### Plot PD ###
pd.plot <- ggplot(pd.ready, aes(x = Group, y = Stat, fill = Group)) +
  geom_violin() +
  geom_jitter(size=2, width = 0.2) + 
  geom_segment(aes(x = 1, y = pd.sum$YMIN[1]-0.1, xend = 1, 
                   yend = pd.sum$YMAX[1]+0.1), color = "black", size = 2, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = pd.sum$YMIN[2]-0.1, xend = 2, 
                   yend = pd.sum$YMAX[2]+0.1), color = "black", size = 2, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = pd.sum$YMIN[3]-0.1, xend = 3, 
                   yend = pd.sum$YMAX[3]+0.1), color = "black", size = 2, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = pd.sum$YMIN[4]-0.1, xend = 4, 
                   yend = pd.sum$YMAX[4]+0.1), color = "black", size = 2, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = pd.sum$YMIN[5]-0.1, xend = 5, 
                   yend = pd.sum$YMAX[5]+0.1), color = "black", size = 2, 
               show.legend = F) +
  geom_segment(aes(x = 1, y = pd.sum$YMIN[1]-0.1, xend = 1, 
                   yend = pd.sum$YMAX[1]+0.1), color = "yellow", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = pd.sum$YMIN[2]-0.1, xend = 2, 
                   yend = pd.sum$YMAX[2]+0.1), color = "yellow", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = pd.sum$YMIN[3]-0.1, xend = 3, 
                   yend = pd.sum$YMAX[3]+0.1), color = "yellow", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = pd.sum$YMIN[4]-0.1, xend = 4, 
                   yend = pd.sum$YMAX[4]+0.1), color = "yellow", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = pd.sum$YMIN[5]-0.1, xend = 5, 
                   yend = pd.sum$YMAX[5]+0.1), color = "yellow", size = 1, 
               show.legend = F) +
  geom_point(data = pd.sum, aes(y= Mean), colour="black", size = 3, show.legend = F) +
  geom_point(data = pd.sum, aes(y= Mean), colour="yellow", size = 2, 
             show.legend = F) +
  scale_fill_manual(values = c("#e60000", "#ec9393", "royalblue1", "deepskyblue", "#6fdc6f"), labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(0,50)) +
  scale_x_discrete(labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  ylab("Faith's Phylogenetic Diversity") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=16),
        strip.text.x = element_text(face ="bold", size=16),
        legend.title = element_text(face="bold", size=16),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(face="bold", size=16),
        axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=13),
        legend.text = element_text(size=14))




        
### Plot MPD ###
mpd.plot <- ggplot(mpd.ready, aes(x = Group, y = Stat, fill = Group)) +
  geom_violin() +
  geom_jitter(size=2, width = 0.2) + 
  geom_segment(aes(x = 1, y = mpd.sum$YMIN[1]-0.1, xend = 1, 
                   yend = mpd.sum$YMAX[1]+0.1), color = "black", size = 2, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = mpd.sum$YMIN[2]-0.1, xend = 2, 
                   yend = mpd.sum$YMAX[2]+0.1), color = "black", size = 2, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = mpd.sum$YMIN[3]-0.1, xend = 3, 
                   yend = mpd.sum$YMAX[3]+0.1), color = "black", size = 2, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = mpd.sum$YMIN[4]-0.1, xend = 4, 
                   yend = mpd.sum$YMAX[4]+0.1), color = "black", size = 2, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = mpd.sum$YMIN[5]-0.1, xend = 5, 
                   yend = mpd.sum$YMAX[5]+0.1), color = "black", size = 2, 
               show.legend = F) +
  geom_segment(aes(x = 1, y = mpd.sum$YMIN[1]-0.1, xend = 1, 
                   yend = mpd.sum$YMAX[1]+0.1), color = "yellow", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 2, y = mpd.sum$YMIN[2]-0.1, xend = 2, 
                   yend = mpd.sum$YMAX[2]+0.1), color = "yellow", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 3, y = mpd.sum$YMIN[3]-0.1, xend = 3, 
                   yend = mpd.sum$YMAX[3]+0.1), color = "yellow", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 4, y = mpd.sum$YMIN[4]-0.1, xend = 4, 
                   yend = mpd.sum$YMAX[4]+0.1), color = "yellow", size = 1, 
               show.legend = F) +
  geom_segment(aes(x = 5, y = mpd.sum$YMIN[5]-0.1, xend = 5, 
                   yend = mpd.sum$YMAX[5]+0.1), color = "yellow", size = 1, 
               show.legend = F) +
  geom_point(data = mpd.sum, aes(y= Mean), colour="black", size = 3, show.legend = F) +
  geom_point(data = mpd.sum, aes(y= Mean), colour="yellow", size = 2, 
             show.legend = F) +
  scale_fill_manual(values = c("#e60000", "#ec9393", "royalblue1", "deepskyblue", "#6fdc6f"), labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  scale_y_continuous(limits = c(-12,6), breaks = c(-12,-6,0,6)) +
  scale_x_discrete(labels = c("Summer Wild", "Summer Lab", "Torpor", "IBA", "Spring")) +
  ylab("SES MPD") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=16),
        strip.text.x = element_text(face ="bold", size=16),
        legend.title = element_text(face="bold", size=16),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(face="bold", size=16),
        axis.text.x = element_text(size=13),
        axis.text.y = element_text(size=13),
        legend.text = element_text(size=14))

        

        
        
        
        
        
########## TESTING PD & MPD ##########

### Test PD ###
hist(pd.ready$Stat, breaks=10)
qqnorm(pd.ready$Stat)
qqline(pd.ready$Stat)
shapiro.test(pd.ready$Stat)
  # p-value = 0.0003125
  # Not Normal

# Female vs. Male
kruskal.test(formula = Stat ~ Sex, data = pd.ready)
  # p-value = 0.2129

# Subset out groups
pd.wild <- pd.ready[which(pd.ready$Group == "Summer_Wild"),]
pd.sum <- pd.ready[which(pd.ready$Group == "Summer_Lab"),]
pd.tor <- pd.ready[which(pd.ready$Group == "Torpor"),]
pd.iba <- pd.ready[which(pd.ready$Group == "IBA"),]
pd.spr <- pd.ready[which(pd.ready$Group == "Spring"),]

# Subset out pairwise comparisons
pd.ws <- rbind(pd.wild, pd.sum)
pd.st <- rbind(pd.sum, pd.tor)
pd.si <- rbind(pd.sum, pd.iba)
pd.sp <- rbind(pd.sum, pd.spr)
pd.ti <- rbind(pd.tor, pd.iba)
pd.tp <- rbind(pd.tor, pd.spr)
pd.ip <- rbind(pd.iba, pd.spr)
pd.wt <- rbind(pd.wild, pd.tor)
pd.wi <- rbind(pd.wild, pd.iba)
pd.wp <- rbind(pd.wild, pd.spr)


# Run Kruskal-Wallis
kruskal.test(formula = Stat ~ Group, data = pd.ready)
  # p-value = 5.833e-06
kruskal.test(formula = Stat ~ Group, data = pd.ws)
  # Summer Wild vs. Summer Lab
  # p-value = 0.0002831     
kruskal.test(formula = Stat ~ Group, data = pd.st)
  # Summer vs. Torpor
  # p-value = 0.001414
kruskal.test(formula = Stat ~ Group, data = pd.si)
  # Summer vs. IBA
  # p-value = 0.001944
kruskal.test(formula = Stat ~ Group, data = pd.sp)
  # Summer vs. Spring
  # p-value = 0.2758
kruskal.test(formula = Stat ~ Group, data = pd.ti)
  # Torpor vs. IBA
  # p-value = 0.9563
kruskal.test(formula = Stat ~ Group, data = pd.tp)
  # Torpor vs. Spring
  # p-value = 0.03481
kruskal.test(formula = Stat ~ Group, data = pd.ip)
  # IBA vs. Spring
  # p-value = 0.05783
kruskal.test(formula = Stat ~ Group, data = pd.wt)
  # Summer Wild vs. Torpor
  # p-value = 0.0004888
kruskal.test(formula = Stat ~ Group, data = pd.wi)
  # Summer Wild vs. IBA
  # p-value = 0.0002566    
kruskal.test(formula = Stat ~ Group, data = pd.wp)
  # Summer Wild vs. Spring
  # p-value = 0.0027 

# Adjust p-values
p.adjust(c(0.0002831, 0.001414, 0.001944, 0.2758, 0.9563, 0.03481, 0.05783, 0.0004888, 0.0002566, 0.0027), method = "fdr")
  # Summer Wild vs. Summer Lab = 0.0014155*
  # Summer Lab vs. Torpor = 0.003535*
  # Summer Lab vs. IBA = 0.003888*
  # Summer Lab vs. Spring = 0.30644
  # Torpor vs. IBA = 0.9563
  # Torpor vs. Spring = 0.049728571*
  # IBA vs. Spring = 0.0722875
  # Summer Wild vs. Torpor = 0.00162933*
  # Summer Wild vs. IBA = 0.0014155*
  # Summer Wild vs. Spring = 0.0045*


 

### Test MPD ###
hist(mpd.ready$Stat, breaks=10)
qqnorm(mpd.ready$Stat)
qqline(mpd.ready$Stat)
shapiro.test(mpd.ready$Stat)
  # p-value = 0.1952
  # Normal

# Female vs. Male
wilcox.test(formula = Stat ~ Sex, data = mpd.ready)
  # p-value = 0.1632

# Run ANOVA
summary(aov(Stat ~ Group, data = mpd.ready))
  # p-value = 2.78e-07
TukeyHSD(aov(Stat ~ Group, data = mpd.ready))
  # Summer_Lab-Summer_Wild = 0.9488331
  # Torpor-Summer_Wild = 0.0006378*
  # IBA-Summer_Wild = 0.0071398*
  # Spring-Summer_Wild = 0.4584299
  # Torpor-Summer_Lab = 0.0000015*
  # IBA-Summer_Lab = 0.0000243*
  # Spring-Summer_Lab = 0.0825831
  # IBA-Torpor = 0.7890777
  # Spring-Torpor = 0.1584833
  # Spring-IBA = 0.5855451


```

### Alpha Diversity
```{r}
adiv <- data.frame(sample_data(physeq))

# Separate by groups of interest
adiv.sum2 <- adiv[which(adiv$Season == "Summer"),]
adiv.lab <- adiv[which(adiv$Diet == "Lab"),]



########## Chao ##########
hist(adiv$chao, breaks=10)
qqnorm(adiv$chao)
qqline(adiv$chao)
shapiro.test(adiv$chao)
  # p-value = 0.003256
  # Not Normal
hist(adiv.sum2$chao, breaks=10)
qqnorm(adiv.sum2$chao)
qqline(adiv.sum2$chao)
shapiro.test(adiv.sum2$chao)
  # p-value = 0.3182
  # Normal
hist(adiv.lab$chao, breaks=10)
qqnorm(adiv.lab$chao)
qqline(adiv.lab$chao)
shapiro.test(adiv.lab$chao)
  # p-value = 0.007034
  # Not Normal

kruskal.test(formula = chao ~ Group, data = adiv)
  # p-value = 0.6918
t.test(chao ~ Group, data = adiv.sum2)
  # p-value = 0.5267
kruskal.test(formula = chao ~ Group, data = adiv.lab)
  # p-value = 0.5676




########## Shannon ##########
hist(adiv$shannon, breaks=10)
qqnorm(adiv$shannon)
qqline(adiv$shannon)
shapiro.test(adiv$shannon)
  # p-value = 0.2932
  # Normal
hist(adiv.sum2$shannon, breaks=10)
qqnorm(adiv.sum2$shannon)
qqline(adiv.sum2$shannon)
shapiro.test(adiv.sum2$shannon)
  # p-value = 0.06212
  # Normal
hist(adiv.lab$shannon, breaks=10)
qqnorm(adiv.lab$shannon)
qqline(adiv.lab$shannon)
shapiro.test(adiv.lab$shannon)
  # p-value = 0.4766
  # Normal


summary(aov(shannon ~ Group, data = adiv))
  # p-value = 0.847
t.test(shannon ~ Group, data = adiv.sum2)
  # p-value = 0.6984
summary(aov(shannon ~ Group, data = adiv.lab))
  # p-value = 0.698




########## Inverse Simpson ##########
hist(adiv$invsimpson, breaks=10)
qqnorm(adiv$invsimpson)
qqline(adiv$invsimpson)
shapiro.test(adiv$invsimpson)
  # p-value = 7.106e-05
  # Not Normal
hist(adiv.sum2$invsimpson, breaks=10)
qqnorm(adiv.sum2$invsimpson)
qqline(adiv.sum2$invsimpson)
shapiro.test(adiv.sum2$invsimpson)
  # p-value = 0.03823
  # Not Normal
hist(adiv.lab$invsimpson, breaks=10)
qqnorm(adiv.lab$invsimpson)
qqline(adiv.lab$invsimpson)
shapiro.test(adiv.lab$invsimpson)
  # p-value = 6.15e-05
  # Not Normal

kruskal.test(formula = invsimpson ~ Group, data = adiv)
  # p-value = 0.5912
wilcox.test(invsimpson ~ Group, data = adiv.sum2)
  # p-value = 0.6796
kruskal.test(formula = invsimpson ~ Group, data = adiv.lab)
  # p-value = 0.4772





##### Plot #####
ggplot(adiv, aes(x = Group, y = shannon, fill = Group)) +
  geom_boxplot(position = position_dodge(1), outlier.shape = NA) +
  geom_jitter(size=2, width = 0.2)





```



### Beta Diversity
```{r}
########## Unweighted UniFrac ##########
UF.u <- phyloseq::distance(physeq = physeq, method = "unifrac")
UF.u.pcoa <- ordinate(physeq = physeq, method = "PCoA", distance = "unifrac")
  # Variation explained = 22.4%

plot_ordination(physeq = physeq, ordination = UF.u.pcoa, axes = c(1,2),
                title = "Unweighted UniFrac") +
  geom_point(size = 2, aes(colour = Group))


### PERMANOVA ###
sampdf <- data.frame(sample_data(physeq))
beta.tax <- betadisper(d=UF.u, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
anosim(UF.u, sampdf$Group, permutations = 9999)
  # p-value = 1e-04 



# Separate out pairwise comparisons
phy.ws <- merge_phyloseq(physeq.wild, physeq.sum)
phy.st <- merge_phyloseq(physeq.sum, physeq.tor)
phy.si <- merge_phyloseq(physeq.sum, physeq.iba)
phy.sp <- merge_phyloseq(physeq.sum, physeq.spr)
phy.ti <- merge_phyloseq(physeq.tor, physeq.iba)
phy.tp <- merge_phyloseq(physeq.tor, physeq.spr)
phy.ip <- merge_phyloseq(physeq.iba, physeq.spr)
phy.wt <- merge_phyloseq(physeq.wild, physeq.tor)
phy.wi <- merge_phyloseq(physeq.wild, physeq.iba)
phy.wp <- merge_phyloseq(physeq.wild, physeq.spr)


# Summer Wild vs. Summer Lab
ws.u <- phyloseq::distance(physeq = phy.ws, method = "unifrac")
sampdf.ws<- data.frame(sample_data(phy.ws))
beta.tax <- betadisper(d=ws.u, group=sampdf.ws$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
anosim(ws.u, sampdf.ws$Group, permutations = 9999)
  # p-value = 2e-04

# Summer Lab vs Torpor
st.u <- phyloseq::distance(physeq = phy.st, method = "unifrac")
sampdf.st<- data.frame(sample_data(phy.st))
beta.tax <- betadisper(d=st.u, group=sampdf.st$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.19
anosim(st.u, sampdf.st$Group, permutations = 9999)
  # p-value = 1e-04

# Summer Lab vs IBA
si.u <- phyloseq::distance(physeq = phy.si, method = "unifrac")
sampdf.si<- data.frame(sample_data(phy.si))
beta.tax <- betadisper(d=si.u, group=sampdf.si$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.105
anosim(si.u, sampdf.si$Group, permutations = 9999)
  # p-value = 1e-04

# Summer Lab vs Spring
sp.u <- phyloseq::distance(physeq = phy.sp, method = "unifrac")
sampdf.sp<- data.frame(sample_data(phy.sp))
beta.tax <- betadisper(d=sp.u, group=sampdf.sp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.008
anosim(sp.u, sampdf.sp$Group, permutations = 9999)
  # p-value = 0.5597

# Torpor vs IBA
ti.u <- phyloseq::distance(physeq = phy.ti, method = "unifrac")
sampdf.ti<- data.frame(sample_data(phy.ti))
beta.tax <- betadisper(d=ti.u, group=sampdf.ti$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.6
anosim(ti.u, sampdf.ti$Group, permutations = 9999)
  # p-value = 0.1113

# Torpor vs Spring
tp.u <- phyloseq::distance(physeq = phy.tp, method = "unifrac")
sampdf.tp<- data.frame(sample_data(phy.tp))
beta.tax <- betadisper(d=tp.u, group=sampdf.tp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.02
anosim(tp.u, sampdf.tp$Group, permutations = 9999)
  # p-value = 0.0027

# IBA vs Spring
ip.u <- phyloseq::distance(physeq = phy.ip, method = "unifrac")
sampdf.ip<- data.frame(sample_data(phy.ip))
beta.tax <- betadisper(d=ip.u, group=sampdf.ip$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.262
anosim(ip.u, sampdf.ip$Group, permutations = 9999)
  # p-value = 0.0157


# Summer Wild vs. Torpor
wt.u <- phyloseq::distance(physeq = phy.wt, method = "unifrac")
sampdf.wt<- data.frame(sample_data(phy.wt))
beta.tax <- betadisper(d=wt.u, group=sampdf.wt$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
anosim(wt.u, sampdf.wt$Group, permutations = 9999)
  # p-value = 2e-04 

# Summer Wild vs. IBA
wi.u <- phyloseq::distance(physeq = phy.wi, method = "unifrac")
sampdf.wi<- data.frame(sample_data(phy.wi))
beta.tax <- betadisper(d=wi.u, group=sampdf.wi$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.008
anosim(wi.u, sampdf.wi$Group, permutations = 9999)
  # p-value = 1e-04 

# Summer Wild vs. Spring
wp.u <- phyloseq::distance(physeq = phy.wp, method = "unifrac")
sampdf.wp<- data.frame(sample_data(phy.wp))
beta.tax <- betadisper(d=wp.u, group=sampdf.wp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.01
anosim(wp.u, sampdf.wp$Group, permutations = 9999)
  # p-value = 8e-04 


# Adjust betadisper p-values
p.adjust(c(0.001, 0.19, 0.105, 0.008, 0.6, 0.02, 0.262, 0.001, 0.008, 0.01),
         method = "fdr")
  # Summer Wild vs. Summer Lab = 0.005*
  # Summer Lab vs. Torpor = 0.2375
  # Summer Lab vs. IBA = 0.15
  # Summer Lab vs. Spring = 0.02*
  # Torpor vs. IBA = 0.6
  # Torpor vs. Spring = 0.033*
  # IBA vs. Spring = 0.2911
  # Summer Wild vs. Torpor = 0.005*
  # Summer Wild vs. IBA = 0.02*
  # Summer Wild vs. Spring = 0.02*


# Adjust ANOSIM p-values
p.adjust(c(2e-04, 1e-04, 1e-04, 0.5597, 0.1113, 0.0027, 0.0157, 2e-04, 1e-04, 8e-04),
         method = "fdr")
  # Summer Wild vs. Summer Lab = 0.0004*
  # Summer Lab vs. Torpor = 0.00033*
  # Summer Lab vs. IBA = 0.00033*
  # Summer Lab vs. Spring = 0.5597
  # Torpor vs. IBA = 0.123667
  # Torpor vs. Spring = 0.0038571429*
  # IBA vs. Spring = 0.019625
  # Summer Wild vs. Torpor = 0.0004*
  # Summer Wild vs. IBA = 0.00033*
  # Summer Wild vs. Spring = 0.0013*








########## Weighted UniFrac ##########
UF.w <- phyloseq::distance(physeq = physeq, method = "wunifrac")
UF.w.pcoa <- ordinate(physeq = physeq, method = "PCoA", distance = "wunifrac")
  # Variation explained = 35.8%

plot_ordination(physeq = physeq, ordination = UF.w.pcoa, axes = c(1,2),
                title = "Weighted UniFrac") +
  geom_point(size = 2, aes(colour = Group))


### PERMANOVA ###
sampdf <- data.frame(sample_data(physeq))
beta.tax <- betadisper(d=UF.w, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.01
anosim(UF.w, sampdf$Group, permutations = 9999)
  # p-value = 1e-04 



# Separate out pairwise comparisons
#phy.ws <- merge_phyloseq(physeq.wild, physeq.sum)
#phy.st <- merge_phyloseq(physeq.sum, physeq.tor)
#phy.si <- merge_phyloseq(physeq.sum, physeq.iba)
#phy.sp <- merge_phyloseq(physeq.sum, physeq.spr)
#phy.ti <- merge_phyloseq(physeq.tor, physeq.iba)
#phy.tp <- merge_phyloseq(physeq.tor, physeq.spr)
#phy.ip <- merge_phyloseq(physeq.iba, physeq.spr)
#phy.wt <- merge_phyloseq(physeq.wild, physeq.tor)
#phy.wi <- merge_phyloseq(physeq.wild, physeq.iba)
#phy.wp <- merge_phyloseq(physeq.wild, physeq.spr)


# Summer Wild vs. Summer Lab
ws.w <- phyloseq::distance(physeq = phy.ws, method = "wunifrac")
sampdf.ws<- data.frame(sample_data(phy.ws))
beta.tax <- betadisper(d=ws.w, group=sampdf.ws$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.002
anosim(ws.w, sampdf.ws$Group, permutations = 9999)
  # p-value = 0.0019

# Summer Lab vs Torpor
st.w <- phyloseq::distance(physeq = phy.st, method = "wunifrac")
sampdf.st<- data.frame(sample_data(phy.st))
beta.tax <- betadisper(d=st.w, group=sampdf.st$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.935
anosim(st.w, sampdf.st$Group, permutations = 9999)
  # p-value = 1e-04


# Summer Lab vs IBA
si.w <- phyloseq::distance(physeq = phy.si, method = "wunifrac")
sampdf.si<- data.frame(sample_data(phy.si))
beta.tax <- betadisper(d=si.w, group=sampdf.si$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.511
anosim(si.w, sampdf.si$Group, permutations = 9999)
  # p-value = 1e-04


# Summer Lab vs Spring
sp.w <- phyloseq::distance(physeq = phy.sp, method = "wunifrac")
sampdf.sp<- data.frame(sample_data(phy.sp))
beta.tax <- betadisper(d=sp.w, group=sampdf.sp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.272
anosim(sp.w, sampdf.sp$Group, permutations = 9999)
  # p-value = 0.0385


# Torpor vs IBA
ti.w <- phyloseq::distance(physeq = phy.ti, method = "wunifrac")
sampdf.ti<- data.frame(sample_data(phy.ti))
beta.tax <- betadisper(d=ti.w, group=sampdf.ti$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.483
anosim(ti.w, sampdf.ti$Group, permutations = 9999)
  # p-value = 0.7023

# Torpor vs Spring
tp.w <- phyloseq::distance(physeq = phy.tp, method = "wunifrac")
sampdf.tp<- data.frame(sample_data(phy.tp))
beta.tax <- betadisper(d=tp.w, group=sampdf.tp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.128
anosim(tp.w, sampdf.tp$Group, permutations = 9999)
  # p-value = 1e-04

# IBA vs Spring
ip.w <- phyloseq::distance(physeq = phy.ip, method = "wunifrac")
sampdf.ip<- data.frame(sample_data(phy.ip))
beta.tax <- betadisper(d=ip.w, group=sampdf.ip$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.292
anosim(ip.w, sampdf.ip$Group, permutations = 9999)
  # p-value = 1e-04

# Summer Wild vs. Torpor
wt.w <- phyloseq::distance(physeq = phy.wt, method = "wunifrac")
sampdf.wt<- data.frame(sample_data(phy.wt))
beta.tax <- betadisper(d=wt.w, group=sampdf.wt$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.005
anosim(wt.w, sampdf.wt$Group, permutations = 9999)
  # p-value = 1e-04 

# Summer Wild vs. IBA
wi.w <- phyloseq::distance(physeq = phy.wi, method = "wunifrac")
sampdf.wi<- data.frame(sample_data(phy.wi))
beta.tax <- betadisper(d=wi.w, group=sampdf.wi$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.007
anosim(wi.w, sampdf.wi$Group, permutations = 9999)
  # p-value = 1e-04

# Summer Wild vs. Spring
wp.w <- phyloseq::distance(physeq = phy.wp, method = "wunifrac")
sampdf.wp<- data.frame(sample_data(phy.wp))
beta.tax <- betadisper(d=wp.w, group=sampdf.wp$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.151
anosim(wp.w, sampdf.wp$Group, permutations = 9999)
  # p-value = 8e-04 


# Adjust betadisper p-values
p.adjust(c(0.002, 0.935, 0.511, 0.272, 0.483, 0.128, 0.292, 0.005, 0.007, 0.151),
         method = "fdr")
  # Summer Wild vs. Summer Lab = 0.02*
  # Summer Lab vs. Torpor = 0.935
  # Summer Lab vs. IBA = 0.56778
  # Summer Lab vs. Spring = 0.41714286
  # Torpor vs. IBA = 0.56778
  # Torpor vs. Spring = 0.302
  # IBA vs. Spring = 0.41714286
  # Summer Wild vs. Torpor = 0.0233*
  # Summer Wild vs. IBA = 0.0233*
  # Summer Wild vs. Spring = 0.302

# Adjust ANOSIM p-values
p.adjust(c(0.0019, 1e-04, 1e-04, 0.0385, 0.7023, 1e-04, 1e-04, 1e-04, 1e-04, 8e-04),
         method = "fdr")
  # Summer Wild vs. Summer Lab = 0.002375*
  # Summer Lab vs. Torpor = 0.0001667*
  # Summer Lab vs. IBA = 0.0001667*
  # Summer Lab vs. Spring = 0.042778*
  # Torpor vs. IBA = 0.7023
  # Torpor vs. Spring = 0.0001667*
  # IBA vs. Spring = 0.0001667*
  # Summer Wild vs. Torpor = 0.0001667*
  # Summer Wild vs. IBA = 0.0001667*
  # Summer Wild vs. Spring = 0.0011428571*



```


### Simper
```{r}
# Change Group names to be compatible (no "_")
sum.rename <- data.frame(sample_data(physeq))
sum.rename$GroupRename <- rep(NA, nrow(sum.rename))
sum.rename$GroupRename[which(sum.rename$Group == "Summer_Wild")] <- "SummerWild"
sum.rename$GroupRename[which(sum.rename$Group == "Summer_Lab")] <- "SummerLab"
sum.rename$GroupRename[which(sum.rename$Group == "Torpor")] <- "Torpor"
sum.rename$GroupRename[which(sum.rename$Group == "IBA")] <- "IBA"
sum.rename$GroupRename[which(sum.rename$Group == "Spring")] <- "Spring"
sum.rename$GroupRename <- ordered(sum.rename$GroupRename, levels = c("SummerWild", "SummerLab", "Torpor", "IBA", "Spring"))
physeq.simp <- merge_phyloseq(otu_table(physeq), sample_data(sum.rename), tax_table(physeq))


# Group
simper.pretty(data.frame(otu_table(physeq.simp)),
              data.frame(sample_data(physeq.simp)),
              c("GroupRename"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='group')
group.simper <- read.csv("group_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(physeq.simp)),
               data.frame(sample_data(physeq.simp)),
               csv = group.simper,
               c("GroupRename"),
               output_name = 'group',
               taxonomy = data.frame(tax_table(physeq.simp)))
group.simper.kw <- read.csv("group_krusk_simper.csv")
for(i in 1:nrow(group.simper.kw)){
  save <- which(rownames(data.frame(tax_table(physeq.simp))) == group.simper.kw$OTU[i])
  group.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(physeq.simp))[save,2], "-",
          data.frame(tax_table(physeq.simp))[save,3], "-",
          data.frame(tax_table(physeq.simp))[save,4], "-",
          data.frame(tax_table(physeq.simp))[save,5], "-",
          data.frame(tax_table(physeq.simp))[save,6])
}
#write.table(group.simper.kw, "group_krusk_simper.csv", sep=",")
group.simper.kw <- read.csv("group_clean_simper.csv")



```


### Core OTUs
```{r}
wild.otu <- data.frame(otu_table(physeq.wild))
wild.core <- apply(wild.otu, 1, function(row) all(row != 0))
wild.core <- wild.otu[wild.core,]
phy.wild.core <- merge_phyloseq(otu_table(wild.core, taxa_are_rows = T), tax_table(physeq.wild), sample_data(physeq.wild))
  # 237 OTUs

sum.otu <- data.frame(otu_table(physeq.sum))
sum.core <- apply(sum.otu, 1, function(row) all(row != 0))
sum.core <- sum.otu[sum.core,]
phy.sum.core <- merge_phyloseq(otu_table(sum.core, taxa_are_rows = T), tax_table(physeq.sum), sample_data(physeq.sum))
  # 28 OTUs

tor.otu <- data.frame(otu_table(physeq.tor))
tor.core <- apply(tor.otu, 1, function(row) all(row != 0))
tor.core <- tor.otu[tor.core,]
phy.tor.core <- merge_phyloseq(otu_table(tor.core, taxa_are_rows = T), tax_table(physeq.tor), sample_data(physeq.tor))
  # 47 OTUs

iba.otu <- data.frame(otu_table(physeq.iba))
iba.core <- apply(iba.otu, 1, function(row) all(row != 0))
iba.core <- iba.otu[iba.core,]
phy.iba.core <- merge_phyloseq(otu_table(iba.core, taxa_are_rows = T), tax_table(physeq.iba), sample_data(physeq.iba))
  # 48 OTUs

spr.otu <- data.frame(otu_table(physeq.spr))
spr.core <- apply(spr.otu, 1, function(row) all(row != 0))
spr.core <- spr.otu[spr.core,]
phy.spr.core <- merge_phyloseq(otu_table(spr.core, taxa_are_rows = T), tax_table(physeq.spr), sample_data(physeq.spr))
  # 112 OTUs
```











### Test Phyla Rel Abund
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

# View ordered phyla - most abundant --> least abundant
# barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)
# 11 phyla: "Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Bacteria_unclassified", "Kiritimatiellaeota", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia", "Epsilonbacteraeota"


### Adjust P-values
# The raw p-values are from the Group-level Kruskal-Wallis (not pairwise Wilcoxon)
# I included this code above the phyla-specific analyses for reference
p.adjust(c(3.383e-08, 0.0001905, 0.0007905, 0.002968, 0.03355, 0.0298, 7.077e-05, 0.001643, 0.04759, 0.009963, 0.009963), method = "fdr")
  # Firmicutes = 3.721300e-07
  # Bacteroidetes = 6.985000e-04
  # Verrucomicrobia = .002173875
  # Proteobacteria = .005441333e
  # Unclassified = .03690500
  # Kiritimatiellaeota = .03642222
  # Cyanobacteria = 3.892350e-04
  # Tenericutes = .003614600
  # Actinobacteria = .04759000
  # Elusimicrobia = .01369912
  # Epsilonbacteraeota = .01369912


##### FIRMICUTES #####
fir.phy <- subset_taxa(phy99, Phylum == "Firmicutes")
fir.df <- data.frame(sample_data(fir.phy))
fir.df$RelAbund <- t(data.frame(otu_table(fir.phy)))

# Test normality
hist(fir.df$RelAbund, breaks=10)
qqnorm(fir.df$RelAbund)
qqline(fir.df$RelAbund)
shapiro.test(fir.df$RelAbund)
  # p-value = 0.02565
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=fir.df)
  # p-value = 3.383e-08
pairwise.wilcox.test(fir.df$RelAbund, fir.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 1.00000
  # Wild-Torpor = 0.00016*
  # Wild-IBA = 5.7e-05*
  # Wild-Spring = 0.04371*
  # Lab-Torpor = 1.3e-06*
  # Lab-IBA = 2.6e-07*
  # Lab-Spring = 0.00658*
  # Torpor-IBA = 1.00000
  # Torpor-Spring = 0.00108*
  # IBA-Spring = 0.00041*



##### BACTEROIDETES #####
bac.phy <- subset_taxa(phy99, Phylum == "Bacteroidetes")
bac.df <- data.frame(sample_data(bac.phy))
bac.df$RelAbund <- t(data.frame(otu_table(bac.phy)))

# Test normality
hist(bac.df$RelAbund, breaks=10)
qqnorm(bac.df$RelAbund)
qqline(bac.df$RelAbund)
shapiro.test(bac.df$RelAbund)
  # p-value = 0.5318
  # Normal
  # Sticking with Kruskal-Wallis for consistency among phyla-level comparisons

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=bac.df)
  # p-value = 0.0001905
pairwise.wilcox.test(bac.df$RelAbund, bac.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.6392
  # Wild-Torpor = 0.0098*
  # Wild-IBA = 0.0057 *
  # Wild-Spring = 0.0093*
  # Lab-Torpor = 0.0093*
  # Lab-IBA = 0.0034*
  # Lab-Spring = 0.0079*
  # Torpor-IBA = 0.9612
  # Torpor-Spring = 0.9612
  # IBA-Spring = 0.9612


##### Verrucomicrobia #####
ver.phy <- subset_taxa(phy99, Phylum == "Verrucomicrobia")
ver.df <- data.frame(sample_data(ver.phy))
ver.df$RelAbund <- t(data.frame(otu_table(ver.phy)))

# Test normality
hist(ver.df$RelAbund, breaks=10)
qqnorm(ver.df$RelAbund)
qqline(ver.df$RelAbund)
shapiro.test(ver.df$RelAbund)
  # p-value = 3.532e-08
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=ver.df)
  # p-value = 0.0007905
pairwise.wilcox.test(ver.df$RelAbund, ver.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.6298
  # Wild-Torpor = 0.3345
  # Wild-IBA = 0.0006*
  # Wild-Spring = 0.3178
  # Lab-Torpor = 0.3178 
  # Lab-IBA =  9.6e-05*
  # Lab-Spring = 0.3178
  # Torpor-IBA = 0.3178
  # Torpor-Spring = 0.3345
  # IBA-Spring = 0.0855





##### PROTEOBACTERIA #####
pro.phy <- subset_taxa(phy99, Phylum == "Proteobacteria")
pro.df <- data.frame(sample_data(pro.phy))
pro.df$RelAbund <- t(data.frame(otu_table(pro.phy)))

# Test normality
hist(pro.df$RelAbund, breaks=10)
qqnorm(pro.df$RelAbund)
qqline(pro.df$RelAbund)
shapiro.test(pro.df$RelAbund)
  # p-value = 0.0003034
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=pro.df)
  # p-value = 0.002968
pairwise.wilcox.test(pro.df$RelAbund, pro.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.07245 
  # Wild-Torpor = 0.00063*
  # Wild-IBA = 0.02821*
  # Wild-Spring = 0.36859
  # Lab-Torpor = 0.07245 
  # Lab-IBA = 0.17503
  # Lab-Spring = 0.69131
  # Torpor-IBA = 0.97857
  # Torpor-Spring = 0.04848*
  # IBA-Spring = 0.15222




##### UNCLASSIFIED #####
unc.phy <- subset_taxa(phy99, Phylum == "Bacteria_unclassified")
unc.df <- data.frame(sample_data(unc.phy))
unc.df$RelAbund <- t(data.frame(otu_table(unc.phy)))

# Test normality
hist(unc.df$RelAbund, breaks=10)
qqnorm(unc.df$RelAbund)
qqline(unc.df$RelAbund)
shapiro.test(unc.df$RelAbund)
  # p-value = 2.589e-11
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=unc.df)
  # p-value = 0.03355
pairwise.wilcox.test(unc.df$RelAbund, unc.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.182
  # Wild-Torpor = 0.134
  # Wild-IBA = 0.134
  # Wild-Spring = 0.012*
  # Lab-Torpor = 0.318
  # Lab-IBA = 0.142
  # Lab-Spring = 0.425
  # Torpor-IBA = 0.318
  # Torpor-Spring = 0.808
  # IBA-Spring = 0.441





##### KIRITIMATIELLAEOTA #####
# Ar/ma/ti/mon/a/de/tes
# ^        ^      ^
# Ki/ri/ti/ma/ti/e/llae/o/ta
#                       ^
# Pull out kiris
kir.phy <- subset_taxa(phy99, Phylum == "Kiritimatiellaeota")
kir.df <- data.frame(sample_data(kir.phy))
kir.df$RelAbund <- t(data.frame(otu_table(kir.phy)))

# Test normality
hist(kir.df$RelAbund, breaks=10)
qqnorm(kir.df$RelAbund)
qqline(kir.df$RelAbund)
shapiro.test(kir.df$RelAbund)
  # p-value = 8.273e-13
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=kir.df)
  # p-value = 0.0298
pairwise.wilcox.test(kir.df$RelAbund, kir.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.96
  # Wild-Torpor = 0.1
  # Wild-IBA = 0.74
  # Wild-Spring = 0.1
  # Lab-Torpor = 0.1
  # Lab-IBA = 0.74
  # Lab-Spring = 0.1
  # Torpor-IBA = 0.1
  # Torpor-Spring = 0.96
  # IBA-Spring = 0.48



##### CYANOBACTERIA #####
# Pull out cyanos
cya.phy <- subset_taxa(phy99, Phylum == "Cyanobacteria")
cya.df <- data.frame(sample_data(cya.phy))
cya.df$RelAbund <- t(data.frame(otu_table(cya.phy)))

# Test normality
hist(cya.df$RelAbund, breaks=10)
qqnorm(cya.df$RelAbund)
qqline(cya.df$RelAbund)
shapiro.test(cya.df$RelAbund)
  # p-value = 1.665e-07
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=cya.df)
  # p-value = 7.077e-05
pairwise.wilcox.test(cya.df$RelAbund, cya.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 8.6e-05*
  # Wild-Torpor = 0.00021*
  # Wild-IBA = 8.6e-05*
  # Wild-Spring = 0.00291*
  # Lab-Torpor = 0.21206 
  # Lab-IBA = 0.57042
  # Lab-Spring = 0.37787
  # Torpor-IBA = 0.01798*
  # Torpor-Spring = 0.01422*
  # IBA-Spring = 0.44112



##### TENERICUTES #####
ten.phy <- subset_taxa(phy99, Phylum == "Tenericutes")
ten.df <- data.frame(sample_data(ten.phy))
ten.df$RelAbund <- t(data.frame(otu_table(ten.phy)))

# Test normality
hist(ten.df$RelAbund, breaks=10)
qqnorm(ten.df$RelAbund)
qqline(ten.df$RelAbund)
shapiro.test(ten.df$RelAbund)
  # p-value = 1.228e-08
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=ten.df)
  # p-value = 0.001643
pairwise.wilcox.test(ten.df$RelAbund, ten.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.22640
  # Wild-Torpor = 0.00031*
  # Wild-IBA = 0.00031*
  # Wild-Spring = 0.44773
  # Lab-Torpor = 0.12625
  # Lab-IBA = 0.12625
  # Lab-Spring = 0.66842
  # Torpor-IBA = 0.44773
  # Torpor-Spring = 0.12625
  # IBA-Spring = 0.12625




##### ACTINOBACTERIA #####
act.phy <- subset_taxa(phy99, Phylum == "Actinobacteria")
act.df <- data.frame(sample_data(act.phy))
act.df$RelAbund <- t(data.frame(otu_table(act.phy)))

# Test normality
hist(act.df$RelAbund, breaks=10)
qqnorm(act.df$RelAbund)
qqline(act.df$RelAbund)
shapiro.test(act.df$RelAbund)
  # p-value = 0.0003346
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=act.df)
  # p-value = 0.04759
pairwise.wilcox.test(act.df$RelAbund, act.df$Group, p.adjust.method="fdr")
  # Wild-Lab = 0.344
  # Wild-Torpor = 0.019
  # Wild-IBA = 0.050
  # Wild-Spring = 0.019
  # Lab-Torpor = 0.369
  # Lab-IBA = 0.501
  # Lab-Spring = 0.369
  # Torpor-IBA = 0.544
  # Torpor-Spring = 0.600
  # IBA-Spring = 0.344






##### ELUSIMICROBIA #####
elu.phy <- subset_taxa(phy99, Phylum == "Elusimicrobia")
elu.df <- data.frame(sample_data(elu.phy))
elu.df$RelAbund <- t(data.frame(otu_table(elu.phy)))

# Test normality
hist(elu.df$RelAbund, breaks=10)
qqnorm(elu.df$RelAbund)
qqline(elu.df$RelAbund)
shapiro.test(elu.df$RelAbund)
  # p-value = 2.203e-11
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=elu.df)
  # p-value = 0.009963
pairwise.wilcox.test(elu.df$RelAbund, elu.df$Group, p.adjust.method="fdr")#### ERROR
  # Wild-Lab = 0.058
  # Wild-Torpor = 0.065
  # Wild-IBA = 0.932
  # Wild-Spring = 0.058
  # Lab-Torpor = 0.932
  # Lab-IBA = 0.113
  # Lab-Spring = 0.145
  # Torpor-IBA = 0.145
  # Torpor-Spring = 0.398
  # IBA-Spring = 0.058



##### EPSILONBACTERAEOTA #####
eps.phy <- subset_taxa(phy99, Phylum == "Elusimicrobia")
eps.df <- data.frame(sample_data(eps.phy))
eps.df$RelAbund <- t(data.frame(otu_table(eps.phy)))

# Test normality
hist(eps.df$RelAbund, breaks=10)
qqnorm(eps.df$RelAbund)
qqline(eps.df$RelAbund)
shapiro.test(eps.df$RelAbund)
  # p-value = 2.203e-11
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund ~ Group, data=eps.df)
  # p-value = 0.009963
pairwise.wilcox.test(eps.df$RelAbund, eps.df$Group, p.adjust.method="fdr")#### ERROR
  # Wild-Lab = 0.058
  # Wild-Torpor = 0.065
  # Wild-IBA = 0.932
  # Wild-Spring = 0.058
  # Lab-Torpor = 0.932
  # Lab-IBA = 0.113
  # Lab-Spring = 0.145
  # Torpor-IBA = 0.145
  # Torpor-Spring = 0.398
  # IBA-Spring = 0.058
```


