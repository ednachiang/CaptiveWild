---
title: "Code"
author: "Edna Chiang"
date: "May 7, 2018"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(ggplot2)
library(gplots)
library(phangorn)
library(tidyr)
library(vegan)
library(phyloseq)
library(grid)
library(pgirmess)
theme_set(theme_bw())
set.seed(1)
```



### Import Data
```{r}
# Link files
shared = "mothur_output/final.shared"
taxonomy = "mothur_output/final.taxonomy"


# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
```

### Explore mothurdata object
```{r}
samp.sum <- data.frame(colSums(otu_table(mothurdata)))
colnames(samp.sum) <- "Sample_TotalSeqs"
samp.sum$sample <- row.names(samp.sum)
samp.sum <- arrange(samp.sum, Sample_TotalSeqs)

ggplot(samp.sum, aes(x=reorder(sample, Sample_TotalSeqs), y=Sample_TotalSeqs)) +
  ylab("Number of Sequences per Sample") +
  geom_bar(stat="identity", colour="black", fill="cornflowerblue") +
  xlab("Sample Name") +
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45,hjust = 1,
                                   vjust = 1))

ggplot(data.frame(sum = sample_sums(mothurdata)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue", bins=60) + 
  ggtitle("Sample read counts") + 
  xlab("total sequences")


# Min, Mean, Max of sample read counts
min(sample_sums(mothurdata))
mean(sample_sums(mothurdata))
median(sample_sums(mothurdata))
max(sample_sums(mothurdata))
```


### Interim Phyloseq Object
```{r}
meta <- read.csv("metadata.csv")
colnames(meta)[1] <- "Sample"
rownames(meta) <- meta$Sample
divsum <- read.table("mothur_output/8494.summary", header=T)
remove <- setdiff(meta$Sample, divsum$group)
for(i in 1:length(remove)){
  meta <- meta[-which(meta$Sample == remove[i]),]
}


# Add in diversity summaries
meta[,11:21] <- divsum[,3:12]

# Create intermin phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))

# Order factors
sample_data(physeq)$Season <- ordered(sample_data(physeq)$Season,
                                     levels=c("Summer", "Winter", "Spring"))
sample_data(physeq)$Metabolism <- ordered(sample_data(physeq)$Metabolism,
                                     levels=c("Active", "Torpor", "IBA"))
sample_data(physeq)$Group <- ordered(sample_data(physeq)$Group,
                                     levels=c("Summer_Wild", "Summer_Lab", "Torpor", "IBA", "Spring"))

# Remove unwanted samples
physeq.rem <- subset_samples(physeq, Sample_Type != "Black_Tissue" & Season != "NA")



#save(physeq.rem, file="Physeq.RData")
```


### Load Phyloseq Object
```{r}
load("Physeq.RData")
```

### Examine Summer Lab vs. Wild
```{r}
sum.physeq <- subset_samples(physeq.rem, Season == "Summer")

###### Examine Phyla ######
# Merge samples with the same taxonomic rank
sum.goodphy <- tax_glom(sum.physeq, taxrank="Phylum")

# Transform each merged phylum count to rel abund
sum.phy99 <- transform_sample_counts(sum.goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
sum.phy99 <- prune_taxa(taxa_sums(sum.phy99) > 1, sum.phy99)


# Summarize data
sum.phy.df <- psmelt(sum.phy99)
sum.phy.df$Phylum <- ordered(sum.phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes","Verrucomicrobia", "Proteobacteria", "Unclassified", "Cyanobacteria", "Tenericutes", "Elusimicrobia"))
sum.phy.df$Phylum[which(is.na(sum.phy.df$Phylum))] <- rep("Unclassified",18)
sum.phy.sum <- sum.phy.df %>%
  group_by(Diet, Sample_Type, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

# Calculate IQR limits
sum.phy.sum$iqr.min <- sum.phy.sum$Median - 0.5*sum.phy.sum$iqr
sum.phy.sum[which(sum.phy.sum$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
sum.phy.sum$iqr.max <- sum.phy.sum$Median + 0.5*sum.phy.sum$iqr


### Barplot ###
ggplot(sum.phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Diet ~ Sample_Type) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  theme(axis.text.x = element_blank())


###### Alpha-Diversity ######
sum.adiv <- data.frame(sample_data(sum.physeq))

sum.adiv.con <- sum.adiv[which(sum.adiv$Sample_Type=="Content"),]
sum.adiv.muc <- sum.adiv[which(sum.adiv$Sample_Type=="Mucosa"),]
sum.adiv.lab <- sum.adiv[which(sum.adiv$Diet=="Lab"),]
sum.adiv.wil <- sum.adiv[which(sum.adiv$Diet=="Wild"),]

# Total OTUs
# Make the original, unnormalized phyloseq object

sum.otu.tot <- data.frame(sample_names(sum.physeq))
# Pull out # of OTUs from all samples
sum.otu.tot$Total_OTUs <- rep("NA", 17)
for(i in 1:17){
  sum.otu.tot[i,2] <- length(which(otu_table(sum.physeq)[,i] != 0))
}
colnames(sum.otu.tot) <- c("Sample", "Total_OTUs")
sum.otu.tot$Total_OTUs <- as.integer(sum.otu.tot$Total_OTUs)
sum.otusum <- sum.adiv
sum.otusum$Total_OTUs <- sum.otu.tot$Total_OTUs

# Color by group
ggplot(sum.otusum, aes(x=Diet, y=Total_OTUs, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral")) +
  xlab("Group") +
  ylab("Total OTUs")

# Test normality
hist(sum.otusum$Total_OTUs, breaks=10)
qqnorm(sum.otusum$Total_OTUs)
qqline(sum.otusum$Total_OTUs)
shapiro.test(sum.otusum$Total_OTUs)
  # p-value = 0.0071
  # Not normal
ks.test(sum.otusum$Total_OTUs, "pnorm", mean=mean(sum.otusum$Total_OTUs), sd=sd(sum.otusum$Total_OTUs))
  # p-value = 0.1352

# Wilcoxon
wilcox.test(Total_OTUs ~ Diet, data=sum.otusum)
  # p-value = 0.0001616
wilcox.test(Total_OTUs ~ Diet, data=sum.otusum, subset=Sample_Type=="Content")
  # p-value = 0.01667
wilcox.test(Total_OTUs ~ Diet, data=sum.otusum, subset=Sample_Type=="Mucosa")
  # p-value = 0.05714
wilcox.test(Total_OTUs ~ Sample_Type, data=sum.otusum)
  # p-value = 0.8868
wilcox.test(Total_OTUs ~ Sample_Type, data=sum.otusum, subset=Diet=="Lab")
  # p-value = 0.7879
wilcox.test(Total_OTUs ~ Sample_Type, data=sum.otusum, subset=Diet=="Wild")
  # p-value = 1




### Chao
ggplot(sum.adiv, aes(x=Diet, y=chao, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral") )+
  xlab("Diet") +
  ylab("Chao Richness")

# Test normality
hist(sum.adiv$chao, breaks=10)
qqnorm(sum.adiv$chao)
qqline(sum.adiv$chao)
shapiro.test(sum.adiv$chao)
  # p-value = 0.01554
  # Not normal
ks.test(sum.adiv$chao, "pnorm", mean=mean(sum.adiv$chao), sd=sd(sum.adiv$chao))
  # p-value = 0.6185

# Wilcoxon
wilcox.test(chao ~ Diet, data=sum.adiv)
  # p-value = 0.0202
wilcox.test(chao ~ Diet, data=sum.adiv, subset=Sample_Type=="Content")
  # p-value = 0.01667
wilcox.test(chao ~ Diet, data=sum.adiv, subset=Sample_Type=="Mucosa")
  # p-value = 0.8571
wilcox.test(chao ~ Sample_Type, data=sum.adiv)
  # p-value = 0.9623
wilcox.test(chao ~ Sample_Type, data=sum.adiv, subset=Diet=="Lab")
  # p-value = 0.7879
wilcox.test(chao ~ Sample_Type, data=sum.adiv, subset=Diet=="Wild")
  # p-value = 0.4






### Berger-Parker
ggplot(sum.adiv, aes(x=Diet, y=bergerparker, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral") )+
  xlab("Diet") +
  ylab("Berger-Parker")

# Test normality
hist(sum.adiv$bergerparker, breaks=10)
qqnorm(sum.adiv$bergerparker)
qqline(sum.adiv$bergerparker)
shapiro.test(sum.adiv$bergerparker)
  # p-value = 0.008697
ks.test(sum.adiv$bergerparker, "pnorm", mean=mean(sum.adiv$bergerparker), sd=sd(sum.adiv$bergerparker))
  # p-value = 0.4016

# Wilcoxon
wilcox.test(bergerparker ~ Diet, data=sum.adiv)
  # p-value = 0.149
wilcox.test(bergerparker ~ Diet, data=sum.adiv, subset=Sample_Type=="Content")
  # p-value = 0.03333
wilcox.test(bergerparker ~ Diet, data=sum.adiv, subset=Sample_Type=="Mucosa")
  # p-value = 0.8571
wilcox.test(bergerparker ~ Sample_Type, data=sum.adiv)
  # p-value = 0.9623
wilcox.test(bergerparker ~ Sample_Type, data=sum.adiv, subset=Diet=="Lab")
  # p-value = 0.6485
wilcox.test(bergerparker ~ Sample_Type, data=sum.adiv, subset=Diet=="Wild")
  # p-value = 0.4





### Shannon
ggplot(sum.adiv, aes(x=Diet, y=shannon, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral")) +
  xlab("Group") +
  ylab("Shannon Diversity")

# Test normality
hist(sum.adiv$shannon, breaks=10)
qqnorm(sum.adiv$shannon)
qqline(sum.adiv$shannon)
shapiro.test(sum.adiv$shannon)
  # p-value = 0.2649
ks.test(sum.adiv$shannon, "pnorm", mean=mean(sum.adiv$shannon), sd=sd(sum.adiv$shannon))
  # p-value = 0.6198

# Wilcoxon
t.test(shannon ~ Diet, data=sum.adiv)
  # p-value = 0.05814
t.test(shannon ~ Diet, data=sum.adiv.con)
  # p-value = 0.003129
t.test(shannon ~ Diet, data=sum.adiv.muc)
  # p-value = 0.9498
t.test(shannon ~ Sample_Type, data=sum.adiv)
  # p-value = 0.9695
t.test(shannon ~ Sample_Type, data=sum.adiv.lab)
  # p-value = 0.3654
t.test(shannon ~ Sample_Type, data=sum.adiv.wil)
  # p-value = 0.1508

# Inverse Simpson
ggplot(sum.adiv, aes(x=Diet, y= invsimpson, fill = Diet)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral")) +
  xlab("Diet") +
  ylab("Inverse Simpson Diversity")

# Test normality
hist(sum.adiv$invsimpson, breaks=10)
qqnorm(sum.adiv$invsimpson)
qqline(sum.adiv$invsimpson)
shapiro.test(sum.adiv$invsimpson)
  # p-value = 0.01727
ks.test(sum.adiv$invsimpson, "pnorm", mean=mean(sum.adiv$invsimpson), sd=sd(sum.adiv$invsimpson))
  # p-value = 0.2989

# Wilcoxon
wilcox.test(invsimpson ~ Diet, data=sum.adiv)
  # p-value = 0.09825
wilcox.test(invsimpson ~ Diet, data=sum.adiv, subset=Sample_Type=="Content")
  # p-value = 0.01667
wilcox.test(invsimpson ~ Diet, data=sum.adiv, subset=Sample_Type=="Mucosa")
  # p-value = 0.8571
wilcox.test(invsimpson ~ Sample_Type, data=sum.adiv)
  # p-value = 0.8125
wilcox.test(invsimpson ~ Sample_Type, data=sum.adiv, subset=Diet=="Lab")
  # p-value = 0.6485
wilcox.test(invsimpson ~ Sample_Type, data=sum.adiv, subset=Diet=="Wild")
  # p-value = 0.2


###### Bray-Curtis ######
### Bray NMDS
sum.nmds <- ordinate(physeq=sum.physeq, method="NMDS", distance="bray")
  # stress = 0.07623348

plot_ordination(physeq=sum.physeq, ordination=sum.nmds, color="Diet", shape="Sample_Type")

# https://stackoverflow.com/questions/13794419/plotting-ordiellipse-function-from-vegan-package-onto-nmds-plot-created-in-ggplo

sample_data(sum.physeq)$Elip <- paste(sample_data(sum.physeq)$Diet, sample_data(sum.physeq)$Sample_Type)
elip.sum.nmds <- data.frame(MDS1 = sum.nmds$points[,1], MDS2 = sum.nmds$points[,2],
                        Group = sample_data(sum.physeq)$Elip)
plot.new()
elip.sum.ord <- ordiellipse(sum.nmds, sample_data(sum.physeq)$Elip, display="sites", kind="se", conf=0.95, label=T)

veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}

elip.sum.df <- data.frame()
for(i in levels(elip.sum.nmds$Group)){
  elip.sum.df <- rbind(elip.sum.df, cbind(as.data.frame(with(elip.sum.nmds[elip.sum.nmds$Group==i,],
                                                     veganCovEllipse(elip.sum.ord[[i]]$cov,
                                                                     elip.sum.ord[[i]]$center,
                                                                     elip.sum.ord[[i]]$scale))),
                                  group=i))
  
}




plot_ordination(physeq=sum.physeq, ordination=sum.nmds, color="Elip") +
  geom_path(data=elip.sum.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  guides(color=guide_legend(title="Group")) +
  scale_color_manual(values=c("darkgoldenrod", "darkgoldenrod1", "brown2", "lightcoral"))



### PERMANOVA
sum.sampdf <- data.frame(sample_data(sum.physeq))
sum.bray<- phyloseq::distance(physeq=sum.physeq, method="bray")
adonis(sum.bray~ Diet, data=sum.sampdf)
  # p-value = 0.001
beta.tax = betadisper(d=sum.bray, group=sum.sampdf$Diet)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.002
adonis(sum.bray~ Sample_Type, data=sum.sampdf)
  # p-value = 0.996
beta.tax = betadisper(d=sum.bray, group=sum.sampdf$Sample_Type)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.656
```





### Alpha Div
```{r}
adiv <- data.frame(sample_data(physeq.rem))

par(mfrow=c(5,1))

# Coverage
ggplot(adiv, aes(x=Group, y= coverage, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  scale_fill_manual(values=c("brown2", "lightcoral", "royalblue3", "deepskyblue", "limegreen")) +
  xlab("Group") +
  ylab("Coverage")

# Total OTUs
# Make the original, unnormalized phyloseq object
shared = "mothur_output/final.shared"
taxonomy = "mothur_output/final.taxonomy"
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
# Read in metadata
meta <- read.csv("metadata.csv")
colnames(meta)[1] <- "Sample"
otu.tot <- data.frame(sample_names(mothurdata))
# Pull out # of OTUs from all samples
otu.tot$Total_OTUs <- rep("NA", 77)
for(i in 1:77){
  otu.tot[i,2] <- length(which(otu_table(mothurdata)[,i] != 0))
}
# Pull out the data from just the samples we kept
keep <- data.frame(rep("NA",47))
keep[,2] <- rep("NA", 47)
for(i in 1:47){
  x <- which(otu.tot$sample_names.mothurdata. == sample_names(physeq.rem)[i])
  keep[i,2] <- otu.tot[x,2]
}
keep[,1] <- sample_names(physeq.rem)
colnames(keep) <- c("Sample", "Total_OTUs")
keep$Total_OTUs <- as.integer(keep$Total_OTUs)
otusum <- adiv
otusum$Total_OTUs <- keep$Total_OTUs

# Color by group
ggplot(otusum, aes(x=Group, y=Total_OTUs, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Total OTUs")

# Color by group, facet by sample type
ggplot(otusum, aes(x=Group, y=Total_OTUs, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Total OTUs")

# Color by sample type, facet by group
ggplot(otusum, aes(x=Sample_Type, y=Total_OTUs, fill = Sample_Type)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Group) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Sample Type") +
  ylab("Total OTUs")

# Test normality
hist(otusum$Total_OTUs, breaks=10)
qqnorm(otusum$Total_OTUs)
qqline(otusum$Total_OTUs)
shapiro.test(otusum$Total_OTUs)
  # p-value = 1.276e-06
ks.test(otusum$Total_OTUs, "pnorm", mean=mean(otusum$Total_OTUs), sd=sd(otusum$Total_OTUs))
  # p-value = 0.01574

# Kruskal-Wallis
kruskal.test(formula = Total_OTUs ~ Group, data = otusum)
  # p-value = 7.987e-05
kruskalmc(resp = Total_OTUs ~ Group, data = otusum)
  # Significant:
    # Summer-Torpor
    # Summer-IBA
kruskal.test(formula = Total_OTUs ~ Group, data = otusum, subset=Diet=="Lab")
  # p-value = 0.004659
kruskal.test(formula = Total_OTUs ~ Sample_Type, data = otusum)
  # p-value = 0.4302
kruskal.test(formula = Total_OTUs ~ Diet, data = otusum)
  # p-value = 8.811e-05
kruskal.test(formula = Total_OTUs ~ Diet, data = otusum, subset=Season=="Summer")
  # p-value = 0.009111
wilcox.test(Total_OTUs ~ Diet, data=otusum)
  # p-value = 9.412e-05

### Chao
# Color by group
ggplot(adiv, aes(x=Group, y=chao, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  #scale_fill_manual(values=c("gray95", "dimgray") )+
  xlab("Group") +
  ylab("Chao Richness")
# Color by group, facet by sample type
ggplot(adiv, aes(x=Group, y=chao, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Chao Richness")

# Test normality
hist(adiv$chao, breaks=10)
qqnorm(adiv$chao)
qqline(adiv$chao)
shapiro.test(adiv$chao)
  # p-value = 1.736e-05
ks.test(adiv$chao, "pnorm", mean=mean(adiv$chao), sd=sd(adiv$chao))
  # p-value = 0.2134

# Kruskal-Wallis
kruskal.test(formula = chao ~ Group, data = adiv)
  # p-value = 0.02779
kruskalmc(resp = chao ~ Group, data = adiv)
  # Significant:
    # Summer-Spring
kruskal.test(formula = chao ~ Group, data = adiv, subset=Diet=="Lab")
  # p-value = 0.119
kruskal.test(formula = chao ~ Sample_Type, data = adiv)
  # p-value = 0.1792
kruskal.test(formula = chao ~ Diet, data = adiv)
  # p-value = 0.004116
kruskal.test(formula = chao ~ Diet, data = adiv, subset=Season=="Summer")
  # p-value = 0.0208
wilcox.test(chao ~ Diet, data=adiv)
  # p-value = 0.002454


### Berger-Parker
# Color by group
ggplot(adiv, aes(x=Group, y=bergerparker, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  #scale_fill_manual(values=c("gray95", "dimgray") )+
  xlab("Group") +
  ylab("Berger-Parker")
# Color by group, facet by sample type
ggplot(adiv, aes(x=Group, y=bergerparker, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray") )+
  xlab("Group") +
  ylab("Berger-Parker")

# Test normality
hist(adiv$bergerparker, breaks=10)
qqnorm(adiv$bergerparker)
qqline(adiv$bergerparker)
shapiro.test(adiv$bergerparker)
  # p-value = 2.924e-05
ks.test(adiv$bergerparker, "pnorm", mean=mean(adiv$bergerparker), sd=sd(adiv$bergerparker))
  # p-value = 0.351

# Kruskal-Wallis
kruskal.test(formula = bergerparker ~ Group, data = adiv)
  # p-value = 0.4087
kruskal.test(formula = bergerparker ~ Group, data = adiv, subset=Diet=="Lab")
  # p-value = 0.7487
kruskal.test(formula = bergerparker ~ Sample_Type, data = adiv)
  # p-value = 0.594
kruskal.test(formula = bergerparker ~ Diet, data = adiv)
  # p-value = 0.03825
kruskal.test(formula = bergerparker ~ Diet, data = adiv, subset=Season=="Summer")
  # p-value = 0.1317
wilcox.test(bergerparker ~ Diet, data=adiv)
  # p-value = 0.03743


### Shannon
# Color by group
ggplot(adiv, aes(x=Group, y=shannon, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Shannon Diversity")
# Color by group, facet by sample type
ggplot(adiv, aes(x=Group, y=shannon, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Shannon Diversity")

# Test normality
hist(adiv$shannon, breaks=10)
qqnorm(adiv$shannon)
qqline(adiv$shannon)
shapiro.test(adiv$shannon)
  # p-value = 0.3431
ks.test(adiv$shannon, "pnorm", mean=mean(adiv$shannon), sd=sd(adiv$shannon))
  # p-value = 0.9152

# ANOVA
summary(aov(shannon ~ Group, data=adiv))
  # p-value = 0.0501
t.test(shannon ~ Sample_Type, data=adiv)
  # p-value = 0.8445
t.test(shannon ~ Diet, data=adiv)
  # p-value = 0.02371



### Inverse Simpson
# Color by group
ggplot(adiv, aes(x=Group, y= invsimpson, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  #facet_grid(.~Substrate) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Inverse Simpson Diversity")
# Color by group, facet by sample type
ggplot(adiv, aes(x=Group, y= invsimpson, fill = Group)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Sample_Type) +
  #scale_fill_manual(values=c("gray95", "dimgray")) +
  xlab("Group") +
  ylab("Inverse Simpson Diversity")

# Test normality
hist(adiv$invsimpson, breaks=10)
qqnorm(adiv$invsimpson)
qqline(adiv$invsimpson)
shapiro.test(adiv$invsimpson)
  # p-value = 6.667e-06
ks.test(adiv$invsimpson, "pnorm", mean=mean(adiv$invsimpson), sd=sd(adiv$invsimpson))
  # p-value = 0.02063

# Kruskal-Wallis
kruskal.test(formula = invsimpson ~ Group, data = adiv)
  # p-value = 0.3059
kruskal.test(formula = invsimpson ~ Group, data = adiv, subset=Diet=="Lab")
  # p-value = 0.6151
kruskal.test(formula = invsimpson ~ Sample_Type, data = adiv)
  # p-value = 0.7817
kruskal.test(formula = invsimpson ~ Diet, data = adiv)
  # p-value = 0.02565
kruskal.test(formula = invsimpson ~ Diet, data = adiv, subset=Season=="Summer")
  # p-value = 0.08753
wilcox.test(invsimpson ~ Diet, data=adiv)
  # p-value = 0.0239
```


### Examine Phyla
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(physeq.rem, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

# Create rank abundance of phyla
barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)

# Summarize data
phy.df <- psmelt(phy99)
phy.df$Phylum <- ordered(phy.df$Phylum, levels=c("Firmicutes", "Bacteroidetes","Verrucomicrobia", "Proteobacteria", "Unclassified", "Cyanobacteria", "Tenericutes", "Elusimicrobia"))
phy.df$Phylum[which(is.na(phy.df$Phylum))] <- rep("Unclassified",18)
phy.sum <- phy.df %>%
  group_by(Group, Sample_Type, Phylum) %>%
  summarize(Mean = mean(Abundance),
            Median = median(Abundance),
            SD = sd(Abundance),
            SE = (sd(Abundance)/(sqrt(length(Abundance)))),
            iqr = IQR(Abundance))

# Calculate IQR limits
phy.sum$iqr.min <- phy.sum$Median - 0.5*phy.sum$iqr
phy.sum[which(phy.sum$iqr.min < 0),10] <- 0
  # Any IQR min < 0, change to 0 (otherwise error bar won't plot)
phy.sum$iqr.max <- phy.sum$Median + 0.5*phy.sum$iqr


### Barplot ###
ggplot(phy.sum, aes(x=Phylum, y=Median, fill=Phylum)) +
  geom_bar(stat="identity", color="black") +
  geom_errorbar(aes(ymax=iqr.max, ymin=iqr.min), width=0.25) +
  facet_grid(Sample_Type ~ Group) +
  scale_fill_brewer(palette="Set1") +
  xlab("Phyla") +
  ylab("Median Relative Abundance for Phyla > 1%") +
  theme(axis.text.x = element_blank())

# Pull out otu table to test phyla
phy.num <- as.numeric(otu_table(phy99))

# Test normality
hist(phy.num, breaks=10)
qqnorm(phy.num)
qqline(phy.num)
shapiro.test(phy.num)
  # p-value < 2.2e-16
ks.test(phy.num, "pnorm", mean=mean(phy.num), sd=sd(phy.num))
  # p-value < 2.2e-16

# Get ready for stats
sampdf <- data.frame(sample_data(phy99))
sampdf$Relative_Abundance <- otu_table(phy99)
```




### Bray-Curtis Ordination
```{r}
### Bray NMDS
nmds <- ordinate(physeq=physeq.rem, method="NMDS", distance="bray")
  # No convergence

plot_ordination(physeq=physeq.rem, ordination=nmds, color="Group", shape="Sample_Type")

# Try removing that insanely crazy Cellobiose ABX sample with all Proteos
physeq.rem.rem <- subset_samples(physeq.rem=physeq.rem, sample_names(physeq.rem) != "CC1_S25")
nmds.rem <- ordinate(physeq.rem=physeq.rem.rem, method="NMDS", distance="bray")
  # Stress = 0.1233697 

plot_ordination(physeq.rem=physeq.rem.rem, ordination=nmds.rem, color="ABX", shape="Substrate") +
  stat_ellipse(type = "norm", linetype = 2) + stat_ellipse(type = "t")
```


### Play with ellipses
```{r}
### Bray NMDS
# Try removing that insanely crazy Cellobiose ABX sample with all Proteos
physeq.rem.rem <- subset_samples(physeq.rem=physeq.rem, sample_names(physeq.rem) != "CC1_S25")
nmds.rem <- ordinate(physeq.rem=physeq.rem.rem, method="NMDS", distance="bray")
  # Stress = 0.1233697 

plot_ordination(physeq.rem=physeq.rem.rem, ordination=nmds.rem, color="ABX", shape="Substrate") +
  stat_ellipse(type = "norm", linetype = 2) + stat_ellipse(type = "t")


# https://stackoverflow.com/questions/13794419/plotting-ordiellipse-function-from-vegan-package-onto-nmds-plot-created-in-ggplo

elip.nmds <- data.frame(MDS1 = nmds.rem$points[,1], MDS2 = nmds.rem$points[,2],
                        ABX = sample_data(physeq.rem.rem)$ABX)
plot.new()
elip.ord <- ordiellipse(nmds.rem, sample_data(physeq.rem.rem)$ABX, display="sites", kind="se", conf=0.95, label=T)


veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
}


elip.df <- data.frame()
for(i in levels(elip.nmds$ABX)){
  elip.df <- rbind(elip.df, cbind(as.data.frame(with(elip.nmds[elip.nmds$ABX==i,],
                                                     veganCovEllipse(elip.ord[[i]]$cov,
                                                                     elip.ord[[i]]$center,
                                                                     elip.ord[[i]]$scale))),
                                  group=i))
  
}


plot_ordination(physeq.rem=physeq.rem.rem, ordination=nmds.rem, color="ABX") +
  geom_path(data=elip.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1)

```


### Jaccard Ordination
```{r}
jac <- ordinate(physeq=physeq.rem, method="NMDS", distance="jaccard")
  # stress =  0.1026393

plot_ordination(physeq=physeq.rem, ordination=jac, color="Group", shape="Sample_Type")

# Try removing that insanely crazy Cellobiose ABX sample with all Proteos
physeq.rem.rem <- subset_samples(physeq.rem=physeq.rem, sample_names(physeq.rem) != "CC1_S25")
jac.rem <- ordinate(physeq.rem=physeq.rem.rem, method="NMDS", distance="jaccard")
  # Stress = 0.1032307 

plot_ordination(physeq.rem=physeq.rem.rem, ordination=jac.rem, color="ABX", shape="Substrate")
```









