---
title: "Code_WildCaptive"
author: "Edna Chiang"
date: "5/10/2021"
output: html_document
---
### Load Libraries
```{r}
library(ape)
library(dplyr)
library(dunn.test)
library(effsize)
library(ggplot2)
library(grid)
library(gridExtra)
library(phyloseq)
library(pwr)
library(picante)
library(tidyr)
library(vegan)

theme_set(theme_bw())
set.seed(1)
```

### Load Functions
```{r}
source('../scripts/simper_pretty.R')
source('../scripts/R_krusk.R')
source('../scripts/misc.R')
```

### Import Data
```{r}
# Link files
shared = "../mothur_output/final.shared"
taxonomy = "../mothur_output/final.taxonomy"
tree = "../mothur_output/final.tre"

# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy,
  mothur_tree_file = tree)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

# Add metadata
meta <- read.csv("../metadata.csv")
rownames(meta) <- meta$Sample
divsum <- read.table("../mothur_output/final.summary", header = T)
meta[,12:21] <- divsum[,3:12]

# Update phyloseq object
physeq <- merge_phyloseq(mothurdata, sample_data(meta))

# Subset out Summer Wild & Captive
phy.sum <- subset_samples(physeq, Season == "Summer")

# Remove OTUs that appear in < 3 samples
otu <- data.frame(otu_table(phy.sum))
otu.rem <- list()
for(i in 1:nrow(otu)){
  empty <- length(which(otu[i,] == 0))
    # Identifies # of samples w/o OTU
  if(empty > 19){
    # If OTU appears in < 3 samples
    otu.rem <- append(otu.rem, i)
      # Create list of OTUs that appear in only 1 sample
  }
}
otu.rem.row <- as.numeric(otu.rem)
  # Convert list to numeric
otu.rem.df <- otu[-otu.rem.row,]
  # Remove OTUs
otu.rem.tab <- otu_table(otu.rem.df, taxa_are_rows = T)
  # Convert trimmed OTU table to otu_table

# Update phyloseq object
phy.both <- merge_phyloseq(otu.rem.tab, sample_data(phy.sum), tax_table(phy.sum), phy_tree(phy.sum))

# Remove unpaired samples
# Not in Wild or Captive groups
#phy.both <- subset_samples(phy.both, ID != 3881)
#phy.both <- subset_samples(phy.both, ID != 4057)


# Order factors
sample_data(phy.both)$Diet <- ordered(sample_data(phy.both)$Diet, levels = c("Captive", "Wild"))

# Calculate relative abundance
phy.both <- transform_sample_counts(phy.both, function(x){(x/sum(x))*100})

# Subset by Sample Type
phy.con <- subset_samples(phy.both, Sample_Type == "Content")
phy.muc <- subset_samples(phy.both, Sample_Type == "Mucosa")
```




### Content - Test Phyla Rel Abund
```{r}
# Merge samples with the same taxonomic rank
goodphy <- tax_glom(phy.con, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99 <- transform_sample_counts(goodphy, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99 <- prune_taxa(taxa_sums(phy99) > 1, phy99)

# View ordered phyla - most abundant --> least abundant
# barplot(sort(taxa_sums(phy99),TRUE)[1:20]/nsamples(phy99),las=2,cex.axis=.7)
# Firmicutes, Bacteroidetes, Verrucomicrobia, Proteobacteria, Cyanobacteria, Unclassified, Tenericutes, Actinobacteria, Elusimicrobia

     


##### FIRMICUTES #####
fir.phy <- subset_taxa(phy99, Phylum == "Firmicutes")
fir.df <- data.frame(sample_data(fir.phy))
fir.df$RelAbund <- t(data.frame(otu_table(fir.phy)))

hist(fir.df$RelAbund, breaks=10)
qqnorm(fir.df$RelAbund)
qqline(fir.df$RelAbund)
shapiro.test(fir.df$RelAbund)
  # p-value = 0.1036
  # Normal
t.test(RelAbund ~ Diet, data = fir.df)
  # p-value = 0.1972




##### BACTEROIDETES #####
bac.phy <- subset_taxa(phy99, Phylum == "Bacteroidetes")
bac.df <- data.frame(sample_data(bac.phy))
bac.df$RelAbund <- t(data.frame(otu_table(bac.phy)))

hist(bac.df$RelAbund, breaks=10)
qqnorm(bac.df$RelAbund)
qqline(bac.df$RelAbund)
shapiro.test(bac.df$RelAbund)
  # p-value = 0.5738
  # Normal
t.test(RelAbund ~ Diet, data = bac.df)
  # p-value = 0.3764



##### Verrucomicrobia #####
ver.phy <- subset_taxa(phy99, Phylum == "Verrucomicrobia")
ver.df <- data.frame(sample_data(ver.phy))
ver.df$RelAbund <- t(data.frame(otu_table(ver.phy)))

hist(ver.df$RelAbund, breaks=10)
qqnorm(ver.df$RelAbund)
qqline(ver.df$RelAbund)
shapiro.test(ver.df$RelAbund)
  # p-value = 0.0001841
  # Not Normal
wilcox.test(RelAbund ~ Diet, data = ver.df)
  # p-value = 1



##### PROTEOBACTERIA #####
pro.phy <- subset_taxa(phy99, Phylum == "Proteobacteria")
pro.df <- data.frame(sample_data(pro.phy))
pro.df$RelAbund <- t(data.frame(otu_table(pro.phy)))

hist(pro.df$RelAbund, breaks=10)
qqnorm(pro.df$RelAbund)
qqline(pro.df$RelAbund)
shapiro.test(pro.df$RelAbund)
  # p-value = 0.06827
  # Normal
t.test(RelAbund ~ Diet, data = pro.df)
  # p-value = 0.01182



##### CYANOBACTERIA #####
cya.phy <- subset_taxa(phy99, Phylum == "Cyanobacteria")
cya.df <- data.frame(sample_data(cya.phy))
cya.df$RelAbund <- t(data.frame(otu_table(cya.phy)))

hist(cya.df$RelAbund, breaks=10)
qqnorm(cya.df$RelAbund)
qqline(cya.df$RelAbund)
shapiro.test(cya.df$RelAbund)
  # p-value = 0.005228
  # Not Normal
wilcox.test(RelAbund ~ Diet, data = cya.df)
  # p-value = 0.01212



##### TENERICUTES #####
ten.phy <- subset_taxa(phy99, Phylum == "Tenericutes")
ten.df <- data.frame(sample_data(ten.phy))
ten.df$RelAbund <- t(data.frame(otu_table(ten.phy)))

hist(ten.df$RelAbund, breaks=10)
qqnorm(ten.df$RelAbund)
qqline(ten.df$RelAbund)
shapiro.test(ten.df$RelAbund)
  # p-value = 0.03708
  # Not Normal
wilcox.test(RelAbund ~ Diet, data = ten.df)
  # p-value = 0.3572



##### ACTINOBACTERIA #####
act.phy <- subset_taxa(phy99, Phylum == "Actinobacteria")
act.df <- data.frame(sample_data(act.phy))
act.df$RelAbund <- t(data.frame(otu_table(act.phy)))

hist(act.df$RelAbund, breaks=10)
qqnorm(act.df$RelAbund)
qqline(act.df$RelAbund)
shapiro.test(act.df$RelAbund)
  # p-value = 0.05262
  # Normal
t.test(RelAbund ~ Diet, data = act.df)
  # p-value = 0.6397



##### ELUSIMICROBIA #####
elu.phy <- subset_taxa(phy99, Phylum == "Elusimicrobia")
elu.df <- data.frame(sample_data(elu.phy))
elu.df$RelAbund <- t(data.frame(otu_table(elu.phy)))

hist(elu.df$RelAbund, breaks=10)
qqnorm(elu.df$RelAbund)
qqline(elu.df$RelAbund)
shapiro.test(elu.df$RelAbund)
  # p-value = 3.247e-06
  # Not Normal
wilcox.test(RelAbund ~ Diet, data = elu.df)
  # p-value = 0.1817



##### UNCLASSIFIED #####
unc.phy <- subset_taxa(phy99, Phylum == "Bacteria_unclassified")
unc.df <- data.frame(sample_data(unc.phy))
unc.df$RelAbund <- t(data.frame(otu_table(unc.phy)))

hist(unc.df$RelAbund, breaks=10)
qqnorm(unc.df$RelAbund)
qqline(unc.df$RelAbund)
shapiro.test(unc.df$RelAbund)
  # p-value = 0.01209
  # Not Normal
wilcox.test(RelAbund ~ Diet, data = unc.df)
  # p-value = 0.2788



########## P-Adjust ##########
p.adjust(c(0.1972,0.3764,1,0.01182,0.01212,0.3572,0.6397,0.1817), method = "BH")
  # 0.4437000 0.4839429 1.0000000 0.0545400 0.0545400 0.4839429 0.7196625 0.4437000 0.4839429
  # Firmicutes, Bacteroidetes, Verrucomicrobia, Proteobacteria, Cyanobacteria, Tenericutes, Actinobacteria, Elusimicrobia, Unclassified



##### Summarize rel abund for table #####
phyla.sum <- psmelt(phy99)
phyla.sum.df <- phyla.sum %>%
  group_by(Diet, Phylum) %>%
  summarize(Mean = mean(Abundance),
            SE = se(Abundance))
phyla.sum.df$Phylum <- ordered(phyla.sum.df$Phylum, levels = c("Firmicutes", "Bacteroidetes", "Verrucomicrobia", "Proteobacteria", "Cyanobacteria", "Tenericutes", "Actinobacteria", "Elusimicrobia", "Bacteria_unclassified"))

#write.table(phyla.sum.df, "Content/Table1.WildCaptive.con.Phyla.csv", sep=",")
```





### Content - Alpha Diversity - Phylogenetic Diversity and SES MPD
```{r}
# Calculate Faith's phylogenetic diversity
pd.res <- pd(t(data.frame(otu_table(phy.con))), phy_tree(phy.con), include.root = T)
pd.df <- data.frame(pd.res)

# Calculate MPD (Mean Pairwise Distance)
pd.dist <- cophenetic(phy_tree(phy.con))
  # Calculate cophenetic distance
ses.mpd.res <- ses.mpd(t(data.frame(otu_table(phy.con))), pd.dist, null.model = "taxa.labels", abundance.weighted = F, runs = 999)
  # Calculate MPD
  # This'll take a while to run-- be patient
mpd <- data.frame(ses.mpd.res)
  # Pull out MDP results


### Prepare data for plotting ###
mpd$SampleID <- row.names(mpd)
pd.res$SampleID <- row.names(pd.res)
  # Make sure all SampleID's match!

# Pull out first Stat of each test
pd.stats <- data.frame(pd.res$SampleID, pd.res$PD)
pd.stats$Measure <- rep("PD", nrow(pd.df))
colnames(pd.stats) <- c("Sample", "Stat", "Measure")
mpd.stats <- data.frame(mpd$SampleID, mpd$mpd.obs.z)
mpd.stats$Measure <- rep("MPD SES", nrow(pd.df))
colnames(mpd.stats) <- c("Sample", "Stat", "Measure")

pd.ready <- merge(pd.stats, meta, by = "Sample")
pd.ready$Group <- ordered(pd.ready$Group, levels = c("Summer_Captive", "Summer_Wild"))

mpd.ready <- merge(mpd.stats, meta, by = "Sample")
mpd.ready$Group <- ordered(mpd.ready$Group, levels = c("Summer_Captive", "Summer_Wild"))

        
##### TESTING PD & MPD #####

### Test PD ###
hist(pd.ready$Stat, breaks=10)
qqnorm(pd.ready$Stat)
qqline(pd.ready$Stat)
shapiro.test(pd.ready$Stat)
  # p-value = 0.2589
  # Normal
t.test(Stat ~ Diet, data = pd.ready)
  # p-value = 0.0001161


### Test MPD ###
hist(mpd.ready$Stat, breaks=10)
qqnorm(mpd.ready$Stat)
qqline(mpd.ready$Stat)
shapiro.test(mpd.ready$Stat)
  # p-value = 0.4727
  # Normal
t.test(Stat ~ Diet, data = mpd.ready)
  # p-value = 0.07837

```



### Content - Alpha Diversity - Shannon & # OTUs
```{r}
adiv <- data.frame(sample_data(phy.con))

##### Shannon #####
hist(adiv$shannon, breaks=10)
qqnorm(adiv$shannon)
qqline(adiv$shannon)
shapiro.test(adiv$shannon)
  # p-value = 0.1497
  # Normal
t.test(shannon ~ Diet, data = adiv)
  # p-value = 0.9401



##### Number of Unique OTUs #####
otus <- data.frame(otu_table(phy.con))
sampNames <- colnames(otus)
uniq.otus <- data.frame(matrix(nrow = nsamples(phy.con), ncol = 2))
colnames(uniq.otus) <- c("Sample", "Unique_OTUs")
for(n in 1:nsamples(phy.con)) {
  COL <- otus[,n]
  numUniq <- length(which(COL > 0))
  uniq.otus$Sample[n] <- sampNames[n]
  uniq.otus$Unique_OTUs[n] <- numUniq
}
uniq.otus$Group <- sample_data(phy.con)$Group
rownames(uniq.otus) <- uniq.otus$Sample

hist(uniq.otus$Unique_OTUs, breaks=10)
qqnorm(uniq.otus$Unique_OTUs)
qqline(uniq.otus$Unique_OTUs)
shapiro.test(uniq.otus$Unique_OTUs)
  # p-value =  0.2577
  # Normal
t.test(Unique_OTUs ~ Group, data = uniq.otus)
  # p-value = 9.851e-05





###### Adjust a-div p-values ######
p.adjust(c(0.00009851, 0.0001161, 0.07837, 0.9401), method = "BH")
  # 0.0002322 0.0002322 0.1044933 0.9401000
  # Order = Unique # OTUs, PD, MPD, Shannon
```


### Content - Alpha Diversity Prepare Plots
```{r}
##### Unique # of OTUs #####

# Prepare data for plot
uniq.otus.sum <- uniq.otus %>%
  group_by(Group) %>%
  summarize(Mean = mean(Unique_OTUs),
            SE = se(Unique_OTUs),
            SD = sd(Unique_OTUs),
            Median = median(Unique_OTUs))
uniq.otus.sum$YMAX <- uniq.otus.sum$Mean + uniq.otus.sum$SE
uniq.otus.sum$YMIN <- uniq.otus.sum$Mean - uniq.otus.sum$SE

otu.ann <- data.frame(lab = c("*", " "), Group = factor(c("Summer_Captive", "Summer_Wild")))

otu.plot <- ggplot(uniq.otus, aes(x = Group, y = Unique_OTUs, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Wild")) +
  scale_y_continuous(limits = c(250,710), breaks = c(250, 340, 430, 520, 610, 700)) +
  scale_x_discrete(labels = c("Captive", "Wild")) +
  ylab("Number of Observed OTUs") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = otu.ann, aes(label=lab), x=c(1.5,0),
            y=c(705,0), size=5, color="black")





##### Faith's Phylogenetic Diversity #####

# Prepare PD ###
pd.sum <- pd.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
pd.sum$YMAX <- pd.sum$Mean + pd.sum$SE
pd.sum$YMIN <- pd.sum$Mean - pd.sum$SE

pd.ann <- data.frame(lab = c("*", " "), Group = factor(c("Summer_Captive", "Summer_Wild")))

pd.plot <- ggplot(pd.ready, aes(x = Group, y = Stat, fill = Group)) +
  geom_violin() + 
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Wild")) +
  scale_y_continuous(limits = c(16.5,37.5), breaks = c(16.5,20.5,24.5,28.5,32.5,36.5)) +
  scale_x_discrete(labels = c("Captive", "Wild")) +
  ylab("Faith's Phylogenetic Diversity") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = pd.ann, aes(label=lab), x=c(1.5,0),
            y=c(37,0), size=5, color="black")
  
  

  
      
##### Phylogenetic Evenness (MPD) #####

# Prepare MPD
mpd.sum <- mpd.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
mpd.sum$YMAX <- mpd.sum$Mean + mpd.sum$SE
mpd.sum$YMIN <- mpd.sum$Mean - mpd.sum$SE

mpd.ann <- data.frame(lab = c("ns", " "), Group = factor(c("Summer_Captive", "Summer_Wild")))

mpd.plot <- ggplot(mpd.ready, aes(x = Group, y = Stat, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Wild")) +
  scale_y_continuous(limits = c(-6,6), breaks = c(-6,-4,-2,0,2,4,6)) +
  scale_x_discrete(labels = c("Captive", "Wild")) +
  ylab("Phylogenetic Evenness (MPD)") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = mpd.ann, aes(label=lab), x=c(1.5,0),
            y=c(6.2,0), size=2.5, color="black")
  

        


##### Shannon's Diversity #####      

# Prepare data for plot
shannon.sum <- adiv %>%
  group_by(Group) %>%
  summarize(Mean = mean(shannon),
            SE = se(shannon),
            SD = sd(shannon),
            Median = median(shannon))
shannon.sum$YMAX <- shannon.sum$Mean + shannon.sum$SE
shannon.sum$YMIN <- shannon.sum$Mean - shannon.sum$SE

shannon.ann <- data.frame(lab = c("ns", " "), Group = factor(c("Summer_Captive", "Summer_Wild")))

shannon.plot <- ggplot(adiv, aes(x = Group, y = shannon, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Wild")) +
  scale_y_continuous(limits = c(2.3,5.55), breaks = c(2.3,3.1,3.9,4.7,5.5)) +
  scale_x_discrete(labels = c("Captive", "Wild")) +
  ylab("Shannon's Diversity") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        legend.title = element_text(face="bold", size=6),
        axis.title.x = element_text(face="bold", size=6),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.height = unit(3, 'mm'),
        legend.key.width = unit(3, "mm"),
        legend.box.margin=margin(-10,-10,-10,-10)) +
  geom_text(data = shannon.ann, aes(label=lab), x=c(1.5,0),
            y=c(5.6,0), size=2.5, color="black")

```


### Content - Plot - Alpha Diversity
```{r}
#png("Content/Fig2.WildCaptive.con.adiv.png", width = 170, height = 60, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,4, widths = c(1, 1, 1, 1.4), heights = c(0.07, 1.5))))
grid.text("A", x=unit(0.06, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=8,fontface="bold"))
print(otu.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
grid.text("B", x=unit(0.06, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2),
          gp=gpar(fontsize=8,fontface="bold"))
print(pd.plot, vp=viewport(layout.pos.row=2, layout.pos.col=2))
grid.text("C", x=unit(0.06, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=3),
          gp=gpar(fontsize=8,fontface="bold"))
print(mpd.plot, vp=viewport(layout.pos.row=2, layout.pos.col=3))
grid.text("D", x=unit(0.045, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=4),
          gp=gpar(fontsize=8,fontface="bold"))
print(shannon.plot, vp=viewport(layout.pos.row=2, layout.pos.col=4))
#dev.off()
```



### Content - Beta Diversity
```{r}
########## Weighted UniFrac ##########
UF.w <- phyloseq::distance(physeq = phy.con, method = "wunifrac")
UF.w.pcoa <- ordinate(physeq = phy.con, method = "PCoA", distance = "wunifrac")

wUF.plot <- plot_ordination(physeq = phy.con, ordination = UF.w.pcoa, axes = c(1,2),
                title = "Weighted UniFrac", color = "Diet") +
  scale_colour_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Lab")) +
  labs(color = "Group") +  geom_point(size = 3) +
  geom_point(size=3, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "none"
        )

# Test
sampdf <- data.frame(sample_data(phy.con))
beta.tax <- betadisper(d=UF.w, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.006
adonis(UF.w ~ Group, data = sampdf, permutations = 9999)
  # p-value = 0.0132






########## Unweighted UniFrac ##########
UF.u <- phyloseq::distance(physeq = phy.con, method = "unifrac")
UF.u.pcoa <- ordinate(physeq = phy.con, method = "PCoA", distance = "unifrac")

uUF.plot <- plot_ordination(physeq = phy.con, ordination = UF.u.pcoa, axes = c(1,2),
                title = "Unweighted UniFrac", color = "Diet") +
  scale_colour_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Lab")) +
  labs(color = "Group") +  geom_point(size = 3) +
  geom_point(size=3, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position  = "none"
        )

# Test
sampdf <- data.frame(sample_data(phy.con))
beta.tax <- betadisper(d=UF.u, group=sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.005
adonis(UF.u ~ Group, data = sampdf, permutations = 9999)
  # p-value = 0.0064





########## Bray-Curtis ##########
bray.pcoa <- ordinate(physeq=phy.con, method="PCoA", distance="bray")

bc.plot <- plot_ordination(physeq=phy.con, ordination=bray.pcoa, color="Group",
                           title = "Bray-Curtis Dissimilarity") +
  #stat_ellipse(aes(colour = Group), size = 1, level = 0.95) +
  scale_colour_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Wild")) +
  labs(color = "Group") + geom_point(size = 3) +
  geom_point(size=3, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "none"
        #legend.title = element_text(size = 8, face = "bold"),
        #legend.text = element_text(size = 8),
        #legend.key.height = unit(4, 'mm'),
        #legend.box.margin=margin(-10,-10,-10,-10)
        )

ord.legend <- g_legend(bc.plot)

# Test
sampdf <- data.frame(sample_data(phy.con))
bray <- phyloseq::distance(physeq = phy.con, method = "bray")
beta.tax <- betadisper(d = bray, group = sampdf$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
adonis(bray ~ Group, data = sampdf, permutations = 9999)
  # p-value = 0.0137





##### Adjust P-values #####

# Betadisper
p.adjust(c(0.006, 0.005, 0.001), method = "BH")
  # 0.006 0.006 0.003
  # Order = Weighted UniFrac, Unweighted UniFrac, Bray-Curtis

# PERMANOVA
p.adjust(c(0.0123, 0.0064, 0.0137), method = "BH")
  # 0.0137 0.0137 0.0137
  # Order = Weighted UniFrac, Unweighted UniFrac, Bray-Curtis
```



### Content - Plot - Beta Diversity
```{r}
#png("Content/Fig3.WildCaptive.con.bdiv.png", width = 85, height = 180, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(3,2, widths = c(1, 0.45), heights = c(1, 1, 1))))

print(wUF.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(uUF.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
print(bc.plot, vp=viewport(layout.pos.row=3, layout.pos.col=1))


ord.legend$vp <- viewport(layout.pos.row = 1:3, layout.pos.col = 2)
grid.draw(ord.legend)


grid.text("A", x=unit(0.05, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1,
                                                                  layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))
grid.text("B", x=unit(0.05, "npc"),  y=unit(0.95, "npc"), vp=viewport(layout.pos.row=2,
                                                                   layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))
grid.text("C", x=unit(0.05, "npc"),  y=unit(0.95, "npc"), vp=viewport(layout.pos.row=3,
                                                                   layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))

#dev.off()
```


### Content - Simper
```{r}
# Group
#simper.pretty(data.frame(otu_table(phy.con)),
              data.frame(sample_data(phy.con)),
              c("Diet"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='WildCaptive/Content/WildCaptive.con')
#group.simper <- read.csv("WildCaptive/Content/WildCaptive.con_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(phy.con)),
               data.frame(sample_data(phy.con)),
               csv = group.simper,
               c("Diet"),
               output_name = 'WildCaptive/Content/WildCaptive.con',
               taxonomy = data.frame(tax_table(phy.con)))
#group.simper.kw <- read.csv("WildCaptive/Content/WildCaptive.con_krusk_simper.csv")
#for(i in 1:nrow(group.simper.kw)){
  save <- which(rownames(data.frame(tax_table(phy.con))) == group.simper.kw$OTU[i])
  group.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(phy.con))[save,2], "-",
          data.frame(tax_table(phy.con))[save,3], "-",
          data.frame(tax_table(phy.con))[save,4], "-",
          data.frame(tax_table(phy.con))[save,5], "-",
          data.frame(tax_table(phy.con))[save,6])
}
#write.table(group.simper.kw, "WildCaptive/Content/WildCaptive.con_krusk_simper.csv", sep=",")
#group.simper.kw <- read.csv("WildCaptive/Content/WildCaptive.con.con_clean_simper.csv", row.names = 1)
```


### Content & Mucosa - Core OTUs
```{r}
### Subset out group + sample type
phy.wild.con <- subset_samples(phy.con, Diet == "Wild")
phy.wild.muc <- subset_samples(phy.muc, Diet == "Wild")
phy.sum.con <- subset_samples(phy.con, Diet == "Captive")
phy.sum.muc <- subset_samples(phy.muc, Diet == "Captive")


### Identify Core OTUs
wild.con.otu <- data.frame(otu_table(phy.wild.con))
wild.con.core <- apply(wild.con.otu, 1, function(row) all(row != 0))
wild.con.core <- wild.con.otu[wild.con.core,]
phy.wild.con.core <- merge_phyloseq(otu_table(wild.con.core, taxa_are_rows = T),
                                    tax_table(phy.wild.con), sample_data(phy.wild.con))
  # 323 OTUs

wild.muc.otu <- data.frame(otu_table(phy.wild.muc))
wild.muc.core <- apply(wild.muc.otu, 1, function(row) all(row != 0))
wild.muc.core <- wild.muc.otu[wild.muc.core,]
phy.wild.muc.core <- merge_phyloseq(otu_table(wild.muc.core, taxa_are_rows = T),
                                    tax_table(phy.wild.muc), sample_data(phy.wild.muc))
  # 323 OTUs

sum.con.otu <- data.frame(otu_table(phy.sum.con))
sum.con.core <- apply(sum.con.otu, 1, function(row) all(row != 0))
sum.con.core <- sum.con.otu[sum.con.core,]
phy.sum.con.core <- merge_phyloseq(otu_table(sum.con.core, taxa_are_rows = T),
                                    tax_table(phy.sum.con), sample_data(phy.sum.con))
  # 37 OTUs

sum.muc.otu <- data.frame(otu_table(phy.sum.muc))
sum.muc.core <- apply(sum.muc.otu, 1, function(row) all(row != 0))
sum.muc.core <- sum.muc.otu[sum.muc.core,]
phy.sum.muc.core <- merge_phyloseq(otu_table(sum.muc.core, taxa_are_rows = T),
                                    tax_table(phy.sum.muc), sample_data(phy.sum.muc))
  # 43 OTUs



### Compare Core OTUs

intersect(rownames(wild.con.core), rownames(sum.con.core))
  # 19 shared core OTUs
  # "Otu00159" "Otu00044" "Otu00026" "Otu00135" "Otu00154" "Otu00175" "Otu00197" "Otu00120" "Otu00229" "Otu00267" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00067" "Otu00068" "Otu00084" "Otu00011" "Otu00137"

intersect(rownames(wild.muc.core), rownames(sum.muc.core))
  # 24 shared core OTUs
  # "Otu00159" "Otu00026" "Otu00154" "Otu00175" "Otu00278" "Otu00197" "Otu00120" "Otu00169" "Otu00184" "Otu00161" "Otu00236" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00067" "Otu00068" "Otu00084" "Otu00043" "Otu00011" "Otu00041" "Otu00052" "Otu00137" "Otu00090"

intersect(rownames(wild.core), rownames(sum.core))
  # 15 shared core OTUs
  # This is also the core Summer OTUs
  # "Otu00159" "Otu00026" "Otu00154" "Otu00175" "Otu00197" "Otu00120" "Otu00156" "Otu00200" "Otu00093" "Otu00133" "Otu00067" "Otu00068" "Otu00084" "Otu00011" "Otu00137"



### Physeq object with only core OTUs
phy.con.core <- merge_phyloseq(phy.wild.con.core, phy.sum.con.core)
#write.csv(data.frame(tax_table(phy.con.core)), "Content/WildCaptive.con.coreOTUs.csv")
phy.muc.core <- merge_phyloseq(phy.wild.muc.core, phy.sum.muc.core)
#write.csv(data.frame(tax_table(phy.muc.core)), "Mucosa/WildCaptive.muc.coreOTUs.csv")
```




### Content - Effect Size - Phyla
```{r}
# Firmicutes
cohen.d(fir.df$RelAbund ~ fir.df$Group)
  # d = 1.008523 (large)
  # 95% CI = -0.5983509  2.6153966 

# Bacteroidetes
cohen.d(bac.df$RelAbund ~ bac.df$Group)
  # d = -0.7042115 (medium)
  # 95% CI = -2.2729076  0.8644846 

# Verrucomicrobia
cohen.d(ver.df$RelAbund ~ ver.df$Group)
  # d = 0.3057369 (small)
  # 95% CI = -1.232833  1.844307

# Proteobacteria
cohen.d(pro.df$RelAbund ~ pro.df$Group)
  # d = 1.349339 (large)
  # 95% CI = -0.3146818  3.0133601 

# Cyanobacteria
cohen.d(cya.df$RelAbund ~ cya.df$Group)
  # d = -5.671383 (large)
  # 95% CI = -8.806213 -2.536552

# Tenericutes
cohen.d(ten.df$RelAbund ~ ten.df$Group)
  # d = -0.4128499 (small)
  # 95% CI = -1.957227  1.131527

# Actinobacteria
cohen.d(act.df$RelAbund ~ act.df$Group)
  # d = -0.2908292 (small)
  # 95% CI = -1.828727  1.247068 

# Elusimicrobia
cohen.d(elu.df$RelAbund ~ elu.df$Group)
  # d = -2.386911 (large)
  # 95% CI = -4.302818 -0.471005 

# Unclassified
cohen.d(unc.df$RelAbund ~ unc.df$Group)
  # d = -0.5924999 (medium)
  # 95% CI = -2.1504192  0.9654194
```



### Content - Power - Phyla
```{r}
# Firmicutes
pwr.t2n.test(n1 = length(which(fir.df$Group == "Summer_Wild")),
             n2 = length(which(fir.df$Group == "Summer_Captive")), d = 1.008523)
  # 0.2659606

# Bacteroidetes
pwr.t2n.test(n1 = length(which(bac.df$Group == "Summer_Wild")),
             n2 = length(which(bac.df$Group == "Summer_Captive")), d = -0.7042115)
  # 0.1540151

# Verrucomicrobia
pwr.t2n.test(n1 = length(which(ver.df$Group == "Summer_Wild")),
             n2 = length(which(ver.df$Group == "Summer_Captive")), d = 0.3057369)
  # 0.0690403

# Proteobacteria
pwr.t2n.test(n1 = length(which(pro.df$Group == "Summer_Wild")),
             n2 = length(which(pro.df$Group == "Summer_Captive")), d = 1.349339)
  # 0.4289275

# Cyanobacteria
pwr.t2n.test(n1 = length(which(cya.df$Group == "Summer_Wild")),
             n2 = length(which(cya.df$Group == "Summer_Captive")), d = -5.671383)
  # 1

# Tenericutes
pwr.t2n.test(n1 = length(which(ten.df$Group == "Summer_Wild")),
             n2 = length(which(ten.df$Group == "Summer_Captive")), d = -0.4128499)
  # 0.08497037

# Actinobacteria
pwr.t2n.test(n1 = length(which(act.df$Group == "Summer_Wild")),
             n2 = length(which(act.df$Group == "Summer_Captive")), d = -0.2908292)
  # 0.06721344

# Elusimicrobia
pwr.t2n.test(n1 = length(which(elu.df$Group == "Summer_Wild")),
             n2 = length(which(elu.df$Group == "Summer_Captive")), d = -2.386911)
  # 0.8793452

# Unclassified
pwr.t2n.test(n1 = length(which(unc.df$Group == "Summer_Wild")),
             n2 = length(which(unc.df$Group == "Summer_Captive")), d = -0.5924999)
  # 0.1230292
```



### Content - Effect Size - Adiv
```{r}
### PD
cohen.d(pd.ready$Stat ~ pd.ready$Group)
  # d = -2.845633 (large)
  # 95% CI = -4.9020914 -0.7891752

### MPD
cohen.d(mpd.ready$Stat ~ mpd.ready$Group)
  # d = -1.983765 (large)
  # 95% CI = -3.7895437 -0.1779855

### Shannon
cohen.d(adiv$shannon ~ adiv$Group)
  # d = -0.05054058 (negligible)
  # 95% CI = -1.582222  1.481141

### Unique OTUs
cohen.d(uniq.otus$Unique_OTUs ~ uniq.otus$Group)
  # d = -2.944866 (large)
  # 95% CI = -5.0335689 -0.8561639
```



### Content - Power - Alpha Div
```{r}
# PD
pwr.t2n.test(length(which(adiv$Group == "Summer_Wild")),
             length(which(adiv$Group == "Summer_Captive")), d = -2.845633)
  # 0.9611536

# MPD
pwr.t2n.test(length(which(adiv$Group == "Summer_Wild")),
             length(which(adiv$Group == "Summer_Captive")), d = -1.983765)
  # 0.7417039

# Shannon
pwr.t2n.test(length(which(adiv$Group == "Summer_Wild")),
             length(which(adiv$Group == "Summer_Captive")), d = -0.05054058)
  # 0.0505153

# Unique OTUs
pwr.t2n.test(length(which(adiv$Group == "Summer_Wild")),
             length(which(adiv$Group == "Summer_Captive")), d = -2.944866)
  # 0.970757
```



### Content - Detectable Effect Size
```{r}
# https://cran.r-project.org/web/packages/pwr/vignettes/pwr-vignette.html

pwr.t2n.test(length(which(adiv$Group == "Summer_Wild")),
             length(which(adiv$Group == "Summer_Captive")), power = 0.8)
  # 2.132304
```



# BELOW IS MUCOSAAAAAAAAAAAAAAAA 



### Mucosa - Test Phyla Rel Abund
```{r}
# Merge samples with the same taxonomic rank
goodphy.muc <- tax_glom(phy.muc, taxrank="Phylum")

# Transform each merged phylum count to rel abund
phy99.muc <- transform_sample_counts(goodphy.muc, function(x){(x/sum(x))*100})

# Remove any phyla with <1% rel abund
phy99.muc <- prune_taxa(taxa_sums(phy99.muc) > 1, phy99.muc)

# View ordered phyla - most abundant --> least abundant
# barplot(sort(taxa_sums(phy99.muc),TRUE)[1:20]/nsamples(phy99.muc),las=2,cex.axis=.7)
# Firmicutes, Bacteroidetes, Cyanobacteria, Tenericutes, Bacteria_unclassified, Verrucomicrobia, Proteobacteria, Epsilonbacteraeota, Actinobacteria, Elusimicrobia, Kiritimatiellaeota

     



##### FIRMICUTES #####
fir.muc.phy <- subset_taxa(phy99.muc, Phylum == "Firmicutes")
fir.muc.df <- data.frame(sample_data(fir.muc.phy))
fir.muc.df$RelAbund <- t(data.frame(otu_table(fir.muc.phy)))

hist(fir.muc.df$RelAbund, breaks=10)
qqnorm(fir.muc.df$RelAbund)
qqline(fir.muc.df$RelAbund)
shapiro.test(fir.muc.df$RelAbund)
  # p-value = 0.8503
  # Normal
t.test(RelAbund ~ Diet, data = fir.muc.df)
  # p-value = 0.1875





##### BACTEROIDETES #####
bac.muc.phy <- subset_taxa(phy99.muc, Phylum == "Bacteroidetes")
bac.muc.df <- data.frame(sample_data(bac.muc.phy))
bac.muc.df$RelAbund <- t(data.frame(otu_table(bac.muc.phy)))

hist(bac.muc.df$RelAbund, breaks=10)
qqnorm(bac.muc.df$RelAbund)
qqline(bac.muc.df$RelAbund)
shapiro.test(bac.muc.df$RelAbund)
  # p-value = 0.3879
  # Normal
t.test(RelAbund ~ Diet, data = bac.muc.df)
  # p-value = 0.08753





##### CYANOBACTERIA #####
cya.muc.phy <- subset_taxa(phy99.muc, Phylum == "Cyanobacteria")
cya.muc.df <- data.frame(sample_data(cya.muc.phy))
cya.muc.df$RelAbund <- t(data.frame(otu_table(cya.muc.phy)))

hist(cya.muc.df$RelAbund, breaks=10)
qqnorm(cya.muc.df$RelAbund)
qqline(cya.muc.df$RelAbund)
shapiro.test(cya.muc.df$RelAbund)
  # p-value = 0.2891
  # Normal
t.test(RelAbund ~ Diet, data = cya.muc.df)
  # p-value = 0.01657





##### TENERICUTES #####
ten.muc.phy <- subset_taxa(phy99.muc, Phylum == "Tenericutes")
ten.muc.df <- data.frame(sample_data(ten.muc.phy))
ten.muc.df$RelAbund <- t(data.frame(otu_table(ten.muc.phy)))

hist(ten.muc.df$RelAbund, breaks=10)
qqnorm(ten.muc.df$RelAbund)
qqline(ten.muc.df$RelAbund)
shapiro.test(ten.muc.df$RelAbund)
  # p-value = 0.517
  # Normal
t.test(RelAbund ~ Diet, data = ten.muc.df)
  # p-value = 0.2833





##### Verrucomicrobia #####
ver.muc.phy <- subset_taxa(phy99.muc, Phylum == "Verrucomicrobia")
ver.muc.df <- data.frame(sample_data(ver.muc.phy))
ver.muc.df$RelAbund <- t(data.frame(otu_table(ver.muc.phy)))

hist(ver.muc.df$RelAbund, breaks=10)
qqnorm(ver.muc.df$RelAbund)
qqline(ver.muc.df$RelAbund)
shapiro.test(ver.muc.df$RelAbund)
  # p-value = 0.8146
  # Normal
t.test(RelAbund ~ Diet, data = ver.muc.df)
  # p-value = 0.47





##### PROTEOBACTERIA #####
pro.muc.phy <- subset_taxa(phy99.muc, Phylum == "Proteobacteria")
pro.muc.df <- data.frame(sample_data(pro.muc.phy))
pro.muc.df$RelAbund <- t(data.frame(otu_table(pro.muc.phy)))

hist(pro.muc.df$RelAbund, breaks=10)
qqnorm(pro.muc.df$RelAbund)
qqline(pro.muc.df$RelAbund)
shapiro.test(pro.muc.df$RelAbund)
  # p-value = 0.03333
  # Not Normal
wilcox.test(RelAbund ~ Diet, data = pro.muc.df)
  # p-value = 0.6485





##### EPSILONBACTERAEOTA #####
eps.muc.phy <- subset_taxa(phy99.muc, Phylum == "Epsilonbacteraeota")
eps.muc.df <- data.frame(sample_data(eps.muc.phy))
eps.muc.df$RelAbund <- t(data.frame(otu_table(eps.muc.phy)))

hist(eps.muc.df$RelAbund, breaks=10)
qqnorm(eps.muc.df$RelAbund)
qqline(eps.muc.df$RelAbund)
shapiro.test(eps.muc.df$RelAbund)
  # p-value = 3.332e-05
  # Not Normal
wilcox.test(RelAbund ~ Diet, data = eps.muc.df)
  # p-value = 0.05971





##### ACTINOBACTERIA #####
act.muc.phy <- subset_taxa(phy99.muc, Phylum == "Actinobacteria")
act.muc.df <- data.frame(sample_data(act.muc.phy))
act.muc.df$RelAbund <- t(data.frame(otu_table(act.muc.phy)))

hist(act.muc.df$RelAbund, breaks=10)
qqnorm(act.muc.df$RelAbund)
qqline(act.muc.df$RelAbund)
shapiro.test(act.muc.df$RelAbund)
  # p-value = 0.5175
  # Normal
t.test(RelAbund ~ Diet, data = act.muc.df)
  # p-value = 0.2018





##### ELUSIMICROBIA #####
elu.muc.phy <- subset_taxa(phy99.muc, Phylum == "Elusimicrobia")
elu.muc.df <- data.frame(sample_data(elu.muc.phy))
elu.muc.df$RelAbund <- t(data.frame(otu_table(elu.muc.phy)))

hist(elu.muc.df$RelAbund, breaks=10)
qqnorm(elu.muc.df$RelAbund)
qqline(elu.muc.df$RelAbund)
shapiro.test(elu.muc.df$RelAbund)
  # p-value = 0.0003128
  # Not Normal
wilcox.test(RelAbund ~ Diet, data = elu.muc.df)
  # p-value = 0.1074





##### KIRITIMATIELLAEOTA #####
kir.muc.phy <- subset_taxa(phy99.muc, Phylum == "Kiritimatiellaeota")
kir.muc.df <- data.frame(sample_data(kir.muc.phy))
kir.muc.df$RelAbund <- t(data.frame(otu_table(kir.muc.phy)))

hist(kir.muc.df$RelAbund, breaks=10)
qqnorm(kir.muc.df$RelAbund)
qqline(kir.muc.df$RelAbund)
shapiro.test(kir.muc.df$RelAbund)
  # p-value = 5.017e-08
  # Not Normal
wilcox.test(RelAbund ~ Diet, data = kir.muc.df)
  # p-value = 0.7427





##### UNCLASSIFIED #####
unc.muc.phy <- subset_taxa(phy99.muc, Phylum == "Bacteria_unclassified")
unc.muc.df <- data.frame(sample_data(unc.muc.phy))
unc.muc.df$RelAbund <- t(data.frame(otu_table(unc.muc.phy)))

hist(unc.muc.df$RelAbund, breaks=10)
qqnorm(unc.muc.df$RelAbund)
qqline(unc.muc.df$RelAbund)
shapiro.test(unc.muc.df$RelAbund)
  # p-value = 0.00253
  # Not Normal
wilcox.test(RelAbund ~ Diet, data = unc.muc.df)
  # p-value = 0.3152





########## P-Adjust ##########
p.adjust(c(0.1875,0.08753,0.01657,0.2833,0.47,0.6485,0.05971,0.2018,0.1074,0.7427,0.3152), method = "BH")
  # 0.3699667 0.2953500 0.1822700 0.4334000 0.5744444 0.7133500 0.2953500 0.3699667 0.2953500 0.7427000 0.4334000
  # Firmicutes, Bacteroidetes, Cyanobacteria, Tenericutes, Verrucomicrobia, Proteobacteria, Epsilonbacteraeota, Actinobacteria, Elusimicrobia, Kiritimatiellaeota, Unclassified





##### Summarize rel abund for table #####
phyla.muc.sum <- psmelt(phy99.muc)
phyla.muc.sum.df <- phyla.muc.sum %>%
  group_by(Diet, Phylum) %>%
  summarize(Mean = mean(Abundance),
            SE = se(Abundance))
phyla.muc.sum.df$Phylum <- ordered(phyla.muc.sum.df$Phylum, levels = c("Firmicutes", "Bacteroidetes", "Cyanobacteria", "Tenericutes", "Bacteria_unclassified", "Verrucomicrobia", "Proteobacteria", "Epsilonbacteraeota", "Actinobacteria", "Elusimicrobia", "Kiritimatiellaeota"))

#write.table(phyla.muc.sum.df, "Mucosa/TableS3.WildCaptive.muc.Phyla.csv", sep=",")
```





### Mucosa - Alpha Diversity - Phylogenetic Diversity and SES MPD
```{r}
### Unweighted - Calculate phylogenetic diversity and MPD ###

# Calculate Faith's phylogenetic diversity
pd.muc.res <- pd(t(data.frame(otu_table(phy.muc))), phy_tree(phy.muc), include.root = T)
pd.muc.df <- data.frame(pd.muc.res)

# Calculate MPD (Mean Pairwise Distance)
pd.muc.dist <- cophenetic(phy_tree(phy.muc))
  # Calculate cophenetic distance
ses.mpd.res.muc <- ses.mpd(t(data.frame(otu_table(phy.muc))), pd.muc.dist, null.model = "taxa.labels", abundance.weighted = F, runs = 999)
  # Calculate MPD
  # This'll take a while to run-- be patient
mpd.muc <- data.frame(ses.mpd.res.muc)
  # Pull out MDP results


### Prepare data for plotting ###
mpd.muc$SampleID <- row.names(mpd.muc)
pd.muc.res$SampleID <- row.names(pd.muc.res)
  # Make sure all SampleID's match!

# Pull out first Stat of each test
pd.muc.stats <- data.frame(pd.muc.res$SampleID, pd.muc.res$PD)
pd.muc.stats$Measure <- rep("PD", nrow(pd.muc.df))
colnames(pd.muc.stats) <- c("Sample", "Stat", "Measure")
mpd.muc.stats <- data.frame(mpd.muc$SampleID, mpd.muc$mpd.obs.z)
mpd.muc.stats$Measure <- rep("MPD SES", nrow(pd.muc.df))
colnames(mpd.muc.stats) <- c("Sample", "Stat", "Measure")

pd.muc.ready <- merge(pd.muc.stats, meta, by = "Sample")
pd.muc.ready$Group <- ordered(pd.muc.ready$Diet, levels = c("Captive", "Wild"))

mpd.muc.ready <- merge(mpd.muc.stats, meta, by = "Sample")
mpd.muc.ready$Group <- ordered(mpd.muc.ready$Diet, levels = c("Captive", "Wild"))




########## TESTING ##########

### Test PD ###
hist(pd.muc.ready$Stat, breaks=10)
qqnorm(pd.muc.ready$Stat)
qqline(pd.muc.ready$Stat)
shapiro.test(pd.muc.ready$Stat)
  # p-value = 0.118
  # Normal
t.test(Stat ~ Diet, data = pd.muc.ready)
  # p-value = 0.0001115


### Test MPD ###
hist(mpd.muc.ready$Stat, breaks=10)
qqnorm(mpd.muc.ready$Stat)
qqline(mpd.muc.ready$Stat)
shapiro.test(mpd.muc.ready$Stat)
  # p-value = 0.1396
  # Normal
t.test(Stat ~ Diet, data = mpd.muc.ready)
  # p-value = 0.3027

```



### Mucosa - Alpha Diversity - Shannon & # OTUs
```{r}
adiv.muc <- data.frame(sample_data(phy.muc))

########## Shannon ##########
hist(adiv.muc$shannon, breaks=10)
qqnorm(adiv.muc$shannon)
qqline(adiv.muc$shannon)
shapiro.test(adiv.muc$shannon)
  # p-value = 0.07363
  # Normal
t.test(shannon ~ Diet, data = adiv.muc)
  # p-value = 0.6138



########## Number of Unique OTUs ##########
otus.muc <- data.frame(otu_table(phy.muc))
sampNames.muc <- colnames(otus.muc)
uniq.otus.muc <- data.frame(matrix(nrow = nsamples(phy.muc), ncol = 2))
colnames(uniq.otus.muc) <- c("Sample", "Unique_OTUs")
for(n in 1:nsamples(phy.muc)) {
  COL.muc <- otus.muc[,n]
  numUniq.muc <- length(which(COL.muc > 0))
  uniq.otus.muc$Sample[n] <- sampNames.muc[n]
  uniq.otus.muc$Unique_OTUs[n] <- numUniq.muc
}
uniq.otus.muc$Group <- sample_data(phy.muc)$Group
rownames(uniq.otus.muc) <- uniq.otus.muc$Sample

hist(uniq.otus.muc$Unique_OTUs, breaks=10)
qqnorm(uniq.otus.muc$Unique_OTUs)
qqline(uniq.otus.muc$Unique_OTUs)
shapiro.test(uniq.otus.muc$Unique_OTUs)
  # p-value =  0.1959
  # Normal
t.test(Unique_OTUs ~ Group, data = uniq.otus.muc)
  # p-value = 3.348e-05



###### Adjust a-div p-values ######
p.adjust(c(0.00003348,0.00011150,0.30270000,0.61380000), method = "BH")
  # 0.00013392 0.00022300 0.40360000 0.61380000
  # Order = Unique # OTUs, PD, MPD, Shannon

```


### Mucosa - Alpha Diversity Prepare Plots
```{r}
##### Unique # of OTUs #####

# Prepare data for plot
uniq.otus.muc.sum <- uniq.otus.muc %>%
  group_by(Group) %>%
  summarize(Mean = mean(Unique_OTUs),
            SE = se(Unique_OTUs),
            SD = sd(Unique_OTUs),
            Median = median(Unique_OTUs))
uniq.otus.muc.sum$YMAX <- uniq.otus.muc.sum$Mean + uniq.otus.muc.sum$SE
uniq.otus.muc.sum$YMIN <- uniq.otus.muc.sum$Mean - uniq.otus.muc.sum$SE

otu.muc.ann <- data.frame(lab = c("*", " "), Group = factor(c("Summer_Captive", "Summer_Wild")))

muc.otu.plot <- ggplot(uniq.otus.muc, aes(x = Group, y = Unique_OTUs, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Wild")) +
  scale_y_continuous(limits = c(280,760), breaks = c(280,400,520,640,760)) +
  scale_x_discrete(labels = c("Captive", "Wild")) +
  ylab("Number of Observed OTUs") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = otu.muc.ann, aes(label=lab), x=c(1.5,0),
            y=c(760,0), size=5, color="black")





##### Faith's Phylogenetic Diversity #####

# Prepare PD ###
pd.muc.sum <- pd.muc.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
pd.muc.sum$YMAX <- pd.muc.sum$Mean + pd.muc.sum$SE
pd.muc.sum$YMIN <- pd.muc.sum$Mean - pd.muc.sum$SE

pd.muc.ann <- data.frame(lab = c("*", " "), Diet = factor(c("Captive", "Wild")))

muc.pd.plot <- ggplot(pd.muc.ready, aes(x = Diet, y = Stat, fill = Diet)) +
  geom_violin() + 
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Wild")) +
  scale_y_continuous(limits = c(17,38), breaks = c(17,24,31,38)) +
  ylab("Faith's Phylogenetic Diversity") + xlab("Group") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = pd.muc.ann, aes(label=lab), x=c(1.5,0),
            y=c(38,0), size=5, color="black")
  
  

  
      
##### Phylogenetic Evenness (MPD) #####

# Prepare MPD
mpd.muc.sum <- mpd.muc.ready %>%
  group_by(Group) %>%
  summarize(Mean = mean(Stat),
            SE = se(Stat),
            SD = sd(Stat),
            Median = median(Stat))
mpd.muc.sum$YMAX <- mpd.muc.sum$Mean + mpd.muc.sum$SE
mpd.muc.sum$YMIN <- mpd.muc.sum$Mean - mpd.muc.sum$SE

mpd.muc.ann <- data.frame(lab = c("ns", " "), Diet = factor(c("Captive", "Wild")))

muc.mpd.plot <- ggplot(mpd.muc.ready, aes(x = Diet, y = Stat, fill = Diet)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Wild")) +
  scale_y_continuous(limits = c(-4.6,3.8), breaks = c(-4.6,-2.5,-0.4,1.7,3.8)) +
  scale_x_discrete(labels = c("Captive", "Wild")) +
  ylab("Phylogenetic Evenness (MPD)") + xlab("Group") +
    theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        axis.title.x = element_text(face="bold", size=6),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        legend.position = "none") +
  geom_text(data = mpd.muc.ann, aes(label=lab), x=c(1.5,0),
            y=c(3.8,0), size=2.5, color="black")
  

        


##### Shannon's Diversity #####      

# Prepare data for plot
shannon.muc.sum <- adiv.muc %>%
  group_by(Group) %>%
  summarize(Mean = mean(shannon),
            SE = se(shannon),
            SD = sd(shannon),
            Median = median(shannon))
shannon.muc.sum$YMAX <- shannon.muc.sum$Mean + shannon.muc.sum$SE
shannon.muc.sum$YMIN <- shannon.muc.sum$Mean - shannon.muc.sum$SE

shannon.muc.ann <- data.frame(lab = c("ns", " "), Group = factor(c("Summer_Captive", "Summer_Wild")))

muc.shannon.plot <- ggplot(adiv.muc, aes(x = Group, y = shannon, fill = Group)) +
  geom_violin() +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1, stackratio = 1.15, fill = "black") +
  scale_fill_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Wild")) +
  scale_y_continuous(limits = c(1.4,5.8), breaks = c(1.4,2.5,3.6,4.7,5.8)) +
  scale_x_discrete(labels = c("Captive", "Wild")) +
  ylab("Shannon's Diversity") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(face="bold", size=6),
        strip.text.x = element_text(face ="bold", size=6),
        legend.title = element_text(face="bold", size=6),
        axis.title.x = element_text(face="bold", size=6),
        axis.title.y = element_text(face="bold", size=6),
        axis.text.x = element_text(size=6),
        axis.text.y = element_text(size=6),
        legend.text = element_text(size=6),
        legend.key.height = unit(3, 'mm'),
        legend.key.width = unit(3, "mm"),
        legend.box.margin=margin(-10,-10,-10,-10)) +
  geom_text(data = shannon.muc.ann, aes(label=lab), x=c(1.5,0),
            y=c(5.8,0), size=2.5, color="black")

```


### Mucosa - Plot - Alpha Diversity Mucosa
```{r}
#png("Mucosa/FigS3.WildCaptive.muc.adiv.png", width = 170, height = 60, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,4, widths = c(1, 1, 1, 1.4), heights = c(0.07, 1.5))))
grid.text("A", x=unit(0.06, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1),
          gp=gpar(fontsize=8,fontface="bold"))
print(muc.otu.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
grid.text("B", x=unit(0.06, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2),
          gp=gpar(fontsize=8,fontface="bold"))
print(muc.pd.plot, vp=viewport(layout.pos.row=2, layout.pos.col=2))
grid.text("C", x=unit(0.06, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=3),
          gp=gpar(fontsize=8,fontface="bold"))
print(muc.mpd.plot, vp=viewport(layout.pos.row=2, layout.pos.col=3))
grid.text("D", x=unit(0.045, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=4),
          gp=gpar(fontsize=8,fontface="bold"))
print(muc.shannon.plot, vp=viewport(layout.pos.row=2, layout.pos.col=4))
#dev.off()
```




### Mucosa - Beta Diversity
```{r}
########## Weighted UniFrac ##########
UF.muc.w <- phyloseq::distance(physeq = phy.muc, method = "wunifrac")
UF.muc.w.pcoa <- ordinate(physeq = phy.muc, method = "PCoA", distance = "wunifrac")

wUF.muc.plot <- plot_ordination(physeq = phy.muc, ordination = UF.muc.w.pcoa, axes = c(1,2),
                title = "Weighted UniFrac", color = "Diet") +
  #stat_ellipse(aes(colour = Diet), size = 1, level = 0.95) +
  scale_colour_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Lab")) +
  labs(color = "Group") +  geom_point(size = 3) +
  geom_point(size=3, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "none"
        )


sampdf.muc <- data.frame(sample_data(phy.muc))
beta.tax <- betadisper(d=UF.muc.w, group=sampdf.muc$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.241
adonis(UF.muc.w ~ Group, data = sampdf.muc, permutations = 9999)
  # 0.0041



########## Unweighted UniFrac ##########
UF.muc.u <- phyloseq::distance(physeq = phy.muc, method = "unifrac")
UF.muc.u.pcoa <- ordinate(physeq = phy.muc, method = "PCoA", distance = "unifrac")

uUF.muc.plot <- plot_ordination(physeq = phy.muc, ordination = UF.muc.u.pcoa, axes = c(1,2),
                title = "Unweighted UniFrac", color = "Diet") +
  #stat_ellipse(aes(colour = Group), size = 1, level = 0.95) +
  scale_colour_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Lab")) +
  labs(color = "Group") +  geom_point(size = 3) +
  geom_point(size=3, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position  = "none"
        )


sampdf.muc <- data.frame(sample_data(phy.muc))
beta.tax <- betadisper(d=UF.muc.u, group=sampdf.muc$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.004
adonis(UF.muc.u ~ Group, data = sampdf.muc, permutations = 9999)
  # p-value = 0.0027





########## Bray-Curtis ##########
bray.muc.pcoa <- ordinate(physeq=phy.muc, method="PCoA", distance="bray")

bc.muc.plot <- plot_ordination(physeq=phy.muc, ordination=bray.muc.pcoa, color="Group",
                           title = "Bray-Curtis Dissimilarity") +
  #stat_ellipse(aes(colour = Group), size = 1, level = 0.95) +
  scale_colour_manual(values = c("#e60000", "#ec9393"), labels = c("Captive", "Wild")) +
  labs(color = "Group") + geom_point(size = 3) +
  geom_point(size=3, colour = "black", shape = 21) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size = 8),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8, colour = "black"),
        axis.text.y = element_text(size = 8, colour = "black"),
        plot.title = element_text(hjust = 0.5, size = 10),
        legend.position = "none"
        #legend.title = element_text(size = 8, face = "bold"),
        #legend.text = element_text(size = 8),
        #legend.key.height = unit(4, 'mm'),
        #legend.box.margin=margin(-10,-10,-10,-10)
        )

ord.muc.legend <- g_legend(bc.muc.plot)


sampdf.muc <- data.frame(sample_data(phy.muc))
bray <- phyloseq::distance(physeq = phy.muc, method = "bray")
beta.tax <- betadisper(d = bray, group = sampdf.muc$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.203
adonis(bray ~ Group, data = sampdf.muc, permutations = 9999)
  # p-value = 0.003





##### Adjust P-values #####

# Betadisper
p.adjust(c(0.241, 0.004, 0.203), method = "BH")
  # 0.241 0.012 0.241
  # Weighted UniFrac, Unweighted UniFrac, Bray-Curtis

# ANOSIM
p.adjust(c(0.0041, 0.0027, 0.003), method = "BH")
  # 0.0041 0.0041 0.0041
  # Weighted UniFrac, Unweighted UniFrac, Bray-Curtis

```


### Mucosa - Plot - Beta Diversity
```{r}
#png("Mucosa/Fig.S4.WildCaptive.muc.bdiv.png", width = 85, height = 180, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(3,2, widths = c(1, 0.45), heights = c(1, 1, 1))))

print(wUF.muc.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(uUF.muc.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
print(bc.muc.plot, vp=viewport(layout.pos.row=3, layout.pos.col=1))


ord.muc.legend$vp <- viewport(layout.pos.row = 1:3, layout.pos.col = 2)
grid.draw(ord.muc.legend)


grid.text("A", x=unit(0.05, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1,
                                                                  layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))
grid.text("B", x=unit(0.05, "npc"),  y=unit(0.95, "npc"), vp=viewport(layout.pos.row=2,
                                                                   layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))
grid.text("C", x=unit(0.05, "npc"),  y=unit(0.95, "npc"), vp=viewport(layout.pos.row=3,
                                                                   layout.pos.col=1),
          gp=gpar(fontsize=12,fontface="bold"))

#dev.off()
```

### Mucosa - Simper
```{r}
# Group
#simper.pretty(data.frame(otu_table(phy.muc)),
              data.frame(sample_data(phy.muc)),
              c("Diet"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='Mucosa/WildCaptive.muc')
#group.muc.simper <- read.csv("Mucosa/WildCaptive.muc_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(phy.muc)),
               data.frame(sample_data(phy.muc)),
               csv = group.muc.simper,
               c("Diet"),
               output_name = 'wild.captive.muc',
               taxonomy = data.frame(tax_table(phy.muc)))
#group.muc.simper.kw <- read.csv("Mucosa/WildCaptive.muc_krusk_simper.csv")
#for(i in 1:nrow(group.muc.simper.kw)){
  save <- which(rownames(data.frame(tax_table(phy.muc))) == group.muc.simper.kw$OTU[i])
  group.muc.simper.kw$Taxonomy[i] <-
    paste(data.frame(tax_table(phy.muc))[save,2], "-",
          data.frame(tax_table(phy.muc))[save,3], "-",
          data.frame(tax_table(phy.muc))[save,4], "-",
          data.frame(tax_table(phy.muc))[save,5], "-",
          data.frame(tax_table(phy.muc))[save,6])
}
#write.table(group.muc.simper.kw, "Mucosa/WildCaptive.muc_krusk_simper.csv", sep=",")
#group.muc.simper.kw <- read.csv("Mucosa/WildCaptive.muc_clean_simper.csv", row.names = 1)
```



### Mucosa - Effect Size - Phyla
```{r}
# Firmicutes
cohen.d(fir.muc.df$RelAbund ~ fir.muc.df$Group)
  # d = -1.175883 (large)
  # 95% CI = -2.7029766  0.3512109 

# Bacteroidetes
cohen.d(bac.muc.df$RelAbund ~ bac.muc.df$Group)
  # d = 1.740787 (large)
  # 95% CI = 0.09297978 3.38859353 

# Cyanobacteria
cohen.d(cya.muc.df$RelAbund ~ cya.muc.df$Group)
  # d = -2.899711 (large)
  # 95% CI = -4.8912498 -0.9081729

# Tenericutes
cohen.d(ten.muc.df$RelAbund ~ ten.muc.df$Group)
  # d = -0.8316089 (large)
  # 95% CI = -2.3051266  0.6419088 

# Verrucomicrobia
cohen.d(ver.muc.df$RelAbund ~ ver.muc.df$Group)
  # d = 0.446308 (small)
  # 95% CI = -0.9878198  1.8804359

# Proteobacteria
cohen.d(pro.muc.df$RelAbund ~ pro.muc.df$Group)
  # d = 0.6173098 (medium)
  # 95% CI = -0.8314929  2.0661125 

# Epsilonbacteraeota
cohen.d(eps.muc.df$RelAbund ~ eps.muc.df$Group)
  # d = -0.9771534 (large)
  # 95% CI = -2.4713051  0.5169983 

# Actinobacteria
cohen.d(act.muc.df$RelAbund ~ act.muc.df$Group)
  # d = -0.9344695 (large)
  # 95% CI = -2.4222563  0.5533173  

# Elusimicrobia
cohen.d(elu.muc.df$RelAbund ~ elu.muc.df$Group)
  # d = -2.124502 (large)
  # 95% CI = -3.8738631 -0.3751413 

# Kiritimatiellaeota
cohen.d(kir.muc.df$RelAbund ~ kir.muc.df$Group)
  # d = 0.436739 (small)
  # 95% CI = -0.9967035  1.8701814  

# Unclassified
cohen.d(unc.muc.df$RelAbund ~ unc.muc.df$Group)
  # d = -0.0859002 (negligible)
  # 95% CI = -1.504387  1.332587
```



### Mucosa - Power - Phyla
```{r}
# Firmicutes
pwr.t2n.test(n1 = length(which(fir.muc.df$Group == "Summer_Wild")),
             n2 = length(which(fir.muc.df$Group == "Summer_Captive")), d = -1.175883)
  # 0.3886627

# Bacteroidetes
pwr.t2n.test(n1 = length(which(bac.muc.df$Group == "Summer_Wild")),
             n2 = length(which(bac.muc.df$Group == "Summer_Captive")), d = 1.740787)
  # 0.6963536

# Cyanobacteria
pwr.t2n.test(n1 = length(which(cya.muc.df$Group == "Summer_Wild")),
             n2 = length(which(cya.muc.df$Group == "Summer_Captive")), d = -2.899711)
  # 0.9835279

# Tenericutes
pwr.t2n.test(n1 = length(which(ten.muc.df$Group == "Summer_Wild")),
             n2 = length(which(ten.muc.df$Group == "Summer_Captive")), d = -0.8316089)
  # 0.2209699

# Verrucomicrobia
pwr.t2n.test(n1 = length(which(ver.muc.df$Group == "Summer_Wild")),
             n2 = length(which(ver.muc.df$Group == "Summer_Captive")), d = 0.446308)
  # 0.09792902

# Proteobacteria
pwr.t2n.test(n1 = length(which(pro.muc.df$Group == "Summer_Wild")),
             n2 = length(which(pro.muc.df$Group == "Summer_Captive")), d = 0.6173098)
  # 0.143003

# Epsilonbacteraeota
pwr.t2n.test(n1 = length(which(act.muc.df$Group == "Summer_Wild")),
             n2 = length(which(act.muc.df$Group == "Summer_Captive")), d = -0.9771534)
  # 0.2864668

# Actinobacteria
pwr.t2n.test(n1 = length(which(act.muc.df$Group == "Summer_Wild")),
             n2 = length(which(act.muc.df$Group == "Summer_Captive")), d = -0.9344695)
  # 0.2663121

# Elusimicrobia
pwr.t2n.test(n1 = length(which(elu.muc.df$Group == "Summer_Wild")),
             n2 = length(which(elu.muc.df$Group == "Summer_Captive")), d = -2.124502)
  # 0.853669

# Kiritimatiellaeota
pwr.t2n.test(n1 = length(which(elu.muc.df$Group == "Summer_Wild")),
             n2 = length(which(elu.muc.df$Group == "Summer_Captive")), d = 0.436739)
  # 0.09585929

# Unclassified
pwr.t2n.test(n1 = length(which(unc.muc.df$Group == "Summer_Wild")),
             n2 = length(which(unc.muc.df$Group == "Summer_Captive")), d = -0.0859002)
  # 0.05173786
```



### Mucosa - Effect Size - Adiv
```{r}
### PD
cohen.d(pd.muc.ready$Stat ~ pd.muc.ready$Group)
  # d = -3.62433 (large)
  # 95% CI = -5.875077 -1.373583

### MPD
cohen.d(mpd.muc.ready$Stat ~ mpd.muc.ready$Group)
  # d = -0.6733588 (medium)
  # 95% CI = -2.1279571  0.7812396

### Shannon
cohen.d(adiv.muc$shannon ~ adiv.muc$Group)
  # d = 0.3152049 (small)
  # 95% CI = -1.110804  1.741213 

### Unique OTUs
cohen.d(uniq.otus.muc$Unique_OTUs ~ uniq.otus.muc$Group)
  # d = -4.012347 (large)
  # 95% CI = -6.411328 -1.613365
```



### Mucosa - Power - Alpha Div
```{r}
# PD
pwr.t2n.test(length(which(adiv.muc$Group == "Summer_Wild")),
             length(which(adiv.muc$Group == "Summer_Captive")), d = -2.845633)
  # 0.9801901

# MPD
pwr.t2n.test(length(which(adiv.muc$Group == "Summer_Wild")),
             length(which(adiv.muc$Group == "Summer_Captive")), d = -1.983765)
  # 0.8037583

# Shannon
pwr.t2n.test(length(which(adiv.muc$Group == "Summer_Wild")),
             length(which(adiv.muc$Group == "Summer_Captive")), d = -0.05054058)
  # 0.05060122

# Unique OTUs
pwr.t2n.test(length(which(adiv.muc$Group == "Summer_Wild")),
             length(which(adiv.muc$Group == "Summer_Captive")), d = -2.944866)
  # 0.985933
```



### Mucosa - Detectable Effect Size
```{r}
# https://cran.r-project.org/web/packages/pwr/vignettes/pwr-vignette.html

pwr.t2n.test(length(which(adiv.muc$Group == "Summer_Wild")),
             length(which(adiv.muc$Group == "Summer_Captive")), power = 0.8)
  # 1.974137
```